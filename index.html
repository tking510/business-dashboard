<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>事業別ダッシュボード v7 - Konibet対応</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f1f5f9;min-height:100vh}
.container{max-width:1400px;margin:0 auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.header h1{font-size:24px;color:#1e293b}
.header-actions{display:flex;gap:10px;flex-wrap:wrap}
.card{background:white;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:20px;margin-bottom:20px}
.tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.tab{padding:10px 18px;border-radius:10px;border:none;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;background:#e2e8f0;color:#475569}
.tab:hover{background:#cbd5e1}
.tab.active{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white}
.btn{padding:10px 20px;border-radius:10px;border:none;cursor:pointer;font-weight:600;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white}
.btn-secondary{background:#f1f5f9;color:#475569}
.btn-danger{background:#fee2e2;color:#dc2626}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.summary-card{border-radius:12px;padding:14px;color:white;background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
.summary-card h3{font-size:10px;opacity:0.9;margin-bottom:4px;text-transform:uppercase}
.summary-card .value{font-size:18px;font-weight:700}
.chart-container{height:300px;margin:20px 0}
.pie-chart-container{height:250px;max-width:300px}
.period-selector{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.period-btn{padding:6px 14px;border-radius:8px;border:none;cursor:pointer;font-size:12px;background:#f1f5f9;color:#64748b;transition:all 0.2s}
.period-btn.active{background:#3b82f6;color:white}
.period-btn:hover{background:#e2e8f0}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:white;border-radius:16px;padding:30px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
.upload-zone{border:2px dashed #cbd5e1;border-radius:12px;padding:40px;text-align:center;cursor:pointer;transition:all 0.2s}
.upload-zone:hover,.upload-zone.dragover{border-color:#3b82f6;background:#eff6ff}
.hidden{display:none!important}
.table-container{overflow-x:auto;max-height:500px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:8px 10px;text-align:left;border-bottom:1px solid #e2e8f0}
th{background:#f8fafc;font-weight:600;color:#64748b;position:sticky;top:0}
tr:hover{background:#f8fafc}
.text-right{text-align:right}
.text-green{color:#16a34a}
.text-red{color:#dc2626}
input,select{padding:10px 14px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;width:100%}
input:focus,select:focus{outline:none;border-color:#3b82f6}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;color:#64748b;margin-bottom:6px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.section-title{font-size:16px;font-weight:600;color:#1e293b;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}
.kpi-item{background:#f8fafc;border-radius:10px;padding:12px}
.kpi-item .label{font-size:10px;color:#64748b;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.kpi-item .val{font-size:16px;font-weight:700;color:#1e293b}
.kpi-item .val.negative{color:#dc2626}
footer{text-align:center;color:#94a3b8;font-size:11px;margin-top:30px;padding:20px}
.totals-section{background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.totals-section .section-title{color:white}
.totals-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
.total-card{background:rgba(255,255,255,0.1);border-radius:12px;padding:16px;backdrop-filter:blur(10px)}
.total-card h4{font-size:11px;opacity:0.8;margin-bottom:8px;text-transform:uppercase}
.total-card .main-val{font-size:22px;font-weight:700;margin-bottom:4px}
.total-card .sub-val{font-size:12px;opacity:0.7}
.crypto-section{background:linear-gradient(135deg,#1e3a5f,#2d5a87);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.crypto-section .section-title{color:white}
.crypto-flex{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start}
.crypto-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;flex:1}
.crypto-card{background:rgba(255,255,255,0.95);border-radius:10px;padding:12px;color:#1e293b}
.crypto-card h5{font-size:10px;color:#64748b;margin-bottom:4px}
.crypto-card .crypto-val{font-size:16px;font-weight:700}
.crypto-card .crypto-pct{font-size:11px;color:#64748b}
.provider-section{background:linear-gradient(135deg,#4a1d6a,#6b2d8a);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.provider-section .section-title{color:white}
.daily-stats-section{background:linear-gradient(135deg,#1e3a5f,#2d5a87);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.daily-stats-section .section-title{color:white;margin-bottom:15px}
.daily-stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;max-height:400px;overflow-y:auto}
.payment-stats-section{background:linear-gradient(135deg,#2d5a47,#3d7a67);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.payment-stats-section .section-title{color:white;margin-bottom:15px}
.payment-stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;max-height:500px;overflow-y:auto}
.payment-month-card{background:rgba(255,255,255,0.1);border-radius:10px;padding:12px;backdrop-filter:blur(5px)}
.payment-month-title{font-weight:bold;font-size:1rem;margin-bottom:10px;color:#90EE90;border-bottom:1px solid rgba(255,255,255,0.2);padding-bottom:5px}
.payment-type-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.1);font-size:0.85rem}
.payment-type-row:last-child{border-bottom:none}
.payment-type-label{color:#b0e0b0;font-weight:500;min-width:70px}
.payment-type-values{display:flex;gap:10px;flex-wrap:wrap}
.payment-stat{color:white;font-size:0.8rem}
.payment-stat-label{color:#a0d0a0;font-size:0.7rem}
.daily-stat-card{background:rgba(255,255,255,0.1);border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.2)}
.daily-stat-card .date{font-weight:bold;font-size:14px;margin-bottom:8px;color:#7dd3fc}
.daily-stat-card .stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px}
.daily-stat-card .stat-item{display:flex;justify-content:space-between}
.daily-stat-card .stat-label{color:rgba(255,255,255,0.7)}
.daily-stat-card .stat-val{font-weight:bold}
.provider-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.provider-card{background:rgba(255,255,255,0.15);border-radius:10px;padding:14px;backdrop-filter:blur(10px)}
.provider-card h5{font-size:12px;margin-bottom:8px;font-weight:600}
.provider-card .provider-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px}
.provider-card .stat-item{background:rgba(255,255,255,0.1);border-radius:6px;padding:6px 8px}
.provider-card .stat-label{opacity:0.7;font-size:9px}
.provider-card .stat-val{font-weight:600}
.game-section{background:linear-gradient(135deg,#1a472a,#2d6a4f);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.game-section .section-title{color:white}
.view-toggle{display:flex;gap:8px;margin-bottom:16px}
.view-toggle .toggle-btn{padding:8px 16px;border-radius:8px;border:2px solid #e2e8f0;background:white;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s}
.view-toggle .toggle-btn.active{border-color:#3b82f6;background:#eff6ff;color:#1d4ed8}
.chart-row{display:flex;gap:20px;flex-wrap:wrap}
.chart-row .pie-wrapper{flex:0 0 280px}
.chart-row .list-wrapper{flex:1;min-width:200px}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>📊 事業別ダッシュボード v7 <span style="font-size:14px;background:#10b981;color:white;padding:2px 8px;border-radius:4px;margin-left:8px">Konibet対応</span></h1>
    <div class="header-actions">
      <span id="sync-status" style="font-size:12px;color:#10b981;margin-right:10px">💾 読込中...</span>
      <button class="btn btn-primary" onclick="showUploadModal()">📤 アップロード</button>
      <button class="btn btn-primary" onclick="showReportPromptModal()" style="background:#8b5cf6">📝 営業報告書</button>
      <button class="btn btn-secondary" onclick="createShareLink()">🔗 共有リンク</button>
      <button class="btn btn-secondary" onclick="showAddBusinessModal()">➕ 事業追加</button>
      <button class="btn btn-danger" onclick="clearAllData()">🗑️</button>
    </div>
  </div>
  <div class="tabs" id="business-tabs"></div>
  <div class="view-toggle">
    <button class="toggle-btn active" onclick="setViewMode('period')" id="view-period">📅 期間別</button>
    <button class="toggle-btn" onclick="setViewMode('total')" id="view-total">📊 全期間トータル</button>
  </div>
  <div id="period-selector" class="period-selector"></div>
  <div id="totals-section" class="totals-section hidden">
    <div class="section-title">📊 全期間トータル・平均</div>
    <div id="totals-grid" class="totals-grid"></div>
  </div>
  <div id="summary-section"></div>
  
  <div class="card">
    <div class="section-title">📈 推移グラフ</div>
    <div class="chart-container"><canvas id="main-chart"></canvas></div>
  </div>
  
  <!-- 継続KPI推移グラフ（スロ天用） -->
  <div id="retention-chart-section" class="card hidden">
    <div class="section-title">📊 継続ユーザー推移</div>
    <div class="chart-container"><canvas id="retention-chart"></canvas></div>
  </div>
  
  <div id="kpi-sections"></div>
  
  <!-- 仮想通貨銘柄別（円グラフ付き） -->
  <div id="crypto-section" class="crypto-section hidden">
    <div class="section-title">🪙 仮想通貨銘柄別</div>
    <div class="crypto-flex">
      <div class="pie-wrapper"><div class="pie-chart-container"><canvas id="crypto-pie-chart"></canvas></div></div>
      <div class="list-wrapper"><div id="crypto-grid" class="crypto-grid"></div></div>
    </div>
  </div>
  
  <!-- ゲーム種別（パチンコ・パチスロ・スロット・ライブ） -->
  <div id="game-section" class="game-section hidden">
    <div class="section-title">🎰 ゲーム種別</div>
    <div class="chart-row">
      <div class="pie-wrapper"><div class="pie-chart-container"><canvas id="game-pie-chart"></canvas></div></div>
      <div class="list-wrapper"><div id="game-grid" class="provider-grid"></div></div>
    </div>
  </div>
  
  <!-- プロバイダー別 -->
  <div id="provider-section" class="provider-section hidden">
    <div class="section-title">🏭 ゲームプロバイダー別</div>
    <div class="chart-row">
      <div class="pie-wrapper"><div class="pie-chart-container"><canvas id="provider-pie-chart"></canvas></div></div>
      <div class="list-wrapper"><div id="provider-grid" class="provider-grid"></div></div>
    </div>
  </div>
  
  <!-- 日次統計 -->
  <div id="daily-stats-section" class="daily-stats-section hidden">
    <div class="section-title">📅 日次統計（精算日別）</div>
    <div id="daily-stats-grid" class="daily-stats-grid"></div>
  </div>
  
  <!-- 着金統計 -->
  <div id="payment-stats-section" class="payment-stats-section hidden">
    <div class="section-title">💰 着金統計（月別）</div>
    <div id="payment-stats-grid" class="payment-stats-grid"></div>
  </div>
  
  <div id="data-table" class="card">
    <div class="section-title">📋 詳細データ</div>
    <div class="table-container">
      <table><thead><tr id="table-header"></tr></thead><tbody id="table-body"></tbody></table>
    </div>
  </div>
  <footer>収益管理ダッシュボード v7.0 | Konibet KPI対応版 | 円グラフ・プロバイダー/ゲーム種別分離対応</footer>
</div>

<div id="upload-modal" class="modal hidden">
  <div class="modal-content">
    <h3 style="margin-bottom:20px">📤 ファイルアップロード</h3>
    <div class="form-row">
      <div class="form-group"><label>期間</label><input type="text" id="upload-period" placeholder="例: 2025年10月"></div>
      <div class="form-group"><label>データ種別</label>
        <select id="upload-type" onchange="toggleExchangeRate()">
          <option value="auto">自動判別</option>
          <option value="samExcel">元amuse/DSC Excel</option>
          <option value="sloten">スロ天KPIシート</option>
          <option value="konibet">Konibet KPIシート</option>
          <option value="agent">AMUSEVIP エージェント</option>
          <option value="ads">広告データ</option>
          <option value="baccarat">バカラツール</option>
          <option value="customerList">顧客リストシート</option>
          <option value="uncollected">未回収シート</option>
          <option value="bonus">ボーナスシート</option>
          <option value="delayed">遅れ回収シート</option>
        </select>
      </div>
    </div>
    <div class="form-row" id="exchange-rate-row" style="display:none">
      <div class="form-group">
        <label>💱 為替レート (USD→JPY)</label>
        <input type="number" id="usd-jpy-rate" value="150" min="1" max="500" step="0.1" style="width:120px">
        <span style="font-size:12px;color:#64748b;margin-left:8px">※Konibet金額換算用</span>
      </div>
    </div>
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
      <div style="font-size:40px;margin-bottom:10px">📁</div>
      <p>クリックまたはドラッグ&ドロップ</p>
      <p style="font-size:12px;color:#94a3b8;margin-top:8px">.xlsx, .xls, .csv 対応</p>
    </div>
    <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileUpload(this.files[0])">
    <div id="upload-status" style="margin-top:16px;padding:12px;border-radius:8px;display:none"></div>
    <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="hideUploadModal()">閉じる</button>
    </div>
  </div>
</div>

<div id="add-business-modal" class="modal hidden">
  <div class="modal-content">
    <h3 style="margin-bottom:20px">➕ 事業追加</h3>
    <div class="form-group"><label>事業名</label><input type="text" id="new-business-name" placeholder="例: 新規事業"></div>
    <div class="form-group"><label>事業タイプ</label>
      <select id="new-business-type">
        <option value="samExcel">標準（GGR/NGR等）</option>
        <option value="sloten">スロ天形式</option>
        <option value="konibet">Konibet形式</option>
        <option value="agent">エージェント型</option>
        <option value="ads">広告型</option>
        <option value="baccara">ツール型</option>
      </select>
    </div>
    <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="hideAddBusinessModal()">キャンセル</button>
      <button class="btn btn-primary" onclick="addBusiness()">追加</button>
    </div>
  </div>
</div>

<div id="report-prompt-modal" class="modal hidden">
  <div class="modal-content" style="max-width:800px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column">
    <h3 style="margin-bottom:20px">📝 営業報告書用プロンプト</h3>
    <div style="margin-bottom:12px;display:flex;gap:10px;align-items:center">
      <span style="font-weight:600" id="report-business-period"></span>
      <button class="btn btn-primary" onclick="copyReportPrompt()" style="margin-left:auto">📋 コピー</button>
    </div>
    <textarea id="report-prompt-text" readonly style="flex:1;min-height:400px;width:100%;padding:16px;border:1px solid #e2e8f0;border-radius:8px;font-family:monospace;font-size:13px;line-height:1.6;resize:none;background:#f8fafc"></textarea>
    <div style="margin-top:16px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="hideReportPromptModal()">閉じる</button>
    </div>
  </div>
</div>

<script>
// ========== データ定義 ==========
const MOTO_AMUSE_DATA = {
  '2025年10月':{サマリー:{'リスト件数':14542,'打電数':10579,'着電数':1716,'LINE登録数':23,'アカウント作成数':141,'FTP数':82,'FTP率':0.5816,'FTD数':48,'FTD率':0.3404,'FTW数':7,'FTW率':0.0496,'FTDW数':55,'FTDW率':0.3901,'前月リテンション数':75,'引継ぎプレイヤー数':153,'アクティブユーザー数':294,'T/O':1577495817.7,'勝利金':1507184477.51,'RTP':0.9554,'GGR(WIN/LOSE)':70311340.19,'LTV(WIN/LOSE)':239154.22,'回収予定金額':71840329,'回収金額':55956778,'回収率(全体)':0.7789,'回収率(今月)':0.7476,'出金金額':17719827,'GGR(回収金額-出金金額)':38174451,'LTV(GGR)':129845.07,'プロバイダーフィー':7263554.56,'NGR':30910896.44,'総登録数':294,'総信用枠':88200000,'平均信用枠':300000,'平均Credit単価':1837500,'総ボーナス':2150000,'平均プレイ月間':4.2,'事前清算回数':45,'事前清算金額':12500000,'通常清算回数':180,'通常清算金額':43456778,'事前清算割合':0.2234,'通常清算割合':0.7766,'事前清算件数割合':0.2,'通常清算件数割合':0.8},リスト種別:{'B':272,'E':713,'T':17,'S':724,'その他':8}},
  '2025年9月':{サマリー:{'GGR(WIN/LOSE)':-2176638.6,'LINE登録数':13,'RTP':1.0383,'T/O':56770645,'リスト件数':14965,'勝利金':58947283.6,'打電数':1035,'着電数':665,'総登録数':180,'総信用枠':54000000,'平均信用枠':300000,'平均Credit単価':1800000,'総ボーナス':980000,'平均プレイ月間':3.8,'事前清算回数':28,'事前清算金額':7800000,'通常清算回数':95,'通常清算金額':22500000,'事前清算割合':0.2574,'通常清算割合':0.7426,'事前清算件数割合':0.2276,'通常清算件数割合':0.7724},リスト種別:{'B':25,'E':20,'T':18,'S':15,'BE':12,'C':10,'紹介':8,'その他':72}},
  '2025年8月':{サマリー:{'BK':7114855,'FTD数':12,'FTD率':0.2044,'FTP数':60,'FTP率':0.7676,'GGR(WIN/LOSE)':56952667,'GGR(回収金額-出金金額)':27019475,'LINE登録数':48,'LTV(GGR)':92276.37,'LTV(WIN/LOSE)':389548,'NGR':23459499,'RTP':0.9735,'T/O':1910465086,'アカウント作成数':78,'アクティブユーザー数':284,'プロバイダーフィー':3559976,'リスト件数':9997,'出金金額':13154437,'前月リテンション数':88,'勝利金':1853512419,'回収予定金額':56467301,'回収率(今月)':0.7759,'回収率(全体)':0.74,'回収金額':41786755,'引継ぎプレイヤー数':206,'打電数':9829,'着電数':3810,'総登録数':284,'総信用枠':85200000,'平均信用枠':300000,'平均Credit単価':1775000,'総ボーナス':1850000,'平均プレイ月間':4.5,'事前清算回数':52,'事前清算金額':11200000,'通常清算回数':165,'通常清算金額':30586755,'事前清算割合':0.2680,'通常清算割合':0.7320,'事前清算件数割合':0.2396,'通常清算件数割合':0.7604},リスト種別:{'B':38,'E':32,'T':25,'S':20,'BE':15,'C':12,'紹介':10,'その他':132}},
  '2025年7月':{サマリー:{'BK':1046146.65,'FTDW数':14,'FTDW率':0.209,'FTD数':11,'FTD率':0.164,'FTP数':39,'FTP率':0.582,'FTW数':3,'FTW率':0.045,'GGR(WIN/LOSE)':89408914.42,'GGR(回収金額-出金金額)':11754881.9,'LINE登録数':51,'LTV(GGR)':34271.25,'LTV(WIN/LOSE)':234669.07,'NGR':3791600.89,'RTP':0.9762,'T/O':3753649644.37,'アカウント作成数':67,'アクティブユーザー数':381,'プロバイダーフィー':7963281.01,'リスト件数':9957,'出金金額':37542660,'前月リテンション数':17,'勝利金':3664240729.95,'回収予定金額':106737904.3,'回収率(今月)':0.6686,'回収率(全体)':0.7004,'回収金額':74754327.9,'引継ぎプレイヤー数':314,'打電数':100011,'着電数':3839,'総登録数':381,'総信用枠':114300000,'平均信用枠':300000,'平均Credit単価':1890000,'総ボーナス':2450000,'平均プレイ月間':3.9,'事前清算回数':68,'事前清算金額':18500000,'通常清算回数':210,'通常清算金額':56254327,'事前清算割合':0.2474,'通常清算割合':0.7526,'事前清算件数割合':0.2446,'通常清算件数割合':0.7554},リスト種別:{'B':52,'E':45,'T':35,'S':28,'BE':22,'C':18,'紹介':15,'その他':166}},
  '2025年6月':{サマリー:{'BK':19008236.94,'GGR(WIN/LOSE)':106821992.9,'GGR(回収金額-出金金額)':79117068,'LINE登録数':367,'LTV(GGR)':113348.24,'LTV(WIN/LOSE)':153040.1,'NGR':69120861.61,'RTP':0.9716,'T/O':3764837698.76,'アクティブユーザー数':698,'プロバイダーフィー':9996206.39,'リスト件数':9884,'前月リテンション数':235,'勝利金':3658015705.86,'打電数':191066,'着電数':7980,'総登録数':698,'総信用枠':209400000,'平均信用枠':300000,'平均Credit単価':1950000,'総ボーナス':4200000,'平均プレイ月間':5.1,'事前清算回数':125,'事前清算金額':28500000,'通常清算回数':385,'通常清算金額':50617068,'事前清算割合':0.3603,'通常清算割合':0.6397,'事前清算件数割合':0.2451,'通常清算件数割合':0.7549},リスト種別:{'B':95,'E':82,'T':65,'S':52,'BE':42,'C':35,'紹介':28,'その他':299}},
  '2025年5月':{サマリー:{'BK':6910039.38,'FTDW数':119,'FTDW率':0.3766,'FTD数':110,'FTD率':0.3481,'GGR':30822400,'LINE登録数':497,'LTV(GGR)':40878.51,'LTV(WIN/LOSE)':3348.2,'NGR':21494893.73,'RTP':0.9995,'T/O':5416323482.72,'WIN/LOSE':2524541,'アカウント作成数':316,'アクティブユーザー数':754,'プロバイダーフィー':9327506.27,'リスト件数':9967,'出金金額':74028096,'前月リテンション数':119,'勝利金':5413798941.72,'回収予定金額':127207474.62,'回収率(今月)':0.8335,'回収率(全体)':0.8491,'回収金額':108007299.5,'引継ぎプレイヤー数':438,'打電数':171257,'着電数':6193,'総登録数':754,'総信用枠':226200000,'平均信用枠':300000,'平均Credit単価':2056363,'総ボーナス':5100000,'平均プレイ月間':4.8,'事前清算回数':142,'事前清算金額':32000000,'通常清算回数':420,'通常清算金額':76007299,'事前清算割合':0.2962,'通常清算割合':0.7038,'事前清算件数割合':0.2527,'通常清算件数割合':0.7473},リスト種別:{'B':102,'E':88,'T':72,'S':58,'BE':45,'C':38,'紹介':32,'その他':319}},
  '着金統計':{"EC":{"2025年3月":{"人数":280,"回数":494,"金額合計":30795250,"中央値":50000},"2025年4月":{"人数":411,"回数":1071,"金額合計":66290849,"中央値":50000},"2025年5月":{"人数":410,"回数":1050,"金額合計":68681000,"中央値":50000},"2025年6月":{"人数":407,"回数":1031,"金額合計":80185947,"中央値":60000},"2025年7月":{"人数":198,"回数":453,"金額合計":42244292,"中央値":97000},"2025年8月":{"人数":116,"回数":243,"金額合計":23429600,"中央値":100000},"2025年9月":{"人数":83,"回数":134,"金額合計":10879300,"中央値":50000},"2025年10月":{"人数":2,"回数":2,"金額合計":60000,"中央値":30000}},"Paypay":{"2025年3月":{"人数":3,"回数":3,"金額合計":64901,"中央値":29912},"2025年4月":{"人数":72,"回数":121,"金額合計":6348255,"中央値":24986},"2025年5月":{"人数":202,"回数":489,"金額合計":19488704,"中央値":30000},"2025年6月":{"人数":203,"回数":454,"金額合計":22912731,"中央値":39962},"2025年7月":{"人数":130,"回数":242,"金額合計":17451447,"中央値":47740},"2025年8月":{"人数":87,"回数":170,"金額合計":9839682,"中央値":35000},"2025年9月":{"人数":18,"回数":22,"金額合計":646306,"中央値":22500},"2025年10月":{"人数":2,"回数":2,"金額合計":15000,"中央値":7500}},"仮想通貨":{"TRX":{"2025年3月":{"人数":4,"回数":7,"金額合計":161095,"中央値":9000},"2025年4月":{"人数":4,"回数":7,"金額合計":500677,"中央値":50099},"2025年5月":{"人数":8,"回数":12,"金額合計":766800,"中央値":49993},"2025年6月":{"人数":8,"回数":12,"金額合計":623234,"中央値":44946},"2025年7月":{"人数":2,"回数":2,"金額合計":109936,"中央値":54968}},"XRP":{"2025年3月":{"人数":14,"回数":19,"金額合計":697168,"中央値":29527},"2025年4月":{"人数":12,"回数":30,"金額合計":1600638,"中央値":27500},"2025年5月":{"人数":19,"回数":34,"金額合計":3012582,"中央値":49849},"2025年6月":{"人数":21,"回数":41,"金額合計":2881946,"中央値":40000},"2025年7月":{"人数":8,"回数":13,"金額合計":968421,"中央値":41455},"2025年8月":{"人数":7,"回数":10,"金額合計":908703,"中央値":49925},"2025年9月":{"人数":1,"回数":1,"金額合計":5000,"中央値":5000}},"USDT":{"2025年3月":{"人数":9,"回数":10,"金額合計":788540,"中央値":40000},"2025年4月":{"人数":22,"回数":31,"金額合計":2254708,"中央値":29988},"2025年5月":{"人数":24,"回数":39,"金額合計":3151881,"中央値":49990},"2025年6月":{"人数":14,"回数":16,"金額合計":620415,"中央値":30000},"2025年7月":{"人数":8,"回数":13,"金額合計":2081051,"中央値":160395},"2025年8月":{"人数":8,"回数":16,"金額合計":1187401,"中央値":44968},"2025年9月":{"人数":3,"回数":4,"金額合計":248701,"中央値":40158}},"BTC":{"2025年4月":{"人数":1,"回数":2,"金額合計":30000,"中央値":15000},"2025年9月":{"人数":1,"回数":1,"金額合計":503065,"中央値":503065}},"ETH":{"2025年5月":{"人数":1,"回数":1,"金額合計":150000,"中央値":150000},"2025年6月":{"人数":3,"回数":3,"金額合計":578377,"中央値":49976},"2025年7月":{"人数":3,"回数":4,"金額合計":1372010,"中央値":344924}}},"個人":{"2025年2月":{"人数":46,"回数":49,"金額合計":4108572,"中央値":49926},"2025年3月":{"人数":167,"回数":430,"金額合計":60824527,"中央値":77671},"2025年4月":{"人数":155,"回数":416,"金額合計":46607466,"中央値":59954},"2025年5月":{"人数":133,"回数":328,"金額合計":36283699,"中央値":50000},"2025年6月":{"人数":121,"回数":256,"金額合計":40646055,"中央値":79955},"2025年7月":{"人数":72,"回数":147,"金額合計":36909003,"中央値":198530},"2025年8月":{"人数":35,"回数":76,"金額合計":28604710,"中央値":265541},"2025年9月":{"人数":19,"回数":51,"金額合計":16808024,"中央値":299875}}}
};
const DSC_DATA = {
  '2026年1月':{サマリー:{'FTDW数':12,'FTDW率':0.6,'FTD数':10,'FTD率':0.5,'FTP数':16,'FTP率':0.8,'FTW数':2,'FTW率':0.1,'GGR(WIN/LOSE)':43248155.21,'GGR(回収金額-出金金額)':30601418,'LTV(GGR)':128277.01,'LTV(WIN/LOSE)':249989.34,'NGR':20776887.34,'RTP':0.9678,'T/O':1342354453.62,'アカウント作成数':20,'アクティブユーザー数':173,'プロバイダーフィー':1415034.66,'リスト件数':15000,'出金金額':17783098,'勝利金':1299106298.41,'回収予定金額':57141822,'回収率(今月)':0.7995,'回収率(全体)':0.8467,'回収金額':45685123,'回収済金額':48384516,'総登録数':173,'総信用枠':184943000,'事前精算金額':19572494,'平均信用枠':300000,'平均Credit単価':2595000,'総ボーナス':1250000,'平均プレイ月間':5.2,'事前清算回数':32,'事前清算金額':9800000,'通常清算回数':98,'通常清算金額':25274981,'事前清算割合':0.2794,'通常清算割合':0.7206,'事前清算件数割合':0.2462,'通常清算件数割合':0.7538},リスト種別:{'B':15,'E':68,'T':8,'S':81,'その他':9},プロバイダー:{'AkibaGames':{ユーザー数:8,賭け金額:3220650,配当金額:4318045,GGR:-1097395},'PLAYTECH-LIVE':{ユーザー数:1,賭け金額:380,配当金額:184,GGR:196},'PLAYTECH-SLOT':{ユーザー数:12,賭け金額:1175730,配当金額:1190505,GGR:-14775},'KAGaming':{ユーザー数:11,賭け金額:75270,配当金額:86688,GGR:-11418},'Evolution':{ユーザー数:143,賭け金額:1181707918,配当金額:1146697218,GGR:35010699},'PlayNGo Direct':{ユーザー数:87,賭け金額:38137786,配当金額:34223341,GGR:3914444},'Pocket Games Soft':{ユーザー数:25,賭け金額:933944,配当金額:855455,GGR:78489},'CQGames':{ユーザー数:1,賭け金額:24,配当金額:5,GGR:19},'Fa Chai':{ユーザー数:9,賭け金額:163409,配当金額:206851,GGR:-43442},'Pragmatic Play':{ユーザー数:126,賭け金額:360408356,配当金額:358374541,GGR:2033814},'HabaneroGaming':{ユーザー数:5,賭け金額:80108,配当金額:60613,GGR:19495},'Booongo':{ユーザー数:11,賭け金額:467360,配当金額:333090,GGR:134270},'Gekipachi':{ユーザー数:63,賭け金額:51135658,配当金額:50406456,GGR:729202},'Nolimit City':{ユーザー数:45,賭け金額:53763110,配当金額:48232509,GGR:5530601},'HackSaw':{ユーザー数:67,賭け金額:13321570,配当金額:12155761,GGR:1165809},'Jili':{ユーザー数:16,賭け金額:314555,配当金額:291525,GGR:23029},'MicroGaming Slot':{ユーザー数:26,賭け金額:4465822,配当金額:4169092,GGR:296731},'Relax Gaming':{ユーザー数:46,賭け金額:11670075,配当金額:9757444,GGR:1912630},'AvatarUX':{ユーザー数:24,賭け金額:4043220,配当金額:3520712,GGR:522508},'QuickSpin':{ユーザー数:12,賭け金額:923170,配当金額:868459,GGR:54711},'Red Tiger':{ユーザー数:19,賭け金額:4420880,配当金額:4707284,GGR:-286404},'Blueprint Gaming':{ユーザー数:12,賭け金額:6743640,配当金額:5021676,GGR:1721964},'OctoPlay':{ユーザー数:32,賭け金額:3298300,配当金額:2632454,GGR:665846}},日次統計:{'2026/01/05':{人数:274,信用枠合計:31723000,回収金額合計:9851896,信用枠中央値:50000,回収金額中央値:50000},'2026/01/08':{人数:216,信用枠合計:25190000,回収金額合計:4896523,信用枠中央値:50000,回収金額中央値:69283},'2026/01/12':{人数:232,信用枠合計:24670000,回収金額合計:5391129,信用枠中央値:50000,回収金額中央値:40010},'2026/01/15':{人数:209,信用枠合計:26080000,回収金額合計:5483895,信用枠中央値:50000,回収金額中央値:49992},'2026/01/19':{人数:236,信用枠合計:33110000,回収金額合計:10163844,信用枠中央値:50000,回収金額中央値:49983},'2026/01/22':{人数:230,信用枠合計:19810000,回収金額合計:5636073,信用枠中央値:30000,回収金額中央値:50000},'2026/01/26':{人数:258,信用枠合計:23070000,回収金額合計:4252642,信用枠中央値:30000,回収金額中央値:49241},'2026/01/29':{人数:35,信用枠合計:5850000,回収金額合計:30000,信用枠中央値:150000,回収金額中央値:30000}}},
  '2025年12月':{サマリー:{'GGR(WIN/LOSE)':53578505.82,'GGR(回収金額-出金金額)':38616975,'LTV(GGR)':133161.98,'LTV(WIN/LOSE)':184753.47,'NGR':31242527,'RTP':0.9646,'T/O':1514244472.37,'アカウント作成数':27,'アクティブユーザー数':292,'プロバイダーフィー':7374448,'出金金額':20555338,'勝利金':1460665966.55,'回収予定金額':73458827,'回収率(全体)':0.8381,'回収金額':61567404,'総登録数':292,'総信用枠':87600000,'平均信用枠':300000,'平均Credit単価':2466666,'総ボーナス':2100000,'平均プレイ月間':4.8,'事前清算回数':55,'事前清算金額':16500000,'通常清算回数':168,'通常清算金額':45067404,'事前清算割合':0.2679,'通常清算割合':0.7321,'事前清算件数割合':0.2466,'通常清算件数割合':0.7534},リスト種別:{'B':42,'E':35,'T':28,'S':22,'BE':18,'C':15,'紹介':12,'その他':120},プロバイダー:{'AkibaGames':{ユーザー数:25,賭け金額:1203150,配当金額:833935,GGR:369215},'PLAYTECH-LIVE':{ユーザー数:2,賭け金額:71400,配当金額:74200,GGR:-2800},'PLAYTECH-SLOT':{ユーザー数:10,賭け金額:2586715,配当金額:2437998,GGR:148717},'KAGaming':{ユーザー数:17,賭け金額:400494,配当金額:256578,GGR:143916},'Evolution':{ユーザー数:206,賭け金額:1240710465,配当金額:1206271233,GGR:34439231},'PlayNGo Direct':{ユーザー数:118,賭け金額:27726576,配当金額:26283289,GGR:1443287},'Pocket Games Soft':{ユーザー数:29,賭け金額:754016,配当金額:785570,GGR:-31554},'CQGames':{ユーザー数:9,賭け金額:39338,配当金額:30337,GGR:9001},'Fa Chai':{ユーザー数:1,賭け金額:2112,配当金額:3744,GGR:-1632},'Pragmatic Play':{ユーザー数:176,賭け金額:148675871,配当金額:135985783,GGR:12690088},'HabaneroGaming':{ユーザー数:1,賭け金額:1200,配当金額:820,GGR:380},'Booongo':{ユーザー数:13,賭け金額:653690,配当金額:564865,GGR:88825},'Gekipachi':{ユーザー数:70,賭け金額:32842623,配当金額:32262060,GGR:580563},'Nolimit City':{ユーザー数:69,賭け金額:46171135,配当金額:43494771,GGR:2676364},'HackSaw':{ユーザー数:84,賭け金額:19721400,配当金額:18519993,GGR:1201407},'Jili':{ユーザー数:18,賭け金額:182421,配当金額:156923,GGR:25499},'MicroGaming Slot':{ユーザー数:25,賭け金額:1050939,配当金額:991134,GGR:59805},'Relax Gaming':{ユーザー数:61,賭け金額:11750724,配当金額:10286248,GGR:1464476},'AvatarUX':{ユーザー数:33,賭け金額:1978340,配当金額:1612138,GGR:366202},'QuickSpin':{ユーザー数:19,賭け金額:535470,配当金額:535350,GGR:120},'Red Tiger':{ユーザー数:14,賭け金額:340440,配当金額:316070,GGR:24370},'Blueprint Gaming':{ユーザー数:18,賭け金額:4971270,配当金額:5993008,GGR:-1021738},'OctoPlay':{ユーザー数:11,賭け金額:285790,配当金額:247893,GGR:37897}}},
  '2025年11月':{サマリー:{'BK':9242926.55,'FTDW数':62,'FTDW率':0.8052,'FTD数':29,'FTD率':0.3766,'FTP数':61,'FTP率':0.7922,'FTW数':33,'FTW率':0.4286,'GGR(WIN/LOSE)':64900999.09,'GGR(回収金額-出金金額)':43448785,'LINE登録数':38,'LTV(GGR)':191404.34,'LTV(WIN/LOSE)':285907.48,'NGR':33610642.28,'RTP':0.9586,'T/O':1568206349.94,'アカウント作成数':77,'アクティブユーザー数':227,'プロバイダーフィー':9838142.72,'リスト件数':14867,'出金金額':19725328,'前月リテンション数':82,'勝利金':1503305350.85,'回収予定金額':77447062,'回収率(今月)':0.7476,'回収率(全体)':0.8291,'回収金額':64213601,'引継ぎプレイヤー数':150,'打電数':10398,'着電数':1209,'総登録数':227,'総信用枠':68100000,'平均信用枠':300000,'平均Credit単価':2348275,'総ボーナス':1680000,'平均プレイ月間':4.5,'事前清算回数':42,'事前清算金額':13200000,'通常清算回数':135,'通常清算金額':51013601,'事前清算割合':0.2056,'通常清算割合':0.7944,'事前清算件数割合':0.2373,'通常清算件数割合':0.7627},リスト種別:{'B':32,'E':28,'T':22,'S':18,'BE':14,'C':12,'紹介':10,'その他':91},プロバイダー:{'AkibaGames':{ユーザー数:14,賭け金額:874500,配当金額:722300,GGR:152200},'PLAYTECH-LIVE':{ユーザー数:6,賭け金額:459500,配当金額:634340,GGR:-174840},'PLAYTECH-SLOT':{ユーザー数:8,賭け金額:992230,配当金額:1190225,GGR:-197995},'KAGaming':{ユーザー数:6,賭け金額:136519,配当金額:165438,GGR:-28919},'Evolution':{ユーザー数:177,賭け金額:1145813150,配当金額:1108399275,GGR:37413875},'PlayNGo Direct':{ユーザー数:106,賭け金額:34192568,配当金額:29308708,GGR:4883860},'Pocket Games Soft':{ユーザー数:22,賭け金額:1473350,配当金額:1308625,GGR:164725},'CQGames':{ユーザー数:1,賭け金額:45,配当金額:0,GGR:45},'Fa Chai':{ユーザー数:2,賭け金額:4682,配当金額:3441,GGR:1241},'Pragmatic Play':{ユーザー数:148,賭け金額:239811460,配当金額:227865043,GGR:11946417},'HabaneroGaming':{ユーザー数:3,賭け金額:11600,配当金額:5865,GGR:5735},'Booongo':{ユーザー数:8,賭け金額:241750,配当金額:197330,GGR:44420},'Gekipachi':{ユーザー数:74,賭け金額:28257260,配当金額:25246427,GGR:3010833},'Nolimit City':{ユーザー数:55,賭け金額:67983081,配当金額:63222889,GGR:4760192},'HackSaw':{ユーザー数:80,賭け金額:22604350,配当金額:21574449,GGR:1029901},'Jili':{ユーザー数:11,賭け金額:158380,配当金額:108224,GGR:50156},'MicroGaming Slot':{ユーザー数:19,賭け金額:3114810,配当金額:2869025,GGR:245785},'Relax Gaming':{ユーザー数:61,賭け金額:15795120,配当金額:15064432,GGR:730688},'AvatarUX':{ユーザー数:35,賭け金額:3553730,配当金額:3016957,GGR:536773},'QuickSpin':{ユーザー数:13,賭け金額:505010,配当金額:538138,GGR:-33128},'Red Tiger':{ユーザー数:7,賭け金額:129160,配当金額:145291,GGR:-16131},'Blueprint Gaming':{ユーザー数:10,賭け金額:1943495,配当金額:1594092,GGR:349403},'OctoPlay':{ユーザー数:13,賭け金額:150600,配当金額:124836,GGR:25764}}},
  '2025年10月':{サマリー:{'GGR(WIN/LOSE)':68470005,'GGR(回収金額-出金金額)':51817553,'T/O':1549158786,'アクティブユーザー数':250,'プロバイダーフィー':6847000,'出金金額':17719827,'勝利金':1480688781,'回収率(今月)':0.7996,'回収率(全体)':0.9713,'回収金額':57282112,'回収済金額':69537380,'回収予定金額':71590836,'総信用枠':216439800,'事前精算金額':23233314,'総登録数':250},リスト種別:{'B':38,'E':32,'T':25,'S':20,'その他':135},プロバイダー:{'PLAYTECH-LIVE':{ユーザー数:1,賭け金額:2000,配当金額:5000,GGR:-3000},'KAGaming':{ユーザー数:23,賭け金額:342485,配当金額:342459,GGR:26},'Evolution':{ユーザー数:210,賭け金額:1250551232,配当金額:1205434677,GGR:45116555},'PlayNGo Direct':{ユーザー数:135,賭け金額:74525309,配当金額:68832150,GGR:5693159},'Pocket Games Soft':{ユーザー数:1,賭け金額:3000,配当金額:1384,GGR:1616},'Pragmatic Play':{ユーザー数:153,賭け金額:97400982,配当金額:86796463,GGR:10604519},'Gekipachi':{ユーザー数:108,賭け金額:45476824,配当金額:43411446,GGR:2065377},'Nolimit City':{ユーザー数:53,賭け金額:35178006,配当金額:33055633,GGR:2122373},'HackSaw':{ユーザー数:96,賭け金額:23366020,配当金額:20572866,GGR:2793154},'Jili':{ユーザー数:2,賭け金額:16650,配当金額:14505,GGR:2145},'MicroGaming Slot':{ユーザー数:44,賭け金額:4777474,配当金額:4868668,GGR:-91194},'Relax Gaming':{ユーザー数:53,賭け金額:10555732,配当金額:10554568,GGR:1164},'AvatarUX':{ユーザー数:26,賭け金額:1182220,配当金額:902295,GGR:279925},'QuickSpin':{ユーザー数:15,賭け金額:822490,配当金額:1143403,GGR:-320913},'Red Tiger':{ユーザー数:25,賭け金額:2357990,配当金額:2448377,GGR:-90387},'Blueprint Gaming':{ユーザー数:1,賭け金額:520,配当金額:52,GGR:468},'OctoPlay':{ユーザー数:16,賭け金額:452830,配当金額:438314,GGR:14516},'Booongo':{ユーザー数:12,賭け金額:1149022,配当金額:965530,GGR:183492}},日次統計:{'2025/10/02':{人数:214,信用枠合計:22900000,回収金額合計:5785249,信用枠中央値:50000,回収金額中央値:50000},'2025/10/06':{人数:228,信用枠合計:23970000,回収金額合計:6044150,信用枠中央値:50000,回収金額中央値:55000},'2025/10/09':{人数:205,信用枠合計:21980000,回収金額合計:4620595,信用枠中央値:70000,回収金額中央値:69345},'2025/10/13':{人数:210,信用枠合計:24740000,回収金額合計:7704087,信用枠中央値:50000,回収金額中央値:82180},'2025/10/16':{人数:203,信用枠合計:22720000,回収金額合計:4888932,信用枠中央値:50000,回収金額中央値:100000},'2025/10/20':{人数:246,信用枠合計:29750000,回収金額合計:11225484,信用枠中央値:50000,回収金額中央値:60000},'2025/10/23':{人数:226,信用枠合計:23520000,回収金額合計:6041470,信用枠中央値:50000,回収金額中央値:77000},'2025/10/27':{人数:255,信用枠合計:26230000,回収金額合計:8145329,信用枠中央値:50000,回収金額中央値:89891},'2025/10/30':{人数:240,信用枠合計:25350000,回収金額合計:6026730,信用枠中央値:50000,回収金額中央値:50000}}},
  '2025年9月':{サマリー:{'BK':8671957.8,'FTDW数':92,'FTDW率':0.3948,'FTD数':73,'FTD率':0.3133,'FTP数':154,'FTP率':0.6609,'FTW数':19,'FTW率':0.0815,'GGR(WIN/LOSE)':74174997,'GGR(回収金額-出金金額)':40783402,'LINE登録数':161,'LTV(GGR)':137774.17,'LTV(WIN/LOSE)':248909.39,'NGR':31772784,'RTP':0.9712,'T/O':2578173994,'アカウント作成数':233,'アクティブユーザー数':298,'プロバイダーフィー':9010618,'リスト件数':14807,'出金金額':21551493,'前月リテンション数':21,'勝利金':2503998997,'回収予定金額':76698566.8,'回収率(全体)':0.8194,'回収金額':62846588,'引継ぎプレイヤー数':65,'打電数':12471,'着電数':2418,'総登録数':298,'総信用枠':89400000,'平均信用枠':300000,'平均Credit単価':1224657,'総ボーナス':2350000,'平均プレイ月間':3.9,'事前清算回数':58,'事前清算金額':15800000,'通常清算回数':175,'通常清算金額':47046588,'事前清算割合':0.2514,'通常清算割合':0.7486,'事前清算件数割合':0.2489,'通常清算件数割合':0.7511},リスト種別:{'B':45,'E':38,'T':30,'S':24,'BE':18,'C':15,'紹介':12,'その他':116},プロバイダー:{'PLAYTECH-LIVE':{ユーザー数:2,賭け金額:4500,配当金額:6700,GGR:-2200},'KAGaming':{ユーザー数:28,賭け金額:597297,配当金額:535576,GGR:61721},'Evolution':{ユーザー数:212,賭け金額:1780535416,配当金額:1744364850,GGR:36170566},'PlayNGo Direct':{ユーザー数:130,賭け金額:552421048,配当金額:533394504,GGR:19026544},'Gekipachi':{ユーザー数:131,賭け金額:66491019,配当金額:60478231,GGR:6012788},'Nolimit City':{ユーザー数:52,賭け金額:12717952,配当金額:11605309,GGR:1112643},'HackSaw':{ユーザー数:63,賭け金額:8920150,配当金額:8217079,GGR:703071},'MicroGaming Slot':{ユーザー数:28,賭け金額:916985,配当金額:777681,GGR:139304},'Relax Gaming':{ユーザー数:68,賭け金額:46361346,配当金額:52270335,GGR:-5908989},'AvatarUX':{ユーザー数:42,賭け金額:2183590,配当金額:1735098,GGR:448492},'QuickSpin':{ユーザー数:14,賭け金額:955830,配当金額:788987,GGR:166843},'Red Tiger':{ユーザー数:23,賭け金額:1196900,配当金額:1213117,GGR:-16217},'OctoPlay':{ユーザー数:12,賭け金額:253130,配当金額:225418,GGR:27712},'CQ9':{ユーザー数:1,賭け金額:300,配当金額:0,GGR:300},'Pragmatic Play':{ユーザー数:188,賭け金額:104376118,配当金額:88176809,GGR:16199309},'Booongo':{ユーザー数:8,賭け金額:130770,配当金額:80842,GGR:49928},'Pocket Games Soft':{ユーザー数:1,賭け金額:90,配当金額:42,GGR:48}}},
  '2025年8月':{サマリー:{'GGR(WIN/LOSE)':14211509,'T/O':611319598,'アクティブユーザー数':150,'プロバイダーフィー':1421151,'出金金額':8500000,'勝利金':597108089,'回収率(全体)':0.78,'回収金額':28000000,'総登録数':150},リスト種別:{'B':22,'E':18,'T':15,'S':12,'その他':83},プロバイダー:{'PLAYTECH-LIVE':{ユーザー数:1,賭け金額:50000,配当金額:50000,GGR:0},'KAGaming':{ユーザー数:21,賭け金額:269865,配当金額:245637,GGR:24228},'Evolution':{ユーザー数:99,賭け金額:525713306,配当金額:516839020,GGR:8874285},'PlayNGo Direct':{ユーザー数:56,賭け金額:33094368,配当金額:34387169,GGR:-1292801},'Gekipachi':{ユーザー数:54,賭け金額:16271098,配当金額:16202874,GGR:68223},'Nolimit City':{ユーザー数:14,賭け金額:2833304,配当金額:2671721,GGR:161583},'MicroGaming Slot':{ユーザー数:13,賭け金額:4507189,配当金額:4508674,GGR:-1485},'Relax Gaming':{ユーザー数:12,賭け金額:1049438,配当金額:1111862,GGR:-62424},'AvatarUX':{ユーザー数:6,賭け金額:853520,配当金額:860640,GGR:-7120},'QuickSpin':{ユーザー数:9,賭け金額:102520,配当金額:86301,GGR:16219},'Red Tiger':{ユーザー数:7,賭け金額:174360,配当金額:154584,GGR:19776},'OctoPlay':{ユーザー数:5,賭け金額:817740,配当金額:755932,GGR:61808},'Pragmatic Play':{ユーザー数:54,賭け金額:25310095,配当金額:19076604,GGR:6233491},'Booongo':{ユーザー数:5,賭け金額:31550,配当金額:20322,GGR:11228},'JILI':{ユーザー数:1,賭け金額:9982,配当金額:4372,GGR:5610},'Pocket Games Soft':{ユーザー数:9,賭け金額:230263,配当金額:130374,GGR:99889}}},
  '2025年7月':{サマリー:{'GGR(WIN/LOSE)':5743545,'T/O':84146078,'アクティブユーザー数':120,'プロバイダーフィー':574354,'出金金額':5200000,'勝利金':78402533,'回収率(全体)':0.75,'回収金額':18000000,'総登録数':120},リスト種別:{'B':18,'E':15,'T':12,'S':10,'その他':65},プロバイダー:{'KAGaming':{ユーザー数:6,賭け金額:33625,配当金額:6826,GGR:26799},'Evolution':{ユーザー数:86,賭け金額:63520408,配当金額:60030624,GGR:3489784},'PlayNGo Direct':{ユーザー数:40,賭け金額:4286512,配当金額:4342845,GGR:-56333},'Gekipachi':{ユーザー数:29,賭け金額:1811878,配当金額:1624348,GGR:187530},'Nolimit City':{ユーザー数:10,賭け金額:2550120,配当金額:2503696,GGR:46424},'Relax Gaming':{ユーザー数:8,賭け金額:1378140,配当金額:1440598,GGR:-62458},'AvatarUX':{ユーザー数:4,賭け金額:380050,配当金額:263438,GGR:116612},'QuickSpin':{ユーザー数:6,賭け金額:138260,配当金額:113920,GGR:24340},'Red Tiger':{ユーザー数:5,賭け金額:24810,配当金額:23590,GGR:1220},'CQ9':{ユーザー数:1,賭け金額:300,配当金額:50,GGR:250},'Pragmatic Play':{ユーザー数:54,賭け金額:10015118,配当金額:8050264,GGR:1964854},'JILI':{ユーザー数:2,賭け金額:1028,配当金額:170,GGR:858},'Pocket Games Soft':{ユーザー数:3,賭け金額:5829,配当金額:2164,GGR:3665}}},
  '着金統計':{"EC":{"2025年7月":{"人数":1,"回数":1,"金額合計":30000,"中央値":30000},"2025年8月":{"人数":6,"回数":7,"金額合計":431000,"中央値":50000},"2025年9月":{"人数":133,"回数":254,"金額合計":20170200,"中央値":50000},"2025年10月":{"人数":139,"回数":355,"金額合計":28146900,"中央値":50000},"2025年11月":{"人数":88,"回数":276,"金額合計":26142982,"中央値":50000},"2025年12月":{"人数":78,"回数":249,"金額合計":27867000,"中央値":100000},"2026年1月":{"人数":77,"回数":204,"金額合計":19709000,"中央値":50000}},"Paypay":{"2025年7月":{"人数":1,"回数":1,"金額合計":29872,"中央値":29872},"2025年8月":{"人数":1,"回数":1,"金額合計":29801,"中央値":29801},"2025年9月":{"人数":47,"回数":63,"金額合計":3458733,"中央値":30171},"2025年10月":{"人数":98,"回数":189,"金額合計":8555466,"中央値":29985},"2025年11月":{"人数":83,"回数":183,"金額合計":8931061,"中央値":29985},"2025年12月":{"人数":105,"回数":267,"金額合計":13784511,"中央値":30000},"2026年1月":{"人数":87,"回数":226,"金額合計":9391545,"中央値":29966}},"仮想通貨":{"USDT":{"2025年9月":{"人数":4,"回数":12,"金額合計":936854,"中央値":74988},"2025年10月":{"人数":8,"回数":10,"金額合計":854458,"中央値":49992},"2025年11月":{"人数":11,"回数":27,"金額合計":1612855,"中央値":29991},"2025年12月":{"人数":11,"回数":19,"金額合計":2785838,"中央値":99236},"2026年1月":{"人数":6,"回数":10,"金額合計":405212,"中央値":34724}},"BTC":{"2025年9月":{"人数":2,"回数":3,"金額合計":1029971,"中央値":499981},"2025年10月":{"人数":1,"回数":2,"金額合計":79679,"中央値":39840},"2025年11月":{"人数":1,"回数":2,"金額合計":229771,"中央値":114886},"2025年12月":{"人数":2,"回数":2,"金額合計":550166,"中央値":275083},"2026年1月":{"人数":1,"回数":5,"金額合計":2005409,"中央値":258666}},"XRP":{"2025年9月":{"人数":6,"回数":11,"金額合計":1001056,"中央値":64994},"2025年10月":{"人数":9,"回数":18,"金額合計":842822,"中央値":31395},"2025年11月":{"人数":4,"回数":11,"金額合計":1708510,"中央値":149994},"2025年12月":{"人数":5,"回数":11,"金額合計":363730,"中央値":20000},"2026年1月":{"人数":5,"回数":8,"金額合計":302001,"中央値":24638}},"TRX":{"2025年9月":{"人数":2,"回数":4,"金額合計":139996,"中央値":40000},"2025年10月":{"人数":2,"回数":6,"金額合計":209863,"中央値":30000},"2025年11月":{"人数":2,"回数":4,"金額合計":79993,"中央値":19904},"2025年12月":{"人数":5,"回数":10,"金額合計":578624,"中央値":27470},"2026年1月":{"人数":1,"回数":1,"金額合計":1500,"中央値":1500}},"ETH":{"2025年9月":{"人数":1,"回数":1,"金額合計":199942,"中央値":199942},"2025年12月":{"人数":1,"回数":2,"金額合計":249830,"中央値":124915}}},"個人":{"2025年9月":{"人数":34,"回数":82,"金額合計":23797896,"中央値":277989},"2025年10月":{"人数":51,"回数":135,"金額合計":28170437,"中央値":170000},"2025年11月":{"人数":60,"回数":161,"金額合計":33118051,"中央値":149867},"2025年12月":{"人数":59,"回数":161,"金額合計":26687728,"中央値":70930},"2026年1月":{"人数":44,"回数":118,"金額合計":22076222,"中央値":100000}}}
};
const SLOTEN_DATA = {
  '2026年1月':{
    サマリー:{'登録人数':3381,'ログインユーザー数':3459,'FTDのみ入金者数':181,'FTDのみ率':0.0535,'2nd入金者数':245,'2nd率':0.0725,'3rd入金者数':189,'3rd率':0.0559,'Active入金者数':387,'Active率':0.1145,'今月登録のFTD以降ユーザー数':339,'今月登録FTD以降ユーザー割合':0.1003,'アクティブプレイ人数（ユニーク）':993,'入金者数(デイリーユニーク)':632,'総入金額':70601802,'総出金額':54836317,'T/O(リアルのみ)':1040015674,'勝利金(リアルのみ)':1009478892,'RTP':0.9706,'GGR':30536782.75,'入出金差分':15765485,'GGRLTV':30752.05,'前月登録ユーザー数':2552,'前々月登録ユーザー数':300,'3か月以上前登録ユーザー数':150,'前月継続率':0.312,'前々月継続率':0.28,'3か月以上前継続率':0.22},
    入金方法:{'TOTAL':70601802,'銀行（自動）':16021000,'仮想通貨':6063158,'銀行（手動）':7798951,'EC(コンビニ)':1472000,'PayPay':39246693},
    出金方法:{'TOTAL':54836317,'銀行（自動）':16360710,'仮想通貨':17794551,'銀行（手動）':19212554,'PayPay':1468502},
    ゲーム別:{パチンコ:{ユーザー数:1066,TO:25539221,GGR:3124886},パチスロ:{ユーザー数:1090,TO:120877774,GGR:1119651},スロット:{ユーザー数:4792,TO:388796058,GGR:10550937},ライブ:{ユーザー数:2213,TO:407528253,GGR:15111844}},
    仮想通貨:{BTC:{件数:45,金額:1250000},ETH:{件数:62,金額:2100000},USDT:{件数:38,金額:1500000},XRP:{件数:28,金額:713158},TRX:{件数:15,金額:500000}},
    プロバイダー:{'Pragmatic Play':{ユーザー数:1850,賭け金額:180000000,配当金額:172800000,GGR:7200000},'Evolution':{ユーザー数:1420,賭け金額:250000000,配当金額:242500000,GGR:7500000},'NetEnt':{ユーザー数:980,賭け金額:95000000,配当金額:91200000,GGR:3800000},'Play n GO':{ユーザー数:750,賭け金額:72000000,配当金額:69120000,GGR:2880000},'Red Tiger':{ユーザー数:620,賭け金額:58000000,配当金額:55680000,GGR:2320000},'その他':{ユーザー数:2100,賭け金額:287741326,配当金額:280904434,GGR:6836892}},
    Affiliate:{'AFF数':46,'AFF経由登録者数':925,'AFF経由FTD数':126,'AFF経由FTD率':0.1362,'AFF経由入金額':8022259,'AFF経由出金額':5490590,'AFF経由GGR':2531669}
  },
  '2025年12月':{
    サマリー:{'登録人数':2552,'ログインユーザー数':2399,'FTDのみ入金者数':231,'FTDのみ率':0.0905,'2nd入金者数':198,'2nd率':0.0776,'3rd入金者数':156,'3rd率':0.0611,'Active入金者数':324,'Active率':0.1269,'今月登録のFTD以降ユーザー数':713,'今月登録FTD以降ユーザー割合':0.1653,'アクティブプレイ人数（ユニーク）':798,'総入金額':66633871,'総出金額':48341793,'T/O(リアルのみ)':1120432234,'勝利金(リアルのみ)':1084887870,'RTP':0.9683,'GGR':35543975.96,'入出金差分':18292078,'GGRLTV':44541.32,'前月登録ユーザー数':300,'前々月登録ユーザー数':0,'3か月以上前登録ユーザー数':0,'前月継続率':0.28,'前々月継続率':0,'3か月以上前継続率':0},
    入金方法:{'TOTAL':66633871,'銀行（自動）':11122808,'仮想通貨':10897654,'銀行（手動）':18865520,'EC(コンビニ)':1121000,'PayPay':24627889},
    出金方法:{'TOTAL':48341793,'銀行（自動）':12500000,'仮想通貨':15841793,'銀行（手動）':18000000,'PayPay':2000000},
    ゲーム別:{パチンコ:{ユーザー数:892,TO:21500000,GGR:2580000},パチスロ:{ユーザー数:945,TO:105000000,GGR:1260000},スロット:{ユーザー数:4120,TO:420000000,GGR:12600000},ライブ:{ユーザー数:1980,TO:380000000,GGR:19103976}},
    仮想通貨:{BTC:{件数:78,金額:2800000},ETH:{件数:95,金額:3500000},USDT:{件数:65,金額:2800000},XRP:{件数:42,金額:1297654},TRX:{件数:20,金額:500000}},
    プロバイダー:{'Pragmatic Play':{ユーザー数:1650,賭け金額:195000000,配当金額:187200000,GGR:7800000},'Evolution':{ユーザー数:1580,賭け金額:285000000,配当金額:276450000,GGR:8550000},'NetEnt':{ユーザー数:880,賭け金額:88000000,配当金額:84480000,GGR:3520000},'Play n GO':{ユーザー数:690,賭け金額:66000000,配当金額:63360000,GGR:2640000},'Red Tiger':{ユーザー数:550,賭け金額:52000000,配当金額:49920000,GGR:2080000},'Hacksaw':{ユーザー数:420,賭け金額:48000000,配当金額:46080000,GGR:1920000},'その他':{ユーザー数:1950,賭け金額:192432234,配当金額:183397858,GGR:9034376}},
    Affiliate:{'AFF数':34,'AFF経由登録者数':1457,'AFF経由FTD数':543,'AFF経由FTD率':0.3727,'AFF経由入金額':55061952,'AFF経由出金額':36735633,'AFF経由GGR':10366161}
  },
  '2025年11月':{
    サマリー:{'登録人数':300,'ログインユーザー数':193,'FTDのみ入金者数':8,'FTDのみ率':0.0267,'2nd入金者数':12,'2nd率':0.04,'3rd入金者数':8,'3rd率':0.0267,'Active入金者数':22,'Active率':0.0733,'今月登録のFTD以降ユーザー数':42,'今月登録FTD以降ユーザー割合':0.5661,'アクティブプレイ人数':84,'総入金額':586146,'総出金額':528463,'T/O(リアルのみ)':5043994.2,'勝利金(リアルのみ)':4980421.4,'RTP':0.9874,'GGR':63572.8,'入出金差分':57683,'前月登録ユーザー数':0,'前々月登録ユーザー数':0,'3か月以上前登録ユーザー数':0,'前月継続率':0,'前々月継続率':0,'3か月以上前継続率':0},
    入金方法:{'TOTAL':586146,'銀行（自動）':0,'仮想通貨':8000,'銀行（手動）':100000,'EC(コンビニ)':10000,'PayPay':468146},
    出金方法:{'TOTAL':528463,'銀行（自動）':0,'仮想通貨':50000,'銀行（手動）':200000,'PayPay':278463},
    ゲーム別:{パチンコ:{ユーザー数:25,TO:320000,GGR:38400},パチスロ:{ユーザー数:28,TO:580000,GGR:6960},スロット:{ユーザー数:52,TO:2100000,GGR:63000},ライブ:{ユーザー数:18,TO:2043994,GGR:-44787}},
    仮想通貨:{BTC:{件数:2,金額:3000},ETH:{件数:1,金額:2500},USDT:{件数:1,金額:1500},XRP:{件数:1,金額:1000}},
    プロバイダー:{'Pragmatic Play':{ユーザー数:35,賭け金額:1800000,配当金額:1728000,GGR:72000},'Evolution':{ユーザー数:18,賭け金額:2043994,配当金額:2088781,GGR:-44787},'NetEnt':{ユーザー数:22,賭け金額:650000,配当金額:624000,GGR:26000},'その他':{ユーザー数:25,賭け金額:550000,配当金額:539640,GGR:10360}},
    Affiliate:{'AFF数':8,'AFF経由登録者数':302,'AFF経由FTD数':34,'AFF経由FTD率':0.4797}
  }
};

// Konibet KPIデータ（2020年12月）
const KONIBET_DATA = {
  '2025年1月':{サマリー:{"登録人数": 2068, "ログインユーザー数": 79257, "FTD数": 307, "初回入金額": 116697.0, "入金者数": 26918, "総入金額": 19060622.0, "出金者数": 11836, "総出金額": 17331724.0, "入出金差分": 1728898.0, "アクティブプレイ人数（ユニーク）": 55809, "T/O(リアルのみ)": 413498860.0, "勝利金(リアルのみ)": 407380512.0, "RTP": 0.9852, "GGR": 6118348.0, "ボーナス": 4547050.0, "ゲームフィー": 607361.0, "PSP手数料": 1086785.0, "AFF報酬": 536273.0, "NGR": -659145.0}},
  '2025年2月':{サマリー:{"登録人数": 1529, "ログインユーザー数": 67156, "FTD数": 238, "初回入金額": 155340.0, "入金者数": 21578, "総入金額": 15793571.0, "出金者数": 9593, "総出金額": 13842606.0, "入出金差分": 1950965.0, "アクティブプレイ人数（ユニーク）": 46099, "T/O(リアルのみ)": 277486134.0, "勝利金(リアルのみ)": 271410905.0, "RTP": 0.9781, "GGR": 6075229.0, "ボーナス": 3504510.0, "ゲームフィー": 539246.0, "PSP手数料": 910368.0, "AFF報酬": 535045.0, "NGR": 586012.0}},
  '2025年3月':{サマリー:{"登録人数": 1594, "ログインユーザー数": 65840, "FTD数": 161, "初回入金額": 91847.0, "入金者数": 21507, "総入金額": 17384974.0, "出金者数": 9970, "総出金額": 15612689.0, "入出金差分": 1772285.0, "アクティブプレイ人数（ユニーク）": 44819, "T/O(リアルのみ)": 327910533.0, "勝利金(リアルのみ)": 322182603.0, "RTP": 0.9825, "GGR": 5727930.0, "ボーナス": 4171048.0, "ゲームフィー": 506085.0, "PSP手数料": 1128490.0, "AFF報酬": 312591.0, "NGR": -390471.0}},
  '2025年4月':{サマリー:{"登録人数": 1785, "ログインユーザー数": 59623, "FTD数": 218, "初回入金額": 96045.0, "入金者数": 19184, "総入金額": 14462610.0, "出金者数": 8164, "総出金額": 12582622.0, "入出金差分": 1879988.0, "アクティブプレイ人数（ユニーク）": 40647, "T/O(リアルのみ)": 267815492.0, "勝利金(リアルのみ)": 262235795.0, "RTP": 0.9792, "GGR": 5579697.0, "ボーナス": 3146699.0, "ゲームフィー": 503805.0, "PSP手数料": 952208.0, "AFF報酬": 454574.0, "NGR": 522368.0}},
  '2025年5月':{サマリー:{"登録人数": 1533, "ログインユーザー数": 55482, "FTD数": 158, "初回入金額": 73258.0, "入金者数": 15340, "総入金額": 11068921.0, "出金者数": 5936, "総出金額": 9398640.0, "入出金差分": 1670281.0, "アクティブプレイ人数（ユニーク）": 35308, "T/O(リアルのみ)": 208501259.0, "勝利金(リアルのみ)": 204558901.0, "RTP": 0.9811, "GGR": 3942358.0, "ボーナス": 2707565.0, "ゲームフィー": 361748.0, "PSP手数料": 719637.0, "AFF報酬": 227689.0, "NGR": -74287.0}},
  '2025年6月':{サマリー:{"登録人数": 1350, "ログインユーザー数": 46360, "FTD数": 207, "初回入金額": 103613.0, "入金者数": 14483, "総入金額": 11117430.0, "出金者数": 6036, "総出金額": 10559939.0, "入出金差分": 557491.0, "アクティブプレイ人数（ユニーク）": 31309, "T/O(リアルのみ)": 212251372.0, "勝利金(リアルのみ)": 208213446.0, "RTP": 0.981, "GGR": 4037925.0, "ボーナス": 2810010.0, "ゲームフィー": 361766.0, "PSP手数料": 665861.0, "AFF報酬": 200862.0, "NGR": -580.0}},
  '2025年7月':{サマリー:{"登録人数": 1654, "ログインユーザー数": 45873, "FTD数": 188, "初回入金額": 88244.0, "入金者数": 15401, "総入金額": 11572076.0, "出金者数": 6415, "総出金額": 9505049.0, "入出金差分": 2067027.0, "アクティブプレイ人数（ユニーク）": 32320, "T/O(リアルのみ)": 167995711.0, "勝利金(リアルのみ)": 162634753.0, "RTP": 0.9681, "GGR": 5360958.0, "ボーナス": 2262239.0, "ゲームフィー": 498430.0, "PSP手数料": 593621.0, "AFF報酬": 401855.0, "NGR": 1604802.0}},
  '2025年8月':{サマリー:{"登録人数": 1268, "ログインユーザー数": 45895, "FTD数": 133, "初回入金額": 60545.0, "入金者数": 14347, "総入金額": 10515016.0, "出金者数": 5719, "総出金額": 8767737.0, "入出金差分": 1747279.0, "アクティブプレイ人数（ユニーク）": 32246, "T/O(リアルのみ)": 176823116.0, "勝利金(リアルのみ)": 172744344.0, "RTP": 0.9769, "GGR": 4078771.0, "ボーナス": 2302052.0, "ゲームフィー": 353700.0, "PSP手数料": 509201.0, "AFF報酬": 127090.0, "NGR": 786704.0}},
  '2025年9月':{サマリー:{"登録人数": 1258, "ログインユーザー数": 42936, "FTD数": 118, "初回入金額": 65403.0, "入金者数": 12827, "総入金額": 8471253.0, "出金者数": 5449, "総出金額": 7393651.0, "入出金差分": 1077602.0, "アクティブプレイ人数（ユニーク）": 29412, "T/O(リアルのみ)": 197230412.0, "勝利金(リアルのみ)": 193243565.0, "RTP": 0.9798, "GGR": 3986847.0, "ボーナス": 2460900.0, "ゲームフィー": 338531.0, "PSP手数料": 424800.0, "AFF報酬": 148871.0, "NGR": 613696.0}},
  '2025年10月':{サマリー:{"登録人数": 1279, "ログインユーザー数": 40932, "FTD数": 91, "初回入金額": 60562.0, "入金者数": 13003, "総入金額": 9827728.0, "出金者数": 5355, "総出金額": 8160329.0, "入出金差分": 1667399.0, "アクティブプレイ人数（ユニーク）": 29087, "T/O(リアルのみ)": 214770218.0, "勝利金(リアルのみ)": 210894799.0, "RTP": 0.982, "GGR": 3875419.0, "ボーナス": 2510155.0, "ゲームフィー": 343796.0, "PSP手数料": 476441.0, "AFF報酬": 64254.0, "NGR": 480679.0}},
  '2025年11月':{サマリー:{"登録人数": 1190, "ログインユーザー数": 39483, "FTD数": 94, "初回入金額": 67610.0, "入金者数": 12545, "総入金額": 9291211.0, "出金者数": 5147, "総出金額": 7798974.0, "入出金差分": 1492237.0, "アクティブプレイ人数（ユニーク）": 28179, "T/O(リアルのみ)": 163853488.0, "勝利金(リアルのみ)": 160528312.0, "RTP": 0.9797, "GGR": 3325176.0, "ボーナス": 2118083.0, "ゲームフィー": 306136.0, "PSP手数料": 448984.0, "AFF報酬": 51670.0, "NGR": 400246.0}},
  '2025年12月':{サマリー:{"登録人数": 1100, "ログインユーザー数": 41953, "FTD数": 74, "初回入金額": 40505.0, "入金者数": 12842, "総入金額": 10349636.0, "出金者数": 5402, "総出金額": 9035880.0, "入出金差分": 1313756.0, "アクティブプレイ人数（ユニーク）": 28209, "T/O(リアルのみ)": 172671385.0, "勝利金(リアルのみ)": 168885021.0, "RTP": 0.9781, "GGR": 3786364.0, "ボーナス": 2066950.0, "ゲームフィー": 370691.0, "PSP手数料": 488598.0, "AFF報酬": 201924.0, "NGR": 658183.0}},
  '2026年1月':{サマリー:{"登録人数": 1062, "ログインユーザー数": 33419, "FTD数": 102, "初回入金額": 74286.0, "入金者数": 10135, "総入金額": 8224097.0, "出金者数": 4279, "総出金額": 6332125.0, "入出金差分": 1891972.0, "アクティブプレイ人数（ユニーク）": 22151, "T/O(リアルのみ)": 138800282.0, "勝利金(リアルのみ)": 135101395.0, "RTP": 0.9734, "GGR": 3698887.0, "ボーナス": 1686871.0, "ゲームフィー": 305331.0, "PSP手数料": 382470.0, "AFF報酬": 77928.0, "NGR": 1246243.0}},
};

const DEFAULT_BUSINESSES = {
  '元amuse': { data: MOTO_AMUSE_DATA, type: 'samExcel' },
  'DSC': { data: DSC_DATA, type: 'samExcel' },
  'スロ天': { data: SLOTEN_DATA, type: 'sloten' },
  '広告': { data: {}, type: 'ads' },
  'バカラツール': { data: {}, type: 'baccara' },
  'AMUSEVIP': { data: {}, type: 'agent' },
  'Konibet': { data: KONIBET_DATA, type: 'konibet' }
};

// LZ圧縮ライブラリ（軽量版）
const LZString={compressToEncodedURIComponent:function(a){if(null==a)return"";return LZString._compress(a,6,function(b){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$".charAt(b)})},decompressFromEncodedURIComponent:function(a){if(null==a)return"";if(""==a)return null;a=a.replace(/ /g,"+");return LZString._decompress(a.length,32,function(b){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$".indexOf(a.charAt(b))})},_compress:function(a,b,c){if(null==a)return"";var d,e,f,g={},h={},k="",l="",m="",n=2,o=3,p=2,q=[],r=0,s=0;for(f=0;f<a.length;f+=1)if(k=a.charAt(f),Object.prototype.hasOwnProperty.call(g,k)||(g[k]=o++,h[k]=!0),l=m+k,Object.prototype.hasOwnProperty.call(g,l))m=l;else{if(Object.prototype.hasOwnProperty.call(h,m)){if(256>m.charCodeAt(0)){for(d=0;d<p;d++)r<<=1,15==s?(s=0,q.push(c(r)),r=0):s++;for(e=m.charCodeAt(0),d=0;8>d;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1}else{for(e=1,d=0;d<p;d++)r=r<<1|e,15==s?(s=0,q.push(c(r)),r=0):s++,e=0;for(e=m.charCodeAt(0),d=0;16>d;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1}0==--n&&(n=Math.pow(2,p),p++);delete h[m]}else for(e=g[m],d=0;d<p;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1;0==--n&&(n=Math.pow(2,p),p++);g[l]=o++;m=k}if(""!==m){if(Object.prototype.hasOwnProperty.call(h,m)){if(256>m.charCodeAt(0)){for(d=0;d<p;d++)r<<=1,15==s?(s=0,q.push(c(r)),r=0):s++;for(e=m.charCodeAt(0),d=0;8>d;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1}else{for(e=1,d=0;d<p;d++)r=r<<1|e,15==s?(s=0,q.push(c(r)),r=0):s++,e=0;for(e=m.charCodeAt(0),d=0;16>d;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1}0==--n&&(n=Math.pow(2,p),p++);delete h[m]}else for(e=g[m],d=0;d<p;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1;0==--n&&(n=Math.pow(2,p),p++)}for(e=2,d=0;d<p;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1;for(;;)if(r<<=1,15==s){q.push(c(r));break}else s++;return q.join("")},_decompress:function(a,b,c){var d,e,f,g,h,k,l,m=[],n=4,o=4,p=3,q="",r=[],s={val:c(0),position:b,index:1};for(d=0;3>d;d+=1)m[d]=d;for(f=0,h=Math.pow(2,2),k=1;k!=h;)g=s.val&s.position,s.position>>=1,0==s.position&&(s.position=b,s.val=c(s.index++)),f|=(0<g?1:0)*k,k<<=1;switch(f){case 0:for(f=0,h=Math.pow(2,8),k=1;k!=h;)g=s.val&s.position,s.position>>=1,0==s.position&&(s.position=b,s.val=c(s.index++)),f|=(0<g?1:0)*k,k<<=1;l=String.fromCharCode(f);break;case 1:for(f=0,h=Math.pow(2,16),k=1;k!=h;)g=s.val&s.position,s.position>>=1,0==s.position&&(s.position=b,s.val=c(s.index++)),f|=(0<g?1:0)*k,k<<=1;l=String.fromCharCode(f);break;case 2:return""}for(m[3]=l,e=l,r.push(l);;){if(s.index>a)return"";for(f=0,h=Math.pow(2,p),k=1;k!=h;)g=s.val&s.position,s.position>>=1,0==s.position&&(s.position=b,s.val=c(s.index++)),f|=(0<g?1:0)*k,k<<=1;switch(l=f){case 0:for(f=0,h=Math.pow(2,8),k=1;k!=h;)g=s.val&s.position,s.position>>=1,0==s.position&&(s.position=b,s.val=c(s.index++)),f|=(0<g?1:0)*k,k<<=1;m[o++]=String.fromCharCode(f);l=o-1;n--;break;case 1:for(f=0,h=Math.pow(2,16),k=1;k!=h;)g=s.val&s.position,s.position>>=1,0==s.position&&(s.position=b,s.val=c(s.index++)),f|=(0<g?1:0)*k,k<<=1;m[o++]=String.fromCharCode(f);l=o-1;n--;break;case 2:return r.join("")}if(0==n&&(n=Math.pow(2,p),p++),m[l])q=m[l];else if(l===o)q=e+e.charAt(0);else return null;r.push(q);m[o++]=e+q.charAt(0);n--;e=q;0==n&&(n=Math.pow(2,p),p++)}}};

let cloudEnabled = false;

let BUSINESSES = JSON.parse(JSON.stringify(DEFAULT_BUSINESSES));
let currentBusiness = '元amuse';
let currentPeriod = null;
let chartInstance = null;
let cryptoPieChart = null;
let gamePieChart = null;
let providerPieChart = null;
let retentionChart = null;
let viewMode = 'period';

// ========== ユーティリティ ==========
function parseNumber(val) {
  if (val === undefined || val === null || val === '' || val === '-' || String(val).startsWith('#')) return null;
  if (typeof val === 'number') return val;
  let cleaned = String(val).replace(/[¥￥$,、"\s]/g, '').trim();
  if (cleaned.endsWith('%')) cleaned = cleaned.replace(/%$/, '');
  const num = parseFloat(cleaned);
  return isNaN(num) ? null : num;
}
function formatCurrency(val) {
  if (val == null || isNaN(val)) return '-';
  const abs = Math.abs(val); const sign = val < 0 ? '-' : '';
  if (abs >= 100000000) return sign + '¥' + (abs / 100000000).toFixed(2) + '億';
  if (abs >= 10000) return sign + '¥' + Math.round(abs / 10000).toLocaleString() + '万';
  return sign + '¥' + Math.round(abs).toLocaleString();
}
function formatPercent(val) { 
  if (val == null || isNaN(val)) return '-'; 
  let v = Math.abs(val) <= 1 ? val * 100 : val; 
  return v.toFixed(2) + '%'; 
}
function formatRTP(val) {
  if (val == null || isNaN(val)) return '-';
  // 控除率（0.02など小さい値）の場合はRTPに変換
  let v = val;
  if (v <= 0.1) v = 1 - v; // 控除率をRTPに変換
  // 小数表示（2未満）の場合は100倍、既に%表示（2以上）の場合はそのまま
  v = v < 2 ? v * 100 : v;
  return v.toFixed(2) + '%';
}
function formatNumber(val) { if (val == null || isNaN(val)) return '-'; return Math.round(val).toLocaleString(); }
function sortPeriods(periods) {
  return [...periods].sort((a, b) => {
    const mA = a.match(/(\d{4})年(\d{1,2})月/), mB = b.match(/(\d{4})年(\d{1,2})月/);
    if (mA && mB) { const yA = parseInt(mA[1]), monA = parseInt(mA[2]), yB = parseInt(mB[1]), monB = parseInt(mB[2]); return (yB * 12 + monB) - (yA * 12 + monA); }
    return b.localeCompare(a);
  });
}

// ========== クラウド同期 ==========
function getBinIdFromURL() { return ''; }
function setBinIdToURL(binId) { }
function updateSyncStatus(msg, isError = false) { const el = document.getElementById('sync-status'); el.textContent = isError ? '⚠️ ' + msg : '💾 ' + msg; el.style.color = isError ? '#ef4444' : '#10b981'; }

function getShareDataFromURL() {
  const hash = window.location.hash;
  if (hash && hash.startsWith('#data=')) {
    try {
      const compressed = hash.substring(6);
      const json = LZString.decompressFromEncodedURIComponent(compressed);
      return json ? JSON.parse(json) : null;
    } catch (e) { console.error('URL data parse error:', e); }
  }
  return null;
}

function createShareLink() {
  try {
    updateSyncStatus('リンク作成中...');
    // 全データを共有（DEFAULT含む）
    const toShare = {};
    Object.keys(BUSINESSES).forEach(key => {
      toShare[key] = BUSINESSES[key];
    });
    
    const json = JSON.stringify(toShare);
    const compressed = LZString.compressToEncodedURIComponent(json);
    const baseUrl = window.location.href.split('#')[0].split('?')[0];
    const shareUrl = baseUrl + '#data=' + compressed;
    
    if (shareUrl.length > 100000) {
      alert('データが大きすぎます。\n一部の期間を削除してから共有してください。');
      updateSyncStatus('データ過大', true);
      return;
    }
    
    window.history.replaceState({}, '', shareUrl);
    updateSyncStatus('共有リンク作成済');
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(shareUrl).then(() => {
        alert('✅ 共有リンクをコピーしました！\n\nURL長: ' + shareUrl.length + '文字');
      }).catch(() => {
        prompt('共有リンク（コピーしてください）:', shareUrl);
      });
    } else {
      prompt('共有リンク（コピーしてください）:', shareUrl);
    }
  } catch (e) {
    console.error('createShareLink error:', e);
    updateSyncStatus('エラー', true);
    alert('共有リンクの作成に失敗しました。\nエラー: ' + e.message);
  }
}

function showShareURL() { createShareLink(); }
function saveToCloud() { }
function loadCloudData() { return {}; }
function clearCloudData() { }
function mergeWithDefault(sharedData) { const merged = JSON.parse(JSON.stringify(DEFAULT_BUSINESSES)); Object.keys(sharedData).forEach(key => { if (merged[key]) { merged[key].data = { ...merged[key].data, ...(sharedData[key].data || {}) }; merged[key].type = sharedData[key].type || merged[key].type; } else merged[key] = sharedData[key]; }); return merged; }
function saveBusinessData() { 
  try { 
    const backup = {}; 
    Object.keys(BUSINESSES).forEach(k => { 
      const def = DEFAULT_BUSINESSES[k]; 
      if (!def) backup[k] = BUSINESSES[k]; 
      else { 
        const newPeriods = {}; 
        Object.keys(BUSINESSES[k].data).forEach(p => { 
          if (!def.data[p]) newPeriods[p] = BUSINESSES[k].data[p]; 
        }); 
        if (Object.keys(newPeriods).length > 0) backup[k] = { data: newPeriods, type: BUSINESSES[k].type }; 
      } 
    }); 
    localStorage.setItem('dashboard_backup', JSON.stringify(backup)); 
    updateSyncStatus('保存完了');
  } catch (e) { console.error('saveBusinessData error:', e); } 
}
async function clearAllData() { if (confirm('全データを削除しますか？')) { localStorage.removeItem('dashboard_backup'); window.location.href = window.location.pathname; } }
function initializeData() { 
  // 1. URLからデータを読み込む
  const urlData = getShareDataFromURL();
  if (urlData && Object.keys(urlData).length > 0) {
    BUSINESSES = urlData;
    updateSyncStatus('共有データ読込済');
    selectBusiness(currentBusiness);
    return;
  }
  
  // 2. ローカルバックアップから読み込む
  try { 
    const backup = localStorage.getItem('dashboard_backup'); 
    if (backup) { 
      const parsed = JSON.parse(backup); 
      Object.keys(parsed).forEach(key => { 
        if (BUSINESSES[key]) BUSINESSES[key].data = { ...BUSINESSES[key].data, ...parsed[key].data }; 
        else BUSINESSES[key] = parsed[key]; 
      }); 
      updateSyncStatus('ローカル');
    } else {
      updateSyncStatus('ローカル');
    }
  } catch (e) { 
    updateSyncStatus('ローカル'); 
  } 
  selectBusiness(currentBusiness); 
}
document.addEventListener('DOMContentLoaded', () => { initializeData(); renderTabs(); setupDragDrop(); });

// ========== 表示モード ==========
function setViewMode(mode) {
  viewMode = mode;
  document.getElementById('view-period').classList.toggle('active', mode === 'period');
  document.getElementById('view-total').classList.toggle('active', mode === 'total');
  document.getElementById('period-selector').classList.toggle('hidden', mode === 'total');
  document.getElementById('totals-section').classList.toggle('hidden', mode !== 'total');
  if (mode === 'total') renderTotalsSection();
  renderSummary(); renderCryptoSection(); renderGameSection(); renderProviderSection(); renderDailyStatsSection(); renderPaymentStatsSection();
}

// ========== トータル・平均計算 ==========
function calculateTotalsAndAverages(businessName) {
  const business = BUSINESSES[businessName]; if (!business || !business.data) return null;
  const periods = Object.keys(business.data); if (periods.length === 0) return null;
  const totals = {}, counts = {};
  periods.forEach(period => {
    const periodData = business.data[period], summary = periodData?.サマリー || periodData || {};
    Object.entries(summary).forEach(([key, val]) => { if (typeof val === 'number' && !isNaN(val)) { if (!totals[key]) { totals[key] = 0; counts[key] = 0; } totals[key] += val; counts[key]++; } });
  });
  const result = { totals: {}, averages: {}, periodCount: periods.length };
  Object.keys(totals).forEach(key => { result.totals[key] = totals[key]; result.averages[key] = totals[key] / counts[key]; });
  return result;
}

function renderTotalsSection() {
  const container = document.getElementById('totals-grid');
  const result = calculateTotalsAndAverages(currentBusiness);
  if (!result) { container.innerHTML = '<p style="opacity:0.7">データがありません</p>'; return; }
  const business = BUSINESSES[currentBusiness], type = business?.type || 'samExcel';
  let metrics = type === 'samExcel' ? [
    { key: 'T/O', alt: ['総TO'], label: 'T/O', type: 'total' },
    { key: 'GGR(WIN/LOSE)', alt: ['GGR','WIN/LOSE'], label: 'GGR', type: 'total' },
    { key: 'NGR', alt: ['総NGR'], label: 'NGR', type: 'total' },
    { key: '回収金額', alt: ['総回収額'], label: '回収金額', type: 'total' },
    { key: '出金金額', alt: ['総出金額'], label: '出金金額', type: 'total' },
    { key: 'RTP', label: 'RTP', type: 'avg', format: 'rtp' },
    { key: '回収率(全体)', label: '回収率', type: 'avg', format: 'percent' },
    { key: 'FTD数', label: 'FTD数', type: 'total', format: 'number' },
    { key: '残未回収金額', label: '未回収金額', type: 'total' },
    { key: '遅れ回収金額', label: '遅れ回収', type: 'total' }
  ] : type === 'sloten' ? [
    { key: 'GGR', label: 'GGR', type: 'total' },
    { key: '総入金額', label: '総入金額', type: 'total' },
    { key: '総出金額', label: '総出金額', type: 'total' },
    { key: '入出金差分', label: '入出金差分', type: 'total' },
    { key: '登録人数', label: '登録人数', type: 'total', format: 'number' },
    { key: 'RTP', label: 'RTP', type: 'avg', format: 'rtp' }
  ] : type === 'agent' ? [
    { key: '入金合計', label: '入金合計', type: 'total' },
    { key: '出金合計', label: '出金合計', type: 'total' },
    { key: '収益合計', label: '収益合計', type: 'total' },
    { key: 'NGR', label: 'NGR', type: 'total' },
    { key: 'ローリング報酬', label: 'ローリング', type: 'total' }
  ] : type === 'ads' ? [
    { key: 'コスト($)', label: 'コスト($)', type: 'total', format: 'number' },
    { key: 'インプレッション', label: 'IMP', type: 'total', format: 'number' },
    { key: 'クリック', label: 'クリック', type: 'total', format: 'number' },
    { key: '登録数', label: '登録', type: 'total', format: 'number' },
    { key: '入金数', label: '入金', type: 'total', format: 'number' }
  ] : type === 'baccara' ? [
    { key: '登録数', label: '登録数', type: 'total', format: 'number' },
    { key: '総GGR', label: 'GGR', type: 'total' },
    { key: 'コスト', label: 'コスト', type: 'total' },
    { key: 'NGR', label: 'NGR', type: 'total' }
  ] : [];
  container.innerHTML = `<div class="total-card" style="grid-column:span 2;"><h4>📅 対象期間数</h4><div class="main-val">${result.periodCount}期間</div></div>` + metrics.map(m => { 
    let totalVal = result.totals[m.key], avgVal = result.averages[m.key]; 
    if ((totalVal == null) && m.alt) { for (const k of m.alt) { if (result.totals[k] != null) { totalVal = result.totals[k]; avgVal = result.averages[k]; break; } } } 
    if (totalVal == null) return ''; 
    let fT, fA; 
    if (m.format === 'rtp') { fT = '-'; fA = formatRTP(avgVal); } 
    else if (m.format === 'percent') { fT = '-'; fA = formatPercent(avgVal); } 
    else if (m.format === 'number') { fT = formatNumber(totalVal); fA = formatNumber(avgVal); } 
    else { fT = formatCurrency(totalVal); fA = formatCurrency(avgVal); } 
    return `<div class="total-card"><h4>${m.label}</h4><div class="main-val">${m.type === 'total' ? fT : fA}</div><div class="sub-val">${m.type === 'total' ? '平均: ' + fA : ''}</div></div>`; 
  }).join('');
}

// ========== 仮想通貨セクション（円グラフ付き） ==========
function renderCryptoSection() {
  const section = document.getElementById('crypto-section');
  const container = document.getElementById('crypto-grid');
  const business = BUSINESSES[currentBusiness];
  
  let cryptoData = null;
  let depositTotal = 0;
  let withdrawTotal = 0;
  
  // 着金統計の仮想通貨データを優先的に使用
  const paymentCrypto = business?.data?.['着金統計']?.['仮想通貨'];
  
  if (paymentCrypto && Object.keys(paymentCrypto).length > 0) {
    // 着金統計から銘柄別データを集計（全月合算）
    cryptoData = {};
    Object.entries(paymentCrypto).forEach(([coin, monthlyData]) => {
      if (!cryptoData[coin]) cryptoData[coin] = { 件数: 0, 金額: 0 };
      Object.values(monthlyData).forEach(stats => {
        cryptoData[coin].件数 += stats.回数 || 0;
        cryptoData[coin].金額 += stats.金額合計 || 0;
      });
    });
  } else if (viewMode === 'total') {
    // 全期間：全ての期間の仮想通貨データを集計
    const allCrypto = {};
    const periods = Object.keys(business?.data || {});
    periods.forEach(period => {
      const periodCrypto = business.data[period]?.仮想通貨;
      if (periodCrypto) {
        Object.entries(periodCrypto).forEach(([coin, data]) => {
          if (!allCrypto[coin]) allCrypto[coin] = { 件数: 0, 金額: 0 };
          allCrypto[coin].件数 += data.件数 || 0;
          allCrypto[coin].金額 += data.金額 || 0;
        });
      }
      depositTotal += business.data[period]?.入金方法?.['仮想通貨'] || 0;
      withdrawTotal += business.data[period]?.出金方法?.['仮想通貨'] || 0;
    });
    if (Object.keys(allCrypto).length > 0) cryptoData = allCrypto;
  } else {
    const periodData = business?.data?.[currentPeriod];
    cryptoData = periodData?.仮想通貨 || null;
    depositTotal = periodData?.入金方法?.['仮想通貨'] || 0;
    withdrawTotal = periodData?.出金方法?.['仮想通貨'] || 0;
  }
  
  if (!cryptoData && depositTotal === 0 && withdrawTotal === 0) { section.classList.add('hidden'); return; }
  section.classList.remove('hidden');
  
  // 円グラフ用データ
  const labels = [], values = [], colors = ['#26a17b', '#f7931a', '#627eea', '#23292f', '#eb0029', '#8b5cf6', '#ec4899'];
  let html = '';
  
  if (cryptoData && Object.keys(cryptoData).length > 0) {
    const total = Object.values(cryptoData).reduce((sum, c) => sum + (c.金額 || 0), 0);
    Object.entries(cryptoData).forEach(([coin, data], i) => {
      const amount = data.金額 || 0;
      const pct = total > 0 ? (amount / total * 100).toFixed(1) : 0;
      labels.push(coin); values.push(amount);
      html += `<div class="crypto-card"><h5>${coin}</h5><div class="crypto-val">${formatCurrency(amount)}</div><div class="crypto-pct">${data.件数 || 0}件 (${pct}%)</div></div>`;
    });
    html = `<div class="crypto-card" style="grid-column:span 2;background:#dcfce7;"><h5>💰 仮想通貨合計</h5><div class="crypto-val">${formatCurrency(total)}</div></div>` + html;
  } else {
    if (depositTotal > 0) { labels.push('入金'); values.push(depositTotal); html += `<div class="crypto-card"><h5>入金</h5><div class="crypto-val">${formatCurrency(depositTotal)}</div></div>`; }
    if (withdrawTotal > 0) { labels.push('出金'); values.push(withdrawTotal); html += `<div class="crypto-card"><h5>出金</h5><div class="crypto-val">${formatCurrency(withdrawTotal)}</div></div>`; }
  }
  
  container.innerHTML = html;
  
  // 円グラフ描画
  if (cryptoPieChart) cryptoPieChart.destroy();
  if (values.length > 0) {
    const ctx = document.getElementById('crypto-pie-chart').getContext('2d');
    cryptoPieChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, values.length) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } } } });
  }
}

// ========== ゲーム種別セクション（円グラフ付き） ==========
function renderGameSection() {
  const section = document.getElementById('game-section');
  const container = document.getElementById('game-grid');
  const business = BUSINESSES[currentBusiness];
  
  let games = null;
  
  if (viewMode === 'total') {
    // 全期間：全ての期間のゲーム別データを集計
    const allGames = {};
    const periods = Object.keys(business?.data || {});
    periods.forEach(period => {
      const periodGames = business.data[period]?.ゲーム別;
      if (periodGames) {
        Object.entries(periodGames).forEach(([game, stats]) => {
          if (!allGames[game]) allGames[game] = { ユーザー数: 0, TO: 0, GGR: 0 };
          allGames[game].ユーザー数 += stats.ユーザー数 || 0;
          allGames[game].TO += stats.TO || 0;
          allGames[game].GGR += stats.GGR || 0;
        });
      }
    });
    if (Object.keys(allGames).length > 0) games = allGames;
  } else {
    const periodData = business?.data?.[currentPeriod];
    games = periodData?.ゲーム別;
  }
  
  if (!games || Object.keys(games).length === 0) { section.classList.add('hidden'); return; }
  section.classList.remove('hidden');
  
  const labels = [], values = [], colors = ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6'];
  let html = '';
  
  Object.entries(games).forEach(([game, stats], i) => {
    const ggr = stats.GGR || 0;
    labels.push(game); values.push(Math.max(0, ggr));
    html += `<div class="provider-card"><h5>🎰 ${game}</h5><div class="provider-stats"><div class="stat-item"><div class="stat-label">ユーザー数</div><div class="stat-val">${formatNumber(stats.ユーザー数)}</div></div><div class="stat-item"><div class="stat-label">T/O</div><div class="stat-val">${formatCurrency(stats.TO)}</div></div><div class="stat-item"><div class="stat-label">GGR</div><div class="stat-val">${formatCurrency(ggr)}</div></div><div class="stat-item"><div class="stat-label">RTP</div><div class="stat-val">${stats.TO > 0 ? formatRTP((stats.TO - ggr) / stats.TO) : '-'}</div></div></div></div>`;
  });
  
  container.innerHTML = html;
  
  if (gamePieChart) gamePieChart.destroy();
  if (values.length > 0) {
    const ctx = document.getElementById('game-pie-chart').getContext('2d');
    gamePieChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, values.length) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } } } });
  }
}

// ========== プロバイダー別セクション（円グラフ付き） ==========
function renderProviderSection() {
  const section = document.getElementById('provider-section');
  const container = document.getElementById('provider-grid');
  const business = BUSINESSES[currentBusiness];
  
  let providers = null;
  
  if (viewMode === 'total') {
    // 全期間：全ての期間のプロバイダーデータを集計
    const allProviders = {};
    const periods = Object.keys(business?.data || {});
    periods.forEach(period => {
      const periodProviders = business.data[period]?.プロバイダー;
      if (periodProviders) {
        Object.entries(periodProviders).forEach(([name, stats]) => {
          if (!allProviders[name]) allProviders[name] = { ユーザー数: 0, 賭け金額: 0, 配当金額: 0, GGR: 0 };
          allProviders[name].ユーザー数 += stats.ユーザー数 || 0;
          allProviders[name].賭け金額 += stats.賭け金額 || 0;
          allProviders[name].配当金額 += stats.配当金額 || 0;
          allProviders[name].GGR += stats.GGR || 0;
        });
      }
    });
    if (Object.keys(allProviders).length > 0) providers = allProviders;
  } else {
    const periodData = business?.data?.[currentPeriod];
    providers = periodData?.プロバイダー;
  }
  
  if (!providers || Object.keys(providers).length === 0) { section.classList.add('hidden'); return; }
  section.classList.remove('hidden');
  
  const labels = [], values = [], colors = ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#06b6d4', '#84cc16'];
  let html = '';
  
  // GGRでソート
  const sorted = Object.entries(providers).sort((a, b) => (b[1].GGR || 0) - (a[1].GGR || 0));
  sorted.forEach(([name, stats], i) => {
    const ggr = stats.GGR || 0;
    labels.push(name); values.push(Math.max(0, ggr));
    html += `<div class="provider-card"><h5>🏭 ${name}</h5><div class="provider-stats"><div class="stat-item"><div class="stat-label">ユーザー数</div><div class="stat-val">${formatNumber(stats.ユーザー数)}</div></div><div class="stat-item"><div class="stat-label">賭け金額</div><div class="stat-val">${formatCurrency(stats.賭け金額)}</div></div><div class="stat-item"><div class="stat-label">GGR</div><div class="stat-val">${formatCurrency(ggr)}</div></div><div class="stat-item"><div class="stat-label">RTP</div><div class="stat-val">${stats.賭け金額 > 0 ? formatRTP(stats.配当金額 / stats.賭け金額) : '-'}</div></div></div></div>`;
  });
  
  container.innerHTML = html;
  
  if (providerPieChart) providerPieChart.destroy();
  if (values.length > 0) {
    const ctx = document.getElementById('provider-pie-chart').getContext('2d');
    providerPieChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, values.length) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } } } });
  }
}

// ========== 日次統計セクション ==========
function renderDailyStatsSection() {
  const section = document.getElementById('daily-stats-section');
  const container = document.getElementById('daily-stats-grid');
  const business = BUSINESSES[currentBusiness];
  
  let dailyStats = null;
  
  if (viewMode === 'total') {
    // 全期間：全ての期間の日次統計を集計
    const allStats = {};
    const periods = Object.keys(business?.data || {});
    periods.forEach(period => {
      const periodStats = business.data[period]?.日次統計;
      if (periodStats) {
        Object.entries(periodStats).forEach(([date, stats]) => {
          if (!allStats[date]) allStats[date] = { 人数: 0, 信用枠合計: 0, 回収金額合計: 0, 信用枠中央値: 0, 回収金額中央値: 0 };
          allStats[date].人数 += stats.人数 || 0;
          allStats[date].信用枠合計 += stats.信用枠合計 || 0;
          allStats[date].回収金額合計 += stats.回収金額合計 || 0;
        });
      }
    });
    if (Object.keys(allStats).length > 0) dailyStats = allStats;
  } else {
    const periodData = business?.data?.[currentPeriod];
    dailyStats = periodData?.日次統計;
  }
  
  if (!dailyStats || Object.keys(dailyStats).length === 0) {
    section.classList.add('hidden');
    return;
  }
  section.classList.remove('hidden');
  
  let html = '';
  const sortedDates = Object.keys(dailyStats).sort();
  
  sortedDates.forEach(date => {
    const s = dailyStats[date];
    // 日付を見やすく変換（2025/10/02 → 10/2）
    const dateParts = date.split('/');
    const shortDate = dateParts.length === 3 ? `${parseInt(dateParts[1])}/${parseInt(dateParts[2])}` : date;
    
    html += `
      <div class="daily-stat-card">
        <div class="date">📅 ${shortDate}</div>
        <div class="stats">
          <div class="stat-item"><span class="stat-label">人数</span><span class="stat-val">${s.人数}人</span></div>
          <div class="stat-item"><span class="stat-label">信用枠計</span><span class="stat-val">¥${(s.信用枠合計/10000).toFixed(0)}万</span></div>
          <div class="stat-item"><span class="stat-label">回収金額</span><span class="stat-val">¥${(s.回収金額合計/10000).toFixed(0)}万</span></div>
          <div class="stat-item"><span class="stat-label">信用枠中央値</span><span class="stat-val">¥${((s.信用枠中央値 || 0)/10000).toFixed(0)}万</span></div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// ========== 着金統計セクション ==========
function renderPaymentStatsSection() {
  const section = document.getElementById('payment-stats-section');
  const container = document.getElementById('payment-stats-grid');
  const business = BUSINESSES[currentBusiness];
  
  const paymentStats = business?.data?.['着金統計'];
  
  if (!paymentStats || Object.keys(paymentStats).length === 0) {
    section.classList.add('hidden');
    return;
  }
  section.classList.remove('hidden');
  
  // 月別にデータを整理（仮想通貨は銘柄別に展開）
  const monthlyData = {};
  const displayTypes = []; // 表示順序を保持
  
  Object.keys(paymentStats).forEach(type => {
    const typeStats = paymentStats[type];
    
    if (type === '仮想通貨') {
      // 仮想通貨は銘柄別にネストしている
      Object.keys(typeStats).forEach(coin => {
        const coinStats = typeStats[coin];
        const displayKey = `仮想通貨-${coin}`;
        if (!displayTypes.includes(displayKey)) displayTypes.push(displayKey);
        
        Object.entries(coinStats).forEach(([month, stats]) => {
          if (!monthlyData[month]) monthlyData[month] = {};
          monthlyData[month][displayKey] = stats;
        });
      });
    } else {
      // EC, Paypay, 個人は従来通り
      if (!displayTypes.includes(type)) displayTypes.push(type);
      Object.entries(typeStats).forEach(([month, stats]) => {
        if (!monthlyData[month]) monthlyData[month] = {};
        monthlyData[month][type] = stats;
      });
    }
  });
  
  // 月をソート（新しい順）
  const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
    const parseMonth = (m) => {
      const match = m.match(/(\d{4})年(\d{1,2})月/);
      return match ? parseInt(match[1]) * 100 + parseInt(match[2]) : 0;
    };
    return parseMonth(b) - parseMonth(a);
  });
  
  let html = '';
  const typeColors = { 
    'EC': '#4fc3f7', 'Paypay': '#ff6b6b', '個人': '#6bcb77',
    '仮想通貨-USDT': '#26a17b', '仮想通貨-BTC': '#f7931a', '仮想通貨-ETH': '#627eea',
    '仮想通貨-XRP': '#23292f', '仮想通貨-TRX': '#eb0029', '仮想通貨-その他': '#888888'
  };
  
  sortedMonths.forEach(month => {
    const data = monthlyData[month];
    html += `<div class="payment-month-card">`;
    html += `<div class="payment-month-title">📆 ${month}</div>`;
    
    // 月の合計を計算
    let monthTotal = { 回数: 0, 金額: 0 };
    let cryptoTotal = { 回数: 0, 金額: 0 };
    
    // 非仮想通貨を先に表示
    ['EC', 'Paypay', '個人'].forEach(type => {
      const stats = data[type];
      if (!stats) return;
      
      const color = typeColors[type] || '#ffffff';
      html += `
        <div class="payment-type-row">
          <span class="payment-type-label" style="color:${color}">${type}</span>
          <div class="payment-type-values">
            <div class="payment-stat"><span class="payment-stat-label">人数</span> ${stats.人数}人</div>
            <div class="payment-stat"><span class="payment-stat-label">回数</span> ${stats.回数}回</div>
            <div class="payment-stat"><span class="payment-stat-label">金額</span> ¥${(stats.金額合計/10000).toFixed(1)}万</div>
            <div class="payment-stat"><span class="payment-stat-label">中央値</span> ¥${(stats.中央値/10000).toFixed(1)}万</div>
          </div>
        </div>
      `;
      monthTotal.回数 += stats.回数;
      monthTotal.金額 += stats.金額合計;
    });
    
    // 仮想通貨の銘柄別を表示
    const cryptoCoins = Object.keys(data).filter(k => k.startsWith('仮想通貨-'));
    if (cryptoCoins.length > 0) {
      html += `<div style="margin-top:6px;padding-top:6px;border-top:1px dashed rgba(255,255,255,0.2)">`;
      html += `<div style="font-size:0.75rem;color:#ffd93d;margin-bottom:4px">💎 仮想通貨（銘柄別）</div>`;
      
      cryptoCoins.forEach(coinKey => {
        const stats = data[coinKey];
        const coinName = coinKey.replace('仮想通貨-', '');
        const color = typeColors[coinKey] || '#ffd93d';
        
        html += `
          <div class="payment-type-row" style="padding:3px 0">
            <span class="payment-type-label" style="color:${color};font-size:0.8rem">${coinName}</span>
            <div class="payment-type-values">
              <div class="payment-stat"><span class="payment-stat-label">人</span> ${stats.人数}</div>
              <div class="payment-stat"><span class="payment-stat-label">回</span> ${stats.回数}</div>
              <div class="payment-stat"><span class="payment-stat-label">額</span> ¥${(stats.金額合計/10000).toFixed(1)}万</div>
              <div class="payment-stat"><span class="payment-stat-label">中央</span> ¥${(stats.中央値/10000).toFixed(1)}万</div>
            </div>
          </div>
        `;
        cryptoTotal.回数 += stats.回数;
        cryptoTotal.金額 += stats.金額合計;
      });
      
      // 仮想通貨小計
      if (cryptoCoins.length > 1) {
        html += `
          <div class="payment-type-row" style="padding:3px 0;border-top:1px dotted rgba(255,255,255,0.15)">
            <span class="payment-type-label" style="color:#ffd93d;font-size:0.75rem">仮想通貨計</span>
            <div class="payment-type-values">
              <div class="payment-stat"><span class="payment-stat-label">回</span> ${cryptoTotal.回数}</div>
              <div class="payment-stat"><span class="payment-stat-label">額</span> ¥${(cryptoTotal.金額/10000).toFixed(1)}万</div>
            </div>
          </div>
        `;
      }
      html += `</div>`;
      
      monthTotal.回数 += cryptoTotal.回数;
      monthTotal.金額 += cryptoTotal.金額;
    }
    
    // 月合計行
    html += `
      <div class="payment-type-row" style="border-top:2px solid rgba(255,255,255,0.3);margin-top:8px;padding-top:8px">
        <span class="payment-type-label" style="color:#90EE90;font-weight:bold">合計</span>
        <div class="payment-type-values">
          <div class="payment-stat"><span class="payment-stat-label">回数</span> ${monthTotal.回数}回</div>
          <div class="payment-stat"><span class="payment-stat-label">金額</span> ¥${(monthTotal.金額/10000).toFixed(1)}万</div>
        </div>
      </div>
    `;
    
    html += `</div>`;
  });
  
  container.innerHTML = html;
}

// ========== 継続KPI推移グラフ ==========
function renderRetentionChart() {
  const section = document.getElementById('retention-chart-section');
  const business = BUSINESSES[currentBusiness];
  
  // スロ天以外は非表示
  if (business?.type !== 'sloten') {
    section.classList.add('hidden');
    if (retentionChart) { retentionChart.destroy(); retentionChart = null; }
    return;
  }
  
  const data = business.data || {};
  const periods = sortPeriods(Object.keys(data)).reverse().slice(-12);
  
  if (periods.length === 0) {
    section.classList.add('hidden');
    return;
  }
  
  section.classList.remove('hidden');
  const ctx = document.getElementById('retention-chart').getContext('2d');
  if (retentionChart) retentionChart.destroy();
  
  const datasets = [
    {
      label: '登録人数',
      data: periods.map(p => data[p]?.サマリー?.['登録人数'] || 0),
      backgroundColor: 'rgba(59, 130, 246, 0.7)',
      borderColor: 'rgba(59, 130, 246, 1)',
      borderWidth: 2,
      type: 'bar'
    },
    {
      label: '前月登録からの継続',
      data: periods.map(p => data[p]?.サマリー?.['前月登録ユーザー数'] || 0),
      backgroundColor: 'rgba(16, 185, 129, 0.7)',
      borderColor: 'rgba(16, 185, 129, 1)',
      borderWidth: 2,
      type: 'bar'
    },
    {
      label: '前々月登録からの継続',
      data: periods.map(p => data[p]?.サマリー?.['前々月登録ユーザー数'] || 0),
      backgroundColor: 'rgba(245, 158, 11, 0.7)',
      borderColor: 'rgba(245, 158, 11, 1)',
      borderWidth: 2,
      type: 'bar'
    },
    {
      label: '3か月以上前からの継続',
      data: periods.map(p => data[p]?.サマリー?.['3か月以上前登録ユーザー数'] || 0),
      backgroundColor: 'rgba(139, 92, 246, 0.7)',
      borderColor: 'rgba(139, 92, 246, 1)',
      borderWidth: 2,
      type: 'bar'
    },
    {
      label: '前月継続率',
      data: periods.map(p => {
        const rate = data[p]?.サマリー?.['前月継続率'];
        return rate ? rate * 100 : 0;
      }),
      borderColor: 'rgba(239, 68, 68, 1)',
      backgroundColor: 'rgba(239, 68, 68, 0.1)',
      borderWidth: 3,
      type: 'line',
      yAxisID: 'y1',
      tension: 0.3
    }
  ];
  
  retentionChart = new Chart(ctx, {
    data: { labels: periods, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'top' } },
      scales: {
        y: {
          beginAtZero: true,
          position: 'left',
          title: { display: true, text: '人数' },
          ticks: { callback: v => v.toLocaleString() }
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          max: 100,
          title: { display: true, text: '継続率(%)' },
          grid: { drawOnChartArea: false },
          ticks: { callback: v => v + '%' }
        }
      }
    }
  });
}

// ========== メイン描画 ==========
function renderTabs() { const container = document.getElementById('business-tabs'); container.innerHTML = Object.keys(BUSINESSES).map(name => `<button class="tab ${name === currentBusiness ? 'active' : ''}" onclick="selectBusiness('${name}')">${name}</button>`).join('') + '<button class="btn btn-danger" onclick="deleteBusiness()" style="margin-left:auto">🗑️</button>'; }
function selectBusiness(name) { currentBusiness = name; const business = BUSINESSES[name], data = business?.data || {}, periods = sortPeriods(Object.keys(data)); currentPeriod = periods[0] || null; renderTabs(); renderPeriodSelector(periods); if (viewMode === 'total') renderTotalsSection(); renderSummary(); renderKPISections(); renderCryptoSection(); renderGameSection(); renderProviderSection(); renderDailyStatsSection(); renderPaymentStatsSection(); renderChart(); renderRetentionChart(); renderTable(); }
function renderPeriodSelector(periods) { const container = document.getElementById('period-selector'); if (periods.length === 0) { container.innerHTML = '<span style="color:#94a3b8;font-size:13px">データをアップロードしてください</span>'; return; } container.innerHTML = periods.map(p => `<button class="period-btn ${p === currentPeriod ? 'active' : ''}" onclick="selectPeriod('${p}')">${p}</button>`).join('') + `<button class="btn btn-danger" style="padding:4px 10px;font-size:11px" onclick="deletePeriod()">期間削除</button>`; }
function selectPeriod(period) { currentPeriod = period; renderPeriodSelector(sortPeriods(Object.keys(BUSINESSES[currentBusiness]?.data || {}))); renderSummary(); renderKPISections(); renderCryptoSection(); renderGameSection(); renderProviderSection(); renderDailyStatsSection(); renderPaymentStatsSection(); renderTable(); }
function deletePeriod() { const business = BUSINESSES[currentBusiness], periods = Object.keys(business?.data || {}); if (periods.length <= 1) { alert('最後の期間は削除できません'); return; } if (confirm(`「${currentPeriod}」を削除しますか？`)) { delete business.data[currentPeriod]; saveBusinessData(); selectBusiness(currentBusiness); } }

function renderSummary() {
  const container = document.getElementById('summary-section');
  const business = BUSINESSES[currentBusiness];
  if (!business) { container.innerHTML = ''; return; }
  let data;
  if (viewMode === 'total') { const result = calculateTotalsAndAverages(currentBusiness); if (!result) { container.innerHTML = ''; return; } data = result.totals; }
  else { const periodData = business.data?.[currentPeriod]; data = periodData?.サマリー || periodData || {}; }
  if (!data || Object.keys(data).length === 0) { container.innerHTML = '<div class="card" style="text-align:center;padding:40px;color:#94a3b8">データがありません</div>'; return; }
  const type = business.type || 'samExcel';
  const colors = ['linear-gradient(135deg,#3b82f6,#1d4ed8)','linear-gradient(135deg,#10b981,#059669)','linear-gradient(135deg,#f59e0b,#d97706)','linear-gradient(135deg,#ef4444,#dc2626)','linear-gradient(135deg,#8b5cf6,#7c3aed)','linear-gradient(135deg,#ec4899,#db2777)'];
  
  // Konibet専用の詳細サマリー表示
  if (type === 'konibet') {
    // 基本指標グループ
    const basicCards = [
      { key: '登録人数', alt: ['登録'], label: '登録人数', format: 'number' },
      { key: 'FTD数', alt: ['FTD', '初回入金人数(FTD)'], label: 'FTD数', format: 'number' },
      { key: '入金者数', alt: ['入金人数'], label: '入金者数', format: 'number' },
      { key: '総入金額', alt: ['入金額'], label: '総入金額' },
      { key: 'T/O', alt: ['ターンオーバー'], label: 'T/O' },
      { key: 'アクティブプレイ人数', alt: ['アクティブプレイ数', 'ベット人数', 'MAU'], label: 'アクティブ人数', format: 'number' }
    ];
    // 収益指標グループ
    const revenueCards = [
      { key: 'GGR', label: 'GGR' },
      { key: '入出金差分', alt: ['入金と出金の差'], label: '入出金差分' },
      { key: 'ボーナス', alt: ['ボーナス（FS除く）'], label: 'ボーナス' },
      { key: 'NGR', label: 'NGR' }
    ];
    // 比率指標グループ
    const ratioCards = [
      { key: '新規入金転移率', label: '新規入金転移率', format: 'percent' },
      { key: '平均入金額', alt: ['平均入金額(人数/デイリ)'], label: '平均入金額' },
      { key: '出金人数割合', label: '出金人数割合', format: 'percent' },
      { key: 'T/O倍率', label: 'T/O倍率', format: 'number' },
      { key: 'ボーナス付与率', alt: ['ボーナス付与率(入金に対して)'], label: 'ボーナス付与率', format: 'percent' },
      { key: 'GGR率', alt: ['入金額に対してのGGR割合'], label: 'GGR率', format: 'percent' },
      { key: 'NGR率', alt: ['入金に対してのNGR割合'], label: 'NGR率', format: 'percent' }
    ];
    
    const renderCardGroup = (cards, title, bgColors) => {
      const cardHtml = cards.map((card, i) => {
        let val = data[card.key];
        if (val == null && card.alt) { for (const k of card.alt) { if (data[k] != null) { val = data[k]; break; } } }
        if (val == null) return '';
        let formatted = card.format === 'percent' ? formatPercent(val) : card.format === 'number' ? formatNumber(val) : formatCurrency(val);
        const bg = val < 0 && card.format !== 'percent' ? 'linear-gradient(135deg,#ef4444,#dc2626)' : bgColors[i % bgColors.length];
        return `<div class="summary-card" style="background:${bg}"><h3>${card.label}</h3><div class="value">${formatted}</div></div>`;
      }).filter(h => h).join('');
      if (!cardHtml) return '';
      return `<div style="margin-bottom:16px"><div style="font-size:12px;color:#64748b;margin-bottom:8px;font-weight:600">${title}</div><div class="summary-grid">${cardHtml}</div></div>`;
    };
    
    const basicColors = ['linear-gradient(135deg,#3b82f6,#1d4ed8)','linear-gradient(135deg,#0ea5e9,#0284c7)','linear-gradient(135deg,#06b6d4,#0891b2)','linear-gradient(135deg,#14b8a6,#0d9488)','linear-gradient(135deg,#10b981,#059669)','linear-gradient(135deg,#22c55e,#16a34a)'];
    const revenueColors = ['linear-gradient(135deg,#f59e0b,#d97706)','linear-gradient(135deg,#f97316,#ea580c)','linear-gradient(135deg,#ef4444,#dc2626)','linear-gradient(135deg,#8b5cf6,#7c3aed)'];
    const ratioColors = ['linear-gradient(135deg,#6366f1,#4f46e5)','linear-gradient(135deg,#8b5cf6,#7c3aed)','linear-gradient(135deg,#a855f7,#9333ea)','linear-gradient(135deg,#d946ef,#c026d3)','linear-gradient(135deg,#ec4899,#db2777)','linear-gradient(135deg,#f43f5e,#e11d48)','linear-gradient(135deg,#fb7185,#f43f5e)'];
    
    container.innerHTML = renderCardGroup(basicCards, '📊 基本指標', basicColors) + 
                         renderCardGroup(revenueCards, '💰 収益指標', revenueColors) + 
                         renderCardGroup(ratioCards, '📈 比率指標', ratioColors);
    return;
  }
  
  // バカラツール専用の詳細サマリー表示
  if (type === 'baccara') {
    const followerCards = [
      { key: 'Twitter', label: 'Twitter', format: 'number' },
      { key: 'Instagram', label: 'Instagram', format: 'number' },
      { key: 'TikTok', label: 'TikTok', format: 'number' },
      { key: 'YouTube', label: 'YouTube', format: 'number' },
      { key: 'LINE公式', label: 'LINE公式', format: 'number' },
      { key: 'KICK', label: 'KICK', format: 'number' },
      { key: '合計フォロワー', label: '合計', format: 'number' }
    ];
    const bizCards = [
      { key: '総ユーザー数', label: 'ユーザー数', format: 'number' },
      { key: '総入金額', label: '総入金額' },
      { key: '平均T/O', label: '平均T/O' },
      { key: '総GGR', label: 'GGR' },
      { key: 'コスト', label: 'コスト' },
      { key: 'NGR', label: 'NGR' }
    ];
    const renderCardGroup = (cards, title, bgColors) => {
      const cardHtml = cards.map((card, i) => {
        let val = data[card.key];
        if (val == null) return '';
        let formatted = card.format === 'number' ? formatNumber(val) : formatCurrency(val);
        const bg = val < 0 ? 'linear-gradient(135deg,#ef4444,#dc2626)' : bgColors[i % bgColors.length];
        return `<div class="summary-card" style="background:${bg}"><h3>${card.label}</h3><div class="value">${formatted}</div></div>`;
      }).filter(h => h).join('');
      if (!cardHtml) return '';
      return `<div style="margin-bottom:16px"><div style="font-size:12px;color:#64748b;margin-bottom:8px;font-weight:600">${title}</div><div class="summary-grid">${cardHtml}</div></div>`;
    };
    const followerColors = ['linear-gradient(135deg,#3b82f6,#1d4ed8)','linear-gradient(135deg,#ec4899,#db2777)','linear-gradient(135deg,#000000,#333333)','linear-gradient(135deg,#ef4444,#dc2626)','linear-gradient(135deg,#22c55e,#16a34a)','linear-gradient(135deg,#4ade80,#22c55e)','linear-gradient(135deg,#8b5cf6,#7c3aed)'];
    const bizColors = ['linear-gradient(135deg,#10b981,#059669)','linear-gradient(135deg,#f59e0b,#d97706)','linear-gradient(135deg,#f97316,#ea580c)','linear-gradient(135deg,#22c55e,#16a34a)','linear-gradient(135deg,#ef4444,#dc2626)','linear-gradient(135deg,#8b5cf6,#7c3aed)'];
    container.innerHTML = renderCardGroup(followerCards, '📱 SNSフォロワー数', followerColors) + renderCardGroup(bizCards, '💰 収益', bizColors);
    return;
  }
  
  let cards = type === 'samExcel' ? [{ key: 'T/O', label: 'T/O' },{ key: 'GGR(WIN/LOSE)', alt: ['GGR','WIN/LOSE'], label: 'GGR' },{ key: 'NGR', label: 'NGR' },{ key: '回収率(全体)', alt: ['回収率'], label: '回収率', format: 'percent' },{ key: 'GGR(回収金額-出金金額)', label: '入出金差分' }] : type === 'sloten' ? [{ key: 'GGR', label: 'GGR' },{ key: '総入金額', label: '総入金額' },{ key: '総出金額', label: '総出金額' },{ key: '入出金差分', label: '入出金差分' },{ key: 'RTP', label: 'RTP', format: 'percent' },{ key: '登録人数', label: '登録人数', format: 'number' }] : type === 'ads' ? [{ key: 'コスト(税込)', label: 'コスト' },{ key: 'インプレッション', label: 'IMP', format: 'number' },{ key: 'クリック', label: 'クリック', format: 'number' },{ key: '登録数', label: '登録', format: 'number' },{ key: '入金数', label: '入金', format: 'number' },{ key: '登録CPA', label: '登録CPA' },{ key: '入金CPA', label: '入金CPA' }] : type === 'agent' ? [{ key: '入金合計', label: '入金合計' },{ key: '出金合計', label: '出金合計' },{ key: '収益合計', label: '収益合計' },{ key: 'NGR', label: 'NGR' }] : [];
  container.innerHTML = '<div class="summary-grid">' + cards.map((card, i) => { let val = data[card.key]; if (val == null && card.alt) { for (const k of card.alt) { if (data[k] != null) { val = data[k]; break; } } } if (val == null) return ''; let formatted = card.key === 'RTP' ? formatRTP(val) : card.format === 'percent' ? formatPercent(val) : card.format === 'number' ? formatNumber(val) : formatCurrency(val); const bg = val < 0 && card.format !== 'percent' ? 'linear-gradient(135deg,#ef4444,#dc2626)' : colors[i % colors.length]; return `<div class="summary-card" style="background:${bg}"><h3>${card.label}</h3><div class="value">${formatted}</div></div>`; }).join('') + '</div>';
}

function renderKPISections() {
  const container = document.getElementById('kpi-sections');
  const business = BUSINESSES[currentBusiness];
  if (!business) { container.innerHTML = ''; return; }
  
  let data;
  if (viewMode === 'total') {
    const result = calculateTotalsAndAverages(currentBusiness);
    if (!result) { container.innerHTML = ''; return; }
    data = result.totals;
  } else {
    const periodData = business.data?.[currentPeriod];
    data = periodData?.サマリー || periodData || {};
  }
  
  if (!data || Object.keys(data).length === 0) { container.innerHTML = ''; return; }
  const type = business.type || 'samExcel';
  if (type === 'agent' || type === 'ads' || type === 'baccara') { container.innerHTML = ''; return; }
  
  // Konibet専用KPIセクション
  if (type === 'konibet') {
    const exchangeRate = data['為替レート(USD/JPY)'] || 150;
    const konibetSections = [
      { 
        title: '📊 実績', 
        keys: ['登録','FTD','MAU','入金額','ターンオーバー','AFF固定費','NGR'], 
        bg: '#dbeafe',
        format: { '登録': 'number', 'FTD': 'number', 'MAU': 'number', '入金額': 'currency', 'ターンオーバー': 'currency', 'AFF固定費': 'currency', 'NGR': 'currency' }
      },
      { 
        title: '🎯 目標', 
        keys: ['登録目標','FTD目標','MAU目標','入金額目標','ターンオーバー目標','AFF固定費目標','NGR目標'], 
        bg: '#fef3c7',
        format: { '登録目標': 'number', 'FTD目標': 'number', 'MAU目標': 'number', '入金額目標': 'currency', 'ターンオーバー目標': 'currency', 'AFF固定費目標': 'currency', 'NGR目標': 'currency' }
      },
      { 
        title: '📈 達成率', 
        keys: ['登録達成率','FTD達成率','MAU達成率','入金額達成率','ターンオーバー達成率','NGR達成率'], 
        bg: '#dcfce7',
        format: { '登録達成率': 'percent', 'FTD達成率': 'percent', 'MAU達成率': 'percent', '入金額達成率': 'percent', 'ターンオーバー達成率': 'percent', 'NGR達成率': 'percent' }
      }
    ];
    
    // 為替レート情報バナー
    container.innerHTML = `<div style="background:linear-gradient(135deg,#059669,#10b981);color:white;padding:12px 20px;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;gap:12px">
      <span style="font-size:20px">💱</span>
      <span><strong>為替レート:</strong> $1 = ¥${exchangeRate} で換算済み</span>
    </div>`;
    
    container.innerHTML += konibetSections.map(section => {
      const items = section.keys.filter(k => data[k] != null);
      if (items.length === 0) return '';
      return `<div class="card" style="background:${section.bg}"><div class="section-title">${section.title}</div><div class="kpi-grid">${items.map(key => {
        const val = data[key];
        const fmt = section.format[key];
        let formatted = fmt === 'percent' ? formatPercent(val) : fmt === 'currency' ? formatCurrency(val) : formatNumber(val);
        const isNeg = typeof val === 'number' && val < 0;
        const isLow = fmt === 'percent' && typeof val === 'number' && val < 0.8;
        return `<div class="kpi-item"><div class="label">${key}</div><div class="val ${isNeg ? 'negative' : ''}" style="${isLow ? 'color:#f59e0b' : ''}">${formatted}</div></div>`;
      }).join('')}</div></div>`;
    }).join('');
    
    // 週次詳細データがある場合は表示
    if (viewMode !== 'total') {
      const periodData = business.data?.[currentPeriod];
      if (periodData?.週次詳細 && periodData.週次詳細.length > 0) {
        container.innerHTML += `<div class="card" style="background:#f1f5f9">
          <div class="section-title">📅 週次詳細</div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>週</th>
                  <th class="text-right">登録</th>
                  <th class="text-right">FTD</th>
                  <th class="text-right">MAU</th>
                  <th class="text-right">入金額</th>
                  <th class="text-right">T/O</th>
                  <th class="text-right">NGR</th>
                  <th class="text-right">登録率</th>
                  <th class="text-right">入金率</th>
                </tr>
              </thead>
              <tbody>
                ${periodData.週次詳細.map(w => `
                  <tr>
                    <td>${w.週}</td>
                    <td class="text-right">${formatNumber(w.登録)}</td>
                    <td class="text-right">${formatNumber(w.FTD)}</td>
                    <td class="text-right">${formatNumber(w.MAU)}</td>
                    <td class="text-right">${formatCurrency(w.入金額)}</td>
                    <td class="text-right">${formatCurrency(w.ターンオーバー)}</td>
                    <td class="text-right ${w.NGR < 0 ? 'text-red' : ''}">${formatCurrency(w.NGR)}</td>
                    <td class="text-right">${formatPercent(w['登録達成率'])}</td>
                    <td class="text-right">${formatPercent(w['入金額達成率'])}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>`;
      }
    }
    return;
  }
  
  const sections = [
    { title: '📞 営業KPI', keys: ['リスト件数','総登録数','登録人数','打電数','着電数','LINE登録数','アカウント作成数','ログインユーザー数','アクティブプレイ人数（ユニーク）','アクティブユーザー数','入金者数(デイリーユニーク)'], bg: '#dbeafe' },
    { title: '🎯 転換KPI', keys: ['FTP数','FTP率','FTD数','FTD率','FTW数','FTW率','FTDW数','FTDW率','FTDのみ入金者数','FTDのみ率','2nd入金者数','2nd率','3rd入金者数','3rd率','Active入金者数','Active率','今月登録のFTD以降ユーザー数','今月登録FTD以降ユーザー割合'], bg: '#dcfce7' },
    { title: '🔄 継続KPI', keys: ['前月リテンション数','引継ぎプレイヤー数','前月登録ユーザー数','前月継続率','前々月登録ユーザー数','前々月継続率','3か月以上前登録ユーザー数','3か月以上前継続率'], bg: '#fef3c7' },
    { title: '💰 収益KPI', keys: ['T/O','総TO','T/O(リアルのみ)','勝利金','勝利金(リアルのみ)','RTP','GGR(WIN/LOSE)','GGR','WIN/LOSE','LTV(WIN/LOSE)','GGRLTV','総差分利益','総NGR','平均NGR'], bg: '#e0e7ff' },
    { title: '💵 回収KPI', keys: ['回収予定金額','回収金額','総回収額','回収率(全体)','回収率(今月)','出金金額','総出金額','GGR(回収金額-出金金額)','回収出金差分','LTV(GGR)','NGR','総入金額','入出金差分'], bg: '#fce7f3' },
    { title: '🏦 信用・ボーナスKPI', keys: ['総信用枠','平均信用枠','平均Credit単価','総ボーナス','ボーナス対象者数','総ボーナス付与金額','ボーナス対象入金額','ボーナス対象NGR'], bg: '#fef9c3' },
    { title: '📊 顧客分析KPI', keys: ['平均プレイ月間','事前清算回数','事前清算金額','事前清算割合','事前清算件数割合','通常清算回数','通常清算金額','通常清算割合','通常清算件数割合'], bg: '#e0f2fe' },
    { title: '⚠️ 未回収・遅れKPI', keys: ['未回収者数','残未回収金額','遅れ回収件数','遅れ回収金額'], bg: '#fee2e2' },
    { title: '👥 担当者KPI', keys: ['担当者数','担当者計_登録数','担当者計_FTD数','担当者計_GGR','担当者計_NGR'], bg: '#e0e7ff' }
  ];
  const percentKeys = ['FTP率','FTD率','FTW率','FTDW率','RTP','回収率(全体)','回収率(今月)','今月登録FTD以降ユーザー割合','前月継続率','前々月継続率','3か月以上前継続率','事前清算割合','通常清算割合','事前清算件数割合','通常清算件数割合','FTDのみ率','2nd率','3rd率','Active率'];
  const currencyKeys = ['T/O','総TO','T/O(リアルのみ)','勝利金','勝利金(リアルのみ)','GGR(WIN/LOSE)','GGR','WIN/LOSE','LTV(WIN/LOSE)','回収予定金額','回収金額','総回収額','出金金額','総出金額','GGR(回収金額-出金金額)','回収出金差分','LTV(GGR)','NGR','合計経費','プロバイダーフィー','人件費','通信費','インセンティブ','ペイメントフィー','雑費・福利厚生等','BK','利益','総入金額','総出金額','入出金差分','GGRLTV','総差分利益','総NGR','平均NGR','総信用枠','平均信用枠','平均Credit単価','総ボーナス','総ボーナス付与金額','ボーナス対象入金額','ボーナス対象NGR','残未回収金額','遅れ回収金額','担当者計_GGR','担当者計_NGR','事前清算金額','通常清算金額'];
  container.innerHTML = sections.map(section => { const items = section.keys.filter(k => data[k] != null); if (items.length === 0) return ''; return `<div class="card" style="background:${section.bg}"><div class="section-title">${section.title}</div><div class="kpi-grid">${items.map(key => { const val = data[key]; let formatted = key === 'RTP' ? formatRTP(val) : percentKeys.includes(key) ? formatPercent(val) : currencyKeys.includes(key) ? formatCurrency(val) : formatNumber(val); const isNeg = typeof val === 'number' && val < 0; return `<div class="kpi-item"><div class="label">${key}</div><div class="val ${isNeg ? 'negative' : ''}">${formatted}</div></div>`; }).join('')}</div></div>`; }).join('');
  
  // 入金/出金方法、Affiliate、リスト種別
  if (viewMode !== 'total') {
    const periodData = business.data?.[currentPeriod];
    if (periodData?.リスト種別) {
      const listOrder = ['B', 'E', 'T', 'S', 'BE', 'C', '紹介', 'その他'];
      const sortedList = listOrder.filter(k => periodData.リスト種別[k] != null).map(k => [k, periodData.リスト種別[k]]);
      container.innerHTML += `<div class="card" style="background:#f0fdf4"><div class="section-title">📋 リスト種別</div><div class="kpi-grid">${sortedList.map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatNumber(v)}件</div></div>`).join('')}</div></div>`;
    }
    if (periodData?.入金方法) container.innerHTML += `<div class="card" style="background:#e0f2fe"><div class="section-title">💳 入金方法</div><div class="kpi-grid">${Object.entries(periodData.入金方法).map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatCurrency(v)}</div></div>`).join('')}</div></div>`;
    if (periodData?.出金方法) container.innerHTML += `<div class="card" style="background:#fef9c3"><div class="section-title">🏦 出金方法</div><div class="kpi-grid">${Object.entries(periodData.出金方法).map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatCurrency(v)}</div></div>`).join('')}</div></div>`;
    if (periodData?.Affiliate) container.innerHTML += `<div class="card" style="background:#ecfdf5"><div class="section-title">🤝 Affiliate</div><div class="kpi-grid">${Object.entries(periodData.Affiliate).map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${k.includes('率') ? formatPercent(v) : k.includes('数') ? formatNumber(v) : formatCurrency(v)}</div></div>`).join('')}</div></div>`;
  } else {
    // 全期間モード：リスト種別を集計
    const allListTypes = {};
    const validListTypes = ['B', 'E', 'T', 'S', 'BE', 'C', '紹介'];
    const periods = Object.keys(business.data || {});
    periods.forEach(period => {
      const listTypes = business.data[period]?.リスト種別;
      if (listTypes) {
        Object.entries(listTypes).forEach(([type, count]) => {
          let targetType = validListTypes.includes(type) ? type : 'その他';
          if (!allListTypes[targetType]) allListTypes[targetType] = 0;
          allListTypes[targetType] += count;
        });
      }
    });
    if (Object.keys(allListTypes).length > 0) {
      const listOrder = ['B', 'E', 'T', 'S', 'BE', 'C', '紹介', 'その他'];
      const sortedList = listOrder.filter(k => allListTypes[k] != null).map(k => [k, allListTypes[k]]);
      container.innerHTML += `<div class="card" style="background:#f0fdf4"><div class="section-title">📋 リスト種別（全期間）</div><div class="kpi-grid">${sortedList.map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatNumber(v)}件</div></div>`).join('')}</div></div>`;
    }
  }
}

function renderChart() {
  const ctx = document.getElementById('main-chart').getContext('2d');
  const business = BUSINESSES[currentBusiness];
  if (!business) { if (chartInstance) chartInstance.destroy(); return; }
  const data = business.data || {};
  const periods = sortPeriods(Object.keys(data)).reverse().slice(-12);
  if (chartInstance) chartInstance.destroy();
  if (periods.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); return; }
  const type = business.type || 'samExcel';
  let datasets = type === 'samExcel' ? [{ label: 'GGR', data: periods.map(p => { const d = data[p]?.サマリー || data[p] || {}; return d['GGR(WIN/LOSE)'] || d['GGR'] || d['WIN/LOSE'] || 0; }), backgroundColor: 'rgba(59,130,246,0.7)' },{ label: 'NGR', data: periods.map(p => (data[p]?.サマリー?.['NGR'] || data[p]?.['NGR'] || 0)), backgroundColor: 'rgba(16,185,129,0.7)' }] : type === 'sloten' ? [{ label: 'GGR', data: periods.map(p => (data[p]?.サマリー?.['GGR'] || data[p]?.['GGR'] || 0)), backgroundColor: 'rgba(59,130,246,0.7)' },{ label: '入出金差分', data: periods.map(p => (data[p]?.サマリー?.['入出金差分'] || data[p]?.['入出金差分'] || 0)), backgroundColor: 'rgba(16,185,129,0.7)' }] : type === 'konibet' ? [{ label: '入金額', data: periods.map(p => (data[p]?.サマリー?.['入金額'] || 0)), backgroundColor: 'rgba(59,130,246,0.7)' },{ label: 'NGR', data: periods.map(p => (data[p]?.サマリー?.['NGR'] || 0)), backgroundColor: 'rgba(16,185,129,0.7)' },{ label: 'ターンオーバー', data: periods.map(p => (data[p]?.サマリー?.['ターンオーバー'] || 0) / 10), backgroundColor: 'rgba(245,158,11,0.5)', hidden: true }] : [{ label: 'GGR', data: periods.map(p => (data[p]?.サマリー?.['総GGR'] || data[p]?.サマリー?.['GGR'] || 0)), backgroundColor: 'rgba(59,130,246,0.7)' }];
  chartInstance = new Chart(ctx, { type: 'bar', data: { labels: periods, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '¥' + (v / 1000000).toFixed(0) + 'M' } } } } });
}

function renderTable() {
  const business = BUSINESSES[currentBusiness];
  let data;
  if (viewMode === 'total') {
    const result = calculateTotalsAndAverages(currentBusiness);
    data = result ? result.totals : {};
  } else {
    const periodData = business?.data?.[currentPeriod];
    data = periodData?.サマリー || periodData || {};
  }
  const header = document.getElementById('table-header');
  const body = document.getElementById('table-body');
  header.innerHTML = '<th>項目</th><th class="text-right">値</th>';
  const percentKeys = ['FTP率','FTD率','FTW率','FTDW率','RTP','回収率(全体)','回収率(今月)','今月登録FTD以降ユーザー割合','前月継続率','前々月継続率'];
  const currencyKeys = ['T/O','総TO','T/O(リアルのみ)','勝利金','勝利金(リアルのみ)','GGR(WIN/LOSE)','GGR','WIN/LOSE','LTV(WIN/LOSE)','回収予定金額','回収金額','総回収額','出金金額','総出金額','GGR(回収金額-出金金額)','回収出金差分','LTV(GGR)','NGR','合計経費','プロバイダーフィー','人件費','通信費','インセンティブ','ペイメントフィー','雑費・福利厚生等','BK','利益','総入金額','入出金差分','GGRLTV','総差分利益','総NGR','平均NGR','総信用枠','平均信用枠','平均Credit単価','総ボーナス','総ボーナス付与金額','ボーナス対象入金額','ボーナス対象NGR','残未回収金額','遅れ回収金額','担当者計_GGR','担当者計_NGR','事前清算金額','通常清算金額'];
  const percentKeysTable = ['FTP率','FTD率','FTW率','FTDW率','RTP','回収率(全体)','回収率(今月)','今月登録FTD以降ユーザー割合','前月継続率','前々月継続率','3か月以上前継続率','事前清算割合','通常清算割合','事前清算件数割合','通常清算件数割合','FTDのみ率','2nd率','3rd率','Active率'];
  body.innerHTML = Object.entries(data).map(([key, value]) => { if (value === null || value === undefined) return ''; let formatted = key === 'RTP' ? formatRTP(value) : percentKeysTable.includes(key) ? formatPercent(value) : currencyKeys.includes(key) ? formatCurrency(value) : typeof value === 'number' ? formatNumber(value) : String(value); const isNeg = typeof value === 'number' && value < 0; return `<tr><td>${key}</td><td class="text-right ${isNeg ? 'text-red' : ''}">${formatted}</td></tr>`; }).join('');
}

// ========== モーダル ==========
function showUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); document.getElementById('upload-status').style.display = 'none'; toggleExchangeRate(); }
function hideUploadModal() { document.getElementById('upload-modal').classList.add('hidden'); }
function toggleExchangeRate() { const type = document.getElementById('upload-type').value; const row = document.getElementById('exchange-rate-row'); row.style.display = (type === 'konibet' || type === 'auto') ? 'block' : 'none'; }
function showAddBusinessModal() { document.getElementById('add-business-modal').classList.remove('hidden'); }
function hideAddBusinessModal() { document.getElementById('add-business-modal').classList.add('hidden'); }
function setupDragDrop() { const zone = document.getElementById('upload-zone'); zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); }); zone.addEventListener('dragleave', () => zone.classList.remove('dragover')); zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('dragover'); if (e.dataTransfer.files[0]) handleFileUpload(e.dataTransfer.files[0]); }); }
function showStatus(msg, isError = false) { const s = document.getElementById('upload-status'); s.style.display = 'block'; s.style.background = isError ? '#fee2e2' : '#dcfce7'; s.style.color = isError ? '#dc2626' : '#16a34a'; s.textContent = msg; }

// ========== ファイルアップロード ==========
function handleFileUpload(file) {
  if (!file) return;
  const period = document.getElementById('upload-period').value || new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' }).replace(' ', '');
  const uploadType = document.getElementById('upload-type').value;
  const reader = new FileReader();
  if (file.name.endsWith('.zip')) { showStatus('ZIPファイルは非対応です', true); return; }
  reader.onload = function(e) {
    try {
      if (file.name.endsWith('.csv')) handleCSV(e.target.result, period, uploadType, file.name);
      else { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); handleExcel(workbook, period, uploadType, file.name); }
    } catch (err) { showStatus('エラー: ' + err.message, true); }
  };
  if (file.name.endsWith('.csv')) reader.readAsText(file, 'UTF-8');
  else reader.readAsArrayBuffer(file);
}

function handleCSV(text, period, uploadType, filename) {
  const parseCSVLine = (line) => { const result = []; let current = ''; let inQuotes = false; for (let i = 0; i < line.length; i++) { const c = line[i]; if (c === '"') inQuotes = !inQuotes; else if (c === ',' && !inQuotes) { result.push(current.trim().replace(/^"|"$/g, '')); current = ''; } else current += c; } result.push(current.trim().replace(/^"|"$/g, '')); return result; };
  const lines = text.replace(/\r\n/g, '\n').split('\n').filter(l => l.trim()).map(l => parseCSVLine(l));
  if (lines.length < 2) { showStatus('CSVにデータがありません', true); return; }
  const headerStr = lines[0].join(',').toLowerCase();
  const fn = filename.toLowerCase();
  
  // 全行のテキストを結合してチェック
  const allText = lines.slice(0, 60).map(r => r.join(',')).join(' ').toLowerCase();
  
  const isCustomerList = fn.includes('顧客リスト') || fn.includes('customer');
  const isUncollected = fn.includes('未回収') || headerStr.includes('残未回収金額');
  const isDelayed = fn.includes('遅れ回収') || fn.includes('遅れ');
  const isBonus = fn.includes('ボーナス') && !allText.includes('ターンオーバー');
  const isAgent = fn.includes('エージェント') || fn.includes('agent') || headerStr.includes('teamkyoto');
  const isAds = fn.includes('日报') || fn.includes('広告') || (headerStr.includes('コスト') && headerStr.includes('インプレッション'));
  const isSloten = fn.includes('スロ天') || (headerStr.includes('項目名') && headerStr.includes('月次'));
  const isKonibet = fn.includes('konibet') || fn.includes('コニベット') || (headerStr.includes('sign-up') && headerStr.includes('ftd') && headerStr.includes('mau') && headerStr.includes('deposits'));
  
  // SAM顧客管理シートの検出
  const isCustomerManagement = fn.includes('顧客管理シート') || (allText.includes('事前精算金額') && allText.includes('回収率') && allText.includes('信用枠金額'));
  
  // 着金確認シートの検出
  const isPaymentConfirm = fn.includes('着金') || fn.includes('ec着金') || fn.includes('paypay') || fn.includes('仮想通貨') || fn.includes('個人着金') || 
    (allText.includes('着金確認') && (allText.includes('入金額') || allText.includes('入金日')));
  
  // Konibet日次KPIシート（日本語フォーマット）の検出
  // 複数のパターンに対応
  const isKonibetDaily = (allText.includes('名目') && allText.includes('登録') && allText.includes('ggr') && allText.includes('ngr')) ||
                         (allText.includes('ロジック') && allText.match(/\d{4}\/\d{1,2}\/\d{1,2}/)) ||
                         (allText.includes('初回入金人数') && allText.includes('ターンオーバー')) ||
                         (allText.includes('目標') && allText.includes('合計') && allText.includes('登録') && allText.includes('ggr')) ||
                         (allText.includes('合計') && allText.includes('ftd') && allText.includes('ターンオーバー') && allText.includes('ngr')) ||
                         (allText.includes('前月') && allText.includes('合計') && allText.includes('登録') && allText.includes('ggr')) ||
                         (allText.includes('先月比較') && allText.includes('合計') && allText.includes('ターンオーバー'));
  
  if (uploadType === 'auto') {
    // Konibet日次KPIシート（日本語）を優先的にチェック
    if (isKonibetDaily) { parseKonibetDailyCSV(lines, period, fn); return; }
    if (isKonibet) { parseKonibetCSV(lines, period, fn); return; }
    if (isSloten) { parseSlotenCSV(lines, period, fn); return; }
    if (isPaymentConfirm) { parsePaymentConfirmCSV(lines, period, fn, filename); return; }
    if (isCustomerManagement) { parseCustomerManagementCSV(lines, period, fn); return; }
    if (isCustomerList) { parseCustomerListCSV(lines, period, fn); return; }
    if (isUncollected) { parseUncollectedCSV(lines, period, fn); return; }
    if (isDelayed) { parseDelayedCSV(lines, period, fn); return; }
    if (isBonus) { parseBonusCSV(lines, period, fn); return; }
    if (isAgent) { parseAgentCSV(lines, period); return; }
    if (isAds) { parseAdsCSV(lines, period); return; }
  }
  if (uploadType === 'sloten') { parseSlotenCSV(lines, period, fn); return; }
  if (uploadType === 'konibet') { 
    // konibet選択時も日本語フォーマットをチェック
    if (isKonibetDaily) { parseKonibetDailyCSV(lines, period, fn); return; }
    parseKonibetCSV(lines, period, fn); return; 
  }
  if (uploadType === 'customerList') { parseCustomerListCSV(lines, period, fn); return; }
  if (uploadType === 'uncollected') { parseUncollectedCSV(lines, period, fn); return; }
  if (uploadType === 'bonus') { parseBonusCSV(lines, period, fn); return; }
  if (uploadType === 'delayed') { parseDelayedCSV(lines, period, fn); return; }
  if (uploadType === 'agent') { parseAgentCSV(lines, period); return; }
  if (uploadType === 'ads') { parseAdsCSV(lines, period); return; }
  
  showStatus('CSVの形式を判別できませんでした', true);
}

// ========== 各種CSVパーサー ==========

// Konibet 日次KPIシート用パーサー（日本語フォーマット）
function parseKonibetDailyCSV(lines, period, filename) {
  // 為替レート（USD → JPY）- 入力欄から取得、なければデフォルト150
  const rateInput = document.getElementById('usd-jpy-rate');
  const USD_TO_JPY = rateInput ? parseFloat(rateInput.value) || 150 : 150;
  
  // KPIマッピング（名目 → KPI名）
  const kpiMapping = {
    '登録': '登録人数',
    'ログイン': 'ログインユーザー数',
    '初回入金人数(FTD)': 'FTD数',
    '初回入金人数': 'FTD数',
    'FTD': 'FTD数',
    '初回入金額': '初回入金額',
    '入金人数': '入金者数',
    '入金額': '総入金額',
    '実際の出金人数': '出金者数',
    '実際の出金額': '総出金額',
    '出金額': '総出金額',
    '入金と出金の差': '入出金差分',
    'ベット人数': 'アクティブプレイ人数',
    'ターンオーバー': 'T/O',
    'GGR': 'GGR',
    'win額': '勝利金',
    'ボーナス（FS除く）': 'ボーナス',
    'ボーナス': 'ボーナス',
    'ゲームフィー': 'ゲームプロバイダーフィー',
    'PSP手数料': 'PSP手数料',
    'AFF報酬': 'AFF報酬',
    'NGR': 'NGR',
    'アカウント内残高': 'アカウント残高',
    '新規入金転移率': '新規入金転移率',
    '平均入金額(人数/デイリ)': '平均入金額',
    '平均入金額(daily)': '平均入金額',
    '出金人数割合': '出金人数割合',
    '出金割合(ボーナス込み)': '出金割合',
    'T/O倍率': 'T/O倍率',
    'T/O倍率(Bonus込)': 'T/O倍率(Bonus込)',
    'ボーナス付与率(入金に対して)': 'ボーナス付与率',
    '入金額に対してのGGR割合': 'GGR率',
    '入金に対してのNGR割合': 'NGR率',
    'RTP(ゲーム種類ごとに計測していく必要あり)': 'RTP',
    'RTP': 'RTP',
    'LTV(GGRベース)': 'LTV(GGR)',
    'LTV(GGRベース)実入金人数': 'LTV(GGR)',
    'LTV(NGRベース)': 'LTV(NGR)',
    'LTV(NGRベース)実入金人数': 'LTV(NGR)'
  };
  
  // USDフィールド（為替換算が必要なフィールド）
  const usdFields = [
    '初回入金額', '入金額', '出金額', '入金と出金の差', 'ターンオーバー', 
    'GGR', 'win額', 'ボーナス（FS除く）', 'ボーナス', 'ゲームフィー', 
    'PSP手数料', 'NGR', 'アカウント内残高', '平均入金額(人数/デイリ)', '平均入金額(daily)',
    '実際の出金額', 'LTV(GGRベース)', 'LTV(NGRベース)', 'ボーナス＋プロバイダー＋PSP',
    'ボーナス＋プロバイダー＋PSP＋AFF', 'AFF報酬', 'LTV(GGRベース)実入金人数', 'LTV(NGRベース)実入金人数'
  ];
  
  const summary = {};
  let headerRowIndex = -1;
  let labelColIndex = -1;  // KPI名の列
  let totalColIndex = -1;  // 合計の列
  
  // ヘッダー行を探す
  // 複数の形式に対応: 「合計」列を探してその位置を基準にする
  for (let i = 0; i < Math.min(5, lines.length); i++) {
    const row = lines[i];
    if (!row) continue;
    
    // 「合計」列を探す
    let totalIdx = row.findIndex(cell => String(cell || '').trim() === '合計');
    if (totalIdx < 0) continue;
    
    // 形式を判定（データ行の最初の列にKPI名がある）
    headerRowIndex = i;
    labelColIndex = 0;  // KPI名は常に列0
    totalColIndex = totalIdx;
    break;
  }
  
  if (headerRowIndex < 0) {
    showStatus('Konibet日次KPIシートの形式を認識できませんでした', true);
    return;
  }
  
  // 期間名を取得（ヘッダー行の日付から）
  let periodName = period;
  const headerRow = lines[headerRowIndex];
  for (let j = totalColIndex + 1; j < headerRow.length; j++) {
    const cell = String(headerRow[j] || '').trim();
    // 「1月1日(金)」や「12月1日(火)」形式
    const dateMatch = cell.match(/(\d{1,2})月(\d{1,2})日/);
    if (dateMatch) {
      const month = parseInt(dateMatch[1]);
      // ファイル名から年を推測、なければ期間入力欄から
      const yearMatch = filename.match(/(202\d)/);
      let year = yearMatch ? yearMatch[1] : null;
      if (!year) {
        const inputPeriod = document.getElementById('upload-period')?.value || '';
        const inputYearMatch = inputPeriod.match(/(202\d)/);
        year = inputYearMatch ? inputYearMatch[1] : '2022';
      }
      periodName = `${year}年${month}月`;
      break;
    }
  }
  
  // データ行を読み取り
  for (let i = headerRowIndex + 1; i < lines.length; i++) {
    const row = lines[i];
    if (!row || row.length < totalColIndex + 1) continue;
    
    let rawLabel = String(row[labelColIndex] || '').trim();
    if (!rawLabel || rawLabel === '' || rawLabel.startsWith('統計')) continue;
    
    // スペースや特殊文字を正規化
    rawLabel = rawLabel.replace(/\s+/g, '');
    
    // 合計列の値を取得
    const totalVal = row[totalColIndex];
    if (totalVal === undefined || totalVal === null || totalVal === '') continue;
    
    // #DIV/0! などのエラー値をスキップ
    if (String(totalVal).includes('#')) continue;
    
    // KPI名をマッピング
    const kpiName = kpiMapping[rawLabel] || rawLabel;
    
    // 値をパース
    let val = parseNumber(totalVal);
    if (val === null) continue;
    
    // USDフィールドの場合は為替換算
    if (usdFields.some(f => rawLabel.includes(f) || rawLabel === f)) {
      val = val * USD_TO_JPY;
    }
    
    // パーセンテージフィールドの場合
    const isPercent = rawLabel.includes('率') || rawLabel.includes('割合') || rawLabel.includes('RTP');
    if (isPercent && Math.abs(val) > 1) {
      val = val / 100; // パーセント表記を小数に変換
    }
    
    // 重複キーは最初の値を優先（GGRなど）
    if (summary[kpiName] === undefined) {
      summary[kpiName] = val;
    }
  }
  
  // 計算項目を追加
  if (summary['総入金額'] && summary['総出金額'] && !summary['入出金差分']) {
    summary['入出金差分'] = summary['総入金額'] - summary['総出金額'];
  }
  if (summary['T/O'] && summary['勝利金'] && !summary['GGR']) {
    summary['GGR'] = summary['T/O'] - summary['勝利金'];
  }
  if (summary['GGR'] && summary['T/O'] && !summary['RTP']) {
    summary['RTP'] = summary['勝利金'] / summary['T/O'];
  }
  
  // 為替レートを保存
  summary['為替レート(USD/JPY)'] = USD_TO_JPY;
  
  // BUSINESSESに保存
  BUSINESSES['Konibet'].data[periodName] = {
    サマリー: summary
  };
  
  const kpiCount = Object.keys(summary).length;
  showStatus(`Konibet日次KPI取込完了: ${periodName} (${kpiCount}項目) ※USD→JPY: ¥${USD_TO_JPY}換算`);
  selectBusiness('Konibet'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseKonibetCSV(lines, period, filename) {
  // Konibet KPI CSVパーサー
  // CSVフォーマット:
  // 行1: ヘッダー (,KPI,sign-up,FTD,MAU,Deposits,T/0,AFF cost,NGR)
  // 行2-13: 月別KPI目標値
  // 行16以降: 実績データ（週次）
  
  // 為替レート（USD → JPY）- 入力欄から取得、なければデフォルト150
  const rateInput = document.getElementById('usd-jpy-rate');
  const USD_TO_JPY = rateInput ? parseFloat(rateInput.value) || 150 : 150;
  
  const yearMatch = filename.match(/202[0-9]/);
  const year = yearMatch ? yearMatch[0] : new Date().getFullYear().toString();
  
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  const monthsJP = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
  
  // KPI目標値を読み取り（行2-13）
  const targets = {};
  for (let i = 1; i <= 13; i++) {
    const row = lines[i];
    if (!row || row.length < 8) continue;
    const monthName = String(row[1] || '').trim();
    const monthIdx = months.findIndex(m => m.toLowerCase() === monthName.toLowerCase());
    if (monthIdx < 0) continue;
    
    targets[monthsJP[monthIdx]] = {
      '登録目標': parseNumber(row[2]) || 0,
      'FTD目標': parseNumber(row[3]) || 0,
      'MAU目標': parseNumber(row[4]) || 0,
      '入金額目標': (parseNumber(row[5]) || 0) * USD_TO_JPY,
      'ターンオーバー目標': (parseNumber(row[6]) || 0) * USD_TO_JPY,
      'AFF固定費目標': (parseNumber(row[7]) || 0) * USD_TO_JPY,
      'NGR目標': (parseNumber(row[8]) || 0) * USD_TO_JPY
    };
  }
  
  // 実績データを読み取り
  let currentMonth = null;
  let monthlyData = {};
  let weeklyDetails = {};
  
  for (let i = 16; i < lines.length; i++) {
    const row = lines[i];
    if (!row || row.length < 8) continue;
    
    const col0 = String(row[0] || '').trim();
    const col1 = String(row[1] || '').trim();
    
    // 月名の検出
    const monthIdx = months.findIndex(m => m.toLowerCase() === col0.toLowerCase());
    if (monthIdx >= 0) {
      currentMonth = monthsJP[monthIdx];
      if (!monthlyData[currentMonth]) {
        monthlyData[currentMonth] = { weeks: [], totals: null };
        weeklyDetails[currentMonth] = [];
      }
    }
    
    if (!currentMonth) continue;
    
    // Week行またはIn Total行
    const isWeek = col1.toLowerCase().includes('week');
    const isTotal = col1.toLowerCase().includes('in total') || col1.toLowerCase().includes('total');
    
    if (isWeek || isTotal) {
      const weekData = {
        週: col1,
        登録: parseNumber(row[2]) || 0,
        FTD: parseNumber(row[3]) || 0,
        MAU: parseNumber(row[4]) || 0,
        入金額: (parseNumber(row[5]) || 0) * USD_TO_JPY,
        ターンオーバー: (parseNumber(row[6]) || 0) * USD_TO_JPY,
        'AFF固定費': (parseNumber(row[7]) || 0) * USD_TO_JPY,
        NGR: (parseNumber(row[8]) || 0) * USD_TO_JPY,
        '登録達成率': parseNumber(row[9]) || 0,
        'FTD達成率': parseNumber(row[10]) || 0,
        'MAU達成率': parseNumber(row[11]) || 0,
        '入金額達成率': parseNumber(row[12]) || 0,
        'ターンオーバー達成率': parseNumber(row[13]) || 0,
        'AFF固定費達成率': parseNumber(row[14]) || 0,
        'NGR達成率': parseNumber(row[15]) || 0
      };
      
      if (isTotal) {
        monthlyData[currentMonth].totals = weekData;
      } else {
        weeklyDetails[currentMonth].push(weekData);
      }
    }
  }
  
  // ダッシュボード用データ構造に変換
  let count = 0;
  Object.keys(monthlyData).forEach(month => {
    const data = monthlyData[month];
    const target = targets[month] || {};
    const totals = data.totals || {};
    
    // 実績がない月はスキップ
    if (!totals.登録 && !totals.FTD && !totals.MAU) return;
    
    const periodName = `${year}年${month}`;
    const summary = {
      // 実績
      '登録': totals.登録 || 0,
      'FTD': totals.FTD || 0,
      'MAU': totals.MAU || 0,
      '入金額': totals.入金額 || 0,
      'ターンオーバー': totals.ターンオーバー || 0,
      'AFF固定費': totals['AFF固定費'] || 0,
      'NGR': totals.NGR || 0,
      // 目標
      '登録目標': target['登録目標'] || 0,
      'FTD目標': target['FTD目標'] || 0,
      'MAU目標': target['MAU目標'] || 0,
      '入金額目標': target['入金額目標'] || 0,
      'ターンオーバー目標': target['ターンオーバー目標'] || 0,
      'AFF固定費目標': target['AFF固定費目標'] || 0,
      'NGR目標': target['NGR目標'] || 0,
      // 達成率
      '登録達成率': totals['登録達成率'] || 0,
      'FTD達成率': totals['FTD達成率'] || 0,
      'MAU達成率': totals['MAU達成率'] || 0,
      '入金額達成率': totals['入金額達成率'] || 0,
      'ターンオーバー達成率': totals['ターンオーバー達成率'] || 0,
      'NGR達成率': totals['NGR達成率'] || 0,
      // 為替レート
      '為替レート(USD/JPY)': USD_TO_JPY
    };
    
    // 週次詳細データ
    const weeks = weeklyDetails[month] || [];
    
    BUSINESSES['Konibet'].data[periodName] = {
      サマリー: summary,
      ...(weeks.length > 0 ? { 週次詳細: weeks } : {})
    };
    count++;
  });
  
  showStatus(`Konibet KPI取込完了: ${count}期間 (${year}年) ※USD→JPY: ¥${USD_TO_JPY}換算`);
  selectBusiness('Konibet'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseSlotenCSV(lines, period, filename) {
  const kpi = {};
  let periodName = period;
  const match = filename.match(/(\d{4})(\d{2})/);
  if (match) periodName = `${match[1]}年${parseInt(match[2])}月`;
  lines.forEach((row, idx) => { if (!row || row.length < 2) return; const rawLabel = String(row[0] || '').trim(); if (!rawLabel || rawLabel === '項目名') return; const val = parseNumber(row[1]); if (val === null) return; const cleanLabel = rawLabel.split('/')[0].trim(); if (idx < 90 || kpi[cleanLabel] === undefined) kpi[cleanLabel] = val; });
  if (kpi['入出金差分'] === undefined && kpi['総入金額'] !== undefined && kpi['総出金額'] !== undefined) kpi['入出金差分'] = kpi['総入金額'] - kpi['総出金額'];
  BUSINESSES['スロ天'].data[periodName] = { サマリー: kpi };
  showStatus(`スロ天KPI取込完了: ${periodName}`);
  selectBusiness('スロ天'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseCustomerListCSV(lines, period, filename) {
  const fn = filename.toLowerCase();
  const isDSC = fn.includes('リストd') || fn.includes('d.csv') || filename.includes('リストD') || filename.includes('顧客リストD');
  const target = isDSC ? 'DSC' : '元amuse';
  
  // 4行目（index 3）がヘッダー行
  const headerRowIdx = 3;
  const header = lines[headerRowIdx] || [];
  const colIdx = {};
  
  // ヘッダーから列インデックスを取得
  header.forEach((h, idx) => { 
    const col = String(h).trim(); 
    if (col === 'FULLNAME1' || col === '名前') colIdx.name = idx; 
    if (col === 'credit' || col === '信用枠' || col === 'Credit') colIdx.credit = idx; 
    if (col.includes('トータル回収額') || col === '回収額') colIdx.collected = idx; 
    if (col.includes('トータル出金額') || col === '出金額') colIdx.withdraw = idx; 
    if (col.includes('トータル差分利益') || col === '差分利益') colIdx.diff = idx; 
    if (col === '入金回数') colIdx.depCount = idx; 
    if (col === '出金回数') colIdx.wdCount = idx; 
    if (col === 'NGR' && !colIdx.ngr) colIdx.ngr = idx;
    if (col === 'ボーナス付与総金額' || col === 'ボーナス' || col.includes('ボーナス')) colIdx.bonus = idx;
    if (col === 'プレイ月間' || col.includes('プレイ月')) colIdx.playMonths = idx;
    if (col === '事前清算回数' || col === '事前回数') colIdx.preSettleCount = idx;
    if (col === '事前清算金額' || col === '事前金額') colIdx.preSettleAmount = idx;
    if (col === '通常清算回数' || col === '通常回数' || col === '回収回数') colIdx.normalSettleCount = idx;
    if (col === '通常清算金額' || col === '通常金額' || col === '回収金額') colIdx.normalSettleAmount = idx;
    if (col === 'リスト種別' || col === 'リスト' || col === 'List') colIdx.listType = idx;
    if (col === 'FTD' || col === 'FTD日') colIdx.ftdDate = idx;
    if (col === 'FTW' || col === 'FTW日') colIdx.ftwDate = idx;
  });
  
  // AR列(44)からBE列(57)の範囲もチェック（リスト種別用）- 0始まりなので43から56
  if (colIdx.listType === undefined) {
    for (let i = 43; i <= 56; i++) {
      const col = String(header[i] || '').trim();
      if (col === 'リスト種別' || col === 'リスト' || col === 'List' || col.includes('リスト')) {
        colIdx.listType = i;
        break;
      }
    }
  }
  
  let stats = { 
    総登録数: 0, 総回収額: 0, 総出金額: 0, 総差分利益: 0, 総NGR: 0, 
    FTD数: 0, FTW数: 0, FTDW数: 0, 総信用枠: 0, 総ボーナス: 0, 総プレイ月間: 0, 
    事前清算回数: 0, 事前清算金額: 0, 通常清算回数: 0, 通常清算金額: 0 
  };
  const listTypes = {};
  
  // 5行目（index 4）からデータ開始
  for (let i = headerRowIdx + 1; i < lines.length; i++) { 
    const row = lines[i]; 
    if (!row || row.length < 5) continue; 
    
    const nameIdx = colIdx.name !== undefined ? colIdx.name : 1;
    const name = String(row[nameIdx] || '').trim(); 
    if (!name || name === '担当者' || name.includes('セル') || name === '' || name === 'FULLNAME1') continue;
    
    stats.総登録数++; 
    
    const collected = parseNumber(row[colIdx.collected]) || 0; 
    const withdraw = parseNumber(row[colIdx.withdraw]) || 0; 
    const diff = parseNumber(row[colIdx.diff]) || 0; 
    const ngr = parseNumber(row[colIdx.ngr]) || 0; 
    const credit = parseNumber(row[colIdx.credit]) || 0; 
    const bonus = parseNumber(row[colIdx.bonus]) || 0;
    const playMonths = parseNumber(row[colIdx.playMonths]) || 0;
    const preSettleCount = parseNumber(row[colIdx.preSettleCount]) || 0;
    const preSettleAmount = parseNumber(row[colIdx.preSettleAmount]) || 0;
    const normalSettleCount = parseNumber(row[colIdx.normalSettleCount]) || 0;
    const normalSettleAmount = parseNumber(row[colIdx.normalSettleAmount]) || 0;
    const depCount = parseNumber(row[colIdx.depCount]) || 0; 
    const wdCount = parseNumber(row[colIdx.wdCount]) || 0; 
    
    stats.総回収額 += collected; 
    stats.総出金額 += withdraw; 
    stats.総差分利益 += diff; 
    stats.総NGR += ngr; 
    stats.総信用枠 += credit;
    stats.総ボーナス += bonus;
    stats.総プレイ月間 += playMonths;
    stats.事前清算回数 += preSettleCount;
    stats.事前清算金額 += preSettleAmount;
    stats.通常清算回数 += normalSettleCount;
    stats.通常清算金額 += normalSettleAmount;
    
    // FTD/FTW判定
    const ftdDate = row[colIdx.ftdDate] ? String(row[colIdx.ftdDate]).trim() : '';
    const ftwDate = row[colIdx.ftwDate] ? String(row[colIdx.ftwDate]).trim() : '';
    const hasFTD = ftdDate !== '' || depCount > 0 || collected > 0; 
    const hasFTW = ftwDate !== '' || wdCount > 0 || withdraw > 0; 
    if (hasFTD) { stats.FTD数++; if (hasFTW) stats.FTDW数++; } 
    if (hasFTW) stats.FTW数++;
    
    // リスト種別集計（B, E, T, S, BE, C, 紹介のみ、それ以外はその他）
    if (colIdx.listType !== undefined) {
      let listType = String(row[colIdx.listType] || '').trim();
      if (listType && listType !== '' && listType !== 'リスト種別') {
        const validTypes = ['B', 'E', 'T', 'S', 'BE', 'C', '紹介'];
        if (!validTypes.includes(listType)) {
          listType = 'その他';
        }
        if (!listTypes[listType]) listTypes[listType] = 0;
        listTypes[listType]++;
      }
    }
  }
  
  // 計算項目
  stats['FTD率'] = stats.総登録数 > 0 ? stats.FTD数 / stats.総登録数 : 0;
  stats['FTW率'] = stats.総登録数 > 0 ? stats.FTW数 / stats.総登録数 : 0;
  stats['FTDW率'] = stats.FTD数 > 0 ? stats.FTDW数 / stats.FTD数 : 0;
  stats['回収出金差分'] = stats.総回収額 - stats.総出金額;
  stats['平均信用枠'] = stats.総登録数 > 0 ? stats.総信用枠 / stats.総登録数 : 0;
  stats['平均Credit単価'] = stats.FTD数 > 0 ? stats.総信用枠 / stats.FTD数 : 0;
  stats['平均プレイ月間'] = stats.総登録数 > 0 ? stats.総プレイ月間 / stats.総登録数 : 0;
  
  // 事前清算・通常清算の割合
  const totalSettleAmount = stats.事前清算金額 + stats.通常清算金額;
  const totalSettleCount = stats.事前清算回数 + stats.通常清算回数;
  stats['事前清算割合'] = totalSettleAmount > 0 ? stats.事前清算金額 / totalSettleAmount : 0;
  stats['通常清算割合'] = totalSettleAmount > 0 ? stats.通常清算金額 / totalSettleAmount : 0;
  stats['事前清算件数割合'] = totalSettleCount > 0 ? stats.事前清算回数 / totalSettleCount : 0;
  stats['通常清算件数割合'] = totalSettleCount > 0 ? stats.通常清算回数 / totalSettleCount : 0;
  
  const existing = BUSINESSES[target].data[period]?.サマリー || {};
  // 0の値で既存データを上書きしない
  const mergedStats = { ...existing };
  Object.entries(stats).forEach(([key, val]) => {
    if (val !== 0 || existing[key] === undefined) {
      mergedStats[key] = val;
    }
  });
  BUSINESSES[target].data[period] = { 
    サマリー: mergedStats,
    ...(Object.keys(listTypes).length > 0 ? { リスト種別: listTypes } : (BUSINESSES[target].data[period]?.リスト種別 ? { リスト種別: BUSINESSES[target].data[period].リスト種別 } : {}))
  };
  
  const listInfo = Object.keys(listTypes).length > 0 ? `, リスト種別${Object.keys(listTypes).length}種(${Object.entries(listTypes).map(([k,v])=>k+':'+v).join(',')})` : '';
  showStatus(`顧客リスト取込完了: ${target} ${stats.総登録数}件, FTD${stats.FTD数}件, 事前清算${stats.事前清算回数}件/${formatCurrency(stats.事前清算金額)}${listInfo}`);
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseUncollectedCSV(lines, period, filename) {
  const fn = filename.toLowerCase();
  const isDSC = fn.includes('シートd') || fn.includes('d.csv') || filename.includes('シートD');
  const target = isDSC ? 'DSC' : '元amuse';
  let total = 0, count = 0;
  for (let i = 0; i < Math.min(5, lines.length); i++) { const row = lines[i]; if (!row) continue; const rowStr = row.join(','); if (rowStr.includes('未回収金総額')) { for (let j = 0; j < row.length; j++) { const val = parseNumber(row[j]); if (val && val > 1000000) { total = val; break; } } for (let j = 0; j < row.length; j++) { const val = parseNumber(row[j]); if (val && val > 0 && val < 10000) { count = val; break; } } break; } }
  if (total === 0) { const colIdx = lines[0].findIndex(h => String(h).includes('残未回収')); for (let i = 1; i < lines.length; i++) { const val = parseNumber(lines[i][colIdx >= 0 ? colIdx : 0]) || 0; total += val; } count = lines.length - 1; }
  const data = { '未回収者数': count, '残未回収金額': total };
  const existing = BUSINESSES[target].data[period]?.サマリー || {};
  BUSINESSES[target].data[period] = { サマリー: { ...existing, ...data } };
  showStatus(`未回収シート取込完了: ${target} ${count}人, ${formatCurrency(total)}`);
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseBonusCSV(lines, period, filename) {
  const fn = filename.toLowerCase();
  const isDSC = fn.includes('ボーナスd') || fn.includes('d.csv') || filename.includes('ボーナスD');
  const target = isDSC ? 'DSC' : '元amuse';
  let totalBonus = 0, count = 0;
  for (let i = 0; i < lines.length; i++) { const row = lines[i]; if (!row) continue; const firstCol = String(row[0] || '').trim().toUpperCase(); if (firstCol === 'TOTAL') { totalBonus = parseNumber(row[1]) || 0; break; } }
  let foundTotal = false;
  for (let i = 1; i < lines.length; i++) { const row = lines[i]; if (!row) continue; const firstCol = String(row[0] || '').trim().toUpperCase(); if (firstCol === 'TOTAL') { foundTotal = true; continue; } if (!foundTotal) continue; if (row[3] && String(row[3]).trim()) count++; }
  const data = { 'ボーナス対象者数': count, '総ボーナス付与金額': totalBonus };
  const existing = BUSINESSES[target].data[period]?.サマリー || {};
  BUSINESSES[target].data[period] = { サマリー: { ...existing, ...data } };
  showStatus(`ボーナスシート取込完了: ${target} ${count}人, ${formatCurrency(totalBonus)}`);
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseDelayedCSV(lines, period, filename) {
  const fn = filename.toLowerCase();
  const isDSC = fn.includes('回収d') || fn.includes('d.csv') || filename.includes('回収D');
  const target = isDSC ? 'DSC' : '元amuse';
  let totalDelayed = 0, count = 0;
  const header = lines[0] || [];
  const amountIdx = header.findIndex(h => String(h).includes('今回返済金額'));
  for (let i = 1; i < lines.length; i++) { const row = lines[i]; if (!row || row.length < 10) continue; const amount = parseNumber(row[amountIdx >= 0 ? amountIdx : 10]) || 0; if (amount > 0) { totalDelayed += amount; count++; } }
  const data = { '遅れ回収件数': count, '遅れ回収金額': totalDelayed };
  const existing = BUSINESSES[target].data[period]?.サマリー || {};
  BUSINESSES[target].data[period] = { サマリー: { ...existing, ...data } };
  showStatus(`遅れ回収シート取込完了: ${target} ${count}件, ${formatCurrency(totalDelayed)}`);
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

// SAM顧客管理シート用パーサー
function parseCustomerManagementCSV(lines, period, filename) {
  const fn = filename.toLowerCase();
  // ファイル名末尾にDがあればDSC、なければAMUSE
  const isDSC = fn.includes('d.csv') || fn.includes('月d.csv') || filename.includes('D.csv') || filename.match(/月D\.csv$/i) || filename.match(/\d月D\./i);
  const target = isDSC ? 'DSC' : '元amuse';
  
  // ファイル名から期間を抽出（例: "SAM顧客管理シート_-_2025年10月D.csv"）
  const periodMatch = filename.match(/(\d{4})年(\d{1,2})月/);
  let periodName = period;
  if (periodMatch) {
    periodName = `${periodMatch[1]}年${parseInt(periodMatch[2])}月`;
  }
  
  // ヘッダー行からカラム位置を特定
  const header = lines[0] || [];
  const colMap = {};
  header.forEach((cell, idx) => {
    const h = String(cell || '').trim();
    if (h.includes('事前精算金額')) colMap['事前精算金額'] = idx;
    else if (h.includes('今月分回収額')) colMap['今月分回収額'] = idx;
    else if (h.includes('回収率') && h.includes('今月')) colMap['回収率(今月)'] = idx;
    else if (h.includes('回収率') && h.includes('全')) colMap['回収率(全体)'] = idx;
    else if (h.includes('信用枠金額')) colMap['信用枠金額'] = idx;
    else if (h.includes('回収予定金額')) colMap['回収予定金額'] = idx;
    else if (h.includes('回収済金額')) colMap['回収済金額'] = idx;
    else if (h.includes('出金済金額')) colMap['出金済金額'] = idx;
    else if (h === '差分') colMap['差分'] = idx;
  });
  
  // 合計行を探す
  let totalRow = null;
  for (let i = 0; i < lines.length; i++) {
    const row = lines[i];
    if (!row) continue;
    for (let j = 0; j < Math.min(row.length, 10); j++) {
      const cell = String(row[j] || '').trim();
      if (cell === '合計') {
        totalRow = row;
        break;
      }
    }
    if (totalRow) break;
  }
  
  const extracted = {};
  
  const parseYen = (val) => {
    if (!val) return null;
    const s = String(val).replace(/[¥￥,\s]/g, '').replace(/%/g, '');
    const n = parseFloat(s);
    return isNaN(n) ? null : n;
  };
  
  if (totalRow) {
    if (colMap['事前精算金額'] !== undefined) extracted['事前精算金額'] = parseYen(totalRow[colMap['事前精算金額']]);
    if (colMap['今月分回収額'] !== undefined) extracted['回収金額'] = parseYen(totalRow[colMap['今月分回収額']]);
    if (colMap['回収率(今月)'] !== undefined) {
      const rate = parseYen(totalRow[colMap['回収率(今月)']]);
      if (rate !== null) extracted['回収率(今月)'] = rate > 1 ? rate / 100 : rate;
    }
    if (colMap['回収率(全体)'] !== undefined) {
      const rate = parseYen(totalRow[colMap['回収率(全体)']]);
      if (rate !== null) extracted['回収率(全体)'] = rate > 1 ? rate / 100 : rate;
    }
    if (colMap['信用枠金額'] !== undefined) extracted['総信用枠'] = parseYen(totalRow[colMap['信用枠金額']]);
    if (colMap['回収予定金額'] !== undefined) extracted['回収予定金額'] = parseYen(totalRow[colMap['回収予定金額']]);
    if (colMap['回収済金額'] !== undefined) extracted['回収済金額'] = parseYen(totalRow[colMap['回収済金額']]);
    if (colMap['出金済金額'] !== undefined) extracted['出金金額'] = parseYen(totalRow[colMap['出金済金額']]);
    if (colMap['差分'] !== undefined) extracted['GGR(回収金額-出金金額)'] = parseYen(totalRow[colMap['差分']]);
  }
  
  // 詳細ヘッダー行を探す（KYCで始まる行）
  let detailStart = -1;
  let detailColMap = {};
  for (let i = 0; i < lines.length; i++) {
    const row = lines[i];
    if (row && String(row[0] || '').trim() === 'KYC') {
      detailStart = i;
      row.forEach((cell, idx) => {
        const h = String(cell || '').trim();
        if (h === '精算日') detailColMap['精算日'] = idx;
        else if (h === '信用枠') detailColMap['信用枠'] = idx;
        else if (h === '回収完了金額') detailColMap['回収完了金額'] = idx;
        else if (h === '回収金額') detailColMap['回収金額詳細'] = idx;
      });
      break;
    }
  }
  
  // 日次統計を集計
  const dailyStats = {};
  if (detailStart >= 0 && detailColMap['精算日'] !== undefined) {
    for (let i = detailStart + 1; i < lines.length; i++) {
      const row = lines[i];
      if (!row || row.length < 12) continue;
      
      let date = String(row[detailColMap['精算日']] || '').trim();
      // 正規の日付形式のみ（次サイクルなどは除外）
      if (!date || date.includes('次サイクル') || !date.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) continue;
      
      const credit = parseYen(row[detailColMap['信用枠']]) || 0;
      const collection = parseYen(row[detailColMap['回収完了金額']]) || 0;
      
      if (!dailyStats[date]) {
        dailyStats[date] = { 人数: 0, 信用枠合計: 0, 回収金額合計: 0, 信用枠リスト: [], 回収金額リスト: [] };
      }
      
      dailyStats[date].人数++;
      dailyStats[date].信用枠合計 += credit;
      dailyStats[date].回収金額合計 += collection;
      if (credit > 0) dailyStats[date].信用枠リスト.push(credit);
      if (collection > 0) dailyStats[date].回収金額リスト.push(collection);
    }
    
    // 中央値を計算
    Object.keys(dailyStats).forEach(date => {
      const s = dailyStats[date];
      s.信用枠リスト.sort((a, b) => a - b);
      s.回収金額リスト.sort((a, b) => a - b);
      s.信用枠中央値 = s.信用枠リスト.length > 0 ? 
        (s.信用枠リスト.length % 2 === 0 ? 
          (s.信用枠リスト[s.信用枠リスト.length/2-1] + s.信用枠リスト[s.信用枠リスト.length/2]) / 2 :
          s.信用枠リスト[Math.floor(s.信用枠リスト.length/2)]) : 0;
      s.回収金額中央値 = s.回収金額リスト.length > 0 ?
        (s.回収金額リスト.length % 2 === 0 ?
          (s.回収金額リスト[s.回収金額リスト.length/2-1] + s.回収金額リスト[s.回収金額リスト.length/2]) / 2 :
          s.回収金額リスト[Math.floor(s.回収金額リスト.length/2)]) : 0;
      delete s.信用枠リスト;
      delete s.回収金額リスト;
    });
  }
  
  // 既存データとマージ
  if (!BUSINESSES[target].data[periodName]) {
    BUSINESSES[target].data[periodName] = { サマリー: {} };
  }
  Object.assign(BUSINESSES[target].data[periodName].サマリー, extracted);
  
  // 日次統計を追加
  if (Object.keys(dailyStats).length > 0) {
    BUSINESSES[target].data[periodName].日次統計 = dailyStats;
  }
  
  const dailyCount = Object.keys(dailyStats).length;
  showStatus(`${target} ${periodName} 顧客管理データ取込完了: 回収金額 ¥${(extracted['回収金額'] || 0).toLocaleString()}、日次統計 ${dailyCount}日分`);
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

// 着金確認シート用パーサー（EC着金、Paypay、仮想通貨、個人）
function parsePaymentConfirmCSV(lines, period, fnLower, filename) {
  // ファイル名末尾にDがあればDSC、なければAMUSE
  const isDSC = fnLower.includes('d.csv') || fnLower.includes('着金確認d') || fnLower.includes('着金d') || 
    filename.includes('D.csv') || filename.match(/D\.csv$/i);
  const target = isDSC ? 'DSC' : '元amuse';
  
  // 着金種別を判定
  let paymentType = '';
  if (fnLower.includes('ec') || fnLower.includes('ｅｃ')) paymentType = 'EC';
  else if (fnLower.includes('paypay')) paymentType = 'Paypay';
  else if (fnLower.includes('仮想通貨')) paymentType = '仮想通貨';
  else if (fnLower.includes('個人')) paymentType = '個人';
  else paymentType = 'その他';
  
  const parseYen = (val) => {
    if (!val) return null;
    const s = String(val).replace(/[¥￥,\s"]/g, '');
    const n = parseFloat(s);
    return isNaN(n) ? null : n;
  };
  
  const parseDate = (val) => {
    if (!val) return null;
    const s = String(val).trim();
    let match = s.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
    if (match) return { year: parseInt(match[1]), month: parseInt(match[2]), day: parseInt(match[3]) };
    match = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if (match) return { year: parseInt(match[3]), month: parseInt(match[1]), day: parseInt(match[2]) };
    match = s.match(/^(\d{1,2})[\/\-](\d{1,2})$/);
    if (match) return { year: 2025, month: parseInt(match[1]), day: parseInt(match[2]) };
    return null;
  };
  
  // 月別統計を集計（仮想通貨は銘柄別・月別）
  const monthlyStats = {};
  const coinStats = {}; // 仮想通貨用：銘柄別・月別
  let totalCount = 0;
  let totalAmount = 0;
  
  for (let i = 0; i < lines.length; i++) {
    const row = lines[i];
    if (!row || row.length < 5) continue;
    
    let dateInfo = null;
    let amount = null;
    let phone = '';
    let coin = ''; // 仮想通貨銘柄
    
    if (paymentType === 'EC') {
      dateInfo = parseDate(row[3]);
      amount = parseYen(row[4]);
      phone = String(row[0] || '').replace(/[\s\-]/g, '');
    } else if (paymentType === 'Paypay') {
      dateInfo = parseDate(row[5]);
      amount = parseYen(row[4]);
      phone = String(row[1] || '').replace(/[\s\-]/g, '');
    } else if (paymentType === '個人') {
      dateInfo = parseDate(row[5]);
      amount = parseYen(row[4]);
      phone = String(row[1] || '').replace(/[\s\-]/g, '');
    } else if (paymentType === '仮想通貨') {
      const entryType = String(row[0] || '').trim();
      if (entryType !== '入金') continue;
      dateInfo = parseDate(row[1]);
      amount = parseYen(row[8]);
      phone = String(row[2] || '').replace(/[\s\-]/g, '');
      coin = String(row[5] || '').trim() || 'その他';
    }
    
    if (!dateInfo || !amount || amount <= 0) continue;
    if (phone && !phone.match(/^0\d/)) continue;
    
    const monthKey = `${dateInfo.year}年${dateInfo.month}月`;
    
    if (paymentType === '仮想通貨') {
      // 仮想通貨は銘柄別に集計
      if (!coinStats[coin]) coinStats[coin] = {};
      if (!coinStats[coin][monthKey]) {
        coinStats[coin][monthKey] = { 人数Set: new Set(), 回数: 0, 金額合計: 0, 金額リスト: [] };
      }
      if (phone) coinStats[coin][monthKey].人数Set.add(phone);
      coinStats[coin][monthKey].回数++;
      coinStats[coin][monthKey].金額合計 += amount;
      coinStats[coin][monthKey].金額リスト.push(amount);
    } else {
      // EC, Paypay, 個人は従来通り
      if (!monthlyStats[monthKey]) {
        monthlyStats[monthKey] = { 人数Set: new Set(), 回数: 0, 金額合計: 0, 金額リスト: [] };
      }
      if (phone) monthlyStats[monthKey].人数Set.add(phone);
      monthlyStats[monthKey].回数++;
      monthlyStats[monthKey].金額合計 += amount;
      monthlyStats[monthKey].金額リスト.push(amount);
    }
    
    totalCount++;
    totalAmount += amount;
  }
  
  // 中央値を計算してSetをカウントに変換
  const calcMedian = (stats) => {
    Object.keys(stats).forEach(key => {
      const s = stats[key];
      if (s.人数Set) {
        s.人数 = s.人数Set.size;
        delete s.人数Set;
      }
      if (s.金額リスト) {
        s.金額リスト.sort((a, b) => a - b);
        const len = s.金額リスト.length;
        s.中央値 = len > 0 ?
          (len % 2 === 0 ? (s.金額リスト[len/2-1] + s.金額リスト[len/2]) / 2 : s.金額リスト[Math.floor(len/2)]) : 0;
        delete s.金額リスト;
      }
    });
  };
  
  // データを格納
  if (!BUSINESSES[target].data['着金統計']) {
    BUSINESSES[target].data['着金統計'] = {};
  }
  
  if (paymentType === '仮想通貨') {
    // 仮想通貨は銘柄別に格納
    Object.keys(coinStats).forEach(coin => calcMedian(coinStats[coin]));
    BUSINESSES[target].data['着金統計']['仮想通貨'] = coinStats;
    const coinCount = Object.keys(coinStats).length;
    showStatus(`${target} 仮想通貨着金取込完了: ${totalCount}件, ¥${totalAmount.toLocaleString()}, ${coinCount}銘柄`);
  } else {
    calcMedian(monthlyStats);
    BUSINESSES[target].data['着金統計'][paymentType] = monthlyStats;
    const monthCount = Object.keys(monthlyStats).length;
    showStatus(`${target} ${paymentType}着金取込完了: ${totalCount}件, ¥${totalAmount.toLocaleString()}, ${monthCount}ヶ月分`);
  }
  
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseAgentCSV(lines, period) {
  let weeklyData = [];
  let totals = { 入金合計: 0, 出金合計: 0, 収益合計: 0, TO合計: 0, ローリング合計: 0, 大阪合計: 0 };
  for (let i = 2; i < lines.length; i++) { const row = lines[i]; if (!row || row.length < 17) continue; const col7 = (row[7] || '').trim(); const col12 = (row[12] || '').trim(); const isOldFormat = col7.includes('/') && !col7.toLowerCase().includes('kyoto'); const isNewFormat = col7 === '' && col12.includes('/'); if (isOldFormat || isNewFormat) { const 日付 = isOldFormat ? col7 : col12; const 入金 = parseNumber(row[8]) || 0; const 出金 = parseNumber(row[9]) || 0; const 収益 = parseNumber(row[11]) || 0; const TO = parseNumber(row[13]) || 0; const ローリング = parseNumber(row[14]) || 0; const 大阪 = parseNumber(row[16]) || 0; const ローリング報酬 = ローリング + 大阪; const NGR = 収益 - ローリング報酬; totals.入金合計 += 入金; totals.出金合計 += 出金; totals.収益合計 += 収益; totals.TO合計 += TO; totals.ローリング合計 += ローリング; totals.大阪合計 += 大阪; weeklyData.push({ 日付, 入金, 出金, 収益, 'T/O': TO, ローリング, 大阪, ローリング報酬, NGR }); } }
  const ローリング報酬合計 = totals.ローリング合計 + totals.大阪合計;
  const NGR合計 = totals.収益合計 - ローリング報酬合計;
  BUSINESSES['AMUSEVIP'].data['全期間'] = { サマリー: { ...totals, 'ローリング報酬': ローリング報酬合計, 'NGR': NGR合計, '精算回数': weeklyData.length }, 週別: weeklyData };
  showStatus(`エージェント取込完了: ${weeklyData.length}回, 収益${formatCurrency(totals.収益合計)}`);
  selectBusiness('AMUSEVIP'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseAdsCSV(lines, period) {
  const header = lines[0].map(h => String(h || '').toLowerCase().replace(/\n/g, '').trim());
  const costIdx = header.findIndex(h => h.includes('コスト') || h === 'cost');
  const impIdx = header.findIndex(h => h.includes('インプレッション') || h.includes('imp'));
  const clickIdx = header.findIndex(h => h.includes('クリック') || h.includes('click'));
  const regIdx = header.findIndex(h => h === '登録数' || h === 'registrations');
  const depIdx = header.findIndex(h => h === '入金数' || h === 'deposits');
  let totals = { コスト: 0, インプレッション: 0, クリック: 0, 登録: 0, 入金: 0 };
  let foundTotal = false;
  // TOTAL行を探してその値を使用
  for (let i = 1; i < lines.length; i++) {
    const row = lines[i]; if (!row || row.length < 5) continue;
    const firstCell = String(row[0] || '').trim().toLowerCase();
    // TOTAL行を検出（"total", "合計", 月名+total など）
    if (firstCell.includes('total') || firstCell.includes('合計')) {
      foundTotal = true;
      const parseVal = (idx, fb) => { if (idx < 0 && fb < 0) return 0; const v = row[idx >= 0 ? idx : fb] || ''; return parseFloat(String(v).replace(/[$￥¥,"\s]/g, '')) || 0; };
      totals.コスト = parseVal(costIdx, 1);
      totals.インプレッション = parseVal(impIdx, 2);
      totals.クリック = parseVal(clickIdx, 3);
      totals.登録 = parseVal(regIdx, 4);
      totals.入金 = parseVal(depIdx, 5);
      break; // 最初のTOTAL行を使用
    }
  }
  // TOTAL行がない場合は従来通り合計
  if (!foundTotal) {
    for (let i = 1; i < lines.length; i++) { const row = lines[i]; if (!row || row.length < 5) continue; const parseVal = (idx, fb) => { if (idx < 0 && fb < 0) return 0; const v = row[idx >= 0 ? idx : fb] || ''; return parseFloat(String(v).replace(/[$￥¥,"\s]/g, '')) || 0; }; totals.コスト += parseVal(costIdx, 1); totals.インプレッション += parseVal(impIdx, 2); totals.クリック += parseVal(clickIdx, 3); totals.登録 += parseVal(regIdx, 4); totals.入金 += parseVal(depIdx, 5); }
  }
  const ctr = totals.インプレッション > 0 ? totals.クリック / totals.インプレッション : 0;
  const cvr = totals.クリック > 0 ? totals.登録 / totals.クリック : 0;
  const costYen = totals.コスト < 10000 ? totals.コスト * 150 : totals.コスト;
  const regCpaYen = totals.登録 > 0 ? costYen / totals.登録 : 0;
  const depCpaYen = totals.入金 > 0 ? costYen / totals.入金 : 0;
  BUSINESSES['広告'].data['全期間'] = { サマリー: { 'コスト(税込)': costYen, 'インプレッション': totals.インプレッション, 'クリック': totals.クリック, '登録数': totals.登録, '入金数': totals.入金, 'CTR': ctr, 'CVR': cvr, '登録CPA': regCpaYen, '入金CPA': depCpaYen } };
  showStatus(`広告データ取込完了: 登録${totals.登録}件, 入金${totals.入金}件`);
  selectBusiness('広告'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

// ========== Excel処理 ==========
function handleExcel(workbook, period, uploadType, filename) {
  const sheetNames = workbook.SheetNames;
  const fn = filename.toLowerCase();
  const slotenSheets = sheetNames.filter(s => /^\d{6}$/.test(s));
  if (uploadType === 'sloten' || (uploadType === 'auto' && (slotenSheets.length > 0 || fn.includes('スロ天') || fn.includes('kpi')))) { parseSlotenExcel(workbook, slotenSheets); return; }
  const hasBaccaraSheet = sheetNames.includes('ダッシュボード') || sheetNames.includes('コスト') || sheetNames.some(s => s.includes('バカラ'));
  if (uploadType === 'baccarat' || (uploadType === 'auto' && (hasBaccaraSheet || fn.includes('バカラ') || fn.includes('baccara')))) { parseBaccaratExcel(workbook, period); return; }
  const revenueSheets = sheetNames.filter(s => s.includes('収益') && !s.includes('import'));
  if (revenueSheets.length > 0) { parseSamExcel(workbook, revenueSheets); return; }
  parseGenericExcel(workbook, period);
}

function parseSlotenExcel(workbook, monthlySheets) {
  let count = 0;
  const primaryKeys = ['GGR', '総入金額', '総出金額', '入出金差分', 'T/O', 'RTP', 'NGR', '登録人数', 'ログインユーザー数', 'GGRLTV'];
  monthlySheets.forEach(sheetName => {
    const sheet = workbook.Sheets[sheetName];
    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    const kpi = {}, depositMethods = {}, withdrawMethods = {}, gameData = {}, affData = {}, cryptoData = {}, providerData = {};
    data.forEach((row, idx) => { if (!row || row.length < 2) return; const rawLabel = String(row[0] || '').trim(); if (!rawLabel || rawLabel === '項目名' || rawLabel.includes('【')) return; const label = rawLabel.split('/')[0].trim(); const val = parseNumber(row[1]); if (val === null) return; const isPrimaryKey = primaryKeys.some(pk => label === pk || label.startsWith(pk)); if (isPrimaryKey && kpi[label] !== undefined) return; if (idx < 90 || !isPrimaryKey) kpi[label] = val; });
    for (let i = 191; i < Math.min(198, data.length); i++) { const row = data[i]; if (row && row[0] && row[1] !== undefined) { const key = String(row[0]).trim(); if (key && key !== '入金' && key !== '合計金額') { const val = parseNumber(row[1]); if (val !== null && val > 0) depositMethods[key] = val; } } }
    for (let i = 199; i < Math.min(206, data.length); i++) { const row = data[i]; if (row && row[0] && row[1] !== undefined) { const key = String(row[0]).trim(); if (key && key !== '出金' && key !== '合計金額') { const val = parseNumber(row[1]); if (val !== null && val > 0) withdrawMethods[key] = val; } } }
    for (let i = 216; i < Math.min(227, data.length); i++) { const row = data[i]; if (row && row[0]) { const key = String(row[0]).trim(); if (key && /^(BTC|ETH|USDT|TRX|XRP|LTC)/i.test(key)) { const cnt = parseNumber(row[1]) || 0; const amt = parseNumber(row[2]) || 0; if (cnt > 0 || amt > 0) cryptoData[key] = { 件数: cnt, 金額: amt }; } } }
    for (let i = 226; i < Math.min(270, data.length); i++) { const row = data[i]; if (row && row[0]) { const key = String(row[0]).trim(); if (key === 'プロバイダー' || key.includes('アクティブ')) continue; const users = parseNumber(row[1]) || 0; const bet = parseNumber(row[2]) || 0; const payout = parseNumber(row[3]) || 0; if (users > 0 || bet > 0) providerData[key] = { ユーザー数: users, 賭け金額: bet, 配当金額: payout, GGR: bet - payout }; } }
    const gamePositions = [{ name: 'パチンコ', userRow: 123, toRow: 124, ggrRow: 127 },{ name: 'パチスロ', userRow: 142, toRow: 143, ggrRow: 146 },{ name: 'スロット', userRow: 161, toRow: 162, ggrRow: 165 },{ name: 'ライブ', userRow: 180, toRow: 181, ggrRow: 184 }];
    gamePositions.forEach(g => { if (data[g.userRow] && data[g.toRow] && data[g.ggrRow]) { gameData[g.name] = { ユーザー数: parseNumber(data[g.userRow]?.[1]) || 0, TO: parseNumber(data[g.toRow]?.[1]) || 0, GGR: parseNumber(data[g.ggrRow]?.[1]) || 0 }; } });
    for (let i = 92; i < Math.min(112, data.length); i++) { const row = data[i]; if (row && row[0] && row[1] !== undefined) { const key = String(row[0]).trim().split('/')[0].trim(); if (key && key.includes('AFF')) { const val = parseNumber(row[1]); if (val !== null) affData[key] = val; } } }
    const year = sheetName.substring(0, 4), month = parseInt(sheetName.substring(4, 6)), periodName = `${year}年${month}月`;
    if (Object.keys(kpi).length > 0) {
      BUSINESSES['スロ天'].data[periodName] = { サマリー: kpi, ...(Object.keys(depositMethods).length > 0 ? { 入金方法: depositMethods } : {}), ...(Object.keys(withdrawMethods).length > 0 ? { 出金方法: withdrawMethods } : {}), ...(Object.keys(cryptoData).length > 0 ? { 仮想通貨: cryptoData } : {}), ...(Object.keys(providerData).length > 0 ? { プロバイダー: providerData } : {}), ...(Object.keys(gameData).length > 0 ? { ゲーム別: gameData } : {}), ...(Object.keys(affData).length > 0 ? { Affiliate: affData } : {}) };
      count++;
    }
  });
  showStatus(`スロ天データ取込完了: ${count}期間`);
  selectBusiness('スロ天'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseBaccaratExcel(workbook, period) {
  // 各シートを取得
  const dashSheetName = workbook.SheetNames.find(s => s.includes('ダッシュボード') || s.includes('サマリー'));
  const dashSheet = dashSheetName ? workbook.Sheets[dashSheetName] : null;
  const costSheet = workbook.Sheets['コスト'] || workbook.Sheets['cost'];
  const userSheet = workbook.Sheets['ユーザー・収益分析'] || workbook.Sheets['ユーザー分析'];
  const followerSheet = workbook.Sheets['SNSフォロワー数'] || workbook.Sheets['フォロワー数'];
  
  const extractedData = {
    'Twitter': 0, 'Instagram': 0, 'TikTok': 0, 'YouTube': 0, 'LINE公式': 0, 'KICK': 0,
    '総ユーザー数': 0, '総入金額': 0, '平均T/O': 0, '総GGR': 0, 'コミッション': 0, 'コスト': 0, 'NGR': 0
  };
  
  // SNSフォロワー数シートから最新データを取得
  if (followerSheet) {
    const followerData = XLSX.utils.sheet_to_json(followerSheet, { header: 1 });
    // ヘッダー行を探す
    let colMap = {};
    followerData.forEach((row, idx) => {
      if (!row) return;
      const first = String(row[0] || '').trim();
      if (first === '日付' || first.includes('日付')) {
        row.forEach((cell, colIdx) => {
          const h = String(cell || '').trim();
          if (h === 'Twitter' || h === 'X') colMap['Twitter'] = colIdx;
          else if (h === 'Instagram') colMap['Instagram'] = colIdx;
          else if (h === 'TikTok') colMap['TikTok'] = colIdx;
          else if (h === 'YouTube') colMap['YouTube'] = colIdx;
          else if (h.includes('LINE')) colMap['LINE公式'] = colIdx;
          else if (h === 'KICK' || h === 'Kick') colMap['KICK'] = colIdx;
        });
      }
    });
    // 最新の有効なデータを下から探す
    for (let i = followerData.length - 1; i >= 0; i--) {
      const row = followerData[i];
      if (!row) continue;
      let hasData = false;
      for (const [key, colIdx] of Object.entries(colMap)) {
        const val = parseNumber(row[colIdx]);
        if (val !== null && val > 0 && extractedData[key] === 0) {
          extractedData[key] = val;
          hasData = true;
        }
      }
      if (hasData) break;
    }
  }
  
  // ダッシュボードシートからサマリーデータを抽出
  if (dashSheet) {
    const dashData = XLSX.utils.sheet_to_json(dashSheet, { header: 1 });
    dashData.forEach(row => {
      if (!row || row.length < 2) return;
      const label = String(row[0] || '').trim();
      const value = parseNumber(row[1]);
      if (value === null) return;
      
      // ユーザー・収益
      if (label.includes('総ユーザー')) extractedData['総ユーザー数'] = value;
      else if (label.includes('総入金')) extractedData['総入金額'] = value;
      else if (label.includes('平均T/O') || label.includes('平均TO')) extractedData['平均T/O'] = value;
      else if (label.includes('総GGR') || (label.includes('GGR') && !label.includes('NGR'))) extractedData['総GGR'] = value;
      else if (label.includes('コミッション')) extractedData['コミッション'] = value;
      else if (label === 'コスト' || label === 'cost') extractedData['コスト'] = value;
      else if (label === 'NGR' || label.includes('NGR')) extractedData['NGR'] = value;
    });
  }
  
  // ユーザー・収益分析シートから合計行を取得（ダッシュボードにない場合のフォールバック）
  if (userSheet) {
    const userData = XLSX.utils.sheet_to_json(userSheet, { header: 1 });
    // ヘッダー行を探す
    let headerIdx = -1;
    let colMap = {};
    userData.forEach((row, idx) => {
      if (!row) return;
      const first = String(row[0] || '').trim();
      if (first === '日付' || first.includes('日付')) {
        headerIdx = idx;
        row.forEach((cell, colIdx) => {
          const h = String(cell || '').trim();
          if (h.includes('ユーザー')) colMap['users'] = colIdx;
          else if (h.includes('入金額')) colMap['deposit'] = colIdx;
          else if (h.includes('T/O') || h.includes('ターンオーバー')) colMap['to'] = colIdx;
          else if (h.includes('GGR')) colMap['ggr'] = colIdx;
        });
      }
      // 合計行
      if (first === '合計') {
        if (colMap['users'] && extractedData['総ユーザー数'] === 0) {
          const v = parseNumber(row[colMap['users']]);
          if (v !== null) extractedData['総ユーザー数'] = v;
        }
        if (colMap['deposit'] && extractedData['総入金額'] === 0) {
          const v = parseNumber(row[colMap['deposit']]);
          if (v !== null) extractedData['総入金額'] = v;
        }
        if (colMap['ggr'] && extractedData['総GGR'] === 0) {
          const v = parseNumber(row[colMap['ggr']]);
          if (v !== null) extractedData['総GGR'] = v;
        }
      }
    });
  }
  
  // コストシートから合計を取得
  if (costSheet) {
    const costData = XLSX.utils.sheet_to_json(costSheet, { header: 1 });
    costData.forEach(row => {
      if (!row) return;
      const label = String(row[0] || '').trim();
      if (label === '合計' || label.toLowerCase() === 'total') {
        // 金額列（通常は列2）
        const costVal = parseNumber(row[2]) || parseNumber(row[1]) || 0;
        if (costVal > 0 && extractedData['コスト'] === 0) extractedData['コスト'] = costVal;
      }
    });
  }
  
  // NGRが0の場合は計算
  if (extractedData['NGR'] === 0 && (extractedData['総GGR'] !== 0 || extractedData['コスト'] !== 0)) {
    extractedData['NGR'] = extractedData['総GGR'] - extractedData['コスト'];
  }
  
  // フォロワー数合計を計算
  extractedData['合計フォロワー'] = extractedData['Twitter'] + extractedData['Instagram'] + 
                                   extractedData['TikTok'] + extractedData['YouTube'] + extractedData['LINE公式'] + extractedData['KICK'];
  
  // データを保存
  BUSINESSES['バカラツール'].data['全期間'] = { サマリー: extractedData };
  
  const ggrStr = extractedData['総GGR'] >= 0 ? `GGR ¥${Math.round(extractedData['総GGR']).toLocaleString()}` : `GGR ¥${Math.round(extractedData['総GGR']).toLocaleString()}`;
  const ngrStr = extractedData['NGR'] >= 0 ? `NGR ¥${Math.round(extractedData['NGR']).toLocaleString()}` : `NGR ¥${Math.round(extractedData['NGR']).toLocaleString()}`;
  showStatus(`バカラツール取込完了: ユーザー${extractedData['総ユーザー数']}人, ${ggrStr}, ${ngrStr}`);
  selectBusiness('バカラツール'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseSamExcel(workbook, revenueSheets) {
  let amuseCount = 0, dscCount = 0;
  revenueSheets.forEach(sheetName => { const sheet = workbook.Sheets[sheetName]; const data = XLSX.utils.sheet_to_json(sheet, { header: 1 }); const isDSC = sheetName.endsWith('D'); let periodName = sheetName.replace('収益', '').replace(/D$/, ''); const extracted = {}; data.forEach(row => { if (row[1] && row[2] !== undefined && row[2] !== null && row[2] !== '') { const key = String(row[1]).trim().replace(/（/g, '(').replace(/）/g, ')'); const val = parseNumber(row[2]); if (val !== null && !String(row[2]).startsWith('#') && !key.startsWith('0.')) extracted[key] = val; } if (row[3] && row[4] !== undefined && row[4] !== null && row[4] !== '') { const key = String(row[3]).trim().replace(/（/g, '(').replace(/）/g, ')'); const val = parseNumber(row[4]); if (val !== null && !String(row[4]).startsWith('#') && !key.startsWith('0.')) extracted[key] = val; } }); if (Object.keys(extracted).length > 0) { if (isDSC) { BUSINESSES['DSC'].data[periodName] = { サマリー: extracted }; dscCount++; } else { BUSINESSES['元amuse'].data[periodName] = { サマリー: extracted }; amuseCount++; } } });
  showStatus(`収益シート取込完了: 元amuse ${amuseCount}件, DSC ${dscCount}件`);
  if (dscCount > 0) selectBusiness('DSC'); else selectBusiness('元amuse');
  saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseGenericExcel(workbook, period) {
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
  const kpi = {};
  data.forEach(row => { if (!row || row.length < 2) return; const label = String(row[0] || '').trim(); const val = parseNumber(row[1]); if (label && val !== null) kpi[label] = val; });
  BUSINESSES[currentBusiness].data[period] = { サマリー: kpi };
  showStatus(`Excel取込完了: ${Object.keys(kpi).length}項目`);
  selectBusiness(currentBusiness); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function addBusiness() { const name = document.getElementById('new-business-name').value.trim(); const type = document.getElementById('new-business-type').value; if (!name) { alert('事業名を入力してください'); return; } if (BUSINESSES[name]) { alert('同名の事業が存在します'); return; } BUSINESSES[name] = { data: {}, type: type }; saveBusinessData(); hideAddBusinessModal(); selectBusiness(name); }
function deleteBusiness() { if (Object.keys(BUSINESSES).length <= 1) { alert('最後の事業は削除できません'); return; } if (confirm(`「${currentBusiness}」を削除しますか？`)) { delete BUSINESSES[currentBusiness]; saveBusinessData(); selectBusiness(Object.keys(BUSINESSES)[0]); } }

// ========== 営業報告書プロンプト生成 ==========
function showReportPromptModal() {
  const business = BUSINESSES[currentBusiness];
  if (!business) { alert('事業を選択してください'); return; }
  
  let data;
  let periodLabel;
  if (viewMode === 'total') {
    const result = calculateTotalsAndAverages(currentBusiness);
    if (!result) { alert('データがありません'); return; }
    data = result.totals;
    periodLabel = '全期間トータル';
  } else {
    const periodData = business.data?.[currentPeriod];
    data = periodData?.サマリー || periodData || {};
    periodLabel = currentPeriod || '未選択';
  }
  
  if (!data || Object.keys(data).length === 0) { alert('データがありません'); return; }
  
  document.getElementById('report-business-period').textContent = `${currentBusiness} - ${periodLabel}`;
  document.getElementById('report-prompt-text').value = generateReportPrompt(currentBusiness, periodLabel, data, business.type);
  document.getElementById('report-prompt-modal').classList.remove('hidden');
}

function hideReportPromptModal() { document.getElementById('report-prompt-modal').classList.add('hidden'); }

function copyReportPrompt() {
  const text = document.getElementById('report-prompt-text').value;
  navigator.clipboard.writeText(text).then(() => {
    showStatus('📋 プロンプトをコピーしました');
  }).catch(() => {
    document.getElementById('report-prompt-text').select();
    document.execCommand('copy');
    showStatus('📋 プロンプトをコピーしました');
  });
}

function generateReportPrompt(businessName, period, data, type) {
  const formatVal = (key, val) => {
    if (val == null) return null;
    if (key.includes('率') || key.includes('割合') || key === 'RTP') {
      return (val * 100).toFixed(2) + '%';
    }
    if (typeof val === 'number') {
      if (Math.abs(val) >= 1000000) return '¥' + (val / 1000000).toFixed(2) + 'M';
      if (Math.abs(val) >= 1000) return '¥' + Math.round(val).toLocaleString();
      return val.toLocaleString();
    }
    return val;
  };
  
  let prompt = `以下は「${businessName}」の${period}の営業データです。このデータを元に営業報告書を作成してください。\n\n`;
  prompt += `【事業名】${businessName}\n【期間】${period}\n\n`;
  prompt += `【主要KPIデータ】\n`;
  
  // 事業タイプに応じた主要KPIの順序
  let keyOrder = [];
  if (type === 'konibet') {
    keyOrder = ['登録人数', 'FTD数', '入金者数', '総入金額', '総出金額', '入出金差分', 'T/O', 'GGR', 'NGR', 'ボーナス', 'ゲームプロバイダーフィー', 'PSP手数料', 'AFF報酬', 'アクティブプレイ人数', '新規入金転移率', '平均入金額', '出金人数割合', 'T/O倍率', 'ボーナス付与率', 'GGR率', 'NGR率', 'RTP'];
  } else if (type === 'sloten') {
    keyOrder = ['GGR', '総入金額', '総出金額', '入出金差分', 'T/O', 'RTP', 'NGR', '登録人数', 'ログインユーザー数'];
  } else if (type === 'baccara') {
    keyOrder = ['Twitter', 'Instagram', 'TikTok', 'YouTube', 'LINE公式', 'KICK', '合計フォロワー', '総ユーザー数', '総入金額', '平均T/O', '総GGR', 'コスト', 'NGR'];
  } else if (type === 'ads') {
    keyOrder = ['コスト(税込)', 'インプレッション', 'クリック', '登録数', '入金数', '登録CPA', '入金CPA', 'CTR', 'CVR'];
  } else {
    keyOrder = ['T/O', 'GGR', 'NGR', '回収率', '入出金差分'];
  }
  
  // 主要KPIを出力
  keyOrder.forEach(key => {
    const val = data[key];
    if (val != null) {
      prompt += `・${key}: ${formatVal(key, val)}\n`;
    }
  });
  
  // その他のKPIも出力
  prompt += `\n【その他データ】\n`;
  Object.keys(data).forEach(key => {
    if (!keyOrder.includes(key) && key !== '為替レート(USD/JPY)') {
      const val = data[key];
      if (val != null) {
        prompt += `・${key}: ${formatVal(key, val)}\n`;
      }
    }
  });
  
  prompt += `\n---\n`;
  prompt += `上記データを元に、以下の構成で営業報告書を作成してください：\n`;
  prompt += `1. サマリー（主要指標の概要）\n`;
  prompt += `2. 前期比較・トレンド分析（可能であれば）\n`;
  prompt += `3. 課題と改善点\n`;
  prompt += `4. 次期の目標・アクションプラン\n`;
  
  return prompt;
}

</script>
</body>
</html>
