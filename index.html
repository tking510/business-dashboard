<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº‹æ¥­åˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v7</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f1f5f9;min-height:100vh}
.container{max-width:1400px;margin:0 auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.header h1{font-size:24px;color:#1e293b}
.header-actions{display:flex;gap:10px;flex-wrap:wrap}
.card{background:white;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:20px;margin-bottom:20px}
.tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.tab{padding:10px 18px;border-radius:10px;border:none;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;background:#e2e8f0;color:#475569}
.tab:hover{background:#cbd5e1}
.tab.active{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white}
.btn{padding:10px 20px;border-radius:10px;border:none;cursor:pointer;font-weight:600;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white}
.btn-secondary{background:#f1f5f9;color:#475569}
.btn-danger{background:#fee2e2;color:#dc2626}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.summary-card{border-radius:12px;padding:14px;color:white;background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
.summary-card h3{font-size:10px;opacity:0.9;margin-bottom:4px;text-transform:uppercase}
.summary-card .value{font-size:18px;font-weight:700}
.chart-container{height:300px;margin:20px 0}
.pie-chart-container{height:250px;max-width:300px}
.period-selector{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.period-btn{padding:6px 14px;border-radius:8px;border:none;cursor:pointer;font-size:12px;background:#f1f5f9;color:#64748b;transition:all 0.2s}
.period-btn.active{background:#3b82f6;color:white}
.period-btn:hover{background:#e2e8f0}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:white;border-radius:16px;padding:30px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
.upload-zone{border:2px dashed #cbd5e1;border-radius:12px;padding:40px;text-align:center;cursor:pointer;transition:all 0.2s}
.upload-zone:hover,.upload-zone.dragover{border-color:#3b82f6;background:#eff6ff}
.hidden{display:none!important}
.table-container{overflow-x:auto;max-height:500px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:8px 10px;text-align:left;border-bottom:1px solid #e2e8f0}
th{background:#f8fafc;font-weight:600;color:#64748b;position:sticky;top:0}
tr:hover{background:#f8fafc}
.text-right{text-align:right}
.text-green{color:#16a34a}
.text-red{color:#dc2626}
input,select{padding:10px 14px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;width:100%}
input:focus,select:focus{outline:none;border-color:#3b82f6}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;color:#64748b;margin-bottom:6px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.section-title{font-size:16px;font-weight:600;color:#1e293b;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}
.kpi-item{background:#f8fafc;border-radius:10px;padding:12px}
.kpi-item .label{font-size:10px;color:#64748b;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.kpi-item .val{font-size:16px;font-weight:700;color:#1e293b}
.kpi-item .val.negative{color:#dc2626}
footer{text-align:center;color:#94a3b8;font-size:11px;margin-top:30px;padding:20px}
.totals-section{background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.totals-section .section-title{color:white}
.totals-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
.total-card{background:rgba(255,255,255,0.1);border-radius:12px;padding:16px;backdrop-filter:blur(10px)}
.total-card h4{font-size:11px;opacity:0.8;margin-bottom:8px;text-transform:uppercase}
.total-card .main-val{font-size:22px;font-weight:700;margin-bottom:4px}
.total-card .sub-val{font-size:12px;opacity:0.7}
.crypto-section{background:linear-gradient(135deg,#1e3a5f,#2d5a87);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.crypto-section .section-title{color:white}
.crypto-flex{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start}
.crypto-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;flex:1}
.crypto-card{background:rgba(255,255,255,0.95);border-radius:10px;padding:12px;color:#1e293b}
.crypto-card h5{font-size:10px;color:#64748b;margin-bottom:4px}
.crypto-card .crypto-val{font-size:16px;font-weight:700}
.crypto-card .crypto-pct{font-size:11px;color:#64748b}
.provider-section{background:linear-gradient(135deg,#4a1d6a,#6b2d8a);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.provider-section .section-title{color:white}
.provider-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.provider-card{background:rgba(255,255,255,0.15);border-radius:10px;padding:14px;backdrop-filter:blur(10px)}
.provider-card h5{font-size:12px;margin-bottom:8px;font-weight:600}
.provider-card .provider-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px}
.provider-card .stat-item{background:rgba(255,255,255,0.1);border-radius:6px;padding:6px 8px}
.provider-card .stat-label{opacity:0.7;font-size:9px}
.provider-card .stat-val{font-weight:600}
.game-section{background:linear-gradient(135deg,#1a472a,#2d6a4f);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.game-section .section-title{color:white}
.view-toggle{display:flex;gap:8px;margin-bottom:16px}
.view-toggle .toggle-btn{padding:8px 16px;border-radius:8px;border:2px solid #e2e8f0;background:white;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s}
.view-toggle .toggle-btn.active{border-color:#3b82f6;background:#eff6ff;color:#1d4ed8}
.chart-row{display:flex;gap:20px;flex-wrap:wrap}
.chart-row .pie-wrapper{flex:0 0 280px}
.chart-row .list-wrapper{flex:1;min-width:200px}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ“Š äº‹æ¥­åˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v7</h1>
    <div class="header-actions">
      <span id="sync-status" style="font-size:12px;color:#10b981;margin-right:10px">ğŸ’¾ èª­è¾¼ä¸­...</span>
      <button class="btn btn-primary" onclick="showUploadModal()">ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
      <button class="btn btn-secondary" onclick="createShareLink()">ğŸ”— å…±æœ‰ãƒªãƒ³ã‚¯</button>
      <button class="btn btn-secondary" onclick="showAddBusinessModal()">â• äº‹æ¥­è¿½åŠ </button>
      <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸</button>
    </div>
  </div>
  <div class="tabs" id="business-tabs"></div>
  <div class="view-toggle">
    <button class="toggle-btn active" onclick="setViewMode('period')" id="view-period">ğŸ“… æœŸé–“åˆ¥</button>
    <button class="toggle-btn" onclick="setViewMode('total')" id="view-total">ğŸ“Š å…¨æœŸé–“ãƒˆãƒ¼ã‚¿ãƒ«</button>
  </div>
  <div id="period-selector" class="period-selector"></div>
  <div id="totals-section" class="totals-section hidden">
    <div class="section-title">ğŸ“Š å…¨æœŸé–“ãƒˆãƒ¼ã‚¿ãƒ«ãƒ»å¹³å‡</div>
    <div id="totals-grid" class="totals-grid"></div>
  </div>
  <div id="summary-section"></div>
  
  <div class="card">
    <div class="section-title">ğŸ“ˆ æ¨ç§»ã‚°ãƒ©ãƒ•</div>
    <div class="chart-container"><canvas id="main-chart"></canvas></div>
  </div>
  
  <!-- ç¶™ç¶šKPIæ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆã‚¹ãƒ­å¤©ç”¨ï¼‰ -->
  <div id="retention-chart-section" class="card hidden">
    <div class="section-title">ğŸ“Š ç¶™ç¶šãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨ç§»</div>
    <div class="chart-container"><canvas id="retention-chart"></canvas></div>
  </div>
  
  <div id="kpi-sections"></div>
  
  <!-- ä»®æƒ³é€šè²¨éŠ˜æŸ„åˆ¥ï¼ˆå††ã‚°ãƒ©ãƒ•ä»˜ãï¼‰ -->
  <div id="crypto-section" class="crypto-section hidden">
    <div class="section-title">ğŸª™ ä»®æƒ³é€šè²¨éŠ˜æŸ„åˆ¥</div>
    <div class="crypto-flex">
      <div class="pie-wrapper"><div class="pie-chart-container"><canvas id="crypto-pie-chart"></canvas></div></div>
      <div class="list-wrapper"><div id="crypto-grid" class="crypto-grid"></div></div>
    </div>
  </div>
  
  <!-- ã‚²ãƒ¼ãƒ ç¨®åˆ¥ï¼ˆãƒ‘ãƒãƒ³ã‚³ãƒ»ãƒ‘ãƒã‚¹ãƒ­ãƒ»ã‚¹ãƒ­ãƒƒãƒˆãƒ»ãƒ©ã‚¤ãƒ–ï¼‰ -->
  <div id="game-section" class="game-section hidden">
    <div class="section-title">ğŸ° ã‚²ãƒ¼ãƒ ç¨®åˆ¥</div>
    <div class="chart-row">
      <div class="pie-wrapper"><div class="pie-chart-container"><canvas id="game-pie-chart"></canvas></div></div>
      <div class="list-wrapper"><div id="game-grid" class="provider-grid"></div></div>
    </div>
  </div>
  
  <!-- ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ -->
  <div id="provider-section" class="provider-section hidden">
    <div class="section-title">ğŸ­ ã‚²ãƒ¼ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥</div>
    <div class="chart-row">
      <div class="pie-wrapper"><div class="pie-chart-container"><canvas id="provider-pie-chart"></canvas></div></div>
      <div class="list-wrapper"><div id="provider-grid" class="provider-grid"></div></div>
    </div>
  </div>
  <div id="data-table" class="card">
    <div class="section-title">ğŸ“‹ è©³ç´°ãƒ‡ãƒ¼ã‚¿</div>
    <div class="table-container">
      <table><thead><tr id="table-header"></tr></thead><tbody id="table-body"></tbody></table>
    </div>
  </div>
  <footer>åç›Šç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v7.0 | å††ã‚°ãƒ©ãƒ•ãƒ»ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼/ã‚²ãƒ¼ãƒ ç¨®åˆ¥åˆ†é›¢å¯¾å¿œ</footer>
</div>

<div id="upload-modal" class="modal hidden">
  <div class="modal-content">
    <h3 style="margin-bottom:20px">ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
    <div class="form-row">
      <div class="form-group"><label>æœŸé–“</label><input type="text" id="upload-period" placeholder="ä¾‹: 2025å¹´10æœˆ"></div>
      <div class="form-group"><label>ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥</label>
        <select id="upload-type">
          <option value="auto">è‡ªå‹•åˆ¤åˆ¥</option>
          <option value="samExcel">å…ƒamuse/DSC Excel</option>
          <option value="sloten">ã‚¹ãƒ­å¤©KPIã‚·ãƒ¼ãƒˆ</option>
          <option value="agent">AMUSEVIP ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</option>
          <option value="ads">åºƒå‘Šãƒ‡ãƒ¼ã‚¿</option>
          <option value="baccarat">ãƒã‚«ãƒ©ãƒ„ãƒ¼ãƒ«</option>
          <option value="customerList">é¡§å®¢ãƒªã‚¹ãƒˆã‚·ãƒ¼ãƒˆ</option>
          <option value="uncollected">æœªå›åã‚·ãƒ¼ãƒˆ</option>
          <option value="bonus">ãƒœãƒ¼ãƒŠã‚¹ã‚·ãƒ¼ãƒˆ</option>
          <option value="delayed">é…ã‚Œå›åã‚·ãƒ¼ãƒˆ</option>
        </select>
      </div>
    </div>
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
      <div style="font-size:40px;margin-bottom:10px">ğŸ“</div>
      <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
      <p style="font-size:12px;color:#94a3b8;margin-top:8px">.xlsx, .xls, .csv å¯¾å¿œ</p>
    </div>
    <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileUpload(this.files[0])">
    <div id="upload-status" style="margin-top:16px;padding:12px;border-radius:8px;display:none"></div>
    <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="hideUploadModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<div id="add-business-modal" class="modal hidden">
  <div class="modal-content">
    <h3 style="margin-bottom:20px">â• äº‹æ¥­è¿½åŠ </h3>
    <div class="form-group"><label>äº‹æ¥­å</label><input type="text" id="new-business-name" placeholder="ä¾‹: æ–°è¦äº‹æ¥­"></div>
    <div class="form-group"><label>äº‹æ¥­ã‚¿ã‚¤ãƒ—</label>
      <select id="new-business-type">
        <option value="samExcel">æ¨™æº–ï¼ˆGGR/NGRç­‰ï¼‰</option>
        <option value="sloten">ã‚¹ãƒ­å¤©å½¢å¼</option>
        <option value="agent">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹</option>
        <option value="ads">åºƒå‘Šå‹</option>
        <option value="baccara">ãƒ„ãƒ¼ãƒ«å‹</option>
      </select>
    </div>
    <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="hideAddBusinessModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="addBusiness()">è¿½åŠ </button>
    </div>
  </div>
</div>

<script>
// ========== ãƒ‡ãƒ¼ã‚¿å®šç¾© ==========
const MOTO_AMUSE_DATA = {
  '2025å¹´10æœˆ':{ã‚µãƒãƒªãƒ¼:{'ãƒªã‚¹ãƒˆä»¶æ•°':14542,'æ‰“é›»æ•°':10579,'ç€é›»æ•°':1716,'LINEç™»éŒ²æ•°':23,'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ•°':141,'FTPæ•°':82,'FTPç‡':0.5816,'FTDæ•°':48,'FTDç‡':0.3404,'FTWæ•°':7,'FTWç‡':0.0496,'FTDWæ•°':55,'FTDWç‡':0.3901,'å‰æœˆãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ•°':75,'å¼•ç¶™ããƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°':153,'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':294,'T/O':1577495817.7,'å‹åˆ©é‡‘':1507184477.51,'RTP':0.9554,'GGR(WIN/LOSE)':70311340.19,'LTV(WIN/LOSE)':239154.22,'å›åäºˆå®šé‡‘é¡':71840329,'å›åé‡‘é¡':55956778,'å›åç‡(å…¨ä½“)':0.7789,'å›åç‡(ä»Šæœˆ)':0.7476,'å‡ºé‡‘é‡‘é¡':17719827,'GGR(å›åé‡‘é¡-å‡ºé‡‘é‡‘é¡)':38174451,'LTV(GGR)':129845.07,'ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ•ã‚£ãƒ¼':7263554.56,'NGR':30910896.44,'ç·ç™»éŒ²æ•°':294,'ç·ä¿¡ç”¨æ ':88200000,'å¹³å‡ä¿¡ç”¨æ ':300000,'å¹³å‡Creditå˜ä¾¡':1837500,'ç·ãƒœãƒ¼ãƒŠã‚¹':2150000,'å¹³å‡ãƒ—ãƒ¬ã‚¤æœˆé–“':4.2,'äº‹å‰æ¸…ç®—å›æ•°':45,'äº‹å‰æ¸…ç®—é‡‘é¡':12500000,'é€šå¸¸æ¸…ç®—å›æ•°':180,'é€šå¸¸æ¸…ç®—é‡‘é¡':43456778,'äº‹å‰æ¸…ç®—å‰²åˆ':0.2234,'é€šå¸¸æ¸…ç®—å‰²åˆ':0.7766,'äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ':0.2,'é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ':0.8},ãƒªã‚¹ãƒˆç¨®åˆ¥:{'B':272,'E':713,'T':17,'S':724,'ãã®ä»–':8}},
  '2025å¹´9æœˆ':{ã‚µãƒãƒªãƒ¼:{'GGR(WIN/LOSE)':-2176638.6,'LINEç™»éŒ²æ•°':13,'RTP':1.0383,'T/O':56770645,'ãƒªã‚¹ãƒˆä»¶æ•°':14965,'å‹åˆ©é‡‘':58947283.6,'æ‰“é›»æ•°':1035,'ç€é›»æ•°':665,'ç·ç™»éŒ²æ•°':180,'ç·ä¿¡ç”¨æ ':54000000,'å¹³å‡ä¿¡ç”¨æ ':300000,'å¹³å‡Creditå˜ä¾¡':1800000,'ç·ãƒœãƒ¼ãƒŠã‚¹':980000,'å¹³å‡ãƒ—ãƒ¬ã‚¤æœˆé–“':3.8,'äº‹å‰æ¸…ç®—å›æ•°':28,'äº‹å‰æ¸…ç®—é‡‘é¡':7800000,'é€šå¸¸æ¸…ç®—å›æ•°':95,'é€šå¸¸æ¸…ç®—é‡‘é¡':22500000,'äº‹å‰æ¸…ç®—å‰²åˆ':0.2574,'é€šå¸¸æ¸…ç®—å‰²åˆ':0.7426,'äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ':0.2276,'é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ':0.7724},ãƒªã‚¹ãƒˆç¨®åˆ¥:{'B':25,'E':20,'T':18,'S':15,'BE':12,'C':10,'ç´¹ä»‹':8,'ãã®ä»–':72}},
  '2025å¹´8æœˆ':{ã‚µãƒãƒªãƒ¼:{'BK':7114855,'FTDæ•°':12,'FTDç‡':0.2044,'FTPæ•°':60,'FTPç‡':0.7676,'GGR(WIN/LOSE)':56952667,'GGR(å›åé‡‘é¡-å‡ºé‡‘é‡‘é¡)':27019475,'LINEç™»éŒ²æ•°':48,'LTV(GGR)':92276.37,'LTV(WIN/LOSE)':389548,'NGR':23459499,'RTP':0.9735,'T/O':1910465086,'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ•°':78,'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':284,'ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ•ã‚£ãƒ¼':3559976,'ãƒªã‚¹ãƒˆä»¶æ•°':9997,'å‡ºé‡‘é‡‘é¡':13154437,'å‰æœˆãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ•°':88,'å‹åˆ©é‡‘':1853512419,'å›åäºˆå®šé‡‘é¡':56467301,'å›åç‡(ä»Šæœˆ)':0.7759,'å›åç‡(å…¨ä½“)':0.74,'å›åé‡‘é¡':41786755,'å¼•ç¶™ããƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°':206,'æ‰“é›»æ•°':9829,'ç€é›»æ•°':3810,'ç·ç™»éŒ²æ•°':284,'ç·ä¿¡ç”¨æ ':85200000,'å¹³å‡ä¿¡ç”¨æ ':300000,'å¹³å‡Creditå˜ä¾¡':1775000,'ç·ãƒœãƒ¼ãƒŠã‚¹':1850000,'å¹³å‡ãƒ—ãƒ¬ã‚¤æœˆé–“':4.5,'äº‹å‰æ¸…ç®—å›æ•°':52,'äº‹å‰æ¸…ç®—é‡‘é¡':11200000,'é€šå¸¸æ¸…ç®—å›æ•°':165,'é€šå¸¸æ¸…ç®—é‡‘é¡':30586755,'äº‹å‰æ¸…ç®—å‰²åˆ':0.2680,'é€šå¸¸æ¸…ç®—å‰²åˆ':0.7320,'äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ':0.2396,'é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ':0.7604},ãƒªã‚¹ãƒˆç¨®åˆ¥:{'B':38,'E':32,'T':25,'S':20,'BE':15,'C':12,'ç´¹ä»‹':10,'ãã®ä»–':132}},
  '2025å¹´7æœˆ':{ã‚µãƒãƒªãƒ¼:{'BK':1046146.65,'FTDWæ•°':14,'FTDWç‡':0.209,'FTDæ•°':11,'FTDç‡':0.164,'FTPæ•°':39,'FTPç‡':0.582,'FTWæ•°':3,'FTWç‡':0.045,'GGR(WIN/LOSE)':89408914.42,'GGR(å›åé‡‘é¡-å‡ºé‡‘é‡‘é¡)':11754881.9,'LINEç™»éŒ²æ•°':51,'LTV(GGR)':34271.25,'LTV(WIN/LOSE)':234669.07,'NGR':3791600.89,'RTP':0.9762,'T/O':3753649644.37,'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ•°':67,'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':381,'ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ•ã‚£ãƒ¼':7963281.01,'ãƒªã‚¹ãƒˆä»¶æ•°':9957,'å‡ºé‡‘é‡‘é¡':37542660,'å‰æœˆãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ•°':17,'å‹åˆ©é‡‘':3664240729.95,'å›åäºˆå®šé‡‘é¡':106737904.3,'å›åç‡(ä»Šæœˆ)':0.6686,'å›åç‡(å…¨ä½“)':0.7004,'å›åé‡‘é¡':74754327.9,'å¼•ç¶™ããƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°':314,'æ‰“é›»æ•°':100011,'ç€é›»æ•°':3839,'ç·ç™»éŒ²æ•°':381,'ç·ä¿¡ç”¨æ ':114300000,'å¹³å‡ä¿¡ç”¨æ ':300000,'å¹³å‡Creditå˜ä¾¡':1890000,'ç·ãƒœãƒ¼ãƒŠã‚¹':2450000,'å¹³å‡ãƒ—ãƒ¬ã‚¤æœˆé–“':3.9,'äº‹å‰æ¸…ç®—å›æ•°':68,'äº‹å‰æ¸…ç®—é‡‘é¡':18500000,'é€šå¸¸æ¸…ç®—å›æ•°':210,'é€šå¸¸æ¸…ç®—é‡‘é¡':56254327,'äº‹å‰æ¸…ç®—å‰²åˆ':0.2474,'é€šå¸¸æ¸…ç®—å‰²åˆ':0.7526,'äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ':0.2446,'é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ':0.7554},ãƒªã‚¹ãƒˆç¨®åˆ¥:{'B':52,'E':45,'T':35,'S':28,'BE':22,'C':18,'ç´¹ä»‹':15,'ãã®ä»–':166}},
  '2025å¹´6æœˆ':{ã‚µãƒãƒªãƒ¼:{'BK':19008236.94,'GGR(WIN/LOSE)':106821992.9,'GGR(å›åé‡‘é¡-å‡ºé‡‘é‡‘é¡)':79117068,'LINEç™»éŒ²æ•°':367,'LTV(GGR)':113348.24,'LTV(WIN/LOSE)':153040.1,'NGR':69120861.61,'RTP':0.9716,'T/O':3764837698.76,'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':698,'ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ•ã‚£ãƒ¼':9996206.39,'ãƒªã‚¹ãƒˆä»¶æ•°':9884,'å‰æœˆãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ•°':235,'å‹åˆ©é‡‘':3658015705.86,'æ‰“é›»æ•°':191066,'ç€é›»æ•°':7980,'ç·ç™»éŒ²æ•°':698,'ç·ä¿¡ç”¨æ ':209400000,'å¹³å‡ä¿¡ç”¨æ ':300000,'å¹³å‡Creditå˜ä¾¡':1950000,'ç·ãƒœãƒ¼ãƒŠã‚¹':4200000,'å¹³å‡ãƒ—ãƒ¬ã‚¤æœˆé–“':5.1,'äº‹å‰æ¸…ç®—å›æ•°':125,'äº‹å‰æ¸…ç®—é‡‘é¡':28500000,'é€šå¸¸æ¸…ç®—å›æ•°':385,'é€šå¸¸æ¸…ç®—é‡‘é¡':50617068,'äº‹å‰æ¸…ç®—å‰²åˆ':0.3603,'é€šå¸¸æ¸…ç®—å‰²åˆ':0.6397,'äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ':0.2451,'é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ':0.7549},ãƒªã‚¹ãƒˆç¨®åˆ¥:{'B':95,'E':82,'T':65,'S':52,'BE':42,'C':35,'ç´¹ä»‹':28,'ãã®ä»–':299}},
  '2025å¹´5æœˆ':{ã‚µãƒãƒªãƒ¼:{'BK':6910039.38,'FTDWæ•°':119,'FTDWç‡':0.3766,'FTDæ•°':110,'FTDç‡':0.3481,'GGR':30822400,'LINEç™»éŒ²æ•°':497,'LTV(GGR)':40878.51,'LTV(WIN/LOSE)':3348.2,'NGR':21494893.73,'RTP':0.9995,'T/O':5416323482.72,'WIN/LOSE':2524541,'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ•°':316,'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':754,'ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ•ã‚£ãƒ¼':9327506.27,'ãƒªã‚¹ãƒˆä»¶æ•°':9967,'å‡ºé‡‘é‡‘é¡':74028096,'å‰æœˆãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ•°':119,'å‹åˆ©é‡‘':5413798941.72,'å›åäºˆå®šé‡‘é¡':127207474.62,'å›åç‡(ä»Šæœˆ)':0.8335,'å›åç‡(å…¨ä½“)':0.8491,'å›åé‡‘é¡':108007299.5,'å¼•ç¶™ããƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°':438,'æ‰“é›»æ•°':171257,'ç€é›»æ•°':6193,'ç·ç™»éŒ²æ•°':754,'ç·ä¿¡ç”¨æ ':226200000,'å¹³å‡ä¿¡ç”¨æ ':300000,'å¹³å‡Creditå˜ä¾¡':2056363,'ç·ãƒœãƒ¼ãƒŠã‚¹':5100000,'å¹³å‡ãƒ—ãƒ¬ã‚¤æœˆé–“':4.8,'äº‹å‰æ¸…ç®—å›æ•°':142,'äº‹å‰æ¸…ç®—é‡‘é¡':32000000,'é€šå¸¸æ¸…ç®—å›æ•°':420,'é€šå¸¸æ¸…ç®—é‡‘é¡':76007299,'äº‹å‰æ¸…ç®—å‰²åˆ':0.2962,'é€šå¸¸æ¸…ç®—å‰²åˆ':0.7038,'äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ':0.2527,'é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ':0.7473},ãƒªã‚¹ãƒˆç¨®åˆ¥:{'B':102,'E':88,'T':72,'S':58,'BE':45,'C':38,'ç´¹ä»‹':32,'ãã®ä»–':319}}
};
const DSC_DATA = {
  '2026å¹´1æœˆ':{ã‚µãƒãƒªãƒ¼:{'FTDWæ•°':12,'FTDWç‡':0.6,'FTDæ•°':10,'FTDç‡':0.5,'FTPæ•°':16,'FTPç‡':0.8,'FTWæ•°':2,'FTWç‡':0.1,'GGR(WIN/LOSE)':43248155.21,'GGR(å›åé‡‘é¡-å‡ºé‡‘é‡‘é¡)':22191922,'LTV(GGR)':128277.01,'LTV(WIN/LOSE)':249989.34,'NGR':20776887.34,'RTP':0.9678,'T/O':1342354453.62,'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ•°':20,'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':173,'ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ•ã‚£ãƒ¼':1415034.66,'ãƒªã‚¹ãƒˆä»¶æ•°':15000,'å‡ºé‡‘é‡‘é¡':12883059,'å‹åˆ©é‡‘':1299106298.41,'å›åäºˆå®šé‡‘é¡':43803701,'å›åç‡(å…¨ä½“)':0.8007,'å›åé‡‘é¡':35074981,'ç·ç™»éŒ²æ•°':173,'ç·ä¿¡ç”¨æ ':51900000,'å¹³å‡ä¿¡ç”¨æ ':300000,'å¹³å‡Creditå˜ä¾¡':2595000,'ç·ãƒœãƒ¼ãƒŠã‚¹':1250000,'å¹³å‡ãƒ—ãƒ¬ã‚¤æœˆé–“':5.2,'äº‹å‰æ¸…ç®—å›æ•°':32,'äº‹å‰æ¸…ç®—é‡‘é¡':9800000,'é€šå¸¸æ¸…ç®—å›æ•°':98,'é€šå¸¸æ¸…ç®—é‡‘é¡':25274981,'äº‹å‰æ¸…ç®—å‰²åˆ':0.2794,'é€šå¸¸æ¸…ç®—å‰²åˆ':0.7206,'äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ':0.2462,'é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ':0.7538},ãƒªã‚¹ãƒˆç¨®åˆ¥:{'B':15,'E':68,'T':8,'S':81,'ãã®ä»–':9}},
  '2025å¹´12æœˆ':{ã‚µãƒãƒªãƒ¼:{'GGR(WIN/LOSE)':53578505.82,'GGR(å›åé‡‘é¡-å‡ºé‡‘é‡‘é¡)':38616975,'LTV(GGR)':133161.98,'LTV(WIN/LOSE)':184753.47,'NGR':31242527,'RTP':0.9646,'T/O':1514244472.37,'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ•°':27,'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':292,'ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ•ã‚£ãƒ¼':7374448,'å‡ºé‡‘é‡‘é¡':20555338,'å‹åˆ©é‡‘':1460665966.55,'å›åäºˆå®šé‡‘é¡':73458827,'å›åç‡(å…¨ä½“)':0.8381,'å›åé‡‘é¡':61567404,'ç·ç™»éŒ²æ•°':292,'ç·ä¿¡ç”¨æ ':87600000,'å¹³å‡ä¿¡ç”¨æ ':300000,'å¹³å‡Creditå˜ä¾¡':2466666,'ç·ãƒœãƒ¼ãƒŠã‚¹':2100000,'å¹³å‡ãƒ—ãƒ¬ã‚¤æœˆé–“':4.8,'äº‹å‰æ¸…ç®—å›æ•°':55,'äº‹å‰æ¸…ç®—é‡‘é¡':16500000,'é€šå¸¸æ¸…ç®—å›æ•°':168,'é€šå¸¸æ¸…ç®—é‡‘é¡':45067404,'äº‹å‰æ¸…ç®—å‰²åˆ':0.2679,'é€šå¸¸æ¸…ç®—å‰²åˆ':0.7321,'äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ':0.2466,'é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ':0.7534},ãƒªã‚¹ãƒˆç¨®åˆ¥:{'B':42,'E':35,'T':28,'S':22,'BE':18,'C':15,'ç´¹ä»‹':12,'ãã®ä»–':120}},
  '2025å¹´11æœˆ':{ã‚µãƒãƒªãƒ¼:{'BK':9242926.55,'FTDWæ•°':62,'FTDWç‡':0.8052,'FTDæ•°':29,'FTDç‡':0.3766,'FTPæ•°':61,'FTPç‡':0.7922,'FTWæ•°':33,'FTWç‡':0.4286,'GGR(WIN/LOSE)':64900999.09,'GGR(å›åé‡‘é¡-å‡ºé‡‘é‡‘é¡)':43448785,'LINEç™»éŒ²æ•°':38,'LTV(GGR)':191404.34,'LTV(WIN/LOSE)':285907.48,'NGR':33610642.28,'RTP':0.9586,'T/O':1568206349.94,'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ•°':77,'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':227,'ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ•ã‚£ãƒ¼':9838142.72,'ãƒªã‚¹ãƒˆä»¶æ•°':14867,'å‡ºé‡‘é‡‘é¡':19725328,'å‰æœˆãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ•°':82,'å‹åˆ©é‡‘':1503305350.85,'å›åäºˆå®šé‡‘é¡':77447062,'å›åç‡(ä»Šæœˆ)':0.7476,'å›åç‡(å…¨ä½“)':0.8291,'å›åé‡‘é¡':64213601,'å¼•ç¶™ããƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°':150,'æ‰“é›»æ•°':10398,'ç€é›»æ•°':1209,'ç·ç™»éŒ²æ•°':227,'ç·ä¿¡ç”¨æ ':68100000,'å¹³å‡ä¿¡ç”¨æ ':300000,'å¹³å‡Creditå˜ä¾¡':2348275,'ç·ãƒœãƒ¼ãƒŠã‚¹':1680000,'å¹³å‡ãƒ—ãƒ¬ã‚¤æœˆé–“':4.5,'äº‹å‰æ¸…ç®—å›æ•°':42,'äº‹å‰æ¸…ç®—é‡‘é¡':13200000,'é€šå¸¸æ¸…ç®—å›æ•°':135,'é€šå¸¸æ¸…ç®—é‡‘é¡':51013601,'äº‹å‰æ¸…ç®—å‰²åˆ':0.2056,'é€šå¸¸æ¸…ç®—å‰²åˆ':0.7944,'äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ':0.2373,'é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ':0.7627},ãƒªã‚¹ãƒˆç¨®åˆ¥:{'B':32,'E':28,'T':22,'S':18,'BE':14,'C':12,'ç´¹ä»‹':10,'ãã®ä»–':91}},
  '2025å¹´9æœˆ':{ã‚µãƒãƒªãƒ¼:{'BK':8671957.8,'FTDWæ•°':92,'FTDWç‡':0.3948,'FTDæ•°':73,'FTDç‡':0.3133,'FTPæ•°':154,'FTPç‡':0.6609,'FTWæ•°':19,'FTWç‡':0.0815,'GGR(WIN/LOSE)':74174997,'GGR(å›åé‡‘é¡-å‡ºé‡‘é‡‘é¡)':40783402,'LINEç™»éŒ²æ•°':161,'LTV(GGR)':137774.17,'LTV(WIN/LOSE)':248909.39,'NGR':31772784,'RTP':0.9712,'T/O':2578173994,'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ•°':233,'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':298,'ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ•ã‚£ãƒ¼':9010618,'ãƒªã‚¹ãƒˆä»¶æ•°':14807,'å‡ºé‡‘é‡‘é¡':21551493,'å‰æœˆãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ•°':21,'å‹åˆ©é‡‘':2503998997,'å›åäºˆå®šé‡‘é¡':76698566.8,'å›åç‡(å…¨ä½“)':0.8194,'å›åé‡‘é¡':62846588,'å¼•ç¶™ããƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°':65,'æ‰“é›»æ•°':12471,'ç€é›»æ•°':2418,'ç·ç™»éŒ²æ•°':298,'ç·ä¿¡ç”¨æ ':89400000,'å¹³å‡ä¿¡ç”¨æ ':300000,'å¹³å‡Creditå˜ä¾¡':1224657,'ç·ãƒœãƒ¼ãƒŠã‚¹':2350000,'å¹³å‡ãƒ—ãƒ¬ã‚¤æœˆé–“':3.9,'äº‹å‰æ¸…ç®—å›æ•°':58,'äº‹å‰æ¸…ç®—é‡‘é¡':15800000,'é€šå¸¸æ¸…ç®—å›æ•°':175,'é€šå¸¸æ¸…ç®—é‡‘é¡':47046588,'äº‹å‰æ¸…ç®—å‰²åˆ':0.2514,'é€šå¸¸æ¸…ç®—å‰²åˆ':0.7486,'äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ':0.2489,'é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ':0.7511},ãƒªã‚¹ãƒˆç¨®åˆ¥:{'B':45,'E':38,'T':30,'S':24,'BE':18,'C':15,'ç´¹ä»‹':12,'ãã®ä»–':116}}
};
const SLOTEN_DATA = {
  '2026å¹´1æœˆ':{
    ã‚µãƒãƒªãƒ¼:{'ç™»éŒ²äººæ•°':3381,'ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':3459,'FTDã®ã¿å…¥é‡‘è€…æ•°':181,'FTDã®ã¿ç‡':0.0535,'2ndå…¥é‡‘è€…æ•°':245,'2ndç‡':0.0725,'3rdå…¥é‡‘è€…æ•°':189,'3rdç‡':0.0559,'Activeå…¥é‡‘è€…æ•°':387,'Activeç‡':0.1145,'ä»Šæœˆç™»éŒ²ã®FTDä»¥é™ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':339,'ä»Šæœˆç™»éŒ²FTDä»¥é™ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰²åˆ':0.1003,'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ¬ã‚¤äººæ•°ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰':993,'å…¥é‡‘è€…æ•°(ãƒ‡ã‚¤ãƒªãƒ¼ãƒ¦ãƒ‹ãƒ¼ã‚¯)':632,'ç·å…¥é‡‘é¡':70601802,'ç·å‡ºé‡‘é¡':54836317,'T/O(ãƒªã‚¢ãƒ«ã®ã¿)':1040015674,'å‹åˆ©é‡‘(ãƒªã‚¢ãƒ«ã®ã¿)':1009478892,'RTP':0.9706,'GGR':30536782.75,'å…¥å‡ºé‡‘å·®åˆ†':15765485,'GGRLTV':30752.05,'å‰æœˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':2552,'å‰ã€…æœˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':300,'3ã‹æœˆä»¥ä¸Šå‰ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':150,'å‰æœˆç¶™ç¶šç‡':0.312,'å‰ã€…æœˆç¶™ç¶šç‡':0.28,'3ã‹æœˆä»¥ä¸Šå‰ç¶™ç¶šç‡':0.22},
    å…¥é‡‘æ–¹æ³•:{'TOTAL':70601802,'éŠ€è¡Œï¼ˆè‡ªå‹•ï¼‰':16021000,'ä»®æƒ³é€šè²¨':6063158,'éŠ€è¡Œï¼ˆæ‰‹å‹•ï¼‰':7798951,'EC(ã‚³ãƒ³ãƒ“ãƒ‹)':1472000,'PayPay':39246693},
    å‡ºé‡‘æ–¹æ³•:{'TOTAL':54836317,'éŠ€è¡Œï¼ˆè‡ªå‹•ï¼‰':16360710,'ä»®æƒ³é€šè²¨':17794551,'éŠ€è¡Œï¼ˆæ‰‹å‹•ï¼‰':19212554,'PayPay':1468502},
    ã‚²ãƒ¼ãƒ åˆ¥:{ãƒ‘ãƒãƒ³ã‚³:{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:1066,TO:25539221,GGR:3124886},ãƒ‘ãƒã‚¹ãƒ­:{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:1090,TO:120877774,GGR:1119651},ã‚¹ãƒ­ãƒƒãƒˆ:{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:4792,TO:388796058,GGR:10550937},ãƒ©ã‚¤ãƒ–:{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:2213,TO:407528253,GGR:15111844}},
    ä»®æƒ³é€šè²¨:{BTC:{ä»¶æ•°:45,é‡‘é¡:1250000},ETH:{ä»¶æ•°:62,é‡‘é¡:2100000},USDT:{ä»¶æ•°:38,é‡‘é¡:1500000},XRP:{ä»¶æ•°:28,é‡‘é¡:713158},TRX:{ä»¶æ•°:15,é‡‘é¡:500000}},
    ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼:{'Pragmatic Play':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:1850,è³­ã‘é‡‘é¡:180000000,é…å½“é‡‘é¡:172800000,GGR:7200000},'Evolution':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:1420,è³­ã‘é‡‘é¡:250000000,é…å½“é‡‘é¡:242500000,GGR:7500000},'NetEnt':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:980,è³­ã‘é‡‘é¡:95000000,é…å½“é‡‘é¡:91200000,GGR:3800000},'Play n GO':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:750,è³­ã‘é‡‘é¡:72000000,é…å½“é‡‘é¡:69120000,GGR:2880000},'Red Tiger':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:620,è³­ã‘é‡‘é¡:58000000,é…å½“é‡‘é¡:55680000,GGR:2320000},'ãã®ä»–':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:2100,è³­ã‘é‡‘é¡:287741326,é…å½“é‡‘é¡:280904434,GGR:6836892}},
    Affiliate:{'AFFæ•°':46,'AFFçµŒç”±ç™»éŒ²è€…æ•°':925,'AFFçµŒç”±FTDæ•°':126,'AFFçµŒç”±FTDç‡':0.1362,'AFFçµŒç”±å…¥é‡‘é¡':8022259,'AFFçµŒç”±å‡ºé‡‘é¡':5490590,'AFFçµŒç”±GGR':2531669}
  },
  '2025å¹´12æœˆ':{
    ã‚µãƒãƒªãƒ¼:{'ç™»éŒ²äººæ•°':2552,'ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':2399,'FTDã®ã¿å…¥é‡‘è€…æ•°':231,'FTDã®ã¿ç‡':0.0905,'2ndå…¥é‡‘è€…æ•°':198,'2ndç‡':0.0776,'3rdå…¥é‡‘è€…æ•°':156,'3rdç‡':0.0611,'Activeå…¥é‡‘è€…æ•°':324,'Activeç‡':0.1269,'ä»Šæœˆç™»éŒ²ã®FTDä»¥é™ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':713,'ä»Šæœˆç™»éŒ²FTDä»¥é™ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰²åˆ':0.1653,'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ¬ã‚¤äººæ•°ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰':798,'ç·å…¥é‡‘é¡':66633871,'ç·å‡ºé‡‘é¡':48341793,'T/O(ãƒªã‚¢ãƒ«ã®ã¿)':1120432234,'å‹åˆ©é‡‘(ãƒªã‚¢ãƒ«ã®ã¿)':1084887870,'RTP':0.9683,'GGR':35543975.96,'å…¥å‡ºé‡‘å·®åˆ†':18292078,'GGRLTV':44541.32,'å‰æœˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':300,'å‰ã€…æœˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':0,'3ã‹æœˆä»¥ä¸Šå‰ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':0,'å‰æœˆç¶™ç¶šç‡':0.28,'å‰ã€…æœˆç¶™ç¶šç‡':0,'3ã‹æœˆä»¥ä¸Šå‰ç¶™ç¶šç‡':0},
    å…¥é‡‘æ–¹æ³•:{'TOTAL':66633871,'éŠ€è¡Œï¼ˆè‡ªå‹•ï¼‰':11122808,'ä»®æƒ³é€šè²¨':10897654,'éŠ€è¡Œï¼ˆæ‰‹å‹•ï¼‰':18865520,'EC(ã‚³ãƒ³ãƒ“ãƒ‹)':1121000,'PayPay':24627889},
    å‡ºé‡‘æ–¹æ³•:{'TOTAL':48341793,'éŠ€è¡Œï¼ˆè‡ªå‹•ï¼‰':12500000,'ä»®æƒ³é€šè²¨':15841793,'éŠ€è¡Œï¼ˆæ‰‹å‹•ï¼‰':18000000,'PayPay':2000000},
    ã‚²ãƒ¼ãƒ åˆ¥:{ãƒ‘ãƒãƒ³ã‚³:{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:892,TO:21500000,GGR:2580000},ãƒ‘ãƒã‚¹ãƒ­:{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:945,TO:105000000,GGR:1260000},ã‚¹ãƒ­ãƒƒãƒˆ:{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:4120,TO:420000000,GGR:12600000},ãƒ©ã‚¤ãƒ–:{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:1980,TO:380000000,GGR:19103976}},
    ä»®æƒ³é€šè²¨:{BTC:{ä»¶æ•°:78,é‡‘é¡:2800000},ETH:{ä»¶æ•°:95,é‡‘é¡:3500000},USDT:{ä»¶æ•°:65,é‡‘é¡:2800000},XRP:{ä»¶æ•°:42,é‡‘é¡:1297654},TRX:{ä»¶æ•°:20,é‡‘é¡:500000}},
    ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼:{'Pragmatic Play':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:1650,è³­ã‘é‡‘é¡:195000000,é…å½“é‡‘é¡:187200000,GGR:7800000},'Evolution':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:1580,è³­ã‘é‡‘é¡:285000000,é…å½“é‡‘é¡:276450000,GGR:8550000},'NetEnt':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:880,è³­ã‘é‡‘é¡:88000000,é…å½“é‡‘é¡:84480000,GGR:3520000},'Play n GO':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:690,è³­ã‘é‡‘é¡:66000000,é…å½“é‡‘é¡:63360000,GGR:2640000},'Red Tiger':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:550,è³­ã‘é‡‘é¡:52000000,é…å½“é‡‘é¡:49920000,GGR:2080000},'Hacksaw':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:420,è³­ã‘é‡‘é¡:48000000,é…å½“é‡‘é¡:46080000,GGR:1920000},'ãã®ä»–':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:1950,è³­ã‘é‡‘é¡:192432234,é…å½“é‡‘é¡:183397858,GGR:9034376}},
    Affiliate:{'AFFæ•°':34,'AFFçµŒç”±ç™»éŒ²è€…æ•°':1457,'AFFçµŒç”±FTDæ•°':543,'AFFçµŒç”±FTDç‡':0.3727,'AFFçµŒç”±å…¥é‡‘é¡':55061952,'AFFçµŒç”±å‡ºé‡‘é¡':36735633,'AFFçµŒç”±GGR':10366161}
  },
  '2025å¹´11æœˆ':{
    ã‚µãƒãƒªãƒ¼:{'ç™»éŒ²äººæ•°':300,'ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':193,'FTDã®ã¿å…¥é‡‘è€…æ•°':8,'FTDã®ã¿ç‡':0.0267,'2ndå…¥é‡‘è€…æ•°':12,'2ndç‡':0.04,'3rdå…¥é‡‘è€…æ•°':8,'3rdç‡':0.0267,'Activeå…¥é‡‘è€…æ•°':22,'Activeç‡':0.0733,'ä»Šæœˆç™»éŒ²ã®FTDä»¥é™ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':42,'ä»Šæœˆç™»éŒ²FTDä»¥é™ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰²åˆ':0.5661,'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ¬ã‚¤äººæ•°':84,'ç·å…¥é‡‘é¡':586146,'ç·å‡ºé‡‘é¡':528463,'T/O(ãƒªã‚¢ãƒ«ã®ã¿)':5043994.2,'å‹åˆ©é‡‘(ãƒªã‚¢ãƒ«ã®ã¿)':4980421.4,'RTP':0.9874,'GGR':63572.8,'å…¥å‡ºé‡‘å·®åˆ†':57683,'å‰æœˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':0,'å‰ã€…æœˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':0,'3ã‹æœˆä»¥ä¸Šå‰ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°':0,'å‰æœˆç¶™ç¶šç‡':0,'å‰ã€…æœˆç¶™ç¶šç‡':0,'3ã‹æœˆä»¥ä¸Šå‰ç¶™ç¶šç‡':0},
    å…¥é‡‘æ–¹æ³•:{'TOTAL':586146,'éŠ€è¡Œï¼ˆè‡ªå‹•ï¼‰':0,'ä»®æƒ³é€šè²¨':8000,'éŠ€è¡Œï¼ˆæ‰‹å‹•ï¼‰':100000,'EC(ã‚³ãƒ³ãƒ“ãƒ‹)':10000,'PayPay':468146},
    å‡ºé‡‘æ–¹æ³•:{'TOTAL':528463,'éŠ€è¡Œï¼ˆè‡ªå‹•ï¼‰':0,'ä»®æƒ³é€šè²¨':50000,'éŠ€è¡Œï¼ˆæ‰‹å‹•ï¼‰':200000,'PayPay':278463},
    ã‚²ãƒ¼ãƒ åˆ¥:{ãƒ‘ãƒãƒ³ã‚³:{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:25,TO:320000,GGR:38400},ãƒ‘ãƒã‚¹ãƒ­:{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:28,TO:580000,GGR:6960},ã‚¹ãƒ­ãƒƒãƒˆ:{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:52,TO:2100000,GGR:63000},ãƒ©ã‚¤ãƒ–:{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:18,TO:2043994,GGR:-44787}},
    ä»®æƒ³é€šè²¨:{BTC:{ä»¶æ•°:2,é‡‘é¡:3000},ETH:{ä»¶æ•°:1,é‡‘é¡:2500},USDT:{ä»¶æ•°:1,é‡‘é¡:1500},XRP:{ä»¶æ•°:1,é‡‘é¡:1000}},
    ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼:{'Pragmatic Play':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:35,è³­ã‘é‡‘é¡:1800000,é…å½“é‡‘é¡:1728000,GGR:72000},'Evolution':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:18,è³­ã‘é‡‘é¡:2043994,é…å½“é‡‘é¡:2088781,GGR:-44787},'NetEnt':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:22,è³­ã‘é‡‘é¡:650000,é…å½“é‡‘é¡:624000,GGR:26000},'ãã®ä»–':{ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:25,è³­ã‘é‡‘é¡:550000,é…å½“é‡‘é¡:539640,GGR:10360}},
    Affiliate:{'AFFæ•°':8,'AFFçµŒç”±ç™»éŒ²è€…æ•°':302,'AFFçµŒç”±FTDæ•°':34,'AFFçµŒç”±FTDç‡':0.4797}
  }
};

const DEFAULT_BUSINESSES = {
  'å…ƒamuse': { data: MOTO_AMUSE_DATA, type: 'samExcel' },
  'DSC': { data: DSC_DATA, type: 'samExcel' },
  'ã‚¹ãƒ­å¤©': { data: SLOTEN_DATA, type: 'sloten' },
  'åºƒå‘Š': { data: {}, type: 'ads' },
  'ãƒã‚«ãƒ©ãƒ„ãƒ¼ãƒ«': { data: {}, type: 'baccara' },
  'AMUSEVIP': { data: {}, type: 'agent' }
};

const JSONBLOB_API = 'https://jsonblob.com/api/jsonBlob';
let BLOB_ID = '';
let cloudEnabled = false;

let BUSINESSES = JSON.parse(JSON.stringify(DEFAULT_BUSINESSES));
let currentBusiness = 'å…ƒamuse';
let currentPeriod = null;
let chartInstance = null;
let cryptoPieChart = null;
let gamePieChart = null;
let providerPieChart = null;
let retentionChart = null;
let viewMode = 'period';

// ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
function parseNumber(val) {
  if (val === undefined || val === null || val === '' || val === '-' || String(val).startsWith('#')) return null;
  if (typeof val === 'number') return val;
  let cleaned = String(val).replace(/[Â¥ï¿¥$,ã€"\s]/g, '').trim();
  if (cleaned.endsWith('%')) cleaned = cleaned.replace(/%$/, '');
  const num = parseFloat(cleaned);
  return isNaN(num) ? null : num;
}
function formatCurrency(val) {
  if (val == null || isNaN(val)) return '-';
  const abs = Math.abs(val); const sign = val < 0 ? '-' : '';
  if (abs >= 100000000) return sign + 'Â¥' + (abs / 100000000).toFixed(2) + 'å„„';
  if (abs >= 10000) return sign + 'Â¥' + Math.round(abs / 10000).toLocaleString() + 'ä¸‡';
  return sign + 'Â¥' + Math.round(abs).toLocaleString();
}
function formatPercent(val) { 
  if (val == null || isNaN(val)) return '-'; 
  let v = Math.abs(val) <= 1 ? val * 100 : val; 
  return v.toFixed(2) + '%'; 
}
function formatRTP(val) {
  if (val == null || isNaN(val)) return '-';
  // æ§é™¤ç‡ï¼ˆ0.02ãªã©å°ã•ã„å€¤ï¼‰ã®å ´åˆã¯RTPã«å¤‰æ›
  let v = val;
  if (v <= 0.1) v = 1 - v; // æ§é™¤ç‡ã‚’RTPã«å¤‰æ›
  v = Math.abs(v) <= 1 ? v * 100 : v;
  return v.toFixed(2) + '%';
}
function formatNumber(val) { if (val == null || isNaN(val)) return '-'; return Math.round(val).toLocaleString(); }
function sortPeriods(periods) {
  return [...periods].sort((a, b) => {
    const mA = a.match(/(\d{4})å¹´(\d{1,2})æœˆ/), mB = b.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
    if (mA && mB) { const yA = parseInt(mA[1]), monA = parseInt(mA[2]), yB = parseInt(mB[1]), monB = parseInt(mB[2]); return (yB * 12 + monB) - (yA * 12 + monA); }
    return b.localeCompare(a);
  });
}

// ========== ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ ==========
function getBinIdFromURL() { return new URLSearchParams(window.location.search).get('bin') || ''; }
function setBinIdToURL(binId) { const url = new URL(window.location.href); url.searchParams.set('bin', binId); window.history.replaceState({}, '', url); }
function updateSyncStatus(msg, isError = false) { const el = document.getElementById('sync-status'); el.textContent = isError ? 'âš ï¸ ' + msg : 'ğŸ’¾ ' + msg; el.style.color = isError ? '#ef4444' : '#10b981'; }
async function createNewBin() { 
  try { 
    updateSyncStatus('ä½œæˆä¸­...'); 
    const res = await fetch(JSONBLOB_API, { 
      method: 'POST', 
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, 
      body: JSON.stringify({ businesses: {}, created: new Date().toISOString() })
    });
    if (!res.ok) throw new Error('API error: ' + res.status);
    const location = res.headers.get('Location') || res.headers.get('x-jsonblob');
    const blobId = location ? location.split('/').pop() : null;
    if (blobId && blobId.length > 5) { 
      BLOB_ID = blobId; 
      cloudEnabled = true; 
      setBinIdToURL(blobId); 
      updateSyncStatus('ä½œæˆå®Œäº†ï¼'); 
      showShareURL(); 
      return blobId; 
    } else {
      throw new Error('Invalid blob ID');
    }
  } catch (e) { 
    console.error('createNewBin error:', e);
    updateSyncStatus('ä½œæˆã‚¨ãƒ©ãƒ¼', true); 
    if (window.self !== window.top) {
      alert('âš ï¸ ã“ã®ç’°å¢ƒã§ã¯å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã§ãã¾ã›ã‚“ã€‚\\n\\nãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§ç›´æ¥é–‹ã„ã¦ãã ã•ã„ã€‚');
    } else {
      alert('å…±æœ‰ãƒªãƒ³ã‚¯ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\\nã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
  } 
  return null; 
}
  } 
  return null; 
}
function showShareURL() { const shareUrl = window.location.href; if (confirm(`âœ… å…±æœ‰ãƒªãƒ³ã‚¯:\n${shareUrl}\n\nã‚³ãƒ”ãƒ¼ã—ã¾ã™ã‹ï¼Ÿ`)) { navigator.clipboard.writeText(shareUrl).then(() => alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼')).catch(() => prompt('URLã‚’ã‚³ãƒ”ãƒ¼:', shareUrl)); } }
async function createShareLink() { if (cloudEnabled) showShareURL(); else { const binId = await createNewBin(); if (binId) await saveToCloud(); } }
async function loadCloudData() { 
  if (!BLOB_ID) return {}; 
  try { 
    const fetchPromise = fetch(JSONBLOB_API + '/' + BLOB_ID);
    const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 8000));
    const res = await Promise.race([fetchPromise, timeoutPromise]);
    if (!res.ok) throw new Error('Load failed'); 
    const data = await res.json(); 
    return data.businesses || {}; 
  } catch (e) { 
    console.error('loadCloudData error:', e);
    return {}; 
  } 
}
async function saveToCloud() { if (!BLOB_ID) return; try { const toSave = {}; Object.keys(BUSINESSES).forEach(key => { const biz = BUSINESSES[key], def = DEFAULT_BUSINESSES[key]; if (!def) toSave[key] = biz; else { const newPeriods = {}; Object.keys(biz.data).forEach(period => { if (!def.data[period]) newPeriods[period] = biz.data[period]; }); if (Object.keys(newPeriods).length > 0) toSave[key] = { data: newPeriods, type: biz.type }; } }); await fetch(JSONBLOB_API + '/' + BLOB_ID, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ businesses: toSave, lastUpdate: new Date().toISOString() }) }); updateSyncStatus('ä¿å­˜å®Œäº† âœ“'); } catch (e) { updateSyncStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼', true); } }
async function clearCloudData() { if (!BLOB_ID) return; try { await fetch(JSONBLOB_API + '/' + BLOB_ID, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ businesses: {}, lastUpdate: new Date().toISOString() }) }); } catch (e) {} }
function mergeWithDefault(cloudData) { const merged = JSON.parse(JSON.stringify(DEFAULT_BUSINESSES)); Object.keys(cloudData).forEach(key => { if (merged[key]) { merged[key].data = { ...merged[key].data, ...(cloudData[key].data || {}) }; merged[key].type = cloudData[key].type || merged[key].type; } else merged[key] = cloudData[key]; }); return merged; }
function saveBusinessData() { if (cloudEnabled) { updateSyncStatus('ä¿å­˜ä¸­...'); saveToCloud(); } try { const backup = {}; Object.keys(BUSINESSES).forEach(k => { const def = DEFAULT_BUSINESSES[k]; if (!def) backup[k] = BUSINESSES[k]; else { const newPeriods = {}; Object.keys(BUSINESSES[k].data).forEach(p => { if (!def.data[p]) newPeriods[p] = BUSINESSES[k].data[p]; }); if (Object.keys(newPeriods).length > 0) backup[k] = { data: newPeriods, type: BUSINESSES[k].type }; } }); localStorage.setItem('dashboard_backup', JSON.stringify(backup)); } catch (e) {} }
async function clearAllData() { if (confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { if (cloudEnabled) await clearCloudData(); localStorage.removeItem('dashboard_backup'); location.reload(); } }
async function initializeData() { 
  BLOB_ID = getBinIdFromURL(); 
  cloudEnabled = !!BLOB_ID; 
  if (cloudEnabled) { 
    try { 
      updateSyncStatus('èª­ã¿è¾¼ã¿ä¸­...'); 
      const cloudData = await loadCloudData(); 
      if (cloudData && Object.keys(cloudData).length > 0) {
        BUSINESSES = mergeWithDefault(cloudData); 
        updateSyncStatus('ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸä¸­'); 
      } else {
        throw new Error('Empty data');
      }
    } catch (e) { 
      console.error('Cloud load error:', e);
      cloudEnabled = false;
      BLOB_ID = '';
      updateSyncStatus('ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰æ¥ç¶šå¤±æ•—ï¼‰', true); 
      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã‚€
      try { 
        const backup = localStorage.getItem('dashboard_backup'); 
        if (backup) { 
          const parsed = JSON.parse(backup); 
          Object.keys(parsed).forEach(key => { 
            if (BUSINESSES[key]) BUSINESSES[key].data = { ...BUSINESSES[key].data, ...parsed[key].data }; 
            else BUSINESSES[key] = parsed[key]; 
          }); 
        } 
      } catch (e2) {} 
    } 
  } else { 
    try { 
      const backup = localStorage.getItem('dashboard_backup'); 
      if (backup) { 
        const parsed = JSON.parse(backup); 
        Object.keys(parsed).forEach(key => { 
          if (BUSINESSES[key]) BUSINESSES[key].data = { ...BUSINESSES[key].data, ...parsed[key].data }; 
          else BUSINESSES[key] = parsed[key]; 
        }); 
      } 
    } catch (e) {} 
    updateSyncStatus('ãƒ­ãƒ¼ã‚«ãƒ«'); 
  } 
  selectBusiness(currentBusiness); 
}
document.addEventListener('DOMContentLoaded', () => { initializeData(); renderTabs(); setupDragDrop(); });

// ========== è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ ==========
function setViewMode(mode) {
  viewMode = mode;
  document.getElementById('view-period').classList.toggle('active', mode === 'period');
  document.getElementById('view-total').classList.toggle('active', mode === 'total');
  document.getElementById('period-selector').classList.toggle('hidden', mode === 'total');
  document.getElementById('totals-section').classList.toggle('hidden', mode !== 'total');
  if (mode === 'total') renderTotalsSection();
  renderSummary(); renderCryptoSection(); renderGameSection(); renderProviderSection();
}

// ========== ãƒˆãƒ¼ã‚¿ãƒ«ãƒ»å¹³å‡è¨ˆç®— ==========
function calculateTotalsAndAverages(businessName) {
  const business = BUSINESSES[businessName]; if (!business || !business.data) return null;
  const periods = Object.keys(business.data); if (periods.length === 0) return null;
  const totals = {}, counts = {};
  periods.forEach(period => {
    const periodData = business.data[period], summary = periodData?.ã‚µãƒãƒªãƒ¼ || periodData || {};
    Object.entries(summary).forEach(([key, val]) => { if (typeof val === 'number' && !isNaN(val)) { if (!totals[key]) { totals[key] = 0; counts[key] = 0; } totals[key] += val; counts[key]++; } });
  });
  const result = { totals: {}, averages: {}, periodCount: periods.length };
  Object.keys(totals).forEach(key => { result.totals[key] = totals[key]; result.averages[key] = totals[key] / counts[key]; });
  return result;
}

function renderTotalsSection() {
  const container = document.getElementById('totals-grid');
  const result = calculateTotalsAndAverages(currentBusiness);
  if (!result) { container.innerHTML = '<p style="opacity:0.7">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>'; return; }
  const business = BUSINESSES[currentBusiness], type = business?.type || 'samExcel';
  let metrics = type === 'samExcel' ? [
    { key: 'T/O', alt: ['ç·TO'], label: 'T/O', type: 'total' },
    { key: 'GGR(WIN/LOSE)', alt: ['GGR','WIN/LOSE'], label: 'GGR', type: 'total' },
    { key: 'NGR', alt: ['ç·NGR'], label: 'NGR', type: 'total' },
    { key: 'å›åé‡‘é¡', alt: ['ç·å›åé¡'], label: 'å›åé‡‘é¡', type: 'total' },
    { key: 'å‡ºé‡‘é‡‘é¡', alt: ['ç·å‡ºé‡‘é¡'], label: 'å‡ºé‡‘é‡‘é¡', type: 'total' },
    { key: 'RTP', label: 'RTP', type: 'avg', format: 'rtp' },
    { key: 'å›åç‡(å…¨ä½“)', label: 'å›åç‡', type: 'avg', format: 'percent' },
    { key: 'FTDæ•°', label: 'FTDæ•°', type: 'total', format: 'number' },
    { key: 'æ®‹æœªå›åé‡‘é¡', label: 'æœªå›åé‡‘é¡', type: 'total' },
    { key: 'é…ã‚Œå›åé‡‘é¡', label: 'é…ã‚Œå›å', type: 'total' }
  ] : type === 'sloten' ? [
    { key: 'GGR', label: 'GGR', type: 'total' },
    { key: 'ç·å…¥é‡‘é¡', label: 'ç·å…¥é‡‘é¡', type: 'total' },
    { key: 'ç·å‡ºé‡‘é¡', label: 'ç·å‡ºé‡‘é¡', type: 'total' },
    { key: 'å…¥å‡ºé‡‘å·®åˆ†', label: 'å…¥å‡ºé‡‘å·®åˆ†', type: 'total' },
    { key: 'ç™»éŒ²äººæ•°', label: 'ç™»éŒ²äººæ•°', type: 'total', format: 'number' },
    { key: 'RTP', label: 'RTP', type: 'avg', format: 'rtp' }
  ] : type === 'agent' ? [
    { key: 'å…¥é‡‘åˆè¨ˆ', label: 'å…¥é‡‘åˆè¨ˆ', type: 'total' },
    { key: 'å‡ºé‡‘åˆè¨ˆ', label: 'å‡ºé‡‘åˆè¨ˆ', type: 'total' },
    { key: 'åç›Šåˆè¨ˆ', label: 'åç›Šåˆè¨ˆ', type: 'total' },
    { key: 'NGR', label: 'NGR', type: 'total' },
    { key: 'ãƒ­ãƒ¼ãƒªãƒ³ã‚°å ±é…¬', label: 'ãƒ­ãƒ¼ãƒªãƒ³ã‚°', type: 'total' }
  ] : type === 'ads' ? [
    { key: 'ã‚³ã‚¹ãƒˆ($)', label: 'ã‚³ã‚¹ãƒˆ($)', type: 'total', format: 'number' },
    { key: 'ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³', label: 'IMP', type: 'total', format: 'number' },
    { key: 'ã‚¯ãƒªãƒƒã‚¯', label: 'ã‚¯ãƒªãƒƒã‚¯', type: 'total', format: 'number' },
    { key: 'ç™»éŒ²æ•°', label: 'ç™»éŒ²', type: 'total', format: 'number' },
    { key: 'å…¥é‡‘æ•°', label: 'å…¥é‡‘', type: 'total', format: 'number' }
  ] : type === 'baccara' ? [
    { key: 'ç™»éŒ²æ•°', label: 'ç™»éŒ²æ•°', type: 'total', format: 'number' },
    { key: 'ç·GGR', label: 'GGR', type: 'total' },
    { key: 'ã‚³ã‚¹ãƒˆ', label: 'ã‚³ã‚¹ãƒˆ', type: 'total' },
    { key: 'NGR', label: 'NGR', type: 'total' }
  ] : [];
  container.innerHTML = `<div class="total-card" style="grid-column:span 2;"><h4>ğŸ“… å¯¾è±¡æœŸé–“æ•°</h4><div class="main-val">${result.periodCount}æœŸé–“</div></div>` + metrics.map(m => { 
    let totalVal = result.totals[m.key], avgVal = result.averages[m.key]; 
    if ((totalVal == null) && m.alt) { for (const k of m.alt) { if (result.totals[k] != null) { totalVal = result.totals[k]; avgVal = result.averages[k]; break; } } } 
    if (totalVal == null) return ''; 
    let fT, fA; 
    if (m.format === 'rtp') { fT = '-'; fA = formatRTP(avgVal); } 
    else if (m.format === 'percent') { fT = '-'; fA = formatPercent(avgVal); } 
    else if (m.format === 'number') { fT = formatNumber(totalVal); fA = formatNumber(avgVal); } 
    else { fT = formatCurrency(totalVal); fA = formatCurrency(avgVal); } 
    return `<div class="total-card"><h4>${m.label}</h4><div class="main-val">${m.type === 'total' ? fT : fA}</div><div class="sub-val">${m.type === 'total' ? 'å¹³å‡: ' + fA : ''}</div></div>`; 
  }).join('');
}

// ========== ä»®æƒ³é€šè²¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå††ã‚°ãƒ©ãƒ•ä»˜ãï¼‰ ==========
function renderCryptoSection() {
  const section = document.getElementById('crypto-section');
  const container = document.getElementById('crypto-grid');
  const business = BUSINESSES[currentBusiness];
  
  let cryptoData = null;
  let depositTotal = 0;
  let withdrawTotal = 0;
  
  if (viewMode === 'total') {
    // å…¨æœŸé–“ï¼šå…¨ã¦ã®æœŸé–“ã®ä»®æƒ³é€šè²¨ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
    const allCrypto = {};
    const periods = Object.keys(business?.data || {});
    periods.forEach(period => {
      const periodCrypto = business.data[period]?.ä»®æƒ³é€šè²¨;
      if (periodCrypto) {
        Object.entries(periodCrypto).forEach(([coin, data]) => {
          if (!allCrypto[coin]) allCrypto[coin] = { ä»¶æ•°: 0, é‡‘é¡: 0 };
          allCrypto[coin].ä»¶æ•° += data.ä»¶æ•° || 0;
          allCrypto[coin].é‡‘é¡ += data.é‡‘é¡ || 0;
        });
      }
      depositTotal += business.data[period]?.å…¥é‡‘æ–¹æ³•?.['ä»®æƒ³é€šè²¨'] || 0;
      withdrawTotal += business.data[period]?.å‡ºé‡‘æ–¹æ³•?.['ä»®æƒ³é€šè²¨'] || 0;
    });
    if (Object.keys(allCrypto).length > 0) cryptoData = allCrypto;
  } else {
    const periodData = business?.data?.[currentPeriod];
    cryptoData = periodData?.ä»®æƒ³é€šè²¨ || null;
    depositTotal = periodData?.å…¥é‡‘æ–¹æ³•?.['ä»®æƒ³é€šè²¨'] || 0;
    withdrawTotal = periodData?.å‡ºé‡‘æ–¹æ³•?.['ä»®æƒ³é€šè²¨'] || 0;
  }
  
  if (!cryptoData && depositTotal === 0 && withdrawTotal === 0) { section.classList.add('hidden'); return; }
  section.classList.remove('hidden');
  
  // å††ã‚°ãƒ©ãƒ•ç”¨ãƒ‡ãƒ¼ã‚¿
  const labels = [], values = [], colors = ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];
  let html = '';
  
  if (cryptoData && Object.keys(cryptoData).length > 0) {
    const total = Object.values(cryptoData).reduce((sum, c) => sum + (c.é‡‘é¡ || 0), 0);
    Object.entries(cryptoData).forEach(([coin, data], i) => {
      const amount = data.é‡‘é¡ || 0;
      const pct = total > 0 ? (amount / total * 100).toFixed(1) : 0;
      labels.push(coin); values.push(amount);
      html += `<div class="crypto-card"><h5>${coin}</h5><div class="crypto-val">${formatCurrency(amount)}</div><div class="crypto-pct">${data.ä»¶æ•° || 0}ä»¶ (${pct}%)</div></div>`;
    });
    html = `<div class="crypto-card" style="grid-column:span 2;background:#dcfce7;"><h5>ğŸ’° ä»®æƒ³é€šè²¨åˆè¨ˆ</h5><div class="crypto-val">${formatCurrency(total)}</div></div>` + html;
  } else {
    if (depositTotal > 0) { labels.push('å…¥é‡‘'); values.push(depositTotal); html += `<div class="crypto-card"><h5>å…¥é‡‘</h5><div class="crypto-val">${formatCurrency(depositTotal)}</div></div>`; }
    if (withdrawTotal > 0) { labels.push('å‡ºé‡‘'); values.push(withdrawTotal); html += `<div class="crypto-card"><h5>å‡ºé‡‘</h5><div class="crypto-val">${formatCurrency(withdrawTotal)}</div></div>`; }
  }
  
  container.innerHTML = html;
  
  // å††ã‚°ãƒ©ãƒ•æç”»
  if (cryptoPieChart) cryptoPieChart.destroy();
  if (values.length > 0) {
    const ctx = document.getElementById('crypto-pie-chart').getContext('2d');
    cryptoPieChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, values.length) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } } } });
  }
}

// ========== ã‚²ãƒ¼ãƒ ç¨®åˆ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå††ã‚°ãƒ©ãƒ•ä»˜ãï¼‰ ==========
function renderGameSection() {
  const section = document.getElementById('game-section');
  const container = document.getElementById('game-grid');
  const business = BUSINESSES[currentBusiness];
  
  let games = null;
  
  if (viewMode === 'total') {
    // å…¨æœŸé–“ï¼šå…¨ã¦ã®æœŸé–“ã®ã‚²ãƒ¼ãƒ åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
    const allGames = {};
    const periods = Object.keys(business?.data || {});
    periods.forEach(period => {
      const periodGames = business.data[period]?.ã‚²ãƒ¼ãƒ åˆ¥;
      if (periodGames) {
        Object.entries(periodGames).forEach(([game, stats]) => {
          if (!allGames[game]) allGames[game] = { ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: 0, TO: 0, GGR: 0 };
          allGames[game].ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° += stats.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° || 0;
          allGames[game].TO += stats.TO || 0;
          allGames[game].GGR += stats.GGR || 0;
        });
      }
    });
    if (Object.keys(allGames).length > 0) games = allGames;
  } else {
    const periodData = business?.data?.[currentPeriod];
    games = periodData?.ã‚²ãƒ¼ãƒ åˆ¥;
  }
  
  if (!games || Object.keys(games).length === 0) { section.classList.add('hidden'); return; }
  section.classList.remove('hidden');
  
  const labels = [], values = [], colors = ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6'];
  let html = '';
  
  Object.entries(games).forEach(([game, stats], i) => {
    const ggr = stats.GGR || 0;
    labels.push(game); values.push(Math.max(0, ggr));
    html += `<div class="provider-card"><h5>ğŸ° ${game}</h5><div class="provider-stats"><div class="stat-item"><div class="stat-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</div><div class="stat-val">${formatNumber(stats.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°)}</div></div><div class="stat-item"><div class="stat-label">T/O</div><div class="stat-val">${formatCurrency(stats.TO)}</div></div><div class="stat-item"><div class="stat-label">GGR</div><div class="stat-val">${formatCurrency(ggr)}</div></div><div class="stat-item"><div class="stat-label">RTP</div><div class="stat-val">${stats.TO > 0 ? formatRTP((stats.TO - ggr) / stats.TO) : '-'}</div></div></div></div>`;
  });
  
  container.innerHTML = html;
  
  if (gamePieChart) gamePieChart.destroy();
  if (values.length > 0) {
    const ctx = document.getElementById('game-pie-chart').getContext('2d');
    gamePieChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, values.length) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } } } });
  }
}

// ========== ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå††ã‚°ãƒ©ãƒ•ä»˜ãï¼‰ ==========
function renderProviderSection() {
  const section = document.getElementById('provider-section');
  const container = document.getElementById('provider-grid');
  const business = BUSINESSES[currentBusiness];
  
  let providers = null;
  
  if (viewMode === 'total') {
    // å…¨æœŸé–“ï¼šå…¨ã¦ã®æœŸé–“ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
    const allProviders = {};
    const periods = Object.keys(business?.data || {});
    periods.forEach(period => {
      const periodProviders = business.data[period]?.ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼;
      if (periodProviders) {
        Object.entries(periodProviders).forEach(([name, stats]) => {
          if (!allProviders[name]) allProviders[name] = { ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: 0, è³­ã‘é‡‘é¡: 0, é…å½“é‡‘é¡: 0, GGR: 0 };
          allProviders[name].ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° += stats.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° || 0;
          allProviders[name].è³­ã‘é‡‘é¡ += stats.è³­ã‘é‡‘é¡ || 0;
          allProviders[name].é…å½“é‡‘é¡ += stats.é…å½“é‡‘é¡ || 0;
          allProviders[name].GGR += stats.GGR || 0;
        });
      }
    });
    if (Object.keys(allProviders).length > 0) providers = allProviders;
  } else {
    const periodData = business?.data?.[currentPeriod];
    providers = periodData?.ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼;
  }
  
  if (!providers || Object.keys(providers).length === 0) { section.classList.add('hidden'); return; }
  section.classList.remove('hidden');
  
  const labels = [], values = [], colors = ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#06b6d4', '#84cc16'];
  let html = '';
  
  // GGRã§ã‚½ãƒ¼ãƒˆ
  const sorted = Object.entries(providers).sort((a, b) => (b[1].GGR || 0) - (a[1].GGR || 0));
  sorted.forEach(([name, stats], i) => {
    const ggr = stats.GGR || 0;
    labels.push(name); values.push(Math.max(0, ggr));
    html += `<div class="provider-card"><h5>ğŸ­ ${name}</h5><div class="provider-stats"><div class="stat-item"><div class="stat-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</div><div class="stat-val">${formatNumber(stats.ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°)}</div></div><div class="stat-item"><div class="stat-label">è³­ã‘é‡‘é¡</div><div class="stat-val">${formatCurrency(stats.è³­ã‘é‡‘é¡)}</div></div><div class="stat-item"><div class="stat-label">GGR</div><div class="stat-val">${formatCurrency(ggr)}</div></div><div class="stat-item"><div class="stat-label">RTP</div><div class="stat-val">${stats.è³­ã‘é‡‘é¡ > 0 ? formatRTP(stats.é…å½“é‡‘é¡ / stats.è³­ã‘é‡‘é¡) : '-'}</div></div></div></div>`;
  });
  
  container.innerHTML = html;
  
  if (providerPieChart) providerPieChart.destroy();
  if (values.length > 0) {
    const ctx = document.getElementById('provider-pie-chart').getContext('2d');
    providerPieChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, values.length) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } } } });
  }
}

// ========== ç¶™ç¶šKPIæ¨ç§»ã‚°ãƒ©ãƒ• ==========
function renderRetentionChart() {
  const section = document.getElementById('retention-chart-section');
  const business = BUSINESSES[currentBusiness];
  
  // ã‚¹ãƒ­å¤©ä»¥å¤–ã¯éè¡¨ç¤º
  if (business?.type !== 'sloten') {
    section.classList.add('hidden');
    if (retentionChart) { retentionChart.destroy(); retentionChart = null; }
    return;
  }
  
  const data = business.data || {};
  const periods = sortPeriods(Object.keys(data)).reverse().slice(-12);
  
  if (periods.length === 0) {
    section.classList.add('hidden');
    return;
  }
  
  section.classList.remove('hidden');
  const ctx = document.getElementById('retention-chart').getContext('2d');
  if (retentionChart) retentionChart.destroy();
  
  const datasets = [
    {
      label: 'ç™»éŒ²äººæ•°',
      data: periods.map(p => data[p]?.ã‚µãƒãƒªãƒ¼?.['ç™»éŒ²äººæ•°'] || 0),
      backgroundColor: 'rgba(59, 130, 246, 0.7)',
      borderColor: 'rgba(59, 130, 246, 1)',
      borderWidth: 2,
      type: 'bar'
    },
    {
      label: 'å‰æœˆç™»éŒ²ã‹ã‚‰ã®ç¶™ç¶š',
      data: periods.map(p => data[p]?.ã‚µãƒãƒªãƒ¼?.['å‰æœˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°'] || 0),
      backgroundColor: 'rgba(16, 185, 129, 0.7)',
      borderColor: 'rgba(16, 185, 129, 1)',
      borderWidth: 2,
      type: 'bar'
    },
    {
      label: 'å‰ã€…æœˆç™»éŒ²ã‹ã‚‰ã®ç¶™ç¶š',
      data: periods.map(p => data[p]?.ã‚µãƒãƒªãƒ¼?.['å‰ã€…æœˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°'] || 0),
      backgroundColor: 'rgba(245, 158, 11, 0.7)',
      borderColor: 'rgba(245, 158, 11, 1)',
      borderWidth: 2,
      type: 'bar'
    },
    {
      label: '3ã‹æœˆä»¥ä¸Šå‰ã‹ã‚‰ã®ç¶™ç¶š',
      data: periods.map(p => data[p]?.ã‚µãƒãƒªãƒ¼?.['3ã‹æœˆä»¥ä¸Šå‰ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°'] || 0),
      backgroundColor: 'rgba(139, 92, 246, 0.7)',
      borderColor: 'rgba(139, 92, 246, 1)',
      borderWidth: 2,
      type: 'bar'
    },
    {
      label: 'å‰æœˆç¶™ç¶šç‡',
      data: periods.map(p => {
        const rate = data[p]?.ã‚µãƒãƒªãƒ¼?.['å‰æœˆç¶™ç¶šç‡'];
        return rate ? rate * 100 : 0;
      }),
      borderColor: 'rgba(239, 68, 68, 1)',
      backgroundColor: 'rgba(239, 68, 68, 0.1)',
      borderWidth: 3,
      type: 'line',
      yAxisID: 'y1',
      tension: 0.3
    }
  ];
  
  retentionChart = new Chart(ctx, {
    data: { labels: periods, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'top' } },
      scales: {
        y: {
          beginAtZero: true,
          position: 'left',
          title: { display: true, text: 'äººæ•°' },
          ticks: { callback: v => v.toLocaleString() }
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          max: 100,
          title: { display: true, text: 'ç¶™ç¶šç‡(%)' },
          grid: { drawOnChartArea: false },
          ticks: { callback: v => v + '%' }
        }
      }
    }
  });
}

// ========== ãƒ¡ã‚¤ãƒ³æç”» ==========
function renderTabs() { const container = document.getElementById('business-tabs'); container.innerHTML = Object.keys(BUSINESSES).map(name => `<button class="tab ${name === currentBusiness ? 'active' : ''}" onclick="selectBusiness('${name}')">${name}</button>`).join('') + '<button class="btn btn-danger" onclick="deleteBusiness()" style="margin-left:auto">ğŸ—‘ï¸</button>'; }
function selectBusiness(name) { currentBusiness = name; const business = BUSINESSES[name], data = business?.data || {}, periods = sortPeriods(Object.keys(data)); currentPeriod = periods[0] || null; renderTabs(); renderPeriodSelector(periods); if (viewMode === 'total') renderTotalsSection(); renderSummary(); renderKPISections(); renderCryptoSection(); renderGameSection(); renderProviderSection(); renderChart(); renderRetentionChart(); renderTable(); }
function renderPeriodSelector(periods) { const container = document.getElementById('period-selector'); if (periods.length === 0) { container.innerHTML = '<span style="color:#94a3b8;font-size:13px">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</span>'; return; } container.innerHTML = periods.map(p => `<button class="period-btn ${p === currentPeriod ? 'active' : ''}" onclick="selectPeriod('${p}')">${p}</button>`).join('') + `<button class="btn btn-danger" style="padding:4px 10px;font-size:11px" onclick="deletePeriod()">æœŸé–“å‰Šé™¤</button>`; }
function selectPeriod(period) { currentPeriod = period; renderPeriodSelector(sortPeriods(Object.keys(BUSINESSES[currentBusiness]?.data || {}))); renderSummary(); renderKPISections(); renderCryptoSection(); renderGameSection(); renderProviderSection(); renderTable(); }
function deletePeriod() { const business = BUSINESSES[currentBusiness], periods = Object.keys(business?.data || {}); if (periods.length <= 1) { alert('æœ€å¾Œã®æœŸé–“ã¯å‰Šé™¤ã§ãã¾ã›ã‚“'); return; } if (confirm(`ã€Œ${currentPeriod}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) { delete business.data[currentPeriod]; saveBusinessData(); selectBusiness(currentBusiness); } }

function renderSummary() {
  const container = document.getElementById('summary-section');
  const business = BUSINESSES[currentBusiness];
  if (!business) { container.innerHTML = ''; return; }
  let data;
  if (viewMode === 'total') { const result = calculateTotalsAndAverages(currentBusiness); if (!result) { container.innerHTML = ''; return; } data = result.totals; }
  else { const periodData = business.data?.[currentPeriod]; data = periodData?.ã‚µãƒãƒªãƒ¼ || periodData || {}; }
  if (!data || Object.keys(data).length === 0) { container.innerHTML = '<div class="card" style="text-align:center;padding:40px;color:#94a3b8">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  const type = business.type || 'samExcel';
  const colors = ['linear-gradient(135deg,#3b82f6,#1d4ed8)','linear-gradient(135deg,#10b981,#059669)','linear-gradient(135deg,#f59e0b,#d97706)','linear-gradient(135deg,#ef4444,#dc2626)','linear-gradient(135deg,#8b5cf6,#7c3aed)','linear-gradient(135deg,#ec4899,#db2777)'];
  let cards = type === 'samExcel' ? [{ key: 'T/O', label: 'T/O' },{ key: 'GGR(WIN/LOSE)', alt: ['GGR','WIN/LOSE'], label: 'GGR' },{ key: 'NGR', label: 'NGR' },{ key: 'å›åç‡(å…¨ä½“)', alt: ['å›åç‡'], label: 'å›åç‡', format: 'percent' },{ key: 'GGR(å›åé‡‘é¡-å‡ºé‡‘é‡‘é¡)', label: 'å…¥å‡ºé‡‘å·®åˆ†' }] : type === 'sloten' ? [{ key: 'GGR', label: 'GGR' },{ key: 'ç·å…¥é‡‘é¡', label: 'ç·å…¥é‡‘é¡' },{ key: 'ç·å‡ºé‡‘é¡', label: 'ç·å‡ºé‡‘é¡' },{ key: 'å…¥å‡ºé‡‘å·®åˆ†', label: 'å…¥å‡ºé‡‘å·®åˆ†' },{ key: 'RTP', label: 'RTP', format: 'percent' },{ key: 'ç™»éŒ²äººæ•°', label: 'ç™»éŒ²äººæ•°', format: 'number' }] : type === 'ads' ? [{ key: 'ã‚³ã‚¹ãƒˆ($)', label: 'ã‚³ã‚¹ãƒˆ($)', format: 'number' },{ key: 'ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³', label: 'IMP', format: 'number' },{ key: 'ã‚¯ãƒªãƒƒã‚¯', label: 'ã‚¯ãƒªãƒƒã‚¯', format: 'number' },{ key: 'ç™»éŒ²æ•°', label: 'ç™»éŒ²', format: 'number' },{ key: 'å…¥é‡‘æ•°', label: 'å…¥é‡‘', format: 'number' },{ key: 'CPA(ç¨è¾¼)', label: 'CPA' }] : type === 'agent' ? [{ key: 'å…¥é‡‘åˆè¨ˆ', label: 'å…¥é‡‘åˆè¨ˆ' },{ key: 'å‡ºé‡‘åˆè¨ˆ', label: 'å‡ºé‡‘åˆè¨ˆ' },{ key: 'åç›Šåˆè¨ˆ', label: 'åç›Šåˆè¨ˆ' },{ key: 'NGR', label: 'NGR' }] : type === 'baccara' ? [{ key: 'ç™»éŒ²æ•°', label: 'ç™»éŒ²æ•°', format: 'number' },{ key: 'ç·GGR', label: 'GGR' },{ key: 'ã‚³ã‚¹ãƒˆ', label: 'ã‚³ã‚¹ãƒˆ' },{ key: 'NGR', label: 'NGR' }] : [];
  container.innerHTML = '<div class="summary-grid">' + cards.map((card, i) => { let val = data[card.key]; if (val == null && card.alt) { for (const k of card.alt) { if (data[k] != null) { val = data[k]; break; } } } if (val == null) return ''; let formatted = card.key === 'RTP' ? formatRTP(val) : card.format === 'percent' ? formatPercent(val) : card.format === 'number' ? formatNumber(val) : formatCurrency(val); const bg = val < 0 && card.format !== 'percent' ? 'linear-gradient(135deg,#ef4444,#dc2626)' : colors[i % colors.length]; return `<div class="summary-card" style="background:${bg}"><h3>${card.label}</h3><div class="value">${formatted}</div></div>`; }).join('') + '</div>';
}

function renderKPISections() {
  const container = document.getElementById('kpi-sections');
  const business = BUSINESSES[currentBusiness];
  if (!business) { container.innerHTML = ''; return; }
  
  let data;
  if (viewMode === 'total') {
    const result = calculateTotalsAndAverages(currentBusiness);
    if (!result) { container.innerHTML = ''; return; }
    data = result.totals;
  } else {
    const periodData = business.data?.[currentPeriod];
    data = periodData?.ã‚µãƒãƒªãƒ¼ || periodData || {};
  }
  
  if (!data || Object.keys(data).length === 0) { container.innerHTML = ''; return; }
  const type = business.type || 'samExcel';
  if (type === 'agent' || type === 'ads' || type === 'baccara') { container.innerHTML = ''; return; }
  const sections = [
    { title: 'ğŸ“ å–¶æ¥­KPI', keys: ['ãƒªã‚¹ãƒˆä»¶æ•°','ç·ç™»éŒ²æ•°','ç™»éŒ²äººæ•°','æ‰“é›»æ•°','ç€é›»æ•°','LINEç™»éŒ²æ•°','ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ•°','ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°','ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ¬ã‚¤äººæ•°ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰','ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°','å…¥é‡‘è€…æ•°(ãƒ‡ã‚¤ãƒªãƒ¼ãƒ¦ãƒ‹ãƒ¼ã‚¯)'], bg: '#dbeafe' },
    { title: 'ğŸ¯ è»¢æ›KPI', keys: ['FTPæ•°','FTPç‡','FTDæ•°','FTDç‡','FTWæ•°','FTWç‡','FTDWæ•°','FTDWç‡','FTDã®ã¿å…¥é‡‘è€…æ•°','FTDã®ã¿ç‡','2ndå…¥é‡‘è€…æ•°','2ndç‡','3rdå…¥é‡‘è€…æ•°','3rdç‡','Activeå…¥é‡‘è€…æ•°','Activeç‡','ä»Šæœˆç™»éŒ²ã®FTDä»¥é™ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°','ä»Šæœˆç™»éŒ²FTDä»¥é™ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰²åˆ'], bg: '#dcfce7' },
    { title: 'ğŸ”„ ç¶™ç¶šKPI', keys: ['å‰æœˆãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ•°','å¼•ç¶™ããƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°','å‰æœˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°','å‰æœˆç¶™ç¶šç‡','å‰ã€…æœˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°','å‰ã€…æœˆç¶™ç¶šç‡','3ã‹æœˆä»¥ä¸Šå‰ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°','3ã‹æœˆä»¥ä¸Šå‰ç¶™ç¶šç‡'], bg: '#fef3c7' },
    { title: 'ğŸ’° åç›ŠKPI', keys: ['T/O','ç·TO','T/O(ãƒªã‚¢ãƒ«ã®ã¿)','å‹åˆ©é‡‘','å‹åˆ©é‡‘(ãƒªã‚¢ãƒ«ã®ã¿)','RTP','GGR(WIN/LOSE)','GGR','WIN/LOSE','LTV(WIN/LOSE)','GGRLTV','ç·å·®åˆ†åˆ©ç›Š','ç·NGR','å¹³å‡NGR'], bg: '#e0e7ff' },
    { title: 'ğŸ’µ å›åKPI', keys: ['å›åäºˆå®šé‡‘é¡','å›åé‡‘é¡','ç·å›åé¡','å›åç‡(å…¨ä½“)','å›åç‡(ä»Šæœˆ)','å‡ºé‡‘é‡‘é¡','ç·å‡ºé‡‘é¡','GGR(å›åé‡‘é¡-å‡ºé‡‘é‡‘é¡)','å›åå‡ºé‡‘å·®åˆ†','LTV(GGR)','NGR','ç·å…¥é‡‘é¡','å…¥å‡ºé‡‘å·®åˆ†'], bg: '#fce7f3' },
    { title: 'ğŸ¦ ä¿¡ç”¨ãƒ»ãƒœãƒ¼ãƒŠã‚¹KPI', keys: ['ç·ä¿¡ç”¨æ ','å¹³å‡ä¿¡ç”¨æ ','å¹³å‡Creditå˜ä¾¡','ç·ãƒœãƒ¼ãƒŠã‚¹','ãƒœãƒ¼ãƒŠã‚¹å¯¾è±¡è€…æ•°','ç·ãƒœãƒ¼ãƒŠã‚¹ä»˜ä¸é‡‘é¡','ãƒœãƒ¼ãƒŠã‚¹å¯¾è±¡å…¥é‡‘é¡','ãƒœãƒ¼ãƒŠã‚¹å¯¾è±¡NGR'], bg: '#fef9c3' },
    { title: 'ğŸ“Š é¡§å®¢åˆ†æKPI', keys: ['å¹³å‡ãƒ—ãƒ¬ã‚¤æœˆé–“','äº‹å‰æ¸…ç®—å›æ•°','äº‹å‰æ¸…ç®—é‡‘é¡','äº‹å‰æ¸…ç®—å‰²åˆ','äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ','é€šå¸¸æ¸…ç®—å›æ•°','é€šå¸¸æ¸…ç®—é‡‘é¡','é€šå¸¸æ¸…ç®—å‰²åˆ','é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ'], bg: '#e0f2fe' },
    { title: 'âš ï¸ æœªå›åãƒ»é…ã‚ŒKPI', keys: ['æœªå›åè€…æ•°','æ®‹æœªå›åé‡‘é¡','é…ã‚Œå›åä»¶æ•°','é…ã‚Œå›åé‡‘é¡'], bg: '#fee2e2' },
    { title: 'ğŸ‘¥ æ‹…å½“è€…KPI', keys: ['æ‹…å½“è€…æ•°','æ‹…å½“è€…è¨ˆ_ç™»éŒ²æ•°','æ‹…å½“è€…è¨ˆ_FTDæ•°','æ‹…å½“è€…è¨ˆ_GGR','æ‹…å½“è€…è¨ˆ_NGR'], bg: '#e0e7ff' }
  ];
  const percentKeys = ['FTPç‡','FTDç‡','FTWç‡','FTDWç‡','RTP','å›åç‡(å…¨ä½“)','å›åç‡(ä»Šæœˆ)','ä»Šæœˆç™»éŒ²FTDä»¥é™ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰²åˆ','å‰æœˆç¶™ç¶šç‡','å‰ã€…æœˆç¶™ç¶šç‡','3ã‹æœˆä»¥ä¸Šå‰ç¶™ç¶šç‡','äº‹å‰æ¸…ç®—å‰²åˆ','é€šå¸¸æ¸…ç®—å‰²åˆ','äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ','é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ','FTDã®ã¿ç‡','2ndç‡','3rdç‡','Activeç‡'];
  const currencyKeys = ['T/O','ç·TO','T/O(ãƒªã‚¢ãƒ«ã®ã¿)','å‹åˆ©é‡‘','å‹åˆ©é‡‘(ãƒªã‚¢ãƒ«ã®ã¿)','GGR(WIN/LOSE)','GGR','WIN/LOSE','LTV(WIN/LOSE)','å›åäºˆå®šé‡‘é¡','å›åé‡‘é¡','ç·å›åé¡','å‡ºé‡‘é‡‘é¡','ç·å‡ºé‡‘é¡','GGR(å›åé‡‘é¡-å‡ºé‡‘é‡‘é¡)','å›åå‡ºé‡‘å·®åˆ†','LTV(GGR)','NGR','åˆè¨ˆçµŒè²»','ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ•ã‚£ãƒ¼','äººä»¶è²»','é€šä¿¡è²»','ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–','ãƒšã‚¤ãƒ¡ãƒ³ãƒˆãƒ•ã‚£ãƒ¼','é›‘è²»ãƒ»ç¦åˆ©åšç”Ÿç­‰','BK','åˆ©ç›Š','ç·å…¥é‡‘é¡','ç·å‡ºé‡‘é¡','å…¥å‡ºé‡‘å·®åˆ†','GGRLTV','ç·å·®åˆ†åˆ©ç›Š','ç·NGR','å¹³å‡NGR','ç·ä¿¡ç”¨æ ','å¹³å‡ä¿¡ç”¨æ ','å¹³å‡Creditå˜ä¾¡','ç·ãƒœãƒ¼ãƒŠã‚¹','ç·ãƒœãƒ¼ãƒŠã‚¹ä»˜ä¸é‡‘é¡','ãƒœãƒ¼ãƒŠã‚¹å¯¾è±¡å…¥é‡‘é¡','ãƒœãƒ¼ãƒŠã‚¹å¯¾è±¡NGR','æ®‹æœªå›åé‡‘é¡','é…ã‚Œå›åé‡‘é¡','æ‹…å½“è€…è¨ˆ_GGR','æ‹…å½“è€…è¨ˆ_NGR','äº‹å‰æ¸…ç®—é‡‘é¡','é€šå¸¸æ¸…ç®—é‡‘é¡'];
  container.innerHTML = sections.map(section => { const items = section.keys.filter(k => data[k] != null); if (items.length === 0) return ''; return `<div class="card" style="background:${section.bg}"><div class="section-title">${section.title}</div><div class="kpi-grid">${items.map(key => { const val = data[key]; let formatted = key === 'RTP' ? formatRTP(val) : percentKeys.includes(key) ? formatPercent(val) : currencyKeys.includes(key) ? formatCurrency(val) : formatNumber(val); const isNeg = typeof val === 'number' && val < 0; return `<div class="kpi-item"><div class="label">${key}</div><div class="val ${isNeg ? 'negative' : ''}">${formatted}</div></div>`; }).join('')}</div></div>`; }).join('');
  
  // å…¥é‡‘/å‡ºé‡‘æ–¹æ³•ã€Affiliateã€ãƒªã‚¹ãƒˆç¨®åˆ¥
  if (viewMode !== 'total') {
    const periodData = business.data?.[currentPeriod];
    if (periodData?.ãƒªã‚¹ãƒˆç¨®åˆ¥) {
      const listOrder = ['B', 'E', 'T', 'S', 'BE', 'C', 'ç´¹ä»‹', 'ãã®ä»–'];
      const sortedList = listOrder.filter(k => periodData.ãƒªã‚¹ãƒˆç¨®åˆ¥[k] != null).map(k => [k, periodData.ãƒªã‚¹ãƒˆç¨®åˆ¥[k]]);
      container.innerHTML += `<div class="card" style="background:#f0fdf4"><div class="section-title">ğŸ“‹ ãƒªã‚¹ãƒˆç¨®åˆ¥</div><div class="kpi-grid">${sortedList.map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatNumber(v)}ä»¶</div></div>`).join('')}</div></div>`;
    }
    if (periodData?.å…¥é‡‘æ–¹æ³•) container.innerHTML += `<div class="card" style="background:#e0f2fe"><div class="section-title">ğŸ’³ å…¥é‡‘æ–¹æ³•</div><div class="kpi-grid">${Object.entries(periodData.å…¥é‡‘æ–¹æ³•).map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatCurrency(v)}</div></div>`).join('')}</div></div>`;
    if (periodData?.å‡ºé‡‘æ–¹æ³•) container.innerHTML += `<div class="card" style="background:#fef9c3"><div class="section-title">ğŸ¦ å‡ºé‡‘æ–¹æ³•</div><div class="kpi-grid">${Object.entries(periodData.å‡ºé‡‘æ–¹æ³•).map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatCurrency(v)}</div></div>`).join('')}</div></div>`;
    if (periodData?.Affiliate) container.innerHTML += `<div class="card" style="background:#ecfdf5"><div class="section-title">ğŸ¤ Affiliate</div><div class="kpi-grid">${Object.entries(periodData.Affiliate).map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${k.includes('ç‡') ? formatPercent(v) : k.includes('æ•°') ? formatNumber(v) : formatCurrency(v)}</div></div>`).join('')}</div></div>`;
  } else {
    // å…¨æœŸé–“ãƒ¢ãƒ¼ãƒ‰ï¼šãƒªã‚¹ãƒˆç¨®åˆ¥ã‚’é›†è¨ˆ
    const allListTypes = {};
    const validListTypes = ['B', 'E', 'T', 'S', 'BE', 'C', 'ç´¹ä»‹'];
    const periods = Object.keys(business.data || {});
    periods.forEach(period => {
      const listTypes = business.data[period]?.ãƒªã‚¹ãƒˆç¨®åˆ¥;
      if (listTypes) {
        Object.entries(listTypes).forEach(([type, count]) => {
          let targetType = validListTypes.includes(type) ? type : 'ãã®ä»–';
          if (!allListTypes[targetType]) allListTypes[targetType] = 0;
          allListTypes[targetType] += count;
        });
      }
    });
    if (Object.keys(allListTypes).length > 0) {
      const listOrder = ['B', 'E', 'T', 'S', 'BE', 'C', 'ç´¹ä»‹', 'ãã®ä»–'];
      const sortedList = listOrder.filter(k => allListTypes[k] != null).map(k => [k, allListTypes[k]]);
      container.innerHTML += `<div class="card" style="background:#f0fdf4"><div class="section-title">ğŸ“‹ ãƒªã‚¹ãƒˆç¨®åˆ¥ï¼ˆå…¨æœŸé–“ï¼‰</div><div class="kpi-grid">${sortedList.map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatNumber(v)}ä»¶</div></div>`).join('')}</div></div>`;
    }
  }
}

function renderChart() {
  const ctx = document.getElementById('main-chart').getContext('2d');
  const business = BUSINESSES[currentBusiness];
  if (!business) { if (chartInstance) chartInstance.destroy(); return; }
  const data = business.data || {};
  const periods = sortPeriods(Object.keys(data)).reverse().slice(-12);
  if (chartInstance) chartInstance.destroy();
  if (periods.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); return; }
  const type = business.type || 'samExcel';
  let datasets = type === 'samExcel' ? [{ label: 'GGR', data: periods.map(p => { const d = data[p]?.ã‚µãƒãƒªãƒ¼ || data[p] || {}; return d['GGR(WIN/LOSE)'] || d['GGR'] || d['WIN/LOSE'] || 0; }), backgroundColor: 'rgba(59,130,246,0.7)' },{ label: 'NGR', data: periods.map(p => (data[p]?.ã‚µãƒãƒªãƒ¼?.['NGR'] || data[p]?.['NGR'] || 0)), backgroundColor: 'rgba(16,185,129,0.7)' }] : type === 'sloten' ? [{ label: 'GGR', data: periods.map(p => (data[p]?.ã‚µãƒãƒªãƒ¼?.['GGR'] || data[p]?.['GGR'] || 0)), backgroundColor: 'rgba(59,130,246,0.7)' },{ label: 'å…¥å‡ºé‡‘å·®åˆ†', data: periods.map(p => (data[p]?.ã‚µãƒãƒªãƒ¼?.['å…¥å‡ºé‡‘å·®åˆ†'] || data[p]?.['å…¥å‡ºé‡‘å·®åˆ†'] || 0)), backgroundColor: 'rgba(16,185,129,0.7)' }] : [{ label: 'GGR', data: periods.map(p => (data[p]?.ã‚µãƒãƒªãƒ¼?.['ç·GGR'] || data[p]?.ã‚µãƒãƒªãƒ¼?.['GGR'] || 0)), backgroundColor: 'rgba(59,130,246,0.7)' }];
  chartInstance = new Chart(ctx, { type: 'bar', data: { labels: periods, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, ticks: { callback: v => 'Â¥' + (v / 1000000).toFixed(0) + 'M' } } } } });
}

function renderTable() {
  const business = BUSINESSES[currentBusiness];
  let data;
  if (viewMode === 'total') {
    const result = calculateTotalsAndAverages(currentBusiness);
    data = result ? result.totals : {};
  } else {
    const periodData = business?.data?.[currentPeriod];
    data = periodData?.ã‚µãƒãƒªãƒ¼ || periodData || {};
  }
  const header = document.getElementById('table-header');
  const body = document.getElementById('table-body');
  header.innerHTML = '<th>é …ç›®</th><th class="text-right">å€¤</th>';
  const percentKeys = ['FTPç‡','FTDç‡','FTWç‡','FTDWç‡','RTP','å›åç‡(å…¨ä½“)','å›åç‡(ä»Šæœˆ)','ä»Šæœˆç™»éŒ²FTDä»¥é™ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰²åˆ','å‰æœˆç¶™ç¶šç‡','å‰ã€…æœˆç¶™ç¶šç‡'];
  const currencyKeys = ['T/O','ç·TO','T/O(ãƒªã‚¢ãƒ«ã®ã¿)','å‹åˆ©é‡‘','å‹åˆ©é‡‘(ãƒªã‚¢ãƒ«ã®ã¿)','GGR(WIN/LOSE)','GGR','WIN/LOSE','LTV(WIN/LOSE)','å›åäºˆå®šé‡‘é¡','å›åé‡‘é¡','ç·å›åé¡','å‡ºé‡‘é‡‘é¡','ç·å‡ºé‡‘é¡','GGR(å›åé‡‘é¡-å‡ºé‡‘é‡‘é¡)','å›åå‡ºé‡‘å·®åˆ†','LTV(GGR)','NGR','åˆè¨ˆçµŒè²»','ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ•ã‚£ãƒ¼','äººä»¶è²»','é€šä¿¡è²»','ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–','ãƒšã‚¤ãƒ¡ãƒ³ãƒˆãƒ•ã‚£ãƒ¼','é›‘è²»ãƒ»ç¦åˆ©åšç”Ÿç­‰','BK','åˆ©ç›Š','ç·å…¥é‡‘é¡','å…¥å‡ºé‡‘å·®åˆ†','GGRLTV','ç·å·®åˆ†åˆ©ç›Š','ç·NGR','å¹³å‡NGR','ç·ä¿¡ç”¨æ ','å¹³å‡ä¿¡ç”¨æ ','å¹³å‡Creditå˜ä¾¡','ç·ãƒœãƒ¼ãƒŠã‚¹','ç·ãƒœãƒ¼ãƒŠã‚¹ä»˜ä¸é‡‘é¡','ãƒœãƒ¼ãƒŠã‚¹å¯¾è±¡å…¥é‡‘é¡','ãƒœãƒ¼ãƒŠã‚¹å¯¾è±¡NGR','æ®‹æœªå›åé‡‘é¡','é…ã‚Œå›åé‡‘é¡','æ‹…å½“è€…è¨ˆ_GGR','æ‹…å½“è€…è¨ˆ_NGR','äº‹å‰æ¸…ç®—é‡‘é¡','é€šå¸¸æ¸…ç®—é‡‘é¡'];
  const percentKeysTable = ['FTPç‡','FTDç‡','FTWç‡','FTDWç‡','RTP','å›åç‡(å…¨ä½“)','å›åç‡(ä»Šæœˆ)','ä»Šæœˆç™»éŒ²FTDä»¥é™ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰²åˆ','å‰æœˆç¶™ç¶šç‡','å‰ã€…æœˆç¶™ç¶šç‡','3ã‹æœˆä»¥ä¸Šå‰ç¶™ç¶šç‡','äº‹å‰æ¸…ç®—å‰²åˆ','é€šå¸¸æ¸…ç®—å‰²åˆ','äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ','é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ','FTDã®ã¿ç‡','2ndç‡','3rdç‡','Activeç‡'];
  body.innerHTML = Object.entries(data).map(([key, value]) => { if (value === null || value === undefined) return ''; let formatted = key === 'RTP' ? formatRTP(value) : percentKeysTable.includes(key) ? formatPercent(value) : currencyKeys.includes(key) ? formatCurrency(value) : typeof value === 'number' ? formatNumber(value) : String(value); const isNeg = typeof value === 'number' && value < 0; return `<tr><td>${key}</td><td class="text-right ${isNeg ? 'text-red' : ''}">${formatted}</td></tr>`; }).join('');
}

// ========== ãƒ¢ãƒ¼ãƒ€ãƒ« ==========
function showUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); document.getElementById('upload-status').style.display = 'none'; }
function hideUploadModal() { document.getElementById('upload-modal').classList.add('hidden'); }
function showAddBusinessModal() { document.getElementById('add-business-modal').classList.remove('hidden'); }
function hideAddBusinessModal() { document.getElementById('add-business-modal').classList.add('hidden'); }
function setupDragDrop() { const zone = document.getElementById('upload-zone'); zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); }); zone.addEventListener('dragleave', () => zone.classList.remove('dragover')); zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('dragover'); if (e.dataTransfer.files[0]) handleFileUpload(e.dataTransfer.files[0]); }); }
function showStatus(msg, isError = false) { const s = document.getElementById('upload-status'); s.style.display = 'block'; s.style.background = isError ? '#fee2e2' : '#dcfce7'; s.style.color = isError ? '#dc2626' : '#16a34a'; s.textContent = msg; }

// ========== ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ==========
function handleFileUpload(file) {
  if (!file) return;
  const period = document.getElementById('upload-period').value || new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' }).replace(' ', '');
  const uploadType = document.getElementById('upload-type').value;
  const reader = new FileReader();
  if (file.name.endsWith('.zip')) { showStatus('ZIPãƒ•ã‚¡ã‚¤ãƒ«ã¯éå¯¾å¿œã§ã™', true); return; }
  reader.onload = function(e) {
    try {
      if (file.name.endsWith('.csv')) handleCSV(e.target.result, period, uploadType, file.name);
      else { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); handleExcel(workbook, period, uploadType, file.name); }
    } catch (err) { showStatus('ã‚¨ãƒ©ãƒ¼: ' + err.message, true); }
  };
  if (file.name.endsWith('.csv')) reader.readAsText(file, 'UTF-8');
  else reader.readAsArrayBuffer(file);
}

function handleCSV(text, period, uploadType, filename) {
  const parseCSVLine = (line) => { const result = []; let current = ''; let inQuotes = false; for (let i = 0; i < line.length; i++) { const c = line[i]; if (c === '"') inQuotes = !inQuotes; else if (c === ',' && !inQuotes) { result.push(current.trim().replace(/^"|"$/g, '')); current = ''; } else current += c; } result.push(current.trim().replace(/^"|"$/g, '')); return result; };
  const lines = text.replace(/\r\n/g, '\n').split('\n').filter(l => l.trim()).map(l => parseCSVLine(l));
  if (lines.length < 2) { showStatus('CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', true); return; }
  const headerStr = lines[0].join(',').toLowerCase();
  const fn = filename.toLowerCase();
  
  const isCustomerList = fn.includes('é¡§å®¢ãƒªã‚¹ãƒˆ') || fn.includes('customer');
  const isUncollected = fn.includes('æœªå›å') || headerStr.includes('æ®‹æœªå›åé‡‘é¡');
  const isDelayed = fn.includes('é…ã‚Œå›å') || fn.includes('é…ã‚Œ');
  const isBonus = fn.includes('ãƒœãƒ¼ãƒŠã‚¹') || fn.includes('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒƒã‚¯');
  const isAgent = fn.includes('ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ') || fn.includes('agent') || headerStr.includes('teamkyoto');
  const isAds = fn.includes('æ—¥æŠ¥') || fn.includes('åºƒå‘Š') || (headerStr.includes('ã‚³ã‚¹ãƒˆ') && headerStr.includes('ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³'));
  const isSloten = fn.includes('ã‚¹ãƒ­å¤©') || fn.includes('kpi') || (headerStr.includes('é …ç›®å') && headerStr.includes('æœˆæ¬¡'));
  
  if (uploadType === 'auto') {
    if (isSloten) { parseSlotenCSV(lines, period, fn); return; }
    if (isCustomerList) { parseCustomerListCSV(lines, period, fn); return; }
    if (isUncollected) { parseUncollectedCSV(lines, period, fn); return; }
    if (isDelayed) { parseDelayedCSV(lines, period, fn); return; }
    if (isBonus) { parseBonusCSV(lines, period, fn); return; }
    if (isAgent) { parseAgentCSV(lines, period); return; }
    if (isAds) { parseAdsCSV(lines, period); return; }
  }
  if (uploadType === 'sloten') { parseSlotenCSV(lines, period, fn); return; }
  if (uploadType === 'customerList') { parseCustomerListCSV(lines, period, fn); return; }
  if (uploadType === 'uncollected') { parseUncollectedCSV(lines, period, fn); return; }
  if (uploadType === 'bonus') { parseBonusCSV(lines, period, fn); return; }
  if (uploadType === 'delayed') { parseDelayedCSV(lines, period, fn); return; }
  if (uploadType === 'agent') { parseAgentCSV(lines, period); return; }
  if (uploadType === 'ads') { parseAdsCSV(lines, period); return; }
  
  showStatus('CSVã®å½¢å¼ã‚’åˆ¤åˆ¥ã§ãã¾ã›ã‚“ã§ã—ãŸ', true);
}

// ========== å„ç¨®CSVãƒ‘ãƒ¼ã‚µãƒ¼ ==========
function parseSlotenCSV(lines, period, filename) {
  const kpi = {};
  let periodName = period;
  const match = filename.match(/(\d{4})(\d{2})/);
  if (match) periodName = `${match[1]}å¹´${parseInt(match[2])}æœˆ`;
  lines.forEach((row, idx) => { if (!row || row.length < 2) return; const rawLabel = String(row[0] || '').trim(); if (!rawLabel || rawLabel === 'é …ç›®å') return; const val = parseNumber(row[1]); if (val === null) return; const cleanLabel = rawLabel.split('/')[0].trim(); if (idx < 90 || kpi[cleanLabel] === undefined) kpi[cleanLabel] = val; });
  if (kpi['å…¥å‡ºé‡‘å·®åˆ†'] === undefined && kpi['ç·å…¥é‡‘é¡'] !== undefined && kpi['ç·å‡ºé‡‘é¡'] !== undefined) kpi['å…¥å‡ºé‡‘å·®åˆ†'] = kpi['ç·å…¥é‡‘é¡'] - kpi['ç·å‡ºé‡‘é¡'];
  BUSINESSES['ã‚¹ãƒ­å¤©'].data[periodName] = { ã‚µãƒãƒªãƒ¼: kpi };
  showStatus(`ã‚¹ãƒ­å¤©KPIå–è¾¼å®Œäº†: ${periodName}`);
  selectBusiness('ã‚¹ãƒ­å¤©'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseCustomerListCSV(lines, period, filename) {
  const fn = filename.toLowerCase();
  const isDSC = fn.includes('ãƒªã‚¹ãƒˆd') || fn.includes('d.csv') || filename.includes('ãƒªã‚¹ãƒˆD') || filename.includes('é¡§å®¢ãƒªã‚¹ãƒˆD');
  const target = isDSC ? 'DSC' : 'å…ƒamuse';
  
  // 4è¡Œç›®ï¼ˆindex 3ï¼‰ãŒãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
  const headerRowIdx = 3;
  const header = lines[headerRowIdx] || [];
  const colIdx = {};
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
  header.forEach((h, idx) => { 
    const col = String(h).trim(); 
    if (col === 'FULLNAME1' || col === 'åå‰') colIdx.name = idx; 
    if (col === 'credit' || col === 'ä¿¡ç”¨æ ' || col === 'Credit') colIdx.credit = idx; 
    if (col.includes('ãƒˆãƒ¼ã‚¿ãƒ«å›åé¡') || col === 'å›åé¡') colIdx.collected = idx; 
    if (col.includes('ãƒˆãƒ¼ã‚¿ãƒ«å‡ºé‡‘é¡') || col === 'å‡ºé‡‘é¡') colIdx.withdraw = idx; 
    if (col.includes('ãƒˆãƒ¼ã‚¿ãƒ«å·®åˆ†åˆ©ç›Š') || col === 'å·®åˆ†åˆ©ç›Š') colIdx.diff = idx; 
    if (col === 'å…¥é‡‘å›æ•°') colIdx.depCount = idx; 
    if (col === 'å‡ºé‡‘å›æ•°') colIdx.wdCount = idx; 
    if (col === 'NGR' && !colIdx.ngr) colIdx.ngr = idx;
    if (col === 'ãƒœãƒ¼ãƒŠã‚¹ä»˜ä¸ç·é‡‘é¡' || col === 'ãƒœãƒ¼ãƒŠã‚¹' || col.includes('ãƒœãƒ¼ãƒŠã‚¹')) colIdx.bonus = idx;
    if (col === 'ãƒ—ãƒ¬ã‚¤æœˆé–“' || col.includes('ãƒ—ãƒ¬ã‚¤æœˆ')) colIdx.playMonths = idx;
    if (col === 'äº‹å‰æ¸…ç®—å›æ•°' || col === 'äº‹å‰å›æ•°') colIdx.preSettleCount = idx;
    if (col === 'äº‹å‰æ¸…ç®—é‡‘é¡' || col === 'äº‹å‰é‡‘é¡') colIdx.preSettleAmount = idx;
    if (col === 'é€šå¸¸æ¸…ç®—å›æ•°' || col === 'é€šå¸¸å›æ•°' || col === 'å›åå›æ•°') colIdx.normalSettleCount = idx;
    if (col === 'é€šå¸¸æ¸…ç®—é‡‘é¡' || col === 'é€šå¸¸é‡‘é¡' || col === 'å›åé‡‘é¡') colIdx.normalSettleAmount = idx;
    if (col === 'ãƒªã‚¹ãƒˆç¨®åˆ¥' || col === 'ãƒªã‚¹ãƒˆ' || col === 'List') colIdx.listType = idx;
    if (col === 'FTD' || col === 'FTDæ—¥') colIdx.ftdDate = idx;
    if (col === 'FTW' || col === 'FTWæ—¥') colIdx.ftwDate = idx;
  });
  
  // ARåˆ—(44)ã‹ã‚‰BEåˆ—(57)ã®ç¯„å›²ã‚‚ãƒã‚§ãƒƒã‚¯ï¼ˆãƒªã‚¹ãƒˆç¨®åˆ¥ç”¨ï¼‰- 0å§‹ã¾ã‚Šãªã®ã§43ã‹ã‚‰56
  if (colIdx.listType === undefined) {
    for (let i = 43; i <= 56; i++) {
      const col = String(header[i] || '').trim();
      if (col === 'ãƒªã‚¹ãƒˆç¨®åˆ¥' || col === 'ãƒªã‚¹ãƒˆ' || col === 'List' || col.includes('ãƒªã‚¹ãƒˆ')) {
        colIdx.listType = i;
        break;
      }
    }
  }
  
  let stats = { 
    ç·ç™»éŒ²æ•°: 0, ç·å›åé¡: 0, ç·å‡ºé‡‘é¡: 0, ç·å·®åˆ†åˆ©ç›Š: 0, ç·NGR: 0, 
    FTDæ•°: 0, FTWæ•°: 0, FTDWæ•°: 0, ç·ä¿¡ç”¨æ : 0, ç·ãƒœãƒ¼ãƒŠã‚¹: 0, ç·ãƒ—ãƒ¬ã‚¤æœˆé–“: 0, 
    äº‹å‰æ¸…ç®—å›æ•°: 0, äº‹å‰æ¸…ç®—é‡‘é¡: 0, é€šå¸¸æ¸…ç®—å›æ•°: 0, é€šå¸¸æ¸…ç®—é‡‘é¡: 0 
  };
  const listTypes = {};
  
  // 5è¡Œç›®ï¼ˆindex 4ï¼‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿é–‹å§‹
  for (let i = headerRowIdx + 1; i < lines.length; i++) { 
    const row = lines[i]; 
    if (!row || row.length < 5) continue; 
    
    const nameIdx = colIdx.name !== undefined ? colIdx.name : 1;
    const name = String(row[nameIdx] || '').trim(); 
    if (!name || name === 'æ‹…å½“è€…' || name.includes('ã‚»ãƒ«') || name === '' || name === 'FULLNAME1') continue;
    
    stats.ç·ç™»éŒ²æ•°++; 
    
    const collected = parseNumber(row[colIdx.collected]) || 0; 
    const withdraw = parseNumber(row[colIdx.withdraw]) || 0; 
    const diff = parseNumber(row[colIdx.diff]) || 0; 
    const ngr = parseNumber(row[colIdx.ngr]) || 0; 
    const credit = parseNumber(row[colIdx.credit]) || 0; 
    const bonus = parseNumber(row[colIdx.bonus]) || 0;
    const playMonths = parseNumber(row[colIdx.playMonths]) || 0;
    const preSettleCount = parseNumber(row[colIdx.preSettleCount]) || 0;
    const preSettleAmount = parseNumber(row[colIdx.preSettleAmount]) || 0;
    const normalSettleCount = parseNumber(row[colIdx.normalSettleCount]) || 0;
    const normalSettleAmount = parseNumber(row[colIdx.normalSettleAmount]) || 0;
    const depCount = parseNumber(row[colIdx.depCount]) || 0; 
    const wdCount = parseNumber(row[colIdx.wdCount]) || 0; 
    
    stats.ç·å›åé¡ += collected; 
    stats.ç·å‡ºé‡‘é¡ += withdraw; 
    stats.ç·å·®åˆ†åˆ©ç›Š += diff; 
    stats.ç·NGR += ngr; 
    stats.ç·ä¿¡ç”¨æ  += credit;
    stats.ç·ãƒœãƒ¼ãƒŠã‚¹ += bonus;
    stats.ç·ãƒ—ãƒ¬ã‚¤æœˆé–“ += playMonths;
    stats.äº‹å‰æ¸…ç®—å›æ•° += preSettleCount;
    stats.äº‹å‰æ¸…ç®—é‡‘é¡ += preSettleAmount;
    stats.é€šå¸¸æ¸…ç®—å›æ•° += normalSettleCount;
    stats.é€šå¸¸æ¸…ç®—é‡‘é¡ += normalSettleAmount;
    
    // FTD/FTWåˆ¤å®š
    const ftdDate = row[colIdx.ftdDate] ? String(row[colIdx.ftdDate]).trim() : '';
    const ftwDate = row[colIdx.ftwDate] ? String(row[colIdx.ftwDate]).trim() : '';
    const hasFTD = ftdDate !== '' || depCount > 0 || collected > 0; 
    const hasFTW = ftwDate !== '' || wdCount > 0 || withdraw > 0; 
    if (hasFTD) { stats.FTDæ•°++; if (hasFTW) stats.FTDWæ•°++; } 
    if (hasFTW) stats.FTWæ•°++;
    
    // ãƒªã‚¹ãƒˆç¨®åˆ¥é›†è¨ˆï¼ˆB, E, T, S, BE, C, ç´¹ä»‹ã®ã¿ã€ãã‚Œä»¥å¤–ã¯ãã®ä»–ï¼‰
    if (colIdx.listType !== undefined) {
      let listType = String(row[colIdx.listType] || '').trim();
      if (listType && listType !== '' && listType !== 'ãƒªã‚¹ãƒˆç¨®åˆ¥') {
        const validTypes = ['B', 'E', 'T', 'S', 'BE', 'C', 'ç´¹ä»‹'];
        if (!validTypes.includes(listType)) {
          listType = 'ãã®ä»–';
        }
        if (!listTypes[listType]) listTypes[listType] = 0;
        listTypes[listType]++;
      }
    }
  }
  
  // è¨ˆç®—é …ç›®
  stats['FTDç‡'] = stats.ç·ç™»éŒ²æ•° > 0 ? stats.FTDæ•° / stats.ç·ç™»éŒ²æ•° : 0;
  stats['FTWç‡'] = stats.ç·ç™»éŒ²æ•° > 0 ? stats.FTWæ•° / stats.ç·ç™»éŒ²æ•° : 0;
  stats['FTDWç‡'] = stats.FTDæ•° > 0 ? stats.FTDWæ•° / stats.FTDæ•° : 0;
  stats['å›åå‡ºé‡‘å·®åˆ†'] = stats.ç·å›åé¡ - stats.ç·å‡ºé‡‘é¡;
  stats['å¹³å‡ä¿¡ç”¨æ '] = stats.ç·ç™»éŒ²æ•° > 0 ? stats.ç·ä¿¡ç”¨æ  / stats.ç·ç™»éŒ²æ•° : 0;
  stats['å¹³å‡Creditå˜ä¾¡'] = stats.FTDæ•° > 0 ? stats.ç·ä¿¡ç”¨æ  / stats.FTDæ•° : 0;
  stats['å¹³å‡ãƒ—ãƒ¬ã‚¤æœˆé–“'] = stats.ç·ç™»éŒ²æ•° > 0 ? stats.ç·ãƒ—ãƒ¬ã‚¤æœˆé–“ / stats.ç·ç™»éŒ²æ•° : 0;
  
  // äº‹å‰æ¸…ç®—ãƒ»é€šå¸¸æ¸…ç®—ã®å‰²åˆ
  const totalSettleAmount = stats.äº‹å‰æ¸…ç®—é‡‘é¡ + stats.é€šå¸¸æ¸…ç®—é‡‘é¡;
  const totalSettleCount = stats.äº‹å‰æ¸…ç®—å›æ•° + stats.é€šå¸¸æ¸…ç®—å›æ•°;
  stats['äº‹å‰æ¸…ç®—å‰²åˆ'] = totalSettleAmount > 0 ? stats.äº‹å‰æ¸…ç®—é‡‘é¡ / totalSettleAmount : 0;
  stats['é€šå¸¸æ¸…ç®—å‰²åˆ'] = totalSettleAmount > 0 ? stats.é€šå¸¸æ¸…ç®—é‡‘é¡ / totalSettleAmount : 0;
  stats['äº‹å‰æ¸…ç®—ä»¶æ•°å‰²åˆ'] = totalSettleCount > 0 ? stats.äº‹å‰æ¸…ç®—å›æ•° / totalSettleCount : 0;
  stats['é€šå¸¸æ¸…ç®—ä»¶æ•°å‰²åˆ'] = totalSettleCount > 0 ? stats.é€šå¸¸æ¸…ç®—å›æ•° / totalSettleCount : 0;
  
  const existing = BUSINESSES[target].data[period]?.ã‚µãƒãƒªãƒ¼ || {};
  // 0ã®å€¤ã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ãªã„
  const mergedStats = { ...existing };
  Object.entries(stats).forEach(([key, val]) => {
    if (val !== 0 || existing[key] === undefined) {
      mergedStats[key] = val;
    }
  });
  BUSINESSES[target].data[period] = { 
    ã‚µãƒãƒªãƒ¼: mergedStats,
    ...(Object.keys(listTypes).length > 0 ? { ãƒªã‚¹ãƒˆç¨®åˆ¥: listTypes } : (BUSINESSES[target].data[period]?.ãƒªã‚¹ãƒˆç¨®åˆ¥ ? { ãƒªã‚¹ãƒˆç¨®åˆ¥: BUSINESSES[target].data[period].ãƒªã‚¹ãƒˆç¨®åˆ¥ } : {}))
  };
  
  const listInfo = Object.keys(listTypes).length > 0 ? `, ãƒªã‚¹ãƒˆç¨®åˆ¥${Object.keys(listTypes).length}ç¨®(${Object.entries(listTypes).map(([k,v])=>k+':'+v).join(',')})` : '';
  showStatus(`é¡§å®¢ãƒªã‚¹ãƒˆå–è¾¼å®Œäº†: ${target} ${stats.ç·ç™»éŒ²æ•°}ä»¶, FTD${stats.FTDæ•°}ä»¶, äº‹å‰æ¸…ç®—${stats.äº‹å‰æ¸…ç®—å›æ•°}ä»¶/${formatCurrency(stats.äº‹å‰æ¸…ç®—é‡‘é¡)}${listInfo}`);
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseUncollectedCSV(lines, period, filename) {
  const fn = filename.toLowerCase();
  const isDSC = fn.includes('ã‚·ãƒ¼ãƒˆd') || fn.includes('d.csv') || filename.includes('ã‚·ãƒ¼ãƒˆD');
  const target = isDSC ? 'DSC' : 'å…ƒamuse';
  let total = 0, count = 0;
  for (let i = 0; i < Math.min(5, lines.length); i++) { const row = lines[i]; if (!row) continue; const rowStr = row.join(','); if (rowStr.includes('æœªå›åé‡‘ç·é¡')) { for (let j = 0; j < row.length; j++) { const val = parseNumber(row[j]); if (val && val > 1000000) { total = val; break; } } for (let j = 0; j < row.length; j++) { const val = parseNumber(row[j]); if (val && val > 0 && val < 10000) { count = val; break; } } break; } }
  if (total === 0) { const colIdx = lines[0].findIndex(h => String(h).includes('æ®‹æœªå›å')); for (let i = 1; i < lines.length; i++) { const val = parseNumber(lines[i][colIdx >= 0 ? colIdx : 0]) || 0; total += val; } count = lines.length - 1; }
  const data = { 'æœªå›åè€…æ•°': count, 'æ®‹æœªå›åé‡‘é¡': total };
  const existing = BUSINESSES[target].data[period]?.ã‚µãƒãƒªãƒ¼ || {};
  BUSINESSES[target].data[period] = { ã‚µãƒãƒªãƒ¼: { ...existing, ...data } };
  showStatus(`æœªå›åã‚·ãƒ¼ãƒˆå–è¾¼å®Œäº†: ${target} ${count}äºº, ${formatCurrency(total)}`);
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseBonusCSV(lines, period, filename) {
  const fn = filename.toLowerCase();
  const isDSC = fn.includes('ãƒœãƒ¼ãƒŠã‚¹d') || fn.includes('d.csv') || filename.includes('ãƒœãƒ¼ãƒŠã‚¹D');
  const target = isDSC ? 'DSC' : 'å…ƒamuse';
  let totalBonus = 0, count = 0;
  for (let i = 0; i < lines.length; i++) { const row = lines[i]; if (!row) continue; const firstCol = String(row[0] || '').trim().toUpperCase(); if (firstCol === 'TOTAL') { totalBonus = parseNumber(row[1]) || 0; break; } }
  let foundTotal = false;
  for (let i = 1; i < lines.length; i++) { const row = lines[i]; if (!row) continue; const firstCol = String(row[0] || '').trim().toUpperCase(); if (firstCol === 'TOTAL') { foundTotal = true; continue; } if (!foundTotal) continue; if (row[3] && String(row[3]).trim()) count++; }
  const data = { 'ãƒœãƒ¼ãƒŠã‚¹å¯¾è±¡è€…æ•°': count, 'ç·ãƒœãƒ¼ãƒŠã‚¹ä»˜ä¸é‡‘é¡': totalBonus };
  const existing = BUSINESSES[target].data[period]?.ã‚µãƒãƒªãƒ¼ || {};
  BUSINESSES[target].data[period] = { ã‚µãƒãƒªãƒ¼: { ...existing, ...data } };
  showStatus(`ãƒœãƒ¼ãƒŠã‚¹ã‚·ãƒ¼ãƒˆå–è¾¼å®Œäº†: ${target} ${count}äºº, ${formatCurrency(totalBonus)}`);
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseDelayedCSV(lines, period, filename) {
  const fn = filename.toLowerCase();
  const isDSC = fn.includes('å›åd') || fn.includes('d.csv') || filename.includes('å›åD');
  const target = isDSC ? 'DSC' : 'å…ƒamuse';
  let totalDelayed = 0, count = 0;
  const header = lines[0] || [];
  const amountIdx = header.findIndex(h => String(h).includes('ä»Šå›è¿”æ¸ˆé‡‘é¡'));
  for (let i = 1; i < lines.length; i++) { const row = lines[i]; if (!row || row.length < 10) continue; const amount = parseNumber(row[amountIdx >= 0 ? amountIdx : 10]) || 0; if (amount > 0) { totalDelayed += amount; count++; } }
  const data = { 'é…ã‚Œå›åä»¶æ•°': count, 'é…ã‚Œå›åé‡‘é¡': totalDelayed };
  const existing = BUSINESSES[target].data[period]?.ã‚µãƒãƒªãƒ¼ || {};
  BUSINESSES[target].data[period] = { ã‚µãƒãƒªãƒ¼: { ...existing, ...data } };
  showStatus(`é…ã‚Œå›åã‚·ãƒ¼ãƒˆå–è¾¼å®Œäº†: ${target} ${count}ä»¶, ${formatCurrency(totalDelayed)}`);
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseAgentCSV(lines, period) {
  let weeklyData = [];
  let totals = { å…¥é‡‘åˆè¨ˆ: 0, å‡ºé‡‘åˆè¨ˆ: 0, åç›Šåˆè¨ˆ: 0, TOåˆè¨ˆ: 0, ãƒ­ãƒ¼ãƒªãƒ³ã‚°åˆè¨ˆ: 0, å¤§é˜ªåˆè¨ˆ: 0 };
  for (let i = 2; i < lines.length; i++) { const row = lines[i]; if (!row || row.length < 17) continue; const col7 = (row[7] || '').trim(); const col12 = (row[12] || '').trim(); const isOldFormat = col7.includes('/') && !col7.toLowerCase().includes('kyoto'); const isNewFormat = col7 === '' && col12.includes('/'); if (isOldFormat || isNewFormat) { const æ—¥ä»˜ = isOldFormat ? col7 : col12; const å…¥é‡‘ = parseNumber(row[8]) || 0; const å‡ºé‡‘ = parseNumber(row[9]) || 0; const åç›Š = parseNumber(row[11]) || 0; const TO = parseNumber(row[13]) || 0; const ãƒ­ãƒ¼ãƒªãƒ³ã‚° = parseNumber(row[14]) || 0; const å¤§é˜ª = parseNumber(row[16]) || 0; const ãƒ­ãƒ¼ãƒªãƒ³ã‚°å ±é…¬ = ãƒ­ãƒ¼ãƒªãƒ³ã‚° + å¤§é˜ª; const NGR = åç›Š - ãƒ­ãƒ¼ãƒªãƒ³ã‚°å ±é…¬; totals.å…¥é‡‘åˆè¨ˆ += å…¥é‡‘; totals.å‡ºé‡‘åˆè¨ˆ += å‡ºé‡‘; totals.åç›Šåˆè¨ˆ += åç›Š; totals.TOåˆè¨ˆ += TO; totals.ãƒ­ãƒ¼ãƒªãƒ³ã‚°åˆè¨ˆ += ãƒ­ãƒ¼ãƒªãƒ³ã‚°; totals.å¤§é˜ªåˆè¨ˆ += å¤§é˜ª; weeklyData.push({ æ—¥ä»˜, å…¥é‡‘, å‡ºé‡‘, åç›Š, 'T/O': TO, ãƒ­ãƒ¼ãƒªãƒ³ã‚°, å¤§é˜ª, ãƒ­ãƒ¼ãƒªãƒ³ã‚°å ±é…¬, NGR }); } }
  const ãƒ­ãƒ¼ãƒªãƒ³ã‚°å ±é…¬åˆè¨ˆ = totals.ãƒ­ãƒ¼ãƒªãƒ³ã‚°åˆè¨ˆ + totals.å¤§é˜ªåˆè¨ˆ;
  const NGRåˆè¨ˆ = totals.åç›Šåˆè¨ˆ - ãƒ­ãƒ¼ãƒªãƒ³ã‚°å ±é…¬åˆè¨ˆ;
  BUSINESSES['AMUSEVIP'].data['å…¨æœŸé–“'] = { ã‚µãƒãƒªãƒ¼: { ...totals, 'ãƒ­ãƒ¼ãƒªãƒ³ã‚°å ±é…¬': ãƒ­ãƒ¼ãƒªãƒ³ã‚°å ±é…¬åˆè¨ˆ, 'NGR': NGRåˆè¨ˆ, 'ç²¾ç®—å›æ•°': weeklyData.length }, é€±åˆ¥: weeklyData };
  showStatus(`ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå–è¾¼å®Œäº†: ${weeklyData.length}å›, åç›Š${formatCurrency(totals.åç›Šåˆè¨ˆ)}`);
  selectBusiness('AMUSEVIP'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseAdsCSV(lines, period) {
  const header = lines[0].map(h => String(h || '').toLowerCase().replace(/\n/g, '').trim());
  const costIdx = header.findIndex(h => h.includes('ã‚³ã‚¹ãƒˆ') || h === 'cost');
  const impIdx = header.findIndex(h => h.includes('ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³') || h.includes('imp'));
  const clickIdx = header.findIndex(h => h.includes('ã‚¯ãƒªãƒƒã‚¯') || h.includes('click'));
  const regIdx = header.findIndex(h => h === 'ç™»éŒ²æ•°' || h === 'registrations');
  const depIdx = header.findIndex(h => h === 'å…¥é‡‘æ•°' || h === 'deposits');
  let totals = { ã‚³ã‚¹ãƒˆ: 0, ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³: 0, ã‚¯ãƒªãƒƒã‚¯: 0, ç™»éŒ²: 0, å…¥é‡‘: 0 };
  let foundTotal = false;
  // TOTALè¡Œã‚’æ¢ã—ã¦ãã®å€¤ã‚’ä½¿ç”¨
  for (let i = 1; i < lines.length; i++) {
    const row = lines[i]; if (!row || row.length < 5) continue;
    const firstCell = String(row[0] || '').trim().toLowerCase();
    // TOTALè¡Œã‚’æ¤œå‡ºï¼ˆ"total", "åˆè¨ˆ", æœˆå+total ãªã©ï¼‰
    if (firstCell.includes('total') || firstCell.includes('åˆè¨ˆ')) {
      foundTotal = true;
      const parseVal = (idx, fb) => { if (idx < 0 && fb < 0) return 0; const v = row[idx >= 0 ? idx : fb] || ''; return parseFloat(String(v).replace(/[$ï¿¥Â¥,"\s]/g, '')) || 0; };
      totals.ã‚³ã‚¹ãƒˆ = parseVal(costIdx, 1);
      totals.ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ = parseVal(impIdx, 2);
      totals.ã‚¯ãƒªãƒƒã‚¯ = parseVal(clickIdx, 3);
      totals.ç™»éŒ² = parseVal(regIdx, 4);
      totals.å…¥é‡‘ = parseVal(depIdx, 5);
      break; // æœ€åˆã®TOTALè¡Œã‚’ä½¿ç”¨
    }
  }
  // TOTALè¡ŒãŒãªã„å ´åˆã¯å¾“æ¥é€šã‚Šåˆè¨ˆ
  if (!foundTotal) {
    for (let i = 1; i < lines.length; i++) { const row = lines[i]; if (!row || row.length < 5) continue; const parseVal = (idx, fb) => { if (idx < 0 && fb < 0) return 0; const v = row[idx >= 0 ? idx : fb] || ''; return parseFloat(String(v).replace(/[$ï¿¥Â¥,"\s]/g, '')) || 0; }; totals.ã‚³ã‚¹ãƒˆ += parseVal(costIdx, 1); totals.ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ += parseVal(impIdx, 2); totals.ã‚¯ãƒªãƒƒã‚¯ += parseVal(clickIdx, 3); totals.ç™»éŒ² += parseVal(regIdx, 4); totals.å…¥é‡‘ += parseVal(depIdx, 5); }
  }
  const ctr = totals.ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ > 0 ? totals.ã‚¯ãƒªãƒƒã‚¯ / totals.ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ : 0;
  const cvr = totals.ã‚¯ãƒªãƒƒã‚¯ > 0 ? totals.ç™»éŒ² / totals.ã‚¯ãƒªãƒƒã‚¯ : 0;
  const costYen = totals.ã‚³ã‚¹ãƒˆ < 10000 ? totals.ã‚³ã‚¹ãƒˆ * 150 : totals.ã‚³ã‚¹ãƒˆ;
  const cpaYen = totals.ç™»éŒ² > 0 ? costYen / totals.ç™»éŒ² : 0;
  BUSINESSES['åºƒå‘Š'].data['å…¨æœŸé–“'] = { ã‚µãƒãƒªãƒ¼: { 'ã‚³ã‚¹ãƒˆ($)': totals.ã‚³ã‚¹ãƒˆ, 'ã‚³ã‚¹ãƒˆ(ç¨è¾¼)': costYen, 'ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³': totals.ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³, 'ã‚¯ãƒªãƒƒã‚¯': totals.ã‚¯ãƒªãƒƒã‚¯, 'ç™»éŒ²æ•°': totals.ç™»éŒ², 'å…¥é‡‘æ•°': totals.å…¥é‡‘, 'CTR': ctr, 'CVR': cvr, 'CPA(ç¨è¾¼)': cpaYen } };
  showStatus(`åºƒå‘Šãƒ‡ãƒ¼ã‚¿å–è¾¼å®Œäº†: ç™»éŒ²${totals.ç™»éŒ²}ä»¶, å…¥é‡‘${totals.å…¥é‡‘}ä»¶`);
  selectBusiness('åºƒå‘Š'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

// ========== Excelå‡¦ç† ==========
function handleExcel(workbook, period, uploadType, filename) {
  const sheetNames = workbook.SheetNames;
  const fn = filename.toLowerCase();
  const slotenSheets = sheetNames.filter(s => /^\d{6}$/.test(s));
  if (uploadType === 'sloten' || (uploadType === 'auto' && (slotenSheets.length > 0 || fn.includes('ã‚¹ãƒ­å¤©') || fn.includes('kpi')))) { parseSlotenExcel(workbook, slotenSheets); return; }
  const hasBaccaraSheet = sheetNames.includes('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰') || sheetNames.includes('ã‚³ã‚¹ãƒˆ') || sheetNames.some(s => s.includes('ãƒã‚«ãƒ©'));
  if (uploadType === 'baccarat' || (uploadType === 'auto' && (hasBaccaraSheet || fn.includes('ãƒã‚«ãƒ©') || fn.includes('baccara')))) { parseBaccaratExcel(workbook, period); return; }
  const revenueSheets = sheetNames.filter(s => s.includes('åç›Š') && !s.includes('import'));
  if (revenueSheets.length > 0) { parseSamExcel(workbook, revenueSheets); return; }
  parseGenericExcel(workbook, period);
}

function parseSlotenExcel(workbook, monthlySheets) {
  let count = 0;
  const primaryKeys = ['GGR', 'ç·å…¥é‡‘é¡', 'ç·å‡ºé‡‘é¡', 'å…¥å‡ºé‡‘å·®åˆ†', 'T/O', 'RTP', 'NGR', 'ç™»éŒ²äººæ•°', 'ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°', 'GGRLTV'];
  monthlySheets.forEach(sheetName => {
    const sheet = workbook.Sheets[sheetName];
    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    const kpi = {}, depositMethods = {}, withdrawMethods = {}, gameData = {}, affData = {}, cryptoData = {}, providerData = {};
    data.forEach((row, idx) => { if (!row || row.length < 2) return; const rawLabel = String(row[0] || '').trim(); if (!rawLabel || rawLabel === 'é …ç›®å' || rawLabel.includes('ã€')) return; const label = rawLabel.split('/')[0].trim(); const val = parseNumber(row[1]); if (val === null) return; const isPrimaryKey = primaryKeys.some(pk => label === pk || label.startsWith(pk)); if (isPrimaryKey && kpi[label] !== undefined) return; if (idx < 90 || !isPrimaryKey) kpi[label] = val; });
    for (let i = 191; i < Math.min(198, data.length); i++) { const row = data[i]; if (row && row[0] && row[1] !== undefined) { const key = String(row[0]).trim(); if (key && key !== 'å…¥é‡‘' && key !== 'åˆè¨ˆé‡‘é¡') { const val = parseNumber(row[1]); if (val !== null && val > 0) depositMethods[key] = val; } } }
    for (let i = 199; i < Math.min(206, data.length); i++) { const row = data[i]; if (row && row[0] && row[1] !== undefined) { const key = String(row[0]).trim(); if (key && key !== 'å‡ºé‡‘' && key !== 'åˆè¨ˆé‡‘é¡') { const val = parseNumber(row[1]); if (val !== null && val > 0) withdrawMethods[key] = val; } } }
    for (let i = 216; i < Math.min(227, data.length); i++) { const row = data[i]; if (row && row[0]) { const key = String(row[0]).trim(); if (key && /^(BTC|ETH|USDT|TRX|XRP|LTC)/i.test(key)) { const cnt = parseNumber(row[1]) || 0; const amt = parseNumber(row[2]) || 0; if (cnt > 0 || amt > 0) cryptoData[key] = { ä»¶æ•°: cnt, é‡‘é¡: amt }; } } }
    for (let i = 226; i < Math.min(270, data.length); i++) { const row = data[i]; if (row && row[0]) { const key = String(row[0]).trim(); if (key === 'ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼' || key.includes('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–')) continue; const users = parseNumber(row[1]) || 0; const bet = parseNumber(row[2]) || 0; const payout = parseNumber(row[3]) || 0; if (users > 0 || bet > 0) providerData[key] = { ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: users, è³­ã‘é‡‘é¡: bet, é…å½“é‡‘é¡: payout, GGR: bet - payout }; } }
    const gamePositions = [{ name: 'ãƒ‘ãƒãƒ³ã‚³', userRow: 123, toRow: 124, ggrRow: 127 },{ name: 'ãƒ‘ãƒã‚¹ãƒ­', userRow: 142, toRow: 143, ggrRow: 146 },{ name: 'ã‚¹ãƒ­ãƒƒãƒˆ', userRow: 161, toRow: 162, ggrRow: 165 },{ name: 'ãƒ©ã‚¤ãƒ–', userRow: 180, toRow: 181, ggrRow: 184 }];
    gamePositions.forEach(g => { if (data[g.userRow] && data[g.toRow] && data[g.ggrRow]) { gameData[g.name] = { ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: parseNumber(data[g.userRow]?.[1]) || 0, TO: parseNumber(data[g.toRow]?.[1]) || 0, GGR: parseNumber(data[g.ggrRow]?.[1]) || 0 }; } });
    for (let i = 92; i < Math.min(112, data.length); i++) { const row = data[i]; if (row && row[0] && row[1] !== undefined) { const key = String(row[0]).trim().split('/')[0].trim(); if (key && key.includes('AFF')) { const val = parseNumber(row[1]); if (val !== null) affData[key] = val; } } }
    const year = sheetName.substring(0, 4), month = parseInt(sheetName.substring(4, 6)), periodName = `${year}å¹´${month}æœˆ`;
    if (Object.keys(kpi).length > 0) {
      BUSINESSES['ã‚¹ãƒ­å¤©'].data[periodName] = { ã‚µãƒãƒªãƒ¼: kpi, ...(Object.keys(depositMethods).length > 0 ? { å…¥é‡‘æ–¹æ³•: depositMethods } : {}), ...(Object.keys(withdrawMethods).length > 0 ? { å‡ºé‡‘æ–¹æ³•: withdrawMethods } : {}), ...(Object.keys(cryptoData).length > 0 ? { ä»®æƒ³é€šè²¨: cryptoData } : {}), ...(Object.keys(providerData).length > 0 ? { ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: providerData } : {}), ...(Object.keys(gameData).length > 0 ? { ã‚²ãƒ¼ãƒ åˆ¥: gameData } : {}), ...(Object.keys(affData).length > 0 ? { Affiliate: affData } : {}) };
      count++;
    }
  });
  showStatus(`ã‚¹ãƒ­å¤©ãƒ‡ãƒ¼ã‚¿å–è¾¼å®Œäº†: ${count}æœŸé–“`);
  selectBusiness('ã‚¹ãƒ­å¤©'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseBaccaratExcel(workbook, period) {
  const dashSheetName = workbook.SheetNames.find(s => s.includes('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰') || s.includes('ã‚µãƒãƒªãƒ¼'));
  const dashSheet = dashSheetName ? workbook.Sheets[dashSheetName] : workbook.Sheets[workbook.SheetNames[0]];
  const costSheet = workbook.Sheets['ã‚³ã‚¹ãƒˆ'] || workbook.Sheets['cost'];
  const userSheet = workbook.Sheets['ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»åç›Šåˆ†æ'] || workbook.Sheets['ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ†æ'];
  const extractedData = { 'LINEæµå…¥': 0, 'Telegramæµå…¥': 0, 'Twitteræµå…¥': 0, 'åˆè¨ˆæµå…¥': 0, 'ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°': 0, 'ç·å…¥é‡‘é¡': 0, 'ç·GGR': 0, 'ã‚³ã‚¹ãƒˆ': 0, 'NGR': 0, 'ç™»éŒ²æ•°': 0 };
  if (dashSheet) { const dashData = XLSX.utils.sheet_to_json(dashSheet, { header: 1 }); dashData.forEach(row => { if (!row || row.length < 2) return; const label = String(row[0] || '').trim().toLowerCase(); const value = parseNumber(row[1]); if (value === null) return; if (label.includes('line') && label.includes('æµå…¥')) extractedData['LINEæµå…¥'] = value; else if (label.includes('telegram') && label.includes('æµå…¥')) extractedData['Telegramæµå…¥'] = value; else if ((label.includes('twitter') || label.includes('x')) && label.includes('æµå…¥')) extractedData['Twitteræµå…¥'] = value; else if (label.includes('åˆè¨ˆ') && label.includes('æµå…¥')) extractedData['åˆè¨ˆæµå…¥'] = value; else if (label.includes('ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼') || label.includes('ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°')) extractedData['ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°'] = value; else if (label.includes('ç·å…¥é‡‘') || (label.includes('å…¥é‡‘') && label.includes('é¡'))) extractedData['ç·å…¥é‡‘é¡'] = value; else if (label.includes('ggr') && !label.includes('ngr')) extractedData['ç·GGR'] = value; else if (label === 'ã‚³ã‚¹ãƒˆ' || label === 'cost') extractedData['ã‚³ã‚¹ãƒˆ'] = value; else if (label === 'ngr') extractedData['NGR'] = value; }); }
  if (userSheet) { const userData = XLSX.utils.sheet_to_json(userSheet, { header: 1 }); let totalReg = 0, regColIdx = -1; userData.forEach((row, idx) => { if (!row) return; if (regColIdx < 0) { const foundIdx = row.findIndex(cell => String(cell || '').trim() === 'ç™»éŒ²'); if (foundIdx >= 0) regColIdx = foundIdx; } const firstCell = String(row[0] || '').trim(); if (firstCell === 'åˆè¨ˆ' && regColIdx >= 0) { const regVal = parseNumber(row[regColIdx]); if (regVal !== null && regVal > 0) totalReg += regVal; } }); if (totalReg > 0) extractedData['ç™»éŒ²æ•°'] = totalReg; }
  if (costSheet) { const costData = XLSX.utils.sheet_to_json(costSheet, { header: 1 }); costData.forEach(row => { if (!row) return; const label = String(row[0] || '').trim().toLowerCase(); if (label === 'åˆè¨ˆ' || label === 'total') { const costVal = parseNumber(row[2]) || parseNumber(row[1]) || 0; if (costVal > 0) extractedData['ã‚³ã‚¹ãƒˆ'] = costVal; } }); }
  if (extractedData['NGR'] === 0 && (extractedData['ç·GGR'] > 0 || extractedData['ã‚³ã‚¹ãƒˆ'] > 0)) extractedData['NGR'] = (extractedData['ç·GGR'] || 0) - (extractedData['ã‚³ã‚¹ãƒˆ'] || 0);
  if (extractedData['åˆè¨ˆæµå…¥'] === 0) extractedData['åˆè¨ˆæµå…¥'] = extractedData['LINEæµå…¥'] + extractedData['Telegramæµå…¥'] + extractedData['Twitteræµå…¥'];
  BUSINESSES['ãƒã‚«ãƒ©ãƒ„ãƒ¼ãƒ«'].data['å…¨æœŸé–“'] = { ã‚µãƒãƒªãƒ¼: extractedData };
  showStatus(`ãƒã‚«ãƒ©ãƒ„ãƒ¼ãƒ«å–è¾¼å®Œäº†: ç™»éŒ²${extractedData['ç™»éŒ²æ•°']}ä»¶`);
  selectBusiness('ãƒã‚«ãƒ©ãƒ„ãƒ¼ãƒ«'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseSamExcel(workbook, revenueSheets) {
  let amuseCount = 0, dscCount = 0;
  revenueSheets.forEach(sheetName => { const sheet = workbook.Sheets[sheetName]; const data = XLSX.utils.sheet_to_json(sheet, { header: 1 }); const isDSC = sheetName.endsWith('D'); let periodName = sheetName.replace('åç›Š', '').replace(/D$/, ''); const extracted = {}; data.forEach(row => { if (row[1] && row[2] !== undefined && row[2] !== null && row[2] !== '') { const key = String(row[1]).trim().replace(/ï¼ˆ/g, '(').replace(/ï¼‰/g, ')'); const val = parseNumber(row[2]); if (val !== null && !String(row[2]).startsWith('#') && !key.startsWith('0.')) extracted[key] = val; } if (row[3] && row[4] !== undefined && row[4] !== null && row[4] !== '') { const key = String(row[3]).trim().replace(/ï¼ˆ/g, '(').replace(/ï¼‰/g, ')'); const val = parseNumber(row[4]); if (val !== null && !String(row[4]).startsWith('#') && !key.startsWith('0.')) extracted[key] = val; } }); if (Object.keys(extracted).length > 0) { if (isDSC) { BUSINESSES['DSC'].data[periodName] = { ã‚µãƒãƒªãƒ¼: extracted }; dscCount++; } else { BUSINESSES['å…ƒamuse'].data[periodName] = { ã‚µãƒãƒªãƒ¼: extracted }; amuseCount++; } } });
  showStatus(`åç›Šã‚·ãƒ¼ãƒˆå–è¾¼å®Œäº†: å…ƒamuse ${amuseCount}ä»¶, DSC ${dscCount}ä»¶`);
  if (dscCount > 0) selectBusiness('DSC'); else selectBusiness('å…ƒamuse');
  saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseGenericExcel(workbook, period) {
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
  const kpi = {};
  data.forEach(row => { if (!row || row.length < 2) return; const label = String(row[0] || '').trim(); const val = parseNumber(row[1]); if (label && val !== null) kpi[label] = val; });
  BUSINESSES[currentBusiness].data[period] = { ã‚µãƒãƒªãƒ¼: kpi };
  showStatus(`Excelå–è¾¼å®Œäº†: ${Object.keys(kpi).length}é …ç›®`);
  selectBusiness(currentBusiness); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function addBusiness() { const name = document.getElementById('new-business-name').value.trim(); const type = document.getElementById('new-business-type').value; if (!name) { alert('äº‹æ¥­åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; } if (BUSINESSES[name]) { alert('åŒåã®äº‹æ¥­ãŒå­˜åœ¨ã—ã¾ã™'); return; } BUSINESSES[name] = { data: {}, type: type }; saveBusinessData(); hideAddBusinessModal(); selectBusiness(name); }
function deleteBusiness() { if (Object.keys(BUSINESSES).length <= 1) { alert('æœ€å¾Œã®äº‹æ¥­ã¯å‰Šé™¤ã§ãã¾ã›ã‚“'); return; } if (confirm(`ã€Œ${currentBusiness}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) { delete BUSINESSES[currentBusiness]; saveBusinessData(); selectBusiness(Object.keys(BUSINESSES)[0]); } }
</script>
</body>
</html>
