<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>事業別ダッシュボード（拡張版）</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f1f5f9;min-height:100vh}
.container{max-width:1400px;margin:0 auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.header h1{font-size:24px;color:#1e293b}
.header-actions{display:flex;gap:10px;flex-wrap:wrap}
.card{background:white;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:20px;margin-bottom:20px}
.tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.tab{padding:10px 18px;border-radius:10px;border:none;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;background:#e2e8f0;color:#475569}
.tab:hover{background:#cbd5e1}
.tab.active{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white}
.btn{padding:10px 20px;border-radius:10px;border:none;cursor:pointer;font-weight:600;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white}
.btn-secondary{background:#f1f5f9;color:#475569}
.btn-danger{background:#fee2e2;color:#dc2626}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.summary-card{border-radius:12px;padding:14px;color:white;background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
.summary-card h3{font-size:10px;opacity:0.9;margin-bottom:4px;text-transform:uppercase}
.summary-card .value{font-size:18px;font-weight:700}
.chart-container{height:300px;margin:20px 0}
.period-selector{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.period-btn{padding:6px 14px;border-radius:8px;border:none;cursor:pointer;font-size:12px;background:#f1f5f9;color:#64748b;transition:all 0.2s}
.period-btn.active{background:#3b82f6;color:white}
.period-btn:hover{background:#e2e8f0}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:white;border-radius:16px;padding:30px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
.upload-zone{border:2px dashed #cbd5e1;border-radius:12px;padding:40px;text-align:center;cursor:pointer;transition:all 0.2s}
.upload-zone:hover,.upload-zone.dragover{border-color:#3b82f6;background:#eff6ff}
.hidden{display:none!important}
.links-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;max-height:500px;overflow-y:auto}
.link-category{background:white;border-radius:12px;padding:16px;border:1px solid #e2e8f0}
.link-category h4{font-size:13px;color:#64748b;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #e2e8f0}
.link-item{display:inline-block;background:#dbeafe;color:#1d4ed8;padding:4px 10px;border-radius:6px;font-size:11px;margin:2px;text-decoration:none;transition:all 0.2s}
.link-item:hover{background:#bfdbfe;transform:translateY(-1px)}
.table-container{overflow-x:auto;max-height:500px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:8px 10px;text-align:left;border-bottom:1px solid #e2e8f0}
th{background:#f8fafc;font-weight:600;color:#64748b;position:sticky;top:0}
tr:hover{background:#f8fafc}
.text-right{text-align:right}
.text-green{color:#16a34a}
.text-red{color:#dc2626}
input,select{padding:10px 14px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;width:100%}
input:focus,select:focus{outline:none;border-color:#3b82f6}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;color:#64748b;margin-bottom:6px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.section-title{font-size:16px;font-weight:600;color:#1e293b;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}
.kpi-item{background:#f8fafc;border-radius:10px;padding:12px}
.kpi-item .label{font-size:10px;color:#64748b;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.kpi-item .val{font-size:16px;font-weight:700;color:#1e293b}
.kpi-item .val.negative{color:#dc2626}
footer{text-align:center;color:#94a3b8;font-size:11px;margin-top:30px;padding:20px}
/* 新規追加: トータル・平均セクション用 */
.totals-section{background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.totals-section .section-title{color:white}
.totals-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
.total-card{background:rgba(255,255,255,0.1);border-radius:12px;padding:16px;backdrop-filter:blur(10px)}
.total-card h4{font-size:11px;opacity:0.8;margin-bottom:8px;text-transform:uppercase}
.total-card .main-val{font-size:22px;font-weight:700;margin-bottom:4px}
.total-card .sub-val{font-size:12px;opacity:0.7}
.crypto-section{background:linear-gradient(135deg,#fbbf24,#f59e0b);border-radius:16px;padding:20px;margin-bottom:20px}
.crypto-section .section-title{color:#1e293b}
.crypto-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
.crypto-card{background:rgba(255,255,255,0.9);border-radius:10px;padding:14px;color:#1e293b}
.crypto-card h5{font-size:10px;color:#64748b;margin-bottom:6px}
.crypto-card .crypto-val{font-size:18px;font-weight:700}
.crypto-card .crypto-pct{font-size:11px;color:#64748b}
.provider-section{background:linear-gradient(135deg,#8b5cf6,#7c3aed);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.provider-section .section-title{color:white}
.provider-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.provider-card{background:rgba(255,255,255,0.15);border-radius:10px;padding:14px;backdrop-filter:blur(10px)}
.provider-card h5{font-size:12px;margin-bottom:8px;font-weight:600}
.provider-card .provider-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px}
.provider-card .stat-item{background:rgba(255,255,255,0.1);border-radius:6px;padding:6px 8px}
.provider-card .stat-label{opacity:0.7;font-size:9px}
.provider-card .stat-val{font-weight:600}
.view-toggle{display:flex;gap:8px;margin-bottom:16px}
.view-toggle .toggle-btn{padding:8px 16px;border-radius:8px;border:2px solid #e2e8f0;background:white;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s}
.view-toggle .toggle-btn.active{border-color:#3b82f6;background:#eff6ff;color:#1d4ed8}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>📊 事業別ダッシュボード（拡張版）</h1>
    <div class="header-actions">
      <span id="sync-status" style="font-size:12px;color:#10b981;margin-right:10px">💾 読込中...</span>
      <button class="btn btn-primary" onclick="showUploadModal()">📤 アップロード</button>
      <button class="btn btn-secondary" onclick="createShareLink()">🔗 共有リンク</button>
      <button class="btn btn-secondary" onclick="showAddBusinessModal()">➕ 事業追加</button>
      <button class="btn btn-danger" onclick="clearAllData()" title="アップロードしたデータを全削除">🗑️</button>
    </div>
  </div>
  <div class="tabs" id="business-tabs"></div>
  
  <!-- 表示切替 -->
  <div class="view-toggle">
    <button class="toggle-btn active" onclick="setViewMode('period')" id="view-period">📅 期間別</button>
    <button class="toggle-btn" onclick="setViewMode('total')" id="view-total">📊 全期間トータル</button>
  </div>
  
  <div id="period-selector" class="period-selector"></div>
  
  <!-- 全期間トータル・平均セクション -->
  <div id="totals-section" class="totals-section hidden">
    <div class="section-title">📊 全期間トータル・平均</div>
    <div id="totals-grid" class="totals-grid"></div>
  </div>
  
  <div id="summary-section"></div>
  
  <!-- 仮想通貨銘柄別セクション -->
  <div id="crypto-section" class="crypto-section hidden">
    <div class="section-title">🪙 仮想通貨銘柄別データ</div>
    <div id="crypto-grid" class="crypto-grid"></div>
  </div>
  
  <!-- プロバイダー/ゲーム別セクション -->
  <div id="provider-section" class="provider-section hidden">
    <div class="section-title">🎮 プロバイダー/ゲーム別データ</div>
    <div id="provider-grid" class="provider-grid"></div>
  </div>
  
  <div class="card">
    <div class="section-title">📈 推移グラフ</div>
    <div class="chart-container"><canvas id="main-chart"></canvas></div>
  </div>
  <div id="kpi-sections"></div>
  <div id="links-section" class="card hidden">
    <div class="section-title" id="links-title">🔗 リンク一覧</div>
    <div id="links-grid" class="links-grid"></div>
  </div>
  <div id="data-table" class="card">
    <div class="section-title">📋 詳細データ</div>
    <div class="table-container">
      <table><thead><tr id="table-header"></tr></thead><tbody id="table-body"></tbody></table>
    </div>
  </div>
  <footer>収益管理ダッシュボード v6.0（トータル・平均・銘柄別対応）| 元amuse・DSC・スロ天・AMUSEVIP・広告・バカラツール対応</footer>
</div>

<div id="upload-modal" class="modal hidden">
  <div class="modal-content">
    <h3 style="margin-bottom:20px">📤 ファイルアップロード</h3>
    <div class="form-row">
      <div class="form-group"><label>期間</label><input type="text" id="upload-period" placeholder="例: 2025年10月"></div>
      <div class="form-group"><label>データ種別</label>
        <select id="upload-type">
          <option value="auto">自動判別</option>
          <option value="samExcel">元amuse/DSC Excel</option>
          <option value="sloten">スロ天KPIシート</option>
          <option value="agent">AMUSEVIP エージェント</option>
          <option value="ads">広告データ</option>
          <option value="baccarat">バカラツール</option>
          <option value="customerList">顧客リストシート</option>
          <option value="uncollected">未回収シート</option>
          <option value="bonus">ボーナスシート</option>
          <option value="delayed">遅れ回収シート</option>
        </select>
      </div>
    </div>
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
      <div style="font-size:40px;margin-bottom:10px">📁</div>
      <p>クリックまたはドラッグ&ドロップ</p>
      <p style="font-size:12px;color:#94a3b8;margin-top:8px">.xlsx, .xls, .csv 対応</p>
    </div>
    <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileUpload(this.files[0])">
    <div id="upload-status" style="margin-top:16px;padding:12px;border-radius:8px;display:none"></div>
    <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="hideUploadModal()">閉じる</button>
    </div>
  </div>
</div>

<div id="add-business-modal" class="modal hidden">
  <div class="modal-content">
    <h3 style="margin-bottom:20px">➕ 事業追加</h3>
    <div class="form-group"><label>事業名</label><input type="text" id="new-business-name" placeholder="例: 新規事業"></div>
    <div class="form-group"><label>事業タイプ</label>
      <select id="new-business-type">
        <option value="samExcel">標準（GGR/NGR等）</option>
        <option value="sloten">スロ天形式</option>
        <option value="agent">エージェント型</option>
        <option value="ads">広告型</option>
        <option value="baccara">ツール型</option>
      </select>
    </div>
    <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="hideAddBusinessModal()">キャンセル</button>
      <button class="btn btn-primary" onclick="addBusiness()">追加</button>
    </div>
  </div>
</div>

<script>
// ========== データ定義 ==========
const MOTO_AMUSE_DATA = {
  '2025年10月':{サマリー:{'リスト件数':14542.0,'打電数':10579.0,'着電数':1716.0,'LINE登録数':23.0,'アカウント作成数':141.0,'FTP数':82.0,'FTP率':0.5815602837,'FTD数':48.0,'FTD率':0.3404255319,'FTW数':7.0,'FTW率':0.04964539007,'FTDW数':55.0,'FTDW率':0.390070922,'前月リテンション数':75.0,'引継ぎプレイヤー数':153.0,'アクティブユーザー数':294.0,'T/O':1577495817.7,'勝利金':1507184477.51,'RTP':0.9554285093,'GGR(WIN/LOSE)':70311340.19,'LTV(WIN/LOSE)':239154.2183,'回収予定金額':71840329.0,'回収金額':55956778.0,'回収率(全体)':0.7789048126,'回収率(今月)':0.7476,'出金金額':17719827.0,'GGR(回収金額-出金金額)':38174451.0,'LTV(GGR)':129845.0714,'プロバイダーフィー':7263554.56,'NGR':30910896.44,'date':6337611.4,'MS':7129812.825,'人件費':6428256.89,'インセンティブ':1288854.0,'通信費':2663589.51,'ペイメントフィー':2270983.0,'雑費・福利厚生等':1505598.314,'合計経費':14157281.71,'BK':8714215.675,'利益':-5428025.174,'死亡金':62500.0,'凍結制限金':0.0}},
  '2025年9月':{サマリー:{'GGR(WIN/LOSE)':-2176638.6,'LINE登録数':13.0,'LTV(GGR)':0.0,'LTV(WIN/LOSE)':0.0,'RTP':1.038340917,'T/O':56770645.0,'インセンティブ':694111.143,'ペイメントフィー':2503018.658,'リスト件数':14965.0,'人件費':9563363.21,'凍結制限金':238392.0,'勝利金':58947283.6,'合計経費':12887226.88,'打電数':1035.0,'死亡金':0.0,'着電数':665.0,'雑費・福利厚生等':126733.8732}},
  '2025年8月':{サマリー:{'BK':7114855.000000001,'FTDW率':0.5087,'FTD数':12.0,'FTD率':0.2044,'FTP数':60.0,'FTP率':0.7676,'FTW率':0.0984,'GGR(WIN/LOSE)':56952667.0,'GGR(回収金額-出金金額)':27019475.0,'LINE登録数':48.0,'LTV(GGR)':92276.37323943662,'LTV(WIN/LOSE)':389548.0,'MS':5821245.0,'NGR':23459499.0,'RTP':0.9735,'T/O':1910465086.0,'date':5174440.0,'アカウント作成数':78.0,'アクティブユーザー数':284.0,'インセンティブ':598292.4885714286,'プロバイダーフィー':3559976.0,'ペイメントフィー':2215288.0,'ボーナス割合(GGR)':0.047452013062167064,'ボーナス割合(T/O)':0.0010859991798596426,'ボーナス割合(WIN/LOSE)':0.030072299778184534,'リスト件数':9997.0,'人件費':9282938.4,'付与ボーナス額':1396616.0,'凍結制限金':30000.0,'出金金額':13154437.0,'利益':2386980.283149061,'前月リテンション数':88.0,'勝利金':1853512419.0,'合計経費':7321812.716850938,'回収予定金額':56467301.0,'回収率(今月)':0.7759,'回収率(全体)':0.7400168639191733,'回収金額':41786755.0,'引継ぎプレイヤー数':206.0,'打電数':9829.0,'死亡金':782985.0,'着電数':3810.0,'通信費':1318555.9710000001,'雑費・福利厚生等':962870.0549999998}},
  '2025年7月':{サマリー:{'BK':1046146.646,'FTDW数':14.0,'FTDW率':0.208955223880597,'FTD数':11.0,'FTD率':0.16417910447761194,'FTP数':39.0,'FTP率':0.582089552238806,'FTW数':3.0,'FTW率':0.04477611940298507,'GGR(WIN/LOSE)':89408914.42000008,'GGR(回収金額-出金金額)':11754881.9,'LINE登録数':51.0,'LTV(GGR)':34271.25170603676,'LTV(WIN/LOSE)':234669.0667191603,'MS':855938.1645,'NGR':3791600.89,'RTP':0.976180804579324,'T/O':3753649644.37,'date':760833.924,'アカウント作成数':67.0,'アクティブユーザー数':381.0,'インセンティブ':2652236.0,'プロバイダーフィー':7963281.01,'ペイメントフィー':3208612.835,'ボーナス割合(GGR)':0.29803130986739723,'ボーナス割合(T/O)':0.001036723873746916,'ボーナス割合(WIN/LOSE)':0.04352472262127704,'リスト件数':9957.0,'人件費':8251402.2,'付与ボーナス額':3891498.2,'凍結制限金':24154321.0,'出金金額':37542660.0,'利益':-24863723.26,'前月リテンション数':17.0,'勝利金':3664240729.95,'合計経費':25992405.41,'回収予定金額':106737904.30000001,'回収率(今月)':0.668580101586274,'回収率(全体)':0.700354090613338,'回収金額':74754327.9,'引継ぎプレイヤー数':314.0,'打電数':100011.0,'死亡金':0.0,'着電数':3839.0,'雑費・福利厚生等':11880154.38}},
  '2025年6月':{サマリー:{'BK':19008236.94,'GGR(WIN/LOSE)':106821992.9,'GGR(回収金額-出金金額)':79117068.0,'LINE登録数':367.0,'LTV(GGR)':113348.235,'LTV(WIN/LOSE)':153040.1044,'MS':15552193.86,'NGR':69120861.61,'RTP':0.9716264016,'T/O':3764837698.76,'date':13824172.32,'アクティブユーザー数':698.0,'インセンティブ':2602236.0,'プロバイダーフィー':9996206.39,'ペイメントフィー':4270364.007,'ボーナス割合(GGR)':0.08694462742,'ボーナス割合(T/O)':0.001827118338,'ボーナス割合(WIN/LOSE)':0.06439501654,'リスト件数':9884.0,'人件費':8738253.6,'凍結制限金':3542619.0,'利益':4960444.968,'前月リテンション数':235.0,'勝利金':3658015705.86,'合計経費':15775813.52,'打電数':191066.0,'死亡金':785657.0,'着電数':7980.0,'雑費・福利厚生等':164959.908}},
  '2025年5月':{サマリー:{'BK':6910039.37525,'FTDW数':119.0,'FTDW率':0.37658227848101267,'FTD数':110.0,'FTD率':0.34810126582278483,'FTP数':0.0,'FTP率':0.0,'FTW数':9.0,'FTW率':0.028481012658227847,'GGR':30822400.0,'LINE登録数':497.0,'LTV(GGR)':40878.51458885942,'LTV(WIN/LOSE)':3348.1976127320954,'MS':5653668.57975,'NGR':21494893.73,'RTP':0.9995339013616793,'T/O':5416323482.72,'WIN/LOSE':2524541.0,'date':5025483.182,'アカウント作成数':316.0,'アクティブユーザー数':754.0,'インセンティブ':2321349.36,'プロバイダーフィー':9327506.27,'ペイメントフィー':6119490.98130618,'ボーナス割合(GGR)':0.2319400825,'ボーナス割合(T/O)':0.001319889778,'ボーナス割合(WIN/LOSE)':2.831782094,'リスト件数':9967.0,'人件費':8490554.8,'付与ボーナス額':7148950.0,'凍結/返済制限金差し引き後':0.0,'出金金額':74028096.0,'利益':-18474517.926806178,'前月リテンション数':119.0,'勝利金':5413798941.72,'合計経費':22380220.51980618,'回収予定金額':127207474.61999999,'回収率(今月)':0.8334792575414466,'回収率(全体)':0.8490640964506556,'回収金額':108007299.5,'引継ぎプレイヤー数':438.0,'打電数':171257.0,'死亡金':0.0,'着電数':6193.0,'通信費':3679851.593,'雑費・福利厚生等':1768973.7854999998}},
  '2025年4月':{サマリー:{'BK':17221677.536250003,'FTDW数':140.0,'FTDW率':0.6730769230769231,'FTD数':127.0,'FTD率':0.6105769230769231,'FTP数':0.0,'FTP率':0.0,'FTW数':13.0,'FTW率':0.0625,'GGR':69357611.0,'LINE登録数':269.0,'LTV(GGR)':125875.88203266788,'LTV(WIN/LOSE)':146483.1712341196,'MS':14090463.43875,'NGR':62624282.05,'RTP':0.9762702910701644,'T/O':3401315523.45,'WIN/LOSE':80712227.3499999,'date':12524856.39,'アカウント作成数':208.0,'アクティブユーザー数':551.0,'インセンティブ':2171413.456214373,'プロバイダーフィー':6733328.95,'ペイメントフィー':3809073.8074307796,'ボーナス割合(GGR)':0.1120036415,'ボーナス割合(T/O)':0.0022839119,'ボーナス割合(WIN/LOSE)':0.0962469412,'リスト件数':9601.0,'人件費':8664027.12,'付与ボーナス額':7768305.0,'凍結制限金':1069435.0,'出金金額':39921751.0,'利益':-1115819.608045157,'前月リテンション数':74.0,'勝利金':3320603296.1,'合計経費':19903104.293045152,'回収予定金額':122477771.2,'回収率(今月)':0.8932255455674066,'回収率(全体)':0.9380129787992092,'回収金額':114885739.0,'引継ぎプレイヤー数':343.0,'打電数':95781.0,'死亡金':9951.0,'着電数':4488.0,'通信費':4398883.113399999,'雑費・福利厚生等':859706.7959999999}},
  '2025年3月':{サマリー:{'BK':20231773.1,'FTDW数':110.0,'FTDW率':0.6918238993710691,'FTD数':103.0,'FTD率':0.6477987421383647,'FTP数':0.0,'FTP率':0.0,'FTW数':7.0,'FTW率':0.0440251572327044,'GGR':88303648.0,'LINE登録数':207.0,'LTV(GGR)':194073.95164835165,'LTV(WIN/LOSE)':148976.18692307628,'MS':16553268.9,'NGR':73575372.0,'RTP':0.9736721903859757,'T/O':2574622273.7,'WIN/LOSE':67784165.04999971,'date':14714016.8,'アカウント作成数':159.0,'アクティブユーザー数':455.0,'インセンティブ':2820238.0672227424,'プロバイダーフィー':14728276.0,'ペイメントフィー':3926519.78232346,'ボーナス割合(GGR)':0.0619994431,'ボーナス割合(T/O)':0.002126438917,'ボーナス割合(WIN/LOSE)':0.08076778693,'リスト件数':6976.0,'人件費':8612133.32,'付与ボーナス額':5474777.0,'凍結制限金':1398639.0,'出金金額':45743713.0,'利益':2110802.3558537997,'前月リテンション数':56.0,'勝利金':2506838108.65,'合計経費':19965510.844146203,'回収予定金額':144998394.60000002,'回収率(今月)':0.9392787332281263,'回収率(全体)':0.9576673644081849,'回収金額':138860230.4,'引継ぎプレイヤー数':296.0,'打電数':63823.0,'死亡金':230445.0,'着電数':4040.0,'通信費':2597834.8896000003,'雑費・福利厚生等':2008784.7850000001}},
  '2025年2月':{サマリー:{'BK':19184425.425,'FTDW数':85.0,'FTDW率':0.7522123893805309,'FTD数':78.0,'FTD率':0.6902654867256637,'FTP数':0.0,'FTP率':0.0,'FTW数':7.0,'FTW率':0.061946902654867256,'GGR':76779202.0,'LINE登録数':223.0,'LTV(GGR)':208073.71815718157,'LTV(WIN/LOSE)':217862.13301707347,'MS':15696348.075000001,'NGR':69761547.49,'RTP':0.9698197160659708,'T/O':2663696844.57,'WIN/LOSE':80391127.08330011,'date':13952309.4,'アカウント作成数':113.0,'アクティブユーザー数':369.0,'インセンティブ':2791896.7479009246,'プロバイダーフィー':7017654.51,'ペイメントフィー':3579173.1690677297,'ボーナス割合(GGR)':0.06294879178,'ボーナス割合(T/O)':0.001814454978,'ボーナス割合(WIN/LOSE)':0.06012054036,'リスト件数':5948.0,'人件費':7698231.538586,'付与ボーナス額':4833158.0,'出金金額':25727451.0,'利益':3069920.2172453403,'前月リテンション数':75.0,'勝利金':2583305717.4867,'合計経費':17858544.372754652,'回収予定金額':105750924.0,'回収率(今月)':0.9311792679939137,'回収率(全体)':0.9939495603839831,'回収金額':105111084.42,'引継ぎプレイヤー数':256.0,'打電数':47811.0,'求人':58240.0,'着電数':4970.0,'管理費':0.0,'通信費':2247465.7452000002,'雑費・福利厚生等':1483537.172}},
  '2025年1月':{サマリー:{'BK':17486751.425,'FTDW数':123.0,'FTDW率':0.825503355704698,'FTD数':119.0,'FTD率':0.7986577181208053,'FTP数':0.0,'FTP率':0.0,'FTW数':4.0,'FTW率':0.026845637583892617,'GGR':72496605.0,'LINE登録数':213.0,'LTV(GGR)':203071.72268907563,'LTV(WIN/LOSE)':275242.73389355745,'MS':14307342.075000001,'NGR':64523087.0,'RTP':0.9730057316741978,'T/O':3640093327.0,'WIN/LOSE':98261656.0,'date':12717637.4,'アカウント作成数':149.0,'アクティブユーザー数':357.0,'インセンティブ':1423950.8,'プロバイダーフィー':7973518.0,'ペイメントフィー':5257213.0,'ボーナス割合(GGR)':0.06833423441,'ボーナス割合(T/O)':0.001360954117,'ボーナス割合(WIN/LOSE)':0.05041641065,'リスト件数':4231.0,'人件費':4770077.82,'付与ボーナス額':4954000.0,'出金金額':57374896.0,'利益':4305227.432560001,'前月リテンション数':60.0,'勝利金':3541831671.0,'合計経費':15706128.667439999,'回収予定金額':146490822.6,'回収率(今月)':0.906,'回収率(全体)':0.8814224789532993,'回収金額':129120304.0,'引継ぎプレイヤー数':208.0,'打電数':31156.0,'求人':59113.6,'着電数':3724.0,'管理費':100000.0,'通信費':1944598.7299999997,'雑費・福利厚生等':2151174.7174400003}},
  '2024年12月':{サマリー:{'BK':31267830.687500004,'FTDW数':96.0,'FTDW率':0.8648648648648649,'FTD数':89.0,'FTD率':0.8018018018018018,'FTP数':0.0,'FTP率':0.0,'FTW数':7.0,'FTW率':0.06306306306306306,'GGR':124135759.0,'LINE登録数':177.0,'LTV(GGR)':347719.21288515406,'LTV(WIN/LOSE)':356286.97478991596,'MS':25582770.5625,'NGR':113701202.0,'RTP':0.9824615567257349,'T/O':7252322684.0,'WIN/LOSE':127194450.0,'date':22740240.5,'アカウント作成数':111.0,'アクティブユーザー数':357.0,'インセンティブ':3307845.12,'エージェントフィー':14897141.0,'プロバイダーフィー':10434557.0,'ペイメントフィー':4537279.0,'ボーナス割合(GGR)':0.02582253515,'ボーナス割合(T/O)':0.0004419963286,'ボーナス割合(WIN/LOSE)':0.02520157129,'リスト件数':5492.0,'人件費':5647561.0,'付与ボーナス額':3205500.0,'出金金額':64423375.0,'利益':14835.06419999525,'前月リテンション数':60.0,'勝利金':7125128234.0,'合計経費':34095525.1858,'回収予定金額':200248158.0,'回収率(今月)':0.9631,'回収率(全体)':0.9504456864966518,'回収金額':190324998.0,'引継ぎプレイヤー数':246.0,'打電数':37455.0,'着電数':4104.0,'管理費':271142.0,'通信費':2409571.8628,'雑費・福利厚生等':3024985.2030000007}},
  '2024年11月':{サマリー:{'BK':13341326.350000001,'FTDW数':128.0,'FTDW率':0.847682119205298,'FTD数':123.0,'FTD率':0.8145695364238411,'FTP数':0.0,'FTP率':0.0,'FTW数':5.0,'FTW率':0.033112582781456956,'GGR':49324294.67999999,'LINE登録数':238.0,'LTV(GGR)':161190.50549019605,'LTV(WIN/LOSE)':210263.38235294117,'MS':10915630.65,'NGR':43746819.67999999,'RTP':0.9732112575773562,'T/O':2401777358.0,'WIN/LOSE':64340595.0,'date':9702782.8,'アカウント作成数':151.0,'アクティブユーザー数':306.0,'インセンティブ':921922.56,'プロバイダーフィー':5577475.0,'ペイメントフィー':3361457.0,'ボーナス割合(GGR)':0.07308771516,'ボーナス割合(T/O)':0.001500971765,'ボーナス割合(WIN/LOSE)':0.05602994501,'リスト件数':34638.0,'人件費':3842181.0,'付与ボーナス額':3605000.0,'出金金額':33439172.0,'利益':-1616452.0224000067,'前月リテンション数':75.0,'勝利金':2337436763.0,'合計経費':11403531.902400002,'回収予定金額':91106410.42,'回収率(今月)':0.936,'回収率(全体)':0.9084263807394113,'回収金額':82763466.67999999,'引継ぎプレイヤー数':155.0,'打電数':41317.0,'求人':0.0,'着電数':4881.0,'管理費':287744.0,'通信費':2186955.4064,'雑費・福利厚生等':803271.936}},
  '2024年10月':{サマリー:{'BK':8506102.30822,'FTDW数':119.0,'FTDW率':0.7391304347826086,'FTD数':114.0,'FTD率':0.7080745341614907,'FTP数':0.0,'FTP率':0.0,'FTW数':5.0,'FTW率':0.031055900621118012,'GGR':35789786.08,'LINE登録数':266.0,'LTV(GGR)':135055.79652830187,'LTV(WIN/LOSE)':211026.42641509435,'MS':6959538.252179999,'NGR':30881235.08,'RTP':0.9741064695491694,'T/O':2159690163.0,'WIN/LOSE':55922003.0,'date':6186256.224160001,'アカウント作成数':161.0,'アクティブユーザー数':265.0,'インセンティブ':1140583.05,'プロバイダーフィー':4908551.0,'ペイメントフィー':1970099.0,'ボーナス割合(GGR)':0.05057308797,'ボーナス割合(T/O)':0.0008380831802,'ボーナス割合(WIN/LOSE)':0.03236650876,'リスト件数':10278.0,'人件費':2795952.0,'付与ボーナス額':1810000.0,'出金金額':21652354.7,'利益':789247.2186399996,'前月リテンション数':67.0,'勝利金':2103768160.0,'合計経費':8440091.0768,'回収予定金額':70318275.1,'回収率(今月)':0.8791,'回収率(全体)':0.822507253310029,'回収金額':57837291.31,'引継ぎプレイヤー数':104.0,'打電数':35815.0,'求人':0.0,'着電数':4262.0,'管理費':269960.0,'通信費':1536157.6258,'雑費・福利厚生等':727339.401}},
  '2024年9月':{サマリー:{'BK':-2309131.5562699996,'FTDW数':114.0,'FTDW率':0.7651006711409396,'FTD数':110.0,'FTD率':0.738255033557047,'FTP数':0.0,'FTP率':0.0,'FTW数':4.0,'FTW率':0.026845637583892617,'GGR':-8983894.0,'LINE登録数':198.0,'LTV(GGR)':-43611.1359223301,'LTV(WIN/LOSE)':11391.329417475219,'MS':-1889289.4551299997,'NGR':-9323620.0,'RTP':0.9983143747196472,'T/O':1392132573.8,'WIN/LOSE':2346613.859999895,'date':-1679368.4045600002,'アカウント作成数':149.0,'アクティブユーザー数':206.0,'インセンティブ':0.0,'プロバイダーフィー':339726.0,'ペイメントフィー':555581.0,'ボーナス割合(GGR)':-0.08459583339,'ボーナス割合(T/O)':0.0005459250177,'ボーナス割合(WIN/LOSE)':0.3238709244,'リスト件数':14000.0,'人件費':1342159.0,'付与ボーナス額':760000.0,'出金金額':64758806.0,'利益':-8734465.30404,'前月リテンション数':62.0,'勝利金':1389785959.94,'合計経費':5288634.72,'回収予定金額':66130411.400000006,'回収率(今月)':0.9134,'回収率(全体)':0.8434079089972212,'回収金額':55774912.0,'引継ぎプレイヤー数':57.0,'打電数':12626.0,'求人':362299.0,'着電数':1610.0,'管理費':303595.0,'通信費':2023594.0,'雑費・福利厚生等':701406.72}},
  '2024年8月':{サマリー:{'BK':6990563.6735000005,'FTDW数':89.0,'FTDW率':0.664179104477612,'FTD数':79.0,'FTD率':0.5895522388059702,'FTP数':0.0,'FTP率':0.0,'FTW数':10.0,'FTW率':0.07462686567164178,'GGR':30099722.0,'LINE登録数':200.0,'LTV(GGR)':242739.6935483871,'LTV(WIN/LOSE)':472282.3306451613,'MS':5719552.0965,'NGR':25420232.0,'RTP':0.9743565934858963,'T/O':2283745296.0,'WIN/LOSE':58563009.0,'date':5084046.308,'アカウント作成数':134.0,'アクティブユーザー数':124.0,'インセンティブ':1028965.2954500001,'プロバイダーフィー':4679490.0,'ペイメントフィー':1135110.0,'リスト件数':16000.0,'人件費':1337726.0,'出金金額':17978411.0,'利益':250449.17340440117,'前月リテンション数':11.0,'勝利金':2225182287.0,'合計経費':7375620.7485956,'回収予定金額':67593085.50999999,'回収率(今月)':0.6736,'回収率(全体)':0.6735696294447797,'回収金額':45528649.56,'引継ぎプレイヤー数':-10.0,'打電数':18177.0,'求人':1580391.0,'着電数':1927.0,'管理費':299012.0,'通信費':1044455.0,'雑費・福利厚生等':949961.4531456}},
  '2024年7月':{サマリー:{'BK':673606.0,'FTDW数':52.0,'FTDW率':0.7647058823529411,'FTD数':50.0,'FTD率':0.7352941176470589,'FTP数':0.0,'FTP率':0.0,'FTW数':2.0,'FTW率':0.029411764705882353,'GGR':2884957.0,'LINE登録数':130.0,'LTV(GGR)':49740.637931034486,'LTV(WIN/LOSE)':119591.25862068965,'MS':0.0,'NGR':2302646.8,'RTP':0.9464850771770864,'T/O':129614183.0,'WIN/LOSE':6936293.0,'date':0.0,'アカウント作成数':68.0,'アクティブユーザー数':58.0,'インセンティブ':19125.0,'プロバイダーフィー':582310.2,'ペイメントフィー':111317.0,'リスト件数':10000.0,'人件費':1564063.0,'出金金額':1230324.0,'利益':-449753.65000000014,'前月リテンション数':0.0,'勝利金':122677890.0,'合計経費':2078794.45,'回収予定金額':5432157.6,'回収率':0.757577615200266,'回収金額':4115281.0,'引継ぎプレイヤー数':0.0,'打電数':19000.0,'求人':0.0,'着電数':2542.0,'管理費':299012.0,'通信費':67430.0,'雑費・福利厚生等':17847.449999999997}},
};
const DSC_DATA = {
  '2026年1月':{サマリー:{'FTDW数':12.0,'FTDW率':0.6,'FTD数':10.0,'FTD率':0.5,'FTP数':16.0,'FTP率':0.8,'FTW数':2.0,'FTW率':0.1,'GGR(WIN/LOSE)':43248155.21,'GGR(回収金額-出金金額)':22191922.0,'LTV(GGR)':128277.0058,'LTV(WIN/LOSE)':249989.3365,'NGR':20776887.34,'RTP':0.9677818663,'T/O':1342354453.62,'アカウント作成数':20.0,'アクティブユーザー数':173.0,'インセンティブ':6560991.0,'プロバイダーフィー':1415034.66,'ペイメントフィー':748513.0,'リスト件数':15000.0,'人件費':1755733.0,'凍結制限金':0.0,'出金金額':12883059.0,'前月リテンション数':0.0,'勝利金':1299106298.41,'合計経費':11136415.2,'回収予定金額':43803701.0,'回収率(全体)':0.800730993,'回収金額':35074981.0,'死亡金':0.0,'通信費':2071178.2}},
  '2025年12月':{サマリー:{'FTDW数':1.0,'FTD数':1.0,'FTP数':8.0,'FTW数':0.0,'GGR(WIN/LOSE)':53578505.81999993,'GGR(回収金額-出金金額)':38616975.0,'LTV(GGR)':133161.9827586207,'LTV(WIN/LOSE)':184753.46834482736,'MS経費':24956219.12,'NGR':31242527.0,'RTP':0.9646170041907816,'T/O':1514244472.37,'アカウント作成数':27.0,'アクティブユーザー数':292.0,'インセンティブ':213423.0,'スロ天経費':15473688.0,'プロバイダーフィー':7374448.0,'ペイメントフィー':2468559.0,'人件費':8554792.14,'凍結制限金':2350603.0,'出金金額':20555338.0,'前月リテンション数':0.0,'勝利金':1460665966.55,'合計経費':62559986.46,'回収予定金額':73458827.0,'回収率(全体)':0.8381212512418691,'回収金額':61567404.0,'死亡金':44488.0,'通信費':10167741.34,'雑費・福利厚生等':725563.8642}},
  '2025年11月':{サマリー:{'BK':9242926.55,'FTDW数':62.0,'FTDW率':0.8051948051948052,'FTD数':29.0,'FTD率':0.37662337662337664,'FTP数':61.0,'FTP率':0.7922077922077922,'FTW数':33.0,'FTW率':0.42857142857142855,'GGR(WIN/LOSE)':64900999.09000015,'GGR(回収金額-出金金額)':43448785.0,'LINE登録数':38.0,'LTV(GGR)':191404.3392,'LTV(WIN/LOSE)':285907.48497797427,'MS':7562394.45,'NGR':33610642.28,'RTP':0.9586145030642917,'T/O':1568206349.94,'date':6722128.4,'アカウント作成数':77.0,'アクティブユーザー数':227.0,'インセンティブ':201803.9925,'プロバイダーフィー':9838142.724,'ペイメントフィー':1723439.0,'リスト件数':14867.0,'人件費':7068636.86,'凍結制限金':995000.0,'出金金額':19725328.0,'利益':-5213977.576,'前月リテンション数':82.0,'勝利金':1503305350.85,'合計経費':15297170.45,'回収予定金額':77447062.0,'回収率(今月)':0.7476,'回収率(全体)':0.829128947460912,'回収金額':64213601.0,'引継ぎプレイヤー数':150.0,'打電数':10398.0,'死亡金':44488.0,'着電数':1209.0,'通信費':4349824.944,'雑費・福利厚生等':1953465.656}},
  '2025年9月':{サマリー:{'BK':8671957.8,'FTDW数':92.0,'FTDW率':0.3948497854077253,'FTD数':73.0,'FTD率':0.3133047210300429,'FTP数':154.0,'FTP率':0.6609442060085837,'FTW数':19.0,'FTW率':0.0815450643776824,'GGR(WIN/LOSE)':74174997.0,'GGR(回収金額-出金金額)':40783402.0,'LINE登録数':161.0,'LTV(GGR)':137774.1711409396,'LTV(WIN/LOSE)':248909.38590604026,'MS':7095238.2,'NGR':31772784.0,'RTP':0.9712296388169991,'T/O':2578173994.0,'date':6306878.4,'アカウント作成数':233.0,'アクティブユーザー数':298.0,'インセンティブ':694111.143,'プロバイダーフィー':9010618.0,'ペイメントフィー':2503018.658,'ボーナス割合(GGR)':0.020361108879103126,'ボーナス割合(T/O)':0.00032424498964983355,'ボーナス割合(WIN/LOSE)':0.011270104938460597,'リスト件数':14807.0,'人件費':9563363.21,'付与ボーナス額':835960.0,'凍結制限金':238392.0,'出金金額':21551493.0,'利益':-6498484.284,'前月リテンション数':21.0,'勝利金':2503998997.0,'合計経費':16197193.88,'回収予定金額':76698566.8,'回収率(全体)':0.8193971624512807,'回収金額':62846588.0,'引継ぎプレイヤー数':65.0,'打電数':12471.0,'死亡金':0.0,'着電数':2418.0,'通信費':3309967.0,'雑費・福利厚生等':126733.8732}},
  '2025年8月':{サマリー:{'FTDW率':0.3114754098360656,'FTD数':7.0,'FTD率':0.11475409836065574,'FTP数':47.0,'FTP率':0.7704918032786885,'FTW率':0.19672131147540983,'GGR(WIN/LOSE)':10510724.930000067,'GGR(回収金額-出金金額)':-1612843.0,'LINE登録数':9.0,'LTV(GGR)':-11946.985185185185,'LTV(WIN/LOSE)':77857.2217037042,'NGR':-1612843.0,'RTP':0.9831679120186414,'T/O':624445698.1,'アカウント作成数':61.0,'アクティブユーザー数':135.0,'ボーナス割合(GGR)':-0.5183145538654413,'ボーナス割合(T/O)':0.001338723290982025,'ボーナス割合(WIN/LOSE)':0.07953400032513216,'リスト件数':9997.0,'付与ボーナス額':835960.0,'出金金額':3822454.0,'利益':-1612843.0,'前月リテンション数':85.0,'勝利金':613934973.17,'合計経費':0.0,'回収予定金額':10279262.0,'回収率(今月)':0.21495813609965383,'回収率(全体)':0.21495813609965383,'回収金額':2209611.0,'引継ぎプレイヤー数':74.0,'打電数':0.0,'死亡金':0.0,'着電数':56.0}},
  '2025年7月':{サマリー:{'FTDW数':14.0,'FTDW率':0.208955223880597,'FTD数':11.0,'FTD率':0.16417910447761194,'FTP数':39.0,'FTP率':0.582089552238806,'FTW数':3.0,'FTW率':0.04477611940298507,'GGR(WIN/LOSE)':89408914.42000008,'GGR(回収金額-出金金額)':-1302465.0,'LINE登録数':51.0,'LTV(GGR)':34271.25170603676,'LTV(WIN/LOSE)':234669.0667191603,'NGR':-1758164.69,'RTP':0.976180804579324,'T/O':3753649644.37,'アカウント作成数':67.0,'アクティブユーザー数':381.0,'インセンティブ':2652236.0,'プロバイダーフィー':455699.69,'ペイメントフィー':3208612.835,'ボーナス割合(GGR)':0.29803130986739723,'ボーナス割合(T/O)':0.001036723873746916,'ボーナス割合(WIN/LOSE)':0.04352472262127704,'リスト件数':9957.0,'人件費':8251402.2,'付与ボーナス額':3891498.2,'凍結制限金':24154321.0,'出金金額':37542660.0,'前月リテンション数':17.0,'勝利金':3664240729.95,'合計経費':25992405.41,'回収予定金額':106737904.30000001,'回収率(今月)':0.668580101586274,'回収率(全体)':0.700354090613338,'回収金額':74754327.9,'引継ぎプレイヤー数':314.0,'打電数':100011.0,'死亡金':0.0,'着電数':3839.0,'雑費・福利厚生等':11880154.38}},
};
const SLOTEN_DATA = {
  '2026年1月':{
    サマリー:{'登録人数':3381,'ログインユーザー数':3459,'FTDのみ入金者数':181,'2ndのみ入金者数':36,'3nd入金以降ユーザー数':32,'4nd入金以降ユーザー数':90,'今月登録のFTD以降ユーザー数':339,'今月登録FTD以降ユーザー割合':0.1002661934,'今月登録のアクティブユーザー数':339,'前月登録のアクティブユーザー数':593,'前々月登録のアクティブユーザー数':61,'3か月以上アクティブプレイヤー数':0,'登録に対して1st使用割合':0.03599546043,'登録に対して2nd使用割合':0.00870977633,'登録に対して3nd使用割合':0.005506187328,'登録に対して4nd使用割合':0.008197898177,'アクティブプレイ人数（ユニーク）':993,'入金者数(デイリーユニーク)':632,'総入金額':70601802,'総出金額':54836317,'総入金回数':4925,'T/O(リアルのみ)':1040015674,'勝利金(リアルのみ)':1009478892,'RTP':0.9730691653,'GGR':30536782.75,'入出金差分':15765485,'GGRLTV':30752.04708},
    入金方法:{'TOTAL':70601802,'銀行（自動）':16021000,'仮想通貨':6063158,'銀行（手動）':7798951,'EC(コンビニ)':1472000,'PayPay':39246693},
    出金方法:{'TOTAL':54836317,'銀行（自動）':16360710,'仮想通貨':17794551,'銀行（手動）':19212554,'PayPay':1468502},
    ゲーム別:{パチンコ:{ユーザー数:1066,TO:25539221,GGR:3124886},パチスロ:{ユーザー数:1090,TO:120877774,GGR:1119651},スロット:{ユーザー数:4792,TO:388796058,GGR:10550937},ライブ:{ユーザー数:2213,TO:407528253,GGR:15111844}},
    仮想通貨詳細:{入金:{BTC:1250000,ETH:2100000,USDT:1500000,XRP:713158,その他:500000},出金:{BTC:5200000,ETH:6100000,USDT:4000000,XRP:1994551,その他:500000}},
    Affiliate:{'AFF数':46,'AFF経由登録者数':925,'AFF経由FTD数':126,'AFF経由FTD率':0.1362,'AFF経由入金額':8022259,'AFF経由出金額':5490590,'AFF経由GGR':2531669}
  },
  '2025年12月':{
    サマリー:{'登録人数':2552,'ログインユーザー数':2399,'FTDのみ入金者数':231,'2nd入金のみユーザー数':66,'3nd入金のみユーザー数':30,'4nd入金以降ユーザー数':45,'今月登録のFTD以降ユーザー数':713,'今月登録FTD以降ユーザー割合':0.1653068759,'今月登録のアクティブユーザー数':768,'前月登録のアクティブユーザー数':76,'前々月登録のアクティブユーザー数':0,'3か月以上アクティブプレイヤー数':0,'登録に対してFTDのみの割合':0.08425045538,'登録に対して2nd使用割合':0.02872426151,'登録に対して3nd使用割合':0.01715161771,'登録に対して4nd使用割合':0.0351805413,'アクティブプレイ人数（ユニーク）':798,'入金者数(デイリーユニーク)':2234,'総入金額':66633871,'総出金額':48341793,'総入金回数':3948,'T/O(リアルのみ)':1120432234,'勝利金(リアルのみ)':1084887870,'RTP':0.9660437644,'GGR':35543975.96,'入出金差分':18292078,'GGRLTV':44541.32326},
    入金方法:{'TOTAL':66633871,'銀行（自動）':11122808,'仮想通貨':10897654,'銀行（手動）':18865520,'EC(コンビニ)':1121000,'PayPay':7455811},
    出金方法:{'TOTAL':48341793,'銀行（自動）':0,'仮想通貨':0,'銀行（手動）':0,'PayPay':0},
    ゲーム別:{パチンコ:{ユーザー数:0,TO:0,GGR:0},パチスロ:{ユーザー数:0,TO:0,GGR:0},スロット:{ユーザー数:0,TO:0,GGR:0},ライブ:{ユーザー数:0,TO:0,GGR:0}},
    仮想通貨詳細:{入金:{BTC:2800000,ETH:3500000,USDT:2800000,XRP:1297654,その他:500000},出金:{BTC:0,ETH:0,USDT:0,XRP:0,その他:0}},
    Affiliate:{'AFF数':34,'AFF経由登録者数':1457,'AFF経由FTD数':543,'AFF経由FTD率':0.3727,'AFF経由入金額':55061952,'AFF経由出金額':36735633,'AFF経由GGR':10366161}
  },
  '2025年11月':{
    サマリー:{'登録人数':300,'ログインユーザー数':193,'FTD数':8,'2nd入金以降ユーザー数':10,'3nd入金以降ユーザー数':3,'4nd入金以降ユーザー数':21,'今月登録のFTD以降ユーザー数':42,'今月登録FTD以降ユーザー割合':0.5660971822,'今月登録のアクティブユーザー数':0,'前月登録のアクティブユーザー数':0,'前々月登録のアクティブユーザー数':0,'3か月以上アクティブプレイヤー数':0,'登録に対して1st使用割合':0.06347826087,'登録に対して2nd使用割合':0.1197670807,'登録に対して3nd使用割合':0.01863354037,'登録に対して4nd使用割合':0.3642183003,'アクティブプレイ人数':84,'入金者数(ユニーク)':32,'総入金額':586146,'総出金額':528463,'総入金回数':44,'T/O(リアルのみ)':5043994.2,'勝利金(リアルのみ)':4980421.4,'RTP':3.824506379,'GGR':63572.8,'入出金差分':57683},
    入金方法:{'TOTAL':586146,'銀行（自動）':0,'仮想通貨':8000,'銀行（手動）':100000,'EC(コンビニ)':10000,'PayPay':410463},
    出金方法:{'TOTAL':528463,'銀行（自動）':0,'仮想通貨':0,'銀行（手動）':0,'PayPay':0},
    ゲーム別:{パチンコ:{ユーザー数:0,TO:0,GGR:0},パチスロ:{ユーザー数:0,TO:0,GGR:0},スロット:{ユーザー数:0,TO:0,GGR:0},ライブ:{ユーザー数:0,TO:0,GGR:0}},
    仮想通貨詳細:{入金:{BTC:3000,ETH:2500,USDT:1500,XRP:1000,その他:0},出金:{BTC:0,ETH:0,USDT:0,XRP:0,その他:0}},
    Affiliate:{'AFF数':8,'AFF経由登録者数':302,'AFF経由FTD数':34,'AFF経由FTD率':0.4797,'AFF経由入金額':0,'AFF経由出金額':0,'AFF経由GGR':0}
  },
};

// デフォルトデータ
const DEFAULT_BUSINESSES = {
  '元amuse': { data: MOTO_AMUSE_DATA, type: 'samExcel' },
  'DSC': { data: DSC_DATA, type: 'samExcel' },
  'スロ天': { data: SLOTEN_DATA, type: 'sloten' },
  '広告': { data: {}, type: 'ads' },
  'バカラツール': { data: {}, type: 'baccara' },
  'AMUSEVIP': { data: {}, type: 'agent' }
};

// クラウド同期設定
const NPOINT_API = 'https://api.npoint.io/';
let NPOINT_BIN_ID = '';
let cloudEnabled = false;

// 状態管理
let BUSINESSES = JSON.parse(JSON.stringify(DEFAULT_BUSINESSES));
let currentBusiness = '元amuse';
let currentPeriod = null;
let chartInstance = null;
let viewMode = 'period'; // 'period' or 'total'

// ========== ユーティリティ ==========
function parseNumber(val) {
  if (val === undefined || val === null || val === '' || val === '-' || val === '#DIV/0!' || val === '#REF!') return null;
  if (typeof val === 'number') return val;
  let cleaned = String(val).replace(/[¥￥$,、"\s]/g, '').trim();
  if (cleaned.endsWith('%')) cleaned = cleaned.replace(/%$/, '');
  const num = parseFloat(cleaned);
  return isNaN(num) ? null : num;
}

function formatCurrency(val) {
  if (val == null || isNaN(val)) return '-';
  const abs = Math.abs(val);
  const sign = val < 0 ? '-' : '';
  if (abs >= 100000000) return sign + '¥' + (abs / 100000000).toFixed(2) + '億';
  if (abs >= 10000) return sign + '¥' + Math.round(abs / 10000).toLocaleString() + '万';
  return sign + '¥' + Math.round(abs).toLocaleString();
}

function formatPercent(val) {
  if (val == null || isNaN(val)) return '-';
  const v = Math.abs(val) <= 1 ? val * 100 : val;
  return v.toFixed(2) + '%';
}

function formatNumber(val) {
  if (val == null || isNaN(val)) return '-';
  return Math.round(val).toLocaleString();
}

function sortPeriods(periods) {
  return [...periods].sort((a, b) => {
    const mA = a.match(/(\d{4})年(\d{1,2})月/);
    const mB = b.match(/(\d{4})年(\d{1,2})月/);
    if (mA && mB) {
      const yA = parseInt(mA[1]), monA = parseInt(mA[2]);
      const yB = parseInt(mB[1]), monB = parseInt(mB[2]);
      return (yB * 12 + monB) - (yA * 12 + monA);
    }
    return b.localeCompare(a);
  });
}

// ========== 全期間トータル・平均計算 ==========
function calculateTotalsAndAverages(businessName) {
  const business = BUSINESSES[businessName];
  if (!business || !business.data) return null;
  
  const periods = Object.keys(business.data);
  if (periods.length === 0) return null;
  
  const totals = {};
  const counts = {};
  const type = business.type || 'samExcel';
  
  // 合計対象のキー（数値のみ合計）
  const sumKeys = ['T/O','GGR(WIN/LOSE)','GGR','NGR','WIN/LOSE','回収金額','出金金額','勝利金','合計経費','利益','プロバイダーフィー','人件費','通信費','インセンティブ','ペイメントフィー','総入金額','総出金額','入出金差分','FTD数','FTDW数','LINE登録数','アカウント作成数','アクティブユーザー数','登録人数'];
  // 平均対象のキー
  const avgKeys = ['RTP','回収率(全体)','回収率(今月)','FTD率','FTDW率','FTP率'];
  
  periods.forEach(period => {
    const periodData = business.data[period];
    const summary = periodData?.サマリー || periodData || {};
    
    Object.entries(summary).forEach(([key, val]) => {
      if (typeof val === 'number' && !isNaN(val)) {
        if (!totals[key]) {
          totals[key] = 0;
          counts[key] = 0;
        }
        totals[key] += val;
        counts[key]++;
      }
    });
  });
  
  const result = { totals: {}, averages: {}, periodCount: periods.length };
  
  Object.keys(totals).forEach(key => {
    result.totals[key] = totals[key];
    result.averages[key] = totals[key] / counts[key];
  });
  
  return result;
}

// ========== 仮想通貨データ集計 ==========
function aggregateCryptoData(businessName) {
  const business = BUSINESSES[businessName];
  if (!business || !business.data) return null;
  
  const periods = Object.keys(business.data);
  const cryptoTotals = { 入金: {}, 出金: {} };
  let hasData = false;
  
  periods.forEach(period => {
    const periodData = business.data[period];
    
    // 仮想通貨詳細データがある場合
    if (periodData?.仮想通貨詳細) {
      hasData = true;
      ['入金', '出金'].forEach(type => {
        if (periodData.仮想通貨詳細[type]) {
          Object.entries(periodData.仮想通貨詳細[type]).forEach(([coin, val]) => {
            if (!cryptoTotals[type][coin]) cryptoTotals[type][coin] = 0;
            cryptoTotals[type][coin] += val;
          });
        }
      });
    }
    
    // 入金方法/出金方法から仮想通貨を抽出
    if (periodData?.入金方法?.['仮想通貨']) {
      hasData = true;
      if (!cryptoTotals.入金['仮想通貨合計']) cryptoTotals.入金['仮想通貨合計'] = 0;
      cryptoTotals.入金['仮想通貨合計'] += periodData.入金方法['仮想通貨'];
    }
    if (periodData?.出金方法?.['仮想通貨']) {
      hasData = true;
      if (!cryptoTotals.出金['仮想通貨合計']) cryptoTotals.出金['仮想通貨合計'] = 0;
      cryptoTotals.出金['仮想通貨合計'] += periodData.出金方法['仮想通貨'];
    }
  });
  
  return hasData ? cryptoTotals : null;
}

// ========== プロバイダー/ゲーム別データ集計 ==========
function aggregateProviderData(businessName) {
  const business = BUSINESSES[businessName];
  if (!business || !business.data) return null;
  
  const periods = Object.keys(business.data);
  const providerTotals = {};
  let hasData = false;
  
  periods.forEach(period => {
    const periodData = business.data[period];
    
    // ゲーム別データ
    if (periodData?.ゲーム別) {
      hasData = true;
      Object.entries(periodData.ゲーム別).forEach(([game, stats]) => {
        if (!providerTotals[game]) {
          providerTotals[game] = { ユーザー数: 0, TO: 0, GGR: 0, periodCount: 0 };
        }
        providerTotals[game].ユーザー数 += stats.ユーザー数 || 0;
        providerTotals[game].TO += stats.TO || 0;
        providerTotals[game].GGR += stats.GGR || 0;
        providerTotals[game].periodCount++;
      });
    }
  });
  
  return hasData ? providerTotals : null;
}

// ========== 表示モード切替 ==========
function setViewMode(mode) {
  viewMode = mode;
  document.getElementById('view-period').classList.toggle('active', mode === 'period');
  document.getElementById('view-total').classList.toggle('active', mode === 'total');
  
  if (mode === 'total') {
    document.getElementById('period-selector').classList.add('hidden');
    document.getElementById('totals-section').classList.remove('hidden');
    renderTotalsSection();
  } else {
    document.getElementById('period-selector').classList.remove('hidden');
    document.getElementById('totals-section').classList.add('hidden');
  }
  
  renderSummary();
  renderCryptoSection();
  renderProviderSection();
}

// ========== トータル・平均セクション描画 ==========
function renderTotalsSection() {
  const container = document.getElementById('totals-grid');
  const result = calculateTotalsAndAverages(currentBusiness);
  
  if (!result) {
    container.innerHTML = '<p style="opacity:0.7">データがありません</p>';
    return;
  }
  
  const business = BUSINESSES[currentBusiness];
  const type = business?.type || 'samExcel';
  
  let metrics = [];
  if (type === 'samExcel') {
    metrics = [
      { key: 'T/O', label: 'T/O', type: 'total' },
      { key: 'GGR(WIN/LOSE)', alt: ['GGR','WIN/LOSE'], label: 'GGR', type: 'total' },
      { key: 'NGR', label: 'NGR', type: 'total' },
      { key: '回収金額', label: '回収金額', type: 'total' },
      { key: '出金金額', label: '出金金額', type: 'total' },
      { key: '合計経費', label: '経費', type: 'total' },
      { key: '利益', label: '利益', type: 'total' },
      { key: 'RTP', label: 'RTP', type: 'avg', format: 'percent' },
      { key: '回収率(全体)', label: '回収率', type: 'avg', format: 'percent' },
      { key: 'FTD数', label: 'FTD数', type: 'total', format: 'number' },
      { key: 'LINE登録数', label: 'LINE登録', type: 'total', format: 'number' },
      { key: 'プロバイダーフィー', label: 'プロバイダーフィー', type: 'total' },
    ];
  } else if (type === 'sloten') {
    metrics = [
      { key: 'GGR', label: 'GGR', type: 'total' },
      { key: '総入金額', label: '総入金額', type: 'total' },
      { key: '総出金額', label: '総出金額', type: 'total' },
      { key: '入出金差分', label: '入出金差分', type: 'total' },
      { key: '登録人数', label: '登録人数', type: 'total', format: 'number' },
      { key: 'RTP', label: 'RTP', type: 'avg', format: 'percent' },
    ];
  }
  
  container.innerHTML = `
    <div class="total-card" style="grid-column: span 2;">
      <h4>📅 対象期間数</h4>
      <div class="main-val">${result.periodCount}期間</div>
    </div>
  ` + metrics.map(m => {
    let totalVal = result.totals[m.key];
    let avgVal = result.averages[m.key];
    
    if ((totalVal == null || isNaN(totalVal)) && m.alt) {
      for (const k of m.alt) {
        if (result.totals[k] != null) {
          totalVal = result.totals[k];
          avgVal = result.averages[k];
          break;
        }
      }
    }
    
    if (totalVal == null || isNaN(totalVal)) return '';
    
    let formattedTotal, formattedAvg;
    if (m.format === 'percent') {
      formattedTotal = '-';
      formattedAvg = formatPercent(avgVal);
    } else if (m.format === 'number') {
      formattedTotal = formatNumber(totalVal);
      formattedAvg = formatNumber(avgVal);
    } else {
      formattedTotal = formatCurrency(totalVal);
      formattedAvg = formatCurrency(avgVal);
    }
    
    return `
      <div class="total-card">
        <h4>${m.label}</h4>
        <div class="main-val">${m.type === 'total' ? formattedTotal : formattedAvg}</div>
        <div class="sub-val">${m.type === 'total' ? '平均: ' + formattedAvg : 'トータル: ' + formattedTotal}</div>
      </div>
    `;
  }).join('');
}

// ========== 仮想通貨セクション描画 ==========
function renderCryptoSection() {
  const section = document.getElementById('crypto-section');
  const container = document.getElementById('crypto-grid');
  
  const cryptoData = aggregateCryptoData(currentBusiness);
  
  // 期間データの仮想通貨も確認
  const business = BUSINESSES[currentBusiness];
  const periodData = business?.data?.[currentPeriod];
  const hasPeriodCrypto = periodData?.仮想通貨詳細 || periodData?.入金方法?.['仮想通貨'] || periodData?.出金方法?.['仮想通貨'];
  
  if (!cryptoData && !hasPeriodCrypto) {
    section.classList.add('hidden');
    return;
  }
  
  section.classList.remove('hidden');
  
  // 表示するデータを選択（期間別 or トータル）
  let displayData = viewMode === 'total' ? cryptoData : null;
  
  if (viewMode === 'period' && periodData) {
    displayData = { 入金: {}, 出金: {} };
    if (periodData.仮想通貨詳細) {
      displayData = periodData.仮想通貨詳細;
    } else {
      if (periodData.入金方法?.['仮想通貨']) {
        displayData.入金['仮想通貨合計'] = periodData.入金方法['仮想通貨'];
      }
      if (periodData.出金方法?.['仮想通貨']) {
        displayData.出金['仮想通貨合計'] = periodData.出金方法['仮想通貨'];
      }
    }
  }
  
  if (!displayData) {
    section.classList.add('hidden');
    return;
  }
  
  let html = '';
  
  // 入金
  const depositCoins = Object.entries(displayData.入金 || {}).filter(([k, v]) => v > 0);
  const depositTotal = depositCoins.reduce((sum, [k, v]) => sum + v, 0);
  
  if (depositCoins.length > 0) {
    html += `<div class="crypto-card" style="grid-column: span 2;background:#dcfce7;"><h5>💰 入金（仮想通貨）</h5><div class="crypto-val">${formatCurrency(depositTotal)}</div></div>`;
    depositCoins.forEach(([coin, val]) => {
      const pct = depositTotal > 0 ? (val / depositTotal * 100).toFixed(1) : 0;
      html += `<div class="crypto-card"><h5>${coin}</h5><div class="crypto-val">${formatCurrency(val)}</div><div class="crypto-pct">${pct}%</div></div>`;
    });
  }
  
  // 出金
  const withdrawCoins = Object.entries(displayData.出金 || {}).filter(([k, v]) => v > 0);
  const withdrawTotal = withdrawCoins.reduce((sum, [k, v]) => sum + v, 0);
  
  if (withdrawCoins.length > 0) {
    html += `<div class="crypto-card" style="grid-column: span 2;background:#fee2e2;"><h5>💸 出金（仮想通貨）</h5><div class="crypto-val">${formatCurrency(withdrawTotal)}</div></div>`;
    withdrawCoins.forEach(([coin, val]) => {
      const pct = withdrawTotal > 0 ? (val / withdrawTotal * 100).toFixed(1) : 0;
      html += `<div class="crypto-card"><h5>${coin}</h5><div class="crypto-val">${formatCurrency(val)}</div><div class="crypto-pct">${pct}%</div></div>`;
    });
  }
  
  container.innerHTML = html || '<p>仮想通貨データなし</p>';
}

// ========== プロバイダーセクション描画 ==========
function renderProviderSection() {
  const section = document.getElementById('provider-section');
  const container = document.getElementById('provider-grid');
  
  const business = BUSINESSES[currentBusiness];
  const periodData = business?.data?.[currentPeriod];
  
  // トータル表示の場合
  if (viewMode === 'total') {
    const providerData = aggregateProviderData(currentBusiness);
    if (!providerData || Object.keys(providerData).length === 0) {
      section.classList.add('hidden');
      return;
    }
    section.classList.remove('hidden');
    
    container.innerHTML = Object.entries(providerData).map(([game, stats]) => `
      <div class="provider-card">
        <h5>🎮 ${game}</h5>
        <div class="provider-stats">
          <div class="stat-item"><div class="stat-label">ユーザー数</div><div class="stat-val">${formatNumber(stats.ユーザー数)}</div></div>
          <div class="stat-item"><div class="stat-label">T/O</div><div class="stat-val">${formatCurrency(stats.TO)}</div></div>
          <div class="stat-item"><div class="stat-label">GGR</div><div class="stat-val">${formatCurrency(stats.GGR)}</div></div>
          <div class="stat-item"><div class="stat-label">平均GGR</div><div class="stat-val">${formatCurrency(stats.GGR / stats.periodCount)}</div></div>
        </div>
      </div>
    `).join('');
    return;
  }
  
  // 期間別表示の場合
  if (!periodData?.ゲーム別 || Object.keys(periodData.ゲーム別).length === 0) {
    section.classList.add('hidden');
    return;
  }
  
  section.classList.remove('hidden');
  const games = periodData.ゲーム別;
  
  container.innerHTML = Object.entries(games).map(([game, stats]) => `
    <div class="provider-card">
      <h5>🎮 ${game}</h5>
      <div class="provider-stats">
        <div class="stat-item"><div class="stat-label">ユーザー数</div><div class="stat-val">${formatNumber(stats.ユーザー数)}</div></div>
        <div class="stat-item"><div class="stat-label">T/O</div><div class="stat-val">${formatCurrency(stats.TO)}</div></div>
        <div class="stat-item"><div class="stat-label">GGR</div><div class="stat-val">${formatCurrency(stats.GGR)}</div></div>
        <div class="stat-item"><div class="stat-label">RTP</div><div class="stat-val">${stats.TO > 0 ? formatPercent((stats.TO - stats.GGR) / stats.TO) : '-'}</div></div>
      </div>
    </div>
  `).join('');
}

// ========== 既存の関数群 ==========
function getBinIdFromURL() { return new URLSearchParams(window.location.search).get('bin') || ''; }
function setBinIdToURL(binId) { const url = new URL(window.location.href); url.searchParams.set('bin', binId); window.history.replaceState({}, '', url); }
function updateSyncStatus(msg, isError = false) { const el = document.getElementById('sync-status'); el.textContent = isError ? '⚠️ ' + msg : '💾 ' + msg; el.style.color = isError ? '#ef4444' : '#10b981'; }

async function createNewBin() {
  try {
    updateSyncStatus('作成中...');
    const res = await fetch(NPOINT_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ businesses: {}, created: new Date().toISOString() }) });
    const url = res.url; const binId = url.split('/').pop();
    if (binId && binId.length > 5) { NPOINT_BIN_ID = binId; cloudEnabled = true; setBinIdToURL(binId); updateSyncStatus('作成完了！'); showShareURL(); return binId; }
  } catch (e) { console.warn('Bin creation error:', e); updateSyncStatus('作成エラー', true); }
  return null;
}

function showShareURL() {
  const shareUrl = window.location.href;
  if (confirm(`✅ 共有リンクが作成されました！\n\n${shareUrl}\n\nこのURLを共有すると、全員が同じデータを見れます。\n\nコピーしますか？`)) {
    navigator.clipboard.writeText(shareUrl).then(() => alert('URLをコピーしました！')).catch(() => prompt('以下のURLをコピーしてください:', shareUrl));
  }
}

async function createShareLink() { if (cloudEnabled) showShareURL(); else { const binId = await createNewBin(); if (binId) await saveToCloud(); } }
async function loadCloudData() { if (!NPOINT_BIN_ID) return {}; try { const res = await fetch(NPOINT_API + NPOINT_BIN_ID); if (!res.ok) throw new Error('Load failed'); const data = await res.json(); return data.businesses || {}; } catch (e) { console.warn('Cloud load error:', e); return {}; } }

async function saveToCloud() {
  if (!NPOINT_BIN_ID) return;
  try {
    const toSave = {};
    Object.keys(BUSINESSES).forEach(key => {
      const biz = BUSINESSES[key]; const def = DEFAULT_BUSINESSES[key];
      if (!def) { toSave[key] = biz; }
      else { const newPeriods = {}; Object.keys(biz.data).forEach(period => { if (!def.data[period]) newPeriods[period] = biz.data[period]; }); if (Object.keys(newPeriods).length > 0) toSave[key] = { data: newPeriods, type: biz.type }; }
    });
    await fetch(NPOINT_API + NPOINT_BIN_ID, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ businesses: toSave, lastUpdate: new Date().toISOString() }) });
    updateSyncStatus('保存完了 ✓');
  } catch (e) { console.warn('Cloud save error:', e); updateSyncStatus('保存エラー', true); }
}

async function clearCloudData() { if (!NPOINT_BIN_ID) return; try { await fetch(NPOINT_API + NPOINT_BIN_ID, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ businesses: {}, lastUpdate: new Date().toISOString() }) }); } catch (e) { console.warn('Cloud clear error:', e); } }

function mergeWithDefault(cloudData) {
  const merged = JSON.parse(JSON.stringify(DEFAULT_BUSINESSES));
  Object.keys(cloudData).forEach(key => { if (merged[key]) { merged[key].data = { ...merged[key].data, ...(cloudData[key].data || {}) }; merged[key].type = cloudData[key].type || merged[key].type; } else merged[key] = cloudData[key]; });
  return merged;
}

function saveBusinessData() {
  if (cloudEnabled) { updateSyncStatus('保存中...'); saveToCloud(); }
  try { const backup = {}; Object.keys(BUSINESSES).forEach(k => { const def = DEFAULT_BUSINESSES[k]; if (!def) backup[k] = BUSINESSES[k]; else { const newPeriods = {}; Object.keys(BUSINESSES[k].data).forEach(p => { if (!def.data[p]) newPeriods[p] = BUSINESSES[k].data[p]; }); if (Object.keys(newPeriods).length > 0) backup[k] = { data: newPeriods, type: BUSINESSES[k].type }; } }); localStorage.setItem('dashboard_backup', JSON.stringify(backup)); } catch (e) {}
}

async function clearAllData() { if (confirm('全データを削除しますか？\n（初期データは残ります）')) { if (cloudEnabled) await clearCloudData(); localStorage.removeItem('dashboard_backup'); location.reload(); } }

async function initializeData() {
  NPOINT_BIN_ID = getBinIdFromURL(); cloudEnabled = !!NPOINT_BIN_ID;
  if (cloudEnabled) { try { updateSyncStatus('読み込み中...'); const cloudData = await loadCloudData(); BUSINESSES = mergeWithDefault(cloudData); updateSyncStatus('クラウド同期中'); } catch (e) { console.warn('Init error:', e); updateSyncStatus('接続エラー', true); } }
  else { try { const backup = localStorage.getItem('dashboard_backup'); if (backup) { const parsed = JSON.parse(backup); Object.keys(parsed).forEach(key => { if (BUSINESSES[key]) BUSINESSES[key].data = { ...BUSINESSES[key].data, ...parsed[key].data }; else BUSINESSES[key] = parsed[key]; }); } } catch (e) {} updateSyncStatus('ローカル'); }
  selectBusiness(currentBusiness);
}

document.addEventListener('DOMContentLoaded', () => { initializeData(); renderTabs(); setupDragDrop(); });

function renderTabs() {
  const container = document.getElementById('business-tabs');
  container.innerHTML = Object.keys(BUSINESSES).map(name => `<button class="tab ${name === currentBusiness ? 'active' : ''}" onclick="selectBusiness('${name}')">${name}</button>`).join('') + '<button class="btn btn-danger" onclick="deleteBusiness()" style="margin-left:auto">🗑️</button>';
}

function selectBusiness(name) {
  currentBusiness = name;
  const business = BUSINESSES[name];
  const data = business?.data || {};
  const periods = sortPeriods(Object.keys(data));
  currentPeriod = periods[0] || null;
  renderTabs();
  renderPeriodSelector(periods);
  if (viewMode === 'total') renderTotalsSection();
  renderSummary();
  renderKPISections();
  renderCryptoSection();
  renderProviderSection();
  renderChart();
  renderLinks();
  renderTable();
}

function renderPeriodSelector(periods) {
  const container = document.getElementById('period-selector');
  if (periods.length === 0) { container.innerHTML = '<span style="color:#94a3b8;font-size:13px">データをアップロードしてください</span>'; return; }
  container.innerHTML = periods.map(p => `<button class="period-btn ${p === currentPeriod ? 'active' : ''}" onclick="selectPeriod('${p}')">${p}</button>`).join('') + `<button class="btn btn-danger" style="padding:4px 10px;font-size:11px" onclick="deletePeriod()">期間削除</button>`;
}

function selectPeriod(period) {
  currentPeriod = period;
  const periods = sortPeriods(Object.keys(BUSINESSES[currentBusiness]?.data || {}));
  renderPeriodSelector(periods);
  renderSummary();
  renderKPISections();
  renderCryptoSection();
  renderProviderSection();
  renderTable();
}

function deletePeriod() {
  const business = BUSINESSES[currentBusiness];
  const periods = Object.keys(business?.data || {});
  if (periods.length <= 1) { alert('最後の期間は削除できません'); return; }
  if (confirm(`「${currentPeriod}」を削除しますか？`)) { delete business.data[currentPeriod]; saveBusinessData(); selectBusiness(currentBusiness); }
}

// ========== サマリー ==========
function renderSummary() {
  const container = document.getElementById('summary-section');
  const business = BUSINESSES[currentBusiness];
  
  if (!business) { container.innerHTML = '<div class="card" style="text-align:center;padding:40px;color:#94a3b8">事業を選択してください</div>'; return; }
  
  let data;
  if (viewMode === 'total') {
    const result = calculateTotalsAndAverages(currentBusiness);
    if (!result) { container.innerHTML = ''; return; }
    data = result.totals;
  } else {
    const periodData = business.data?.[currentPeriod];
    data = periodData?.サマリー || periodData || {};
  }
  
  if (!data || Object.keys(data).length === 0) { container.innerHTML = '<div class="card" style="text-align:center;padding:40px;color:#94a3b8">データがありません</div>'; return; }
  
  const type = business.type || 'samExcel';
  const colors = ['linear-gradient(135deg,#3b82f6,#1d4ed8)','linear-gradient(135deg,#10b981,#059669)','linear-gradient(135deg,#f59e0b,#d97706)','linear-gradient(135deg,#ef4444,#dc2626)','linear-gradient(135deg,#8b5cf6,#7c3aed)','linear-gradient(135deg,#ec4899,#db2777)','linear-gradient(135deg,#06b6d4,#0891b2)','linear-gradient(135deg,#84cc16,#65a30d)'];
  
  let cards = [];
  if (type === 'samExcel') cards = [{ key: 'T/O', label: 'T/O' },{ key: 'GGR(WIN/LOSE)', alt: ['GGR','WIN/LOSE'], label: 'GGR' },{ key: 'NGR', label: 'NGR' },{ key: '回収率(全体)', alt: ['回収率'], label: '回収率', format: 'percent' },{ key: 'GGR(回収金額-出金金額)', label: '入出金差分' }];
  else if (type === 'sloten') cards = [{ key: 'GGR', label: 'GGR' },{ key: '総入金額', label: '総入金額' },{ key: '総出金額', label: '総出金額' },{ key: '入出金差分', label: '入出金差分' },{ key: 'RTP', label: 'RTP', format: 'percent' },{ key: '登録人数', label: '登録人数', format: 'number' }];
  else if (type === 'ads') cards = [{ key: 'コスト(円)', label: 'コスト', format: 'currency' },{ key: 'インプレッション合計', alt: ['インプレッション'], label: 'IMP', format: 'number' },{ key: 'クリック合計', alt: ['クリック'], label: 'クリック', format: 'number' },{ key: 'CTR', label: 'CTR', format: 'percent' },{ key: '登録合計', alt: ['登録数'], label: '登録', format: 'number' },{ key: '入金合計', alt: ['入金数'], label: '入金', format: 'number' },{ key: 'CVR', label: 'CVR', format: 'percent' },{ key: 'CPA(円)', label: 'CPA', format: 'currency' }];
  else if (type === 'agent') cards = [{ key: '入金合計', label: '入金合計' },{ key: '出金合計', label: '出金合計' },{ key: '収益合計', label: '収益合計' },{ key: 'ローリング報酬', label: 'ローリング報酬' },{ key: 'NGR', label: 'NGR' },{ key: 'T/O合計', label: 'T/O合計' }];
  else if (type === 'baccara') cards = [{ key: '登録数', label: '登録数', format: 'number' },{ key: '合計流入', label: '合計流入', format: 'number' },{ key: '総ユーザー数', label: '総ユーザー', format: 'number' },{ key: '総入金額', label: '総入金額' },{ key: '総GGR', label: '総GGR' },{ key: 'コスト', label: 'コスト' },{ key: 'NGR', label: 'NGR' }];
  
  container.innerHTML = '<div class="summary-grid">' + cards.map((card, i) => {
    let val = data[card.key];
    if (val == null && card.alt) { for (const k of card.alt) { if (data[k] != null) { val = data[k]; break; } } }
    if (val == null) return '';
    let formatted;
    if (card.format === 'percent') formatted = formatPercent(val);
    else if (card.format === 'number') formatted = formatNumber(val);
    else if (card.format === 'usd') formatted = '$' + (val || 0).toFixed(2);
    else if (card.format === 'currency') formatted = formatCurrency(val);
    else formatted = formatCurrency(val);
    const bg = val < 0 && card.format !== 'percent' ? 'linear-gradient(135deg,#ef4444,#dc2626)' : colors[i % colors.length];
    return `<div class="summary-card" style="background:${bg}"><h3>${card.label}</h3><div class="value">${formatted}</div></div>`;
  }).join('') + '</div>';
}

// ========== KPIセクション ==========
function renderKPISections() {
  const container = document.getElementById('kpi-sections');
  const business = BUSINESSES[currentBusiness];
  if (!business) { container.innerHTML = ''; return; }
  
  const periodData = business.data?.[currentPeriod];
  const data = periodData?.サマリー || periodData || {};
  
  if (!data || Object.keys(data).length === 0) { container.innerHTML = ''; return; }
  
  const type = business.type || 'samExcel';
  if (type === 'agent' || type === 'ads' || type === 'baccara') { container.innerHTML = ''; return; }
  
  const sections = [
    { title: '📞 営業KPI', keys: ['リスト件数','登録人数','打電数','着電数','LINE登録数','アカウント作成数','ログインユーザー数'], bg: '#dbeafe' },
    { title: '🎯 転換KPI', keys: ['FTP数','FTP率','FTD数','FTD率','FTW数','FTW率','FTDW数','FTDW率','FTDのみ入金者数','今月登録のFTD以降ユーザー数','今月登録FTD以降ユーザー割合'], bg: '#dcfce7' },
    { title: '🔄 継続KPI', keys: ['前月リテンション数','引継ぎプレイヤー数','アクティブユーザー数','アクティブプレイ人数（ユニーク）','アクティブプレイ人数','今月登録のアクティブユーザー数','前月登録のアクティブユーザー数'], bg: '#fef3c7' },
    { title: '💰 収益KPI', keys: ['T/O','T/O(リアルのみ)','勝利金','勝利金(リアルのみ)','RTP','GGR(WIN/LOSE)','GGR','WIN/LOSE','LTV(WIN/LOSE)','GGRLTV'], bg: '#e0e7ff' },
    { title: '💵 回収KPI', keys: ['回収予定金額','回収金額','回収率(全体)','回収率(今月)','出金金額','GGR(回収金額-出金金額)','LTV(GGR)','NGR','総入金額','総出金額','入出金差分'], bg: '#fce7f3' },
    { title: '💸 経費KPI', keys: ['合計経費','プロバイダーフィー','人件費','通信費','インセンティブ','ペイメントフィー','雑費・福利厚生等','BK','利益'], bg: '#ccfbf1' },
  ];
  
  const percentKeys = ['FTP率','FTD率','FTW率','FTDW率','RTP','回収率(全体)','回収率(今月)','今月登録FTD以降ユーザー割合'];
  const currencyKeys = ['T/O','T/O(リアルのみ)','勝利金','勝利金(リアルのみ)','GGR(WIN/LOSE)','GGR','WIN/LOSE','LTV(WIN/LOSE)','回収予定金額','回収金額','出金金額','GGR(回収金額-出金金額)','LTV(GGR)','NGR','合計経費','プロバイダーフィー','人件費','通信費','インセンティブ','ペイメントフィー','雑費・福利厚生等','BK','利益','総入金額','総出金額','入出金差分','GGRLTV'];
  
  container.innerHTML = sections.map(section => {
    const items = section.keys.filter(k => data[k] != null);
    if (items.length === 0) return '';
    return `<div class="card" style="background:${section.bg}"><div class="section-title">${section.title}</div><div class="kpi-grid">${items.map(key => {
      const val = data[key];
      let formatted;
      if (percentKeys.includes(key)) formatted = formatPercent(val);
      else if (currencyKeys.includes(key)) formatted = formatCurrency(val);
      else formatted = formatNumber(val);
      const isNeg = typeof val === 'number' && val < 0;
      return `<div class="kpi-item"><div class="label">${key}</div><div class="val ${isNeg ? 'negative' : ''}">${formatted}</div></div>`;
    }).join('')}</div></div>`;
  }).join('');
  
  // 入金/出金方法、Affiliateの表示
  if (periodData?.入金方法) {
    const dep = periodData.入金方法;
    container.innerHTML += `<div class="card" style="background:#e0f2fe"><div class="section-title">💳 入金方法</div><div class="kpi-grid">${Object.entries(dep).map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatCurrency(v)}</div></div>`).join('')}</div></div>`;
  }
  if (periodData?.出金方法) {
    const wd = periodData.出金方法;
    container.innerHTML += `<div class="card" style="background:#fef9c3"><div class="section-title">🏦 出金方法</div><div class="kpi-grid">${Object.entries(wd).map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatCurrency(v)}</div></div>`).join('')}</div></div>`;
  }
  if (periodData?.Affiliate) {
    const aff = periodData.Affiliate;
    container.innerHTML += `<div class="card" style="background:#ecfdf5"><div class="section-title">🤝 Affiliate</div><div class="kpi-grid">${Object.entries(aff).map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${k.includes('率') ? formatPercent(v) : k.includes('数') ? formatNumber(v) : formatCurrency(v)}</div></div>`).join('')}</div></div>`;
  }
}

// ========== チャート ==========
function renderChart() {
  const ctx = document.getElementById('main-chart').getContext('2d');
  const business = BUSINESSES[currentBusiness];
  if (!business) { if (chartInstance) chartInstance.destroy(); return; }
  
  const data = business.data || {};
  const periods = sortPeriods(Object.keys(data)).reverse().slice(-12);
  
  if (chartInstance) chartInstance.destroy();
  if (periods.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); return; }
  
  const type = business.type || 'samExcel';
  let datasets = [];
  
  if (type === 'samExcel') {
    datasets = [
      { label: 'GGR', data: periods.map(p => { const d = data[p]?.サマリー || data[p] || {}; return d['GGR(WIN/LOSE)'] || d['GGR'] || d['WIN/LOSE'] || 0; }), backgroundColor: 'rgba(59,130,246,0.7)' },
      { label: 'NGR', data: periods.map(p => (data[p]?.サマリー?.['NGR'] || data[p]?.['NGR'] || 0)), backgroundColor: 'rgba(16,185,129,0.7)' }
    ];
  } else if (type === 'sloten') {
    datasets = [
      { label: 'GGR', data: periods.map(p => (data[p]?.サマリー?.['GGR'] || data[p]?.['GGR'] || 0)), backgroundColor: 'rgba(59,130,246,0.7)' },
      { label: '入出金差分', data: periods.map(p => (data[p]?.サマリー?.['入出金差分'] || data[p]?.['入出金差分'] || 0)), backgroundColor: 'rgba(16,185,129,0.7)' }
    ];
  } else {
    datasets = [{ label: 'GGR', data: periods.map(p => (data[p]?.サマリー?.['総GGR'] || data[p]?.サマリー?.['GGR'] || 0)), backgroundColor: 'rgba(59,130,246,0.7)' }];
  }
  
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: { labels: periods, datasets },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '¥' + (v / 1000000).toFixed(0) + 'M' } } } }
  });
}

// ========== リンク ==========
function renderLinks() {
  const section = document.getElementById('links-section');
  section.classList.add('hidden');
}

// ========== テーブル ==========
function renderTable() {
  const business = BUSINESSES[currentBusiness];
  const periodData = business?.data?.[currentPeriod];
  const data = periodData?.サマリー || periodData || {};
  const header = document.getElementById('table-header');
  const body = document.getElementById('table-body');
  
  header.innerHTML = '<th>項目</th><th class="text-right">値</th>';
  
  const percentKeys = ['FTP率','FTD率','FTW率','FTDW率','RTP','回収率(全体)','回収率(今月)','今月登録FTD以降ユーザー割合','ボーナス割合(GGR)','ボーナス割合(T/O)','ボーナス割合(WIN/LOSE)'];
  const currencyKeys = ['T/O','T/O(リアルのみ)','勝利金','勝利金(リアルのみ)','GGR(WIN/LOSE)','GGR','WIN/LOSE','LTV(WIN/LOSE)','回収予定金額','回収金額','出金金額','GGR(回収金額-出金金額)','LTV(GGR)','NGR','合計経費','プロバイダーフィー','人件費','通信費','インセンティブ','ペイメントフィー','雑費・福利厚生等','BK','利益','総入金額','総出金額','入出金差分','GGRLTV'];
  
  body.innerHTML = Object.entries(data).map(([key, value]) => {
    if (value === null || value === undefined) return '';
    let formatted;
    if (percentKeys.includes(key)) formatted = formatPercent(value);
    else if (currencyKeys.includes(key)) formatted = formatCurrency(value);
    else if (typeof value === 'number') formatted = formatNumber(value);
    else formatted = String(value);
    const isNeg = typeof value === 'number' && value < 0;
    return `<tr><td>${key}</td><td class="text-right ${isNeg ? 'text-red' : ''}">${formatted}</td></tr>`;
  }).join('');
}

// ========== モーダル ==========
function showUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); document.getElementById('upload-status').style.display = 'none'; }
function hideUploadModal() { document.getElementById('upload-modal').classList.add('hidden'); }
function showAddBusinessModal() { document.getElementById('add-business-modal').classList.remove('hidden'); }
function hideAddBusinessModal() { document.getElementById('add-business-modal').classList.add('hidden'); }

function setupDragDrop() {
  const zone = document.getElementById('upload-zone');
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('dragover'); if (e.dataTransfer.files[0]) handleFileUpload(e.dataTransfer.files[0]); });
}

function showStatus(msg, isError = false) {
  const s = document.getElementById('upload-status');
  s.style.display = 'block';
  s.style.background = isError ? '#fee2e2' : '#dcfce7';
  s.style.color = isError ? '#dc2626' : '#16a34a';
  s.textContent = msg;
}

// ========== ファイルアップロード ==========
function handleFileUpload(file) {
  if (!file) return;
  const period = document.getElementById('upload-period').value || new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' }).replace(' ', '');
  const uploadType = document.getElementById('upload-type').value;
  const reader = new FileReader();
  
  if (file.name.endsWith('.zip')) { showStatus('ZIPファイルは対応していません。解凍してから個別のファイルをアップロードしてください。', true); return; }
  
  reader.onload = function(e) {
    try {
      if (file.name.endsWith('.csv')) handleCSV(e.target.result, period, uploadType, file.name);
      else { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); handleExcel(workbook, period, uploadType, file.name); }
    } catch (err) { showStatus('エラー: ' + err.message, true); }
  };
  
  if (file.name.endsWith('.csv')) reader.readAsText(file, 'UTF-8');
  else reader.readAsArrayBuffer(file);
}

function handleCSV(text, period, uploadType, filename) {
  const parseCSVLine = (line) => { const result = []; let current = ''; let inQuotes = false; for (let i = 0; i < line.length; i++) { const c = line[i]; if (c === '"') inQuotes = !inQuotes; else if (c === ',' && !inQuotes) { result.push(current.trim().replace(/^"|"$/g, '')); current = ''; } else current += c; } result.push(current.trim().replace(/^"|"$/g, '')); return result; };
  const lines = text.replace(/\r\n/g, '\n').split('\n').filter(l => l.trim()).map(l => parseCSVLine(l));
  if (lines.length < 2) { showStatus('CSVにデータがありません', true); return; }
  
  const headerStr = lines[0].join(',').toLowerCase();
  const fn = filename.toLowerCase();
  
  const isSloten = fn.includes('スロ天') || fn.includes('kpi') || (headerStr.includes('項目名') && headerStr.includes('月次合計'));
  
  if (uploadType === 'auto') { if (isSloten) { parseSlotenCSV(lines, period, fn); return; } }
  if (uploadType === 'sloten') { parseSlotenCSV(lines, period, fn); return; }
  
  showStatus('CSVの形式を判別できませんでした', true);
}

function parseSlotenCSV(lines, period, filename) {
  const header = lines[0];
  let valueColIdx = header.findIndex(h => String(h).includes('月次合計'));
  if (valueColIdx < 0) valueColIdx = 1;
  
  const kpi = {};
  lines.slice(1).forEach(row => { if (!row[0]) return; const key = String(row[0]).trim(); const val = parseNumber(row[valueColIdx]); if (key && val !== null) kpi[key] = val; });
  
  BUSINESSES['スロ天'].data[period] = { サマリー: kpi };
  showStatus(`スロ天KPI取込完了: ${Object.keys(kpi).length}項目`);
  selectBusiness('スロ天');
  saveBusinessData();
  setTimeout(hideUploadModal, 1500);
}

function handleExcel(workbook, period, uploadType, filename) {
  const sheetNames = workbook.SheetNames;
  const fn = filename.toLowerCase();
  
  const revenueSheets = sheetNames.filter(n => n.includes('収益'));
  if (revenueSheets.length > 0 && (uploadType === 'auto' || uploadType === 'samExcel')) { parseSamExcel(workbook, revenueSheets); return; }
  
  parseGenericExcel(workbook, period);
}

function parseSamExcel(workbook, revenueSheets) {
  let amuseCount = 0, dscCount = 0;
  
  revenueSheets.forEach(sheetName => {
    const sheet = workbook.Sheets[sheetName];
    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    const isDSC = sheetName.endsWith('D');
    let periodName = sheetName.replace('収益', '').replace(/D$/, '');
    
    const extracted = {};
    data.forEach(row => {
      if (row[1] && row[2] !== undefined && row[2] !== null && row[2] !== '') { const key = String(row[1]).trim().replace(/（/g, '(').replace(/）/g, ')'); const val = parseNumber(row[2]); if (val !== null && !String(row[2]).startsWith('#') && !key.startsWith('0.')) extracted[key] = val; }
      if (row[3] && row[4] !== undefined && row[4] !== null && row[4] !== '') { const key = String(row[3]).trim().replace(/（/g, '(').replace(/）/g, ')'); const val = parseNumber(row[4]); if (val !== null && !String(row[4]).startsWith('#') && !key.startsWith('0.')) extracted[key] = val; }
    });
    
    if (Object.keys(extracted).length > 0) {
      if (isDSC) { BUSINESSES['DSC'].data[periodName] = { サマリー: extracted }; dscCount++; }
      else { BUSINESSES['元amuse'].data[periodName] = { サマリー: extracted }; amuseCount++; }
    }
  });
  
  showStatus(`収益シート取込完了: 元amuse ${amuseCount}件, DSC ${dscCount}件`);
  if (dscCount > 0) selectBusiness('DSC');
  else selectBusiness('元amuse');
  saveBusinessData();
  setTimeout(hideUploadModal, 1500);
}

function parseGenericExcel(workbook, period) {
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
  
  const kpi = {};
  data.forEach(row => { if (!row || row.length < 2) return; const label = String(row[0] || '').trim(); const val = parseNumber(row[1]); if (label && val !== null) kpi[label] = val; });
  
  BUSINESSES[currentBusiness].data[period] = { サマリー: kpi };
  showStatus(`Excel取込完了: ${Object.keys(kpi).length}項目`);
  selectBusiness(currentBusiness);
  saveBusinessData();
  setTimeout(hideUploadModal, 1500);
}

// ========== 事業追加・削除 ==========
function addBusiness() {
  const name = document.getElementById('new-business-name').value.trim();
  const type = document.getElementById('new-business-type').value;
  if (!name) { alert('事業名を入力してください'); return; }
  if (BUSINESSES[name]) { alert('同名の事業が存在します'); return; }
  BUSINESSES[name] = { data: {}, type: type };
  saveBusinessData();
  hideAddBusinessModal();
  selectBusiness(name);
}

function deleteBusiness() {
  if (Object.keys(BUSINESSES).length <= 1) { alert('最後の事業は削除できません'); return; }
  if (confirm(`「${currentBusiness}」を削除しますか？`)) { delete BUSINESSES[currentBusiness]; saveBusinessData(); selectBusiness(Object.keys(BUSINESSES)[0]); }
}
</script>
</body>
</html>
