<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>事業別ダッシュボード v7 - Konibet対応</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f1f5f9;min-height:100vh}
.container{max-width:1400px;margin:0 auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.header h1{font-size:24px;color:#1e293b}
.header-actions{display:flex;gap:10px;flex-wrap:wrap}
.card{background:white;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:20px;margin-bottom:20px}
.tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.tab{padding:10px 18px;border-radius:10px;border:none;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;background:#e2e8f0;color:#475569}
.tab:hover{background:#cbd5e1}
.tab.active{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white}
.btn{padding:10px 20px;border-radius:10px;border:none;cursor:pointer;font-weight:600;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white}
.btn-secondary{background:#f1f5f9;color:#475569}
.btn-danger{background:#fee2e2;color:#dc2626}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.summary-card{border-radius:12px;padding:14px;color:white;background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
.summary-card h3{font-size:10px;opacity:0.9;margin-bottom:4px;text-transform:uppercase}
.summary-card .value{font-size:18px;font-weight:700}
.chart-container{height:300px;margin:20px 0}
.pie-chart-container{height:250px;max-width:300px}
.period-selector{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.period-btn{padding:6px 14px;border-radius:8px;border:none;cursor:pointer;font-size:12px;background:#f1f5f9;color:#64748b;transition:all 0.2s}
.period-btn.active{background:#3b82f6;color:white}
.period-btn:hover{background:#e2e8f0}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:white;border-radius:16px;padding:30px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
.upload-zone{border:2px dashed #cbd5e1;border-radius:12px;padding:40px;text-align:center;cursor:pointer;transition:all 0.2s}
.upload-zone:hover,.upload-zone.dragover{border-color:#3b82f6;background:#eff6ff}
.hidden{display:none!important}
.table-container{overflow-x:auto;max-height:500px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:8px 10px;text-align:left;border-bottom:1px solid #e2e8f0}
th{background:#f8fafc;font-weight:600;color:#64748b;position:sticky;top:0}
tr:hover{background:#f8fafc}
.text-right{text-align:right}
.text-green{color:#16a34a}
.text-red{color:#dc2626}
input,select{padding:10px 14px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;width:100%}
input:focus,select:focus{outline:none;border-color:#3b82f6}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;color:#64748b;margin-bottom:6px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.section-title{font-size:16px;font-weight:600;color:#1e293b;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}
.kpi-item{background:#f8fafc;border-radius:10px;padding:12px}
.kpi-item .label{font-size:10px;color:#64748b;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.kpi-item .val{font-size:16px;font-weight:700;color:#1e293b}
.kpi-item .val.negative{color:#dc2626}
footer{text-align:center;color:#94a3b8;font-size:11px;margin-top:30px;padding:20px}
.totals-section{background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.totals-section .section-title{color:white}
.totals-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
.total-card{background:rgba(255,255,255,0.1);border-radius:12px;padding:16px;backdrop-filter:blur(10px)}
.total-card h4{font-size:11px;opacity:0.8;margin-bottom:8px;text-transform:uppercase}
.total-card .main-val{font-size:22px;font-weight:700;margin-bottom:4px}
.total-card .sub-val{font-size:12px;opacity:0.7}
.crypto-section{background:linear-gradient(135deg,#1e3a5f,#2d5a87);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.crypto-section .section-title{color:white}
.crypto-flex{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start}
.crypto-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;flex:1}
.crypto-card{background:rgba(255,255,255,0.95);border-radius:10px;padding:12px;color:#1e293b}
.crypto-card h5{font-size:10px;color:#64748b;margin-bottom:4px}
.crypto-card .crypto-val{font-size:16px;font-weight:700}
.crypto-card .crypto-pct{font-size:11px;color:#64748b}
.provider-section{background:linear-gradient(135deg,#4a1d6a,#6b2d8a);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.provider-section .section-title{color:white}
.provider-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.provider-card{background:rgba(255,255,255,0.15);border-radius:10px;padding:14px;backdrop-filter:blur(10px)}
.provider-card h5{font-size:12px;margin-bottom:8px;font-weight:600}
.provider-card .provider-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px}
.provider-card .stat-item{background:rgba(255,255,255,0.1);border-radius:6px;padding:6px 8px}
.provider-card .stat-label{opacity:0.7;font-size:9px}
.provider-card .stat-val{font-weight:600}
.game-section{background:linear-gradient(135deg,#1a472a,#2d6a4f);border-radius:16px;padding:20px;margin-bottom:20px;color:white}
.game-section .section-title{color:white}
.view-toggle{display:flex;gap:8px;margin-bottom:16px}
.view-toggle .toggle-btn{padding:8px 16px;border-radius:8px;border:2px solid #e2e8f0;background:white;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s}
.view-toggle .toggle-btn.active{border-color:#3b82f6;background:#eff6ff;color:#1d4ed8}
.chart-row{display:flex;gap:20px;flex-wrap:wrap}
.chart-row .pie-wrapper{flex:0 0 280px}
.chart-row .list-wrapper{flex:1;min-width:200px}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>📊 事業別ダッシュボード v7 <span style="font-size:14px;background:#10b981;color:white;padding:2px 8px;border-radius:4px;margin-left:8px">Konibet対応</span></h1>
    <div class="header-actions">
      <span id="sync-status" style="font-size:12px;color:#10b981;margin-right:10px">💾 読込中...</span>
      <button class="btn btn-primary" onclick="showUploadModal()">📤 アップロード</button>
      <button class="btn btn-primary" onclick="showReportPromptModal()" style="background:#8b5cf6">📝 営業報告書</button>
      <button class="btn btn-secondary" onclick="createShareLink()">🔗 共有リンク</button>
      <button class="btn btn-secondary" onclick="showAddBusinessModal()">➕ 事業追加</button>
      <button class="btn btn-danger" onclick="clearAllData()">🗑️</button>
    </div>
  </div>
  <div class="tabs" id="business-tabs"></div>
  <div class="view-toggle">
    <button class="toggle-btn active" onclick="setViewMode('period')" id="view-period">📅 期間別</button>
    <button class="toggle-btn" onclick="setViewMode('total')" id="view-total">📊 全期間トータル</button>
  </div>
  <div id="period-selector" class="period-selector"></div>
  <div id="totals-section" class="totals-section hidden">
    <div class="section-title">📊 全期間トータル・平均</div>
    <div id="totals-grid" class="totals-grid"></div>
  </div>
  <div id="summary-section"></div>
  
  <div class="card">
    <div class="section-title">📈 推移グラフ</div>
    <div class="chart-container"><canvas id="main-chart"></canvas></div>
  </div>
  
  <!-- 継続KPI推移グラフ（スロ天用） -->
  <div id="retention-chart-section" class="card hidden">
    <div class="section-title">📊 継続ユーザー推移</div>
    <div class="chart-container"><canvas id="retention-chart"></canvas></div>
  </div>
  
  <div id="kpi-sections"></div>
  
  <!-- 仮想通貨銘柄別（円グラフ付き） -->
  <div id="crypto-section" class="crypto-section hidden">
    <div class="section-title">🪙 仮想通貨銘柄別</div>
    <div class="crypto-flex">
      <div class="pie-wrapper"><div class="pie-chart-container"><canvas id="crypto-pie-chart"></canvas></div></div>
      <div class="list-wrapper"><div id="crypto-grid" class="crypto-grid"></div></div>
    </div>
  </div>
  
  <!-- ゲーム種別（パチンコ・パチスロ・スロット・ライブ） -->
  <div id="game-section" class="game-section hidden">
    <div class="section-title">🎰 ゲーム種別</div>
    <div class="chart-row">
      <div class="pie-wrapper"><div class="pie-chart-container"><canvas id="game-pie-chart"></canvas></div></div>
      <div class="list-wrapper"><div id="game-grid" class="provider-grid"></div></div>
    </div>
  </div>
  
  <!-- プロバイダー別 -->
  <div id="provider-section" class="provider-section hidden">
    <div class="section-title">🏭 ゲームプロバイダー別</div>
    <div class="chart-row">
      <div class="pie-wrapper"><div class="pie-chart-container"><canvas id="provider-pie-chart"></canvas></div></div>
      <div class="list-wrapper"><div id="provider-grid" class="provider-grid"></div></div>
    </div>
  </div>
  <div id="data-table" class="card">
    <div class="section-title">📋 詳細データ</div>
    <div class="table-container">
      <table><thead><tr id="table-header"></tr></thead><tbody id="table-body"></tbody></table>
    </div>
  </div>
  <footer>収益管理ダッシュボード v7.0 | Konibet KPI対応版 | 円グラフ・プロバイダー/ゲーム種別分離対応</footer>
</div>

<div id="upload-modal" class="modal hidden">
  <div class="modal-content">
    <h3 style="margin-bottom:20px">📤 ファイルアップロード</h3>
    <div class="form-row">
      <div class="form-group"><label>期間</label><input type="text" id="upload-period" placeholder="例: 2025年10月"></div>
      <div class="form-group"><label>データ種別</label>
        <select id="upload-type" onchange="toggleExchangeRate()">
          <option value="auto">自動判別</option>
          <option value="samExcel">元amuse/DSC Excel</option>
          <option value="sloten">スロ天KPIシート</option>
          <option value="konibet">Konibet KPIシート</option>
          <option value="agent">AMUSEVIP エージェント</option>
          <option value="ads">広告データ</option>
          <option value="baccarat">バカラツール</option>
          <option value="customerList">顧客リストシート</option>
          <option value="uncollected">未回収シート</option>
          <option value="bonus">ボーナスシート</option>
          <option value="delayed">遅れ回収シート</option>
        </select>
      </div>
    </div>
    <div class="form-row" id="exchange-rate-row" style="display:none">
      <div class="form-group">
        <label>💱 為替レート (USD→JPY)</label>
        <input type="number" id="usd-jpy-rate" value="150" min="1" max="500" step="0.1" style="width:120px">
        <span style="font-size:12px;color:#64748b;margin-left:8px">※Konibet金額換算用</span>
      </div>
    </div>
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
      <div style="font-size:40px;margin-bottom:10px">📁</div>
      <p>クリックまたはドラッグ&ドロップ</p>
      <p style="font-size:12px;color:#94a3b8;margin-top:8px">.xlsx, .xls, .csv 対応</p>
    </div>
    <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileUpload(this.files[0])">
    <div id="upload-status" style="margin-top:16px;padding:12px;border-radius:8px;display:none"></div>
    <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="hideUploadModal()">閉じる</button>
    </div>
  </div>
</div>

<div id="add-business-modal" class="modal hidden">
  <div class="modal-content">
    <h3 style="margin-bottom:20px">➕ 事業追加</h3>
    <div class="form-group"><label>事業名</label><input type="text" id="new-business-name" placeholder="例: 新規事業"></div>
    <div class="form-group"><label>事業タイプ</label>
      <select id="new-business-type">
        <option value="samExcel">標準（GGR/NGR等）</option>
        <option value="sloten">スロ天形式</option>
        <option value="konibet">Konibet形式</option>
        <option value="agent">エージェント型</option>
        <option value="ads">広告型</option>
        <option value="baccara">ツール型</option>
      </select>
    </div>
    <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="hideAddBusinessModal()">キャンセル</button>
      <button class="btn btn-primary" onclick="addBusiness()">追加</button>
    </div>
  </div>
</div>

<div id="report-prompt-modal" class="modal hidden">
  <div class="modal-content" style="max-width:800px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column">
    <h3 style="margin-bottom:20px">📝 営業報告書用プロンプト</h3>
    <div style="margin-bottom:12px;display:flex;gap:10px;align-items:center">
      <span style="font-weight:600" id="report-business-period"></span>
      <button class="btn btn-primary" onclick="copyReportPrompt()" style="margin-left:auto">📋 コピー</button>
    </div>
    <textarea id="report-prompt-text" readonly style="flex:1;min-height:400px;width:100%;padding:16px;border:1px solid #e2e8f0;border-radius:8px;font-family:monospace;font-size:13px;line-height:1.6;resize:none;background:#f8fafc"></textarea>
    <div style="margin-top:16px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="hideReportPromptModal()">閉じる</button>
    </div>
  </div>
</div>

<script>
// ========== データ定義 ==========
const MOTO_AMUSE_DATA = {
  '2025年10月':{サマリー:{'リスト件数':14542,'打電数':10579,'着電数':1716,'LINE登録数':23,'アカウント作成数':141,'FTP数':82,'FTP率':0.5816,'FTD数':48,'FTD率':0.3404,'FTW数':7,'FTW率':0.0496,'FTDW数':55,'FTDW率':0.3901,'前月リテンション数':75,'引継ぎプレイヤー数':153,'アクティブユーザー数':294,'T/O':1577495817.7,'勝利金':1507184477.51,'RTP':0.9554,'GGR(WIN/LOSE)':70311340.19,'LTV(WIN/LOSE)':239154.22,'回収予定金額':71840329,'回収金額':55956778,'回収率(全体)':0.7789,'回収率(今月)':0.7476,'出金金額':17719827,'GGR(回収金額-出金金額)':38174451,'LTV(GGR)':129845.07,'プロバイダーフィー':7263554.56,'NGR':30910896.44,'総登録数':294,'総信用枠':88200000,'平均信用枠':300000,'平均Credit単価':1837500,'総ボーナス':2150000,'平均プレイ月間':4.2,'事前清算回数':45,'事前清算金額':12500000,'通常清算回数':180,'通常清算金額':43456778,'事前清算割合':0.2234,'通常清算割合':0.7766,'事前清算件数割合':0.2,'通常清算件数割合':0.8},リスト種別:{'B':272,'E':713,'T':17,'S':724,'その他':8}},
  '2025年9月':{サマリー:{'GGR(WIN/LOSE)':-2176638.6,'LINE登録数':13,'RTP':1.0383,'T/O':56770645,'リスト件数':14965,'勝利金':58947283.6,'打電数':1035,'着電数':665,'総登録数':180,'総信用枠':54000000,'平均信用枠':300000,'平均Credit単価':1800000,'総ボーナス':980000,'平均プレイ月間':3.8,'事前清算回数':28,'事前清算金額':7800000,'通常清算回数':95,'通常清算金額':22500000,'事前清算割合':0.2574,'通常清算割合':0.7426,'事前清算件数割合':0.2276,'通常清算件数割合':0.7724},リスト種別:{'B':25,'E':20,'T':18,'S':15,'BE':12,'C':10,'紹介':8,'その他':72}},
  '2025年8月':{サマリー:{'BK':7114855,'FTD数':12,'FTD率':0.2044,'FTP数':60,'FTP率':0.7676,'GGR(WIN/LOSE)':56952667,'GGR(回収金額-出金金額)':27019475,'LINE登録数':48,'LTV(GGR)':92276.37,'LTV(WIN/LOSE)':389548,'NGR':23459499,'RTP':0.9735,'T/O':1910465086,'アカウント作成数':78,'アクティブユーザー数':284,'プロバイダーフィー':3559976,'リスト件数':9997,'出金金額':13154437,'前月リテンション数':88,'勝利金':1853512419,'回収予定金額':56467301,'回収率(今月)':0.7759,'回収率(全体)':0.74,'回収金額':41786755,'引継ぎプレイヤー数':206,'打電数':9829,'着電数':3810,'総登録数':284,'総信用枠':85200000,'平均信用枠':300000,'平均Credit単価':1775000,'総ボーナス':1850000,'平均プレイ月間':4.5,'事前清算回数':52,'事前清算金額':11200000,'通常清算回数':165,'通常清算金額':30586755,'事前清算割合':0.2680,'通常清算割合':0.7320,'事前清算件数割合':0.2396,'通常清算件数割合':0.7604},リスト種別:{'B':38,'E':32,'T':25,'S':20,'BE':15,'C':12,'紹介':10,'その他':132}},
  '2025年7月':{サマリー:{'BK':1046146.65,'FTDW数':14,'FTDW率':0.209,'FTD数':11,'FTD率':0.164,'FTP数':39,'FTP率':0.582,'FTW数':3,'FTW率':0.045,'GGR(WIN/LOSE)':89408914.42,'GGR(回収金額-出金金額)':11754881.9,'LINE登録数':51,'LTV(GGR)':34271.25,'LTV(WIN/LOSE)':234669.07,'NGR':3791600.89,'RTP':0.9762,'T/O':3753649644.37,'アカウント作成数':67,'アクティブユーザー数':381,'プロバイダーフィー':7963281.01,'リスト件数':9957,'出金金額':37542660,'前月リテンション数':17,'勝利金':3664240729.95,'回収予定金額':106737904.3,'回収率(今月)':0.6686,'回収率(全体)':0.7004,'回収金額':74754327.9,'引継ぎプレイヤー数':314,'打電数':100011,'着電数':3839,'総登録数':381,'総信用枠':114300000,'平均信用枠':300000,'平均Credit単価':1890000,'総ボーナス':2450000,'平均プレイ月間':3.9,'事前清算回数':68,'事前清算金額':18500000,'通常清算回数':210,'通常清算金額':56254327,'事前清算割合':0.2474,'通常清算割合':0.7526,'事前清算件数割合':0.2446,'通常清算件数割合':0.7554},リスト種別:{'B':52,'E':45,'T':35,'S':28,'BE':22,'C':18,'紹介':15,'その他':166}},
  '2025年6月':{サマリー:{'BK':19008236.94,'GGR(WIN/LOSE)':106821992.9,'GGR(回収金額-出金金額)':79117068,'LINE登録数':367,'LTV(GGR)':113348.24,'LTV(WIN/LOSE)':153040.1,'NGR':69120861.61,'RTP':0.9716,'T/O':3764837698.76,'アクティブユーザー数':698,'プロバイダーフィー':9996206.39,'リスト件数':9884,'前月リテンション数':235,'勝利金':3658015705.86,'打電数':191066,'着電数':7980,'総登録数':698,'総信用枠':209400000,'平均信用枠':300000,'平均Credit単価':1950000,'総ボーナス':4200000,'平均プレイ月間':5.1,'事前清算回数':125,'事前清算金額':28500000,'通常清算回数':385,'通常清算金額':50617068,'事前清算割合':0.3603,'通常清算割合':0.6397,'事前清算件数割合':0.2451,'通常清算件数割合':0.7549},リスト種別:{'B':95,'E':82,'T':65,'S':52,'BE':42,'C':35,'紹介':28,'その他':299}},
  '2025年5月':{サマリー:{'BK':6910039.38,'FTDW数':119,'FTDW率':0.3766,'FTD数':110,'FTD率':0.3481,'GGR':30822400,'LINE登録数':497,'LTV(GGR)':40878.51,'LTV(WIN/LOSE)':3348.2,'NGR':21494893.73,'RTP':0.9995,'T/O':5416323482.72,'WIN/LOSE':2524541,'アカウント作成数':316,'アクティブユーザー数':754,'プロバイダーフィー':9327506.27,'リスト件数':9967,'出金金額':74028096,'前月リテンション数':119,'勝利金':5413798941.72,'回収予定金額':127207474.62,'回収率(今月)':0.8335,'回収率(全体)':0.8491,'回収金額':108007299.5,'引継ぎプレイヤー数':438,'打電数':171257,'着電数':6193,'総登録数':754,'総信用枠':226200000,'平均信用枠':300000,'平均Credit単価':2056363,'総ボーナス':5100000,'平均プレイ月間':4.8,'事前清算回数':142,'事前清算金額':32000000,'通常清算回数':420,'通常清算金額':76007299,'事前清算割合':0.2962,'通常清算割合':0.7038,'事前清算件数割合':0.2527,'通常清算件数割合':0.7473},リスト種別:{'B':102,'E':88,'T':72,'S':58,'BE':45,'C':38,'紹介':32,'その他':319}}
};
const DSC_DATA = {
  '2026年1月':{サマリー:{'FTDW数':12,'FTDW率':0.6,'FTD数':10,'FTD率':0.5,'FTP数':16,'FTP率':0.8,'FTW数':2,'FTW率':0.1,'GGR(WIN/LOSE)':43248155.21,'GGR(回収金額-出金金額)':22191922,'LTV(GGR)':128277.01,'LTV(WIN/LOSE)':249989.34,'NGR':20776887.34,'RTP':0.9678,'T/O':1342354453.62,'アカウント作成数':20,'アクティブユーザー数':173,'プロバイダーフィー':1415034.66,'リスト件数':15000,'出金金額':12883059,'勝利金':1299106298.41,'回収予定金額':43803701,'回収率(全体)':0.8007,'回収金額':35074981,'総登録数':173,'総信用枠':51900000,'平均信用枠':300000,'平均Credit単価':2595000,'総ボーナス':1250000,'平均プレイ月間':5.2,'事前清算回数':32,'事前清算金額':9800000,'通常清算回数':98,'通常清算金額':25274981,'事前清算割合':0.2794,'通常清算割合':0.7206,'事前清算件数割合':0.2462,'通常清算件数割合':0.7538},リスト種別:{'B':15,'E':68,'T':8,'S':81,'その他':9}},
  '2025年12月':{サマリー:{'GGR(WIN/LOSE)':53578505.82,'GGR(回収金額-出金金額)':38616975,'LTV(GGR)':133161.98,'LTV(WIN/LOSE)':184753.47,'NGR':31242527,'RTP':0.9646,'T/O':1514244472.37,'アカウント作成数':27,'アクティブユーザー数':292,'プロバイダーフィー':7374448,'出金金額':20555338,'勝利金':1460665966.55,'回収予定金額':73458827,'回収率(全体)':0.8381,'回収金額':61567404,'総登録数':292,'総信用枠':87600000,'平均信用枠':300000,'平均Credit単価':2466666,'総ボーナス':2100000,'平均プレイ月間':4.8,'事前清算回数':55,'事前清算金額':16500000,'通常清算回数':168,'通常清算金額':45067404,'事前清算割合':0.2679,'通常清算割合':0.7321,'事前清算件数割合':0.2466,'通常清算件数割合':0.7534},リスト種別:{'B':42,'E':35,'T':28,'S':22,'BE':18,'C':15,'紹介':12,'その他':120}},
  '2025年11月':{サマリー:{'BK':9242926.55,'FTDW数':62,'FTDW率':0.8052,'FTD数':29,'FTD率':0.3766,'FTP数':61,'FTP率':0.7922,'FTW数':33,'FTW率':0.4286,'GGR(WIN/LOSE)':64900999.09,'GGR(回収金額-出金金額)':43448785,'LINE登録数':38,'LTV(GGR)':191404.34,'LTV(WIN/LOSE)':285907.48,'NGR':33610642.28,'RTP':0.9586,'T/O':1568206349.94,'アカウント作成数':77,'アクティブユーザー数':227,'プロバイダーフィー':9838142.72,'リスト件数':14867,'出金金額':19725328,'前月リテンション数':82,'勝利金':1503305350.85,'回収予定金額':77447062,'回収率(今月)':0.7476,'回収率(全体)':0.8291,'回収金額':64213601,'引継ぎプレイヤー数':150,'打電数':10398,'着電数':1209,'総登録数':227,'総信用枠':68100000,'平均信用枠':300000,'平均Credit単価':2348275,'総ボーナス':1680000,'平均プレイ月間':4.5,'事前清算回数':42,'事前清算金額':13200000,'通常清算回数':135,'通常清算金額':51013601,'事前清算割合':0.2056,'通常清算割合':0.7944,'事前清算件数割合':0.2373,'通常清算件数割合':0.7627},リスト種別:{'B':32,'E':28,'T':22,'S':18,'BE':14,'C':12,'紹介':10,'その他':91}},
  '2025年9月':{サマリー:{'BK':8671957.8,'FTDW数':92,'FTDW率':0.3948,'FTD数':73,'FTD率':0.3133,'FTP数':154,'FTP率':0.6609,'FTW数':19,'FTW率':0.0815,'GGR(WIN/LOSE)':74174997,'GGR(回収金額-出金金額)':40783402,'LINE登録数':161,'LTV(GGR)':137774.17,'LTV(WIN/LOSE)':248909.39,'NGR':31772784,'RTP':0.9712,'T/O':2578173994,'アカウント作成数':233,'アクティブユーザー数':298,'プロバイダーフィー':9010618,'リスト件数':14807,'出金金額':21551493,'前月リテンション数':21,'勝利金':2503998997,'回収予定金額':76698566.8,'回収率(全体)':0.8194,'回収金額':62846588,'引継ぎプレイヤー数':65,'打電数':12471,'着電数':2418,'総登録数':298,'総信用枠':89400000,'平均信用枠':300000,'平均Credit単価':1224657,'総ボーナス':2350000,'平均プレイ月間':3.9,'事前清算回数':58,'事前清算金額':15800000,'通常清算回数':175,'通常清算金額':47046588,'事前清算割合':0.2514,'通常清算割合':0.7486,'事前清算件数割合':0.2489,'通常清算件数割合':0.7511},リスト種別:{'B':45,'E':38,'T':30,'S':24,'BE':18,'C':15,'紹介':12,'その他':116}}
};
const SLOTEN_DATA = {
  '2026年1月':{
    サマリー:{'登録人数':3381,'ログインユーザー数':3459,'FTDのみ入金者数':181,'FTDのみ率':0.0535,'2nd入金者数':245,'2nd率':0.0725,'3rd入金者数':189,'3rd率':0.0559,'Active入金者数':387,'Active率':0.1145,'今月登録のFTD以降ユーザー数':339,'今月登録FTD以降ユーザー割合':0.1003,'アクティブプレイ人数（ユニーク）':993,'入金者数(デイリーユニーク)':632,'総入金額':70601802,'総出金額':54836317,'T/O(リアルのみ)':1040015674,'勝利金(リアルのみ)':1009478892,'RTP':0.9706,'GGR':30536782.75,'入出金差分':15765485,'GGRLTV':30752.05,'前月登録ユーザー数':2552,'前々月登録ユーザー数':300,'3か月以上前登録ユーザー数':150,'前月継続率':0.312,'前々月継続率':0.28,'3か月以上前継続率':0.22},
    入金方法:{'TOTAL':70601802,'銀行（自動）':16021000,'仮想通貨':6063158,'銀行（手動）':7798951,'EC(コンビニ)':1472000,'PayPay':39246693},
    出金方法:{'TOTAL':54836317,'銀行（自動）':16360710,'仮想通貨':17794551,'銀行（手動）':19212554,'PayPay':1468502},
    ゲーム別:{パチンコ:{ユーザー数:1066,TO:25539221,GGR:3124886},パチスロ:{ユーザー数:1090,TO:120877774,GGR:1119651},スロット:{ユーザー数:4792,TO:388796058,GGR:10550937},ライブ:{ユーザー数:2213,TO:407528253,GGR:15111844}},
    仮想通貨:{BTC:{件数:45,金額:1250000},ETH:{件数:62,金額:2100000},USDT:{件数:38,金額:1500000},XRP:{件数:28,金額:713158},TRX:{件数:15,金額:500000}},
    プロバイダー:{'Pragmatic Play':{ユーザー数:1850,賭け金額:180000000,配当金額:172800000,GGR:7200000},'Evolution':{ユーザー数:1420,賭け金額:250000000,配当金額:242500000,GGR:7500000},'NetEnt':{ユーザー数:980,賭け金額:95000000,配当金額:91200000,GGR:3800000},'Play n GO':{ユーザー数:750,賭け金額:72000000,配当金額:69120000,GGR:2880000},'Red Tiger':{ユーザー数:620,賭け金額:58000000,配当金額:55680000,GGR:2320000},'その他':{ユーザー数:2100,賭け金額:287741326,配当金額:280904434,GGR:6836892}},
    Affiliate:{'AFF数':46,'AFF経由登録者数':925,'AFF経由FTD数':126,'AFF経由FTD率':0.1362,'AFF経由入金額':8022259,'AFF経由出金額':5490590,'AFF経由GGR':2531669}
  },
  '2025年12月':{
    サマリー:{'登録人数':2552,'ログインユーザー数':2399,'FTDのみ入金者数':231,'FTDのみ率':0.0905,'2nd入金者数':198,'2nd率':0.0776,'3rd入金者数':156,'3rd率':0.0611,'Active入金者数':324,'Active率':0.1269,'今月登録のFTD以降ユーザー数':713,'今月登録FTD以降ユーザー割合':0.1653,'アクティブプレイ人数（ユニーク）':798,'総入金額':66633871,'総出金額':48341793,'T/O(リアルのみ)':1120432234,'勝利金(リアルのみ)':1084887870,'RTP':0.9683,'GGR':35543975.96,'入出金差分':18292078,'GGRLTV':44541.32,'前月登録ユーザー数':300,'前々月登録ユーザー数':0,'3か月以上前登録ユーザー数':0,'前月継続率':0.28,'前々月継続率':0,'3か月以上前継続率':0},
    入金方法:{'TOTAL':66633871,'銀行（自動）':11122808,'仮想通貨':10897654,'銀行（手動）':18865520,'EC(コンビニ)':1121000,'PayPay':24627889},
    出金方法:{'TOTAL':48341793,'銀行（自動）':12500000,'仮想通貨':15841793,'銀行（手動）':18000000,'PayPay':2000000},
    ゲーム別:{パチンコ:{ユーザー数:892,TO:21500000,GGR:2580000},パチスロ:{ユーザー数:945,TO:105000000,GGR:1260000},スロット:{ユーザー数:4120,TO:420000000,GGR:12600000},ライブ:{ユーザー数:1980,TO:380000000,GGR:19103976}},
    仮想通貨:{BTC:{件数:78,金額:2800000},ETH:{件数:95,金額:3500000},USDT:{件数:65,金額:2800000},XRP:{件数:42,金額:1297654},TRX:{件数:20,金額:500000}},
    プロバイダー:{'Pragmatic Play':{ユーザー数:1650,賭け金額:195000000,配当金額:187200000,GGR:7800000},'Evolution':{ユーザー数:1580,賭け金額:285000000,配当金額:276450000,GGR:8550000},'NetEnt':{ユーザー数:880,賭け金額:88000000,配当金額:84480000,GGR:3520000},'Play n GO':{ユーザー数:690,賭け金額:66000000,配当金額:63360000,GGR:2640000},'Red Tiger':{ユーザー数:550,賭け金額:52000000,配当金額:49920000,GGR:2080000},'Hacksaw':{ユーザー数:420,賭け金額:48000000,配当金額:46080000,GGR:1920000},'その他':{ユーザー数:1950,賭け金額:192432234,配当金額:183397858,GGR:9034376}},
    Affiliate:{'AFF数':34,'AFF経由登録者数':1457,'AFF経由FTD数':543,'AFF経由FTD率':0.3727,'AFF経由入金額':55061952,'AFF経由出金額':36735633,'AFF経由GGR':10366161}
  },
  '2025年11月':{
    サマリー:{'登録人数':300,'ログインユーザー数':193,'FTDのみ入金者数':8,'FTDのみ率':0.0267,'2nd入金者数':12,'2nd率':0.04,'3rd入金者数':8,'3rd率':0.0267,'Active入金者数':22,'Active率':0.0733,'今月登録のFTD以降ユーザー数':42,'今月登録FTD以降ユーザー割合':0.5661,'アクティブプレイ人数':84,'総入金額':586146,'総出金額':528463,'T/O(リアルのみ)':5043994.2,'勝利金(リアルのみ)':4980421.4,'RTP':0.9874,'GGR':63572.8,'入出金差分':57683,'前月登録ユーザー数':0,'前々月登録ユーザー数':0,'3か月以上前登録ユーザー数':0,'前月継続率':0,'前々月継続率':0,'3か月以上前継続率':0},
    入金方法:{'TOTAL':586146,'銀行（自動）':0,'仮想通貨':8000,'銀行（手動）':100000,'EC(コンビニ)':10000,'PayPay':468146},
    出金方法:{'TOTAL':528463,'銀行（自動）':0,'仮想通貨':50000,'銀行（手動）':200000,'PayPay':278463},
    ゲーム別:{パチンコ:{ユーザー数:25,TO:320000,GGR:38400},パチスロ:{ユーザー数:28,TO:580000,GGR:6960},スロット:{ユーザー数:52,TO:2100000,GGR:63000},ライブ:{ユーザー数:18,TO:2043994,GGR:-44787}},
    仮想通貨:{BTC:{件数:2,金額:3000},ETH:{件数:1,金額:2500},USDT:{件数:1,金額:1500},XRP:{件数:1,金額:1000}},
    プロバイダー:{'Pragmatic Play':{ユーザー数:35,賭け金額:1800000,配当金額:1728000,GGR:72000},'Evolution':{ユーザー数:18,賭け金額:2043994,配当金額:2088781,GGR:-44787},'NetEnt':{ユーザー数:22,賭け金額:650000,配当金額:624000,GGR:26000},'その他':{ユーザー数:25,賭け金額:550000,配当金額:539640,GGR:10360}},
    Affiliate:{'AFF数':8,'AFF経由登録者数':302,'AFF経由FTD数':34,'AFF経由FTD率':0.4797}
  }
};

// Konibet KPIデータ（2020年12月）
const KONIBET_DATA = {
  '2020年12月':{
    サマリー: {
      '登録人数': 655, 'ログインユーザー数': 4310, 'FTD数': 114, '入金者数': 566,
      '総入金額': 55017008, 'T/O': 489307826, 'アクティブプレイ人数': 54,
      'GGR': 17124231, '入出金差分': 13033808, 'ボーナス': 8460362, 'NGR': 3103337,
      '新規入金転移率': 0.1866, '平均入金額': 98585, '出金人数割合': 0.4399,
      'T/O倍率': 10.69, 'ボーナス付与率': 0.1948, 'GGR率': 0.3175, 'NGR率': 0.0564,
      '初回入金額': 4724256, '出金者数': 233, '総出金額': 41983200, '勝利金': 471841260,
      'ゲームプロバイダーフィー': 1505054, 'PSP手数料': 4397816, 'RTP': 0.9611,
      'T/O倍率(Bonus込)': 8.77, '為替レート(USD/JPY)': 150
    }
  },
  '2022年9月':{
    サマリー: {
      '登録人数': 4846, 'ログインユーザー数': 103310, 'FTD数': 1259, '入金者数': 31771,
      '総入金額': 4656894900, '総出金額': 3863437050, '入出金差分': 793457850,
      'T/O': 67305079800, '勝利金': 65671600500, 'GGR': 1633479300, 'NGR': 472641300,
      'ボーナス': 677267850, 'ゲームプロバイダーフィー': 126140550, 'PSP手数料': 235127550,
      'AFF報酬': 122287500, 'アクティブプレイ人数': 148605, '出金者数': 14342,
      '新規入金転移率': 0.27, '平均入金額': 146304, '出金人数割合': 0.45, 'T/O倍率': 14.70,
      'T/O倍率(Bonus込)': 12.84, 'ボーナス付与率': 0.14, 'GGR率': 0.35, 'NGR率': 0.10, 'RTP': 0.97,
      '為替レート(USD/JPY)': 150
    }
  },
  '2022年10月':{
    サマリー: {
      '登録人数': 5086, 'ログインユーザー数': 100031, 'FTD数': 1221, '入金者数': 29467,
      '総入金額': 3638004750, '総出金額': 3218559300, '入出金差分': 419445450,
      'T/O': 50526470700, '勝利金': 49431414300, 'GGR': 1095056400, 'NGR': 124012500,
      'ボーナス': 550680900, 'ゲームプロバイダーフィー': 85994700, 'PSP手数料': 197473800,
      'AFF報酬': 136890000, 'アクティブプレイ人数': 133745, '出金者数': 13777,
      '新規入金転移率': 0.24, '平均入金額': 123294, '出金人数割合': 0.47, 'T/O倍率': 13.88,
      'T/O倍率(Bonus込)': 12.06, 'ボーナス付与率': 0.15, 'GGR率': 0.30, 'NGR率': 0.05, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2022年11月':{
    サマリー: {
      '登録人数': 4627, 'ログインユーザー数': 94448, 'FTD数': 1057, '入金者数': 28612,
      '総入金額': 3765088500, '総出金額': 3295819050, '入出金差分': 469269450,
      'T/O': 50160459300, '勝利金': 49161525000, 'GGR': 998934300, 'NGR': 125532000,
      'ボーナス': 508465350, 'ゲームプロバイダーフィー': 76734450, 'PSP手数料': 210948150,
      'AFF報酬': 77245500, 'アクティブプレイ人数': 129463, '出金者数': 13558,
      '新規入金転移率': 0.23, '平均入金額': 131799, '出金人数割合': 0.48, 'T/O倍率': 13.33,
      'T/O倍率(Bonus込)': 11.73, 'ボーナス付与率': 0.13, 'GGR率': 0.27, 'NGR率': 0.05, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2022年12月':{
    サマリー: {
      '登録人数': 4085, 'ログインユーザー数': 101478, 'FTD数': 1118, '入金者数': 33101,
      '総入金額': 4403460300, '総出金額': 3754225200, '入出金差分': 649235100,
      'T/O': 59601919500, '勝利金': 58230346050, 'GGR': 1371573450, 'NGR': 352714200,
      'ボーナス': 620325900, 'ゲームプロバイダーフィー': 109389000, 'PSP手数料': 218751150,
      'AFF報酬': 70390200, 'アクティブプレイ人数': 146077, '出金者数': 15704,
      '新規入金転移率': 0.27, '平均入金額': 132660, '出金人数割合': 0.47, 'T/O倍率': 13.54,
      'T/O倍率(Bonus込)': 11.86, 'ボーナス付与率': 0.14, 'GGR率': 0.31, 'NGR率': 0.12, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2023年1月':{
    サマリー: {
      '登録人数': 5405, 'ログインユーザー数': 103303, 'FTD数': 1291, '入金者数': 31093,
      '総入金額': 4596566850, '総出金額': 3907259550, '入出金差分': 689307300,
      'T/O': 60173530500, '勝利金': 58740607050, 'GGR': 1432923600, 'NGR': 374776950,
      'ボーナス': 626819550, 'ゲームプロバイダーフィー': 111031500, 'PSP手数料': 231298650,
      'AFF報酬': 88834200, 'アクティブプレイ人数': 137065, '出金者数': 15130,
      '新規入金転移率': 0.24, '平均入金額': 148190, '出金人数割合': 0.49, 'T/O倍率': 13.09,
      'T/O倍率(Bonus込)': 11.52, 'ボーナス付与率': 0.14, 'GGR率': 0.31, 'NGR率': 0.12, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2023年2月':{
    サマリー: {
      '登録人数': 5530, 'ログインユーザー数': 97501, 'FTD数': 1388, '入金者数': 29891,
      '総入金額': 4732864350, '総出金額': 4204721400, '入出金差分': 528142950,
      'T/O': 63966672900, '勝利金': 62664758850, 'GGR': 1301914050, 'NGR': 177756750,
      'ボーナス': 688887900, 'ゲームプロバイダーフィー': 98889150, 'PSP手数料': 242944050,
      'AFF報酬': 93430200, 'アクティブプレイ人数': 130845, '出金者数': 14786,
      '新規入金転移率': 0.26, '平均入金額': 158186, '出金人数割合': 0.49, 'T/O倍率': 13.51,
      'T/O倍率(Bonus込)': 11.79, 'ボーナス付与率': 0.15, 'GGR率': 0.28, 'NGR率': 0.06, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2023年3月':{
    サマリー: {
      '登録人数': 5779, 'ログインユーザー数': 110829, 'FTD数': 1467, '入金者数': 33833,
      '総入金額': 5040934800, '総出金額': 4447681200, '入出金差分': 593253600,
      'T/O': 71562549150, '勝利金': 70017281850, 'GGR': 1545267300, 'NGR': 308461500,
      'ボーナス': 757270800, 'ゲームプロバイダーフィー': 116867250, 'PSP手数料': 187792950,
      'AFF報酬': 174874800, 'アクティブプレイ人数': 148064, '出金者数': 16086,
      '新規入金転移率': 0.26, '平均入金額': 148940, '出金人数割合': 0.48, 'T/O倍率': 14.20,
      'T/O倍率(Bonus込)': 12.35, 'ボーナス付与率': 0.15, 'GGR率': 0.31, 'NGR率': 0.09, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2023年4月':{
    サマリー: {
      '登録人数': 5572, 'ログインユーザー数': 109498, 'FTD数': 1414, '入金者数': 33966,
      '総入金額': 5051941500, '総出金額': 4328354100, '入出金差分': 723587400,
      'T/O': 67673301450, '勝利金': 66090306750, 'GGR': 1582994550, 'NGR': 289851750,
      'ボーナス': 741986400, 'ゲームプロバイダーフィー': 122317350, 'PSP手数料': 255595350,
      'AFF報酬': 173243700, 'アクティブプレイ人数': 144653, '出金者数': 16690,
      '新規入金転移率': 0.26, '平均入金額': 147942, '出金人数割合': 0.49, 'T/O倍率': 13.40,
      'T/O倍率(Bonus込)': 11.68, 'ボーナス付与率': 0.15, 'GGR率': 0.31, 'NGR率': 0.09, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2023年5月':{
    サマリー: {
      '登録人数': 5642, 'ログインユーザー数': 110999, 'FTD数': 1236, '入金者数': 31022,
      '総入金額': 4739662950, '総出金額': 4419418950, '入出金差分': 320244000,
      'T/O': 70270756650, '勝利金': 69087908250, 'GGR': 1182848550, 'NGR': -84626550,
      'ボーナス': 745463700, 'ゲームプロバイダーフィー': 89572500, 'PSP手数料': 262674000,
      'AFF報酬': 169759950, 'アクティブプレイ人数': 137941, '出金者数': 14740,
      '新規入金転移率': 0.22, '平均入金額': 154080, '出金人数割合': 0.49, 'T/O倍率': 14.83,
      'T/O倍率(Bonus込)': 12.81, 'ボーナス付与率': 0.17, 'GGR率': 0.25, 'NGR率': -0.03, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2023年6月':{
    サマリー: {
      '登録人数': 4752, 'ログインユーザー数': 98858, 'FTD数': 1248, '入金者数': 27751,
      '総入金額': 4742659500, '総出金額': 4393793550, '入出金差分': 348865950,
      'T/O': 65923549350, '勝利金': 64671475500, 'GGR': 1252073850, 'NGR': 52954950,
      'ボーナス': 685572300, 'ゲームプロバイダーフィー': 98127750, 'PSP手数料': 305791350,
      'AFF報酬': 109627500, 'アクティブプレイ人数': 118846, '出金者数': 13173,
      '新規入金転移率': 0.27, '平均入金額': 171023, '出金人数割合': 0.48, 'T/O倍率': 13.91,
      'T/O倍率(Bonus込)': 12.14, 'ボーナス付与率': 0.15, 'GGR率': 0.26, 'NGR率': 0.02, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2023年7月':{
    サマリー: {
      '登録人数': 4976, 'ログインユーザー数': 102115, 'FTD数': 952, '入金者数': 30866,
      '総入金額': 5314423512, '総出金額': 4718531550, '入出金差分': 595891950,
      'T/O': 67825435107, '勝利金': 66521032200, 'GGR': 1304402889, 'NGR': -3975161,
      'ボーナス': 765398400, 'ゲームプロバイダーフィー': 102696000, 'PSP手数料': 347701050,
      'AFF報酬': 92582700, 'アクティブプレイ人数': 132911, '出金者数': 14798,
      '新規入金転移率': 0.19, '平均入金額': 172376, '出金人数割合': 0.50, 'T/O倍率': 12.76,
      'T/O倍率(Bonus込)': 11.15, 'ボーナス付与率': 0.15, 'GGR率': 0.25, 'NGR率': -0.001, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2023年8月':{
    サマリー: {
      '登録人数': 4320, 'ログインユーザー数': 101517, 'FTD数': 992, '入金者数': 32283,
      '総入金額': 5672952720, '総出金額': 5191089162, '入出金差分': 481863600,
      'T/O': 67611538649, '勝利金': 66312234750, 'GGR': 1299303857, 'NGR': -13644369,
      'ボーナス': 723548850, 'ゲームプロバイダーフィー': 102848850, 'PSP手数料': 373573500,
      'AFF報酬': 112972500, 'アクティブプレイ人数': 136012, '出金者数': 15644,
      '新規入金転移率': 0.23, '平均入金額': 187460, '出金人数割合': 0.48, 'T/O倍率': 11.92,
      'T/O倍率(Bonus込)': 10.57, 'ボーナス付与率': 0.15, 'GGR率': 0.23, 'NGR率': -0.004, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2023年9月':{
    サマリー: {
      '登録人数': 3488, 'ログインユーザー数': 95027, 'FTD数': 775, '入金者数': 32173,
      '総入金額': 5378959013, '総出金額': 4943680950, '入出金差分': 435278100,
      'T/O': 73334792285, '勝利金': 72020185650, 'GGR': 1314606665, 'NGR': 27426557,
      'ボーナス': 790591650, 'ゲームプロバイダーフィー': 100663950, 'PSP手数料': 321740250,
      'AFF報酬': 74182650, 'アクティブプレイ人数': 130658, '出金者数': 16212,
      '新規入金転移率': 0.22, '平均入金額': 167170, '出金人数割合': 0.50, 'T/O倍率': 13.64,
      'T/O倍率(Bonus込)': 11.89, 'ボーナス付与率': 0.15, 'GGR率': 0.24, 'NGR率': 0.01, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2023年10月':{
    サマリー: {
      '登録人数': 3210, 'ログインユーザー数': 94695, 'FTD数': 754, '入金者数': 32943,
      '総入金額': 5449967309, '総出金額': 4905403050, '入出金差分': 544564200,
      'T/O': 71930507087, '勝利金': 70493255400, 'GGR': 1437251688, 'NGR': 147229191,
      'ボーナス': 779403900, 'ゲームプロバイダーフィー': 110542800, 'PSP手数料': 311730900,
      'AFF報酬': 88343850, 'アクティブプレイ人数': 125457, '出金者数': 15965,
      '新規入金転移率': 0.24, '平均入金額': 165296, '出金人数割合': 0.49, 'T/O倍率': 13.20,
      'T/O倍率(Bonus込)': 11.55, 'ボーナス付与率': 0.14, 'GGR率': 0.26, 'NGR率': 0.04, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2023年11月':{
    サマリー: {
      '登録人数': 3247, 'ログインユーザー数': 94707, 'FTD数': 704, '入金者数': 33269,
      '総入金額': 5289826664, '総出金額': 4732256550, '入出金差分': 557570100,
      'T/O': 78859878539, '勝利金': 77400966750, 'GGR': 1458911816, 'NGR': 163320188,
      'ボーナス': 812769300, 'ゲームプロバイダーフィー': 114338100, 'PSP手数料': 298415250,
      'AFF報酬': 70059900, 'アクティブプレイ人数': 126421, '出金者数': 16210,
      '新規入金転移率': 0.22, '平均入金額': 158579, '出金人数割合': 0.48, 'T/O倍率': 14.91,
      'T/O倍率(Bonus込)': 12.92, 'ボーナス付与率': 0.16, 'GGR率': 0.28, 'NGR率': 0.05, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2023年12月':{
    サマリー: {
      '登録人数': 3627, 'ログインユーザー数': 106819, 'FTD数': 764, '入金者数': 38349,
      '総入金額': 5766929393, '総出金額': 5033011050, '入出金差分': 733918350,
      'T/O': 93837269435, '勝利金': 92289123000, 'GGR': 1548146432, 'NGR': -4098641,
      'ボーナス': 1006432650, 'ゲームプロバイダーフィー': 128360400, 'PSP手数料': 319942950,
      'AFF報酬': 97507950, 'アクティブプレイ人数': 145891, '出金者数': 18881,
      '新規入金転移率': 0.22, '平均入金額': 150357, '出金人数割合': 0.49, 'T/O倍率': 16.27,
      'T/O倍率(Bonus込)': 13.85, 'ボーナス付与率': 0.17, 'GGR率': 0.27, 'NGR率': -0.001, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2024年1月':{
    サマリー: {
      '登録人数': 3883, 'ログインユーザー数': 108238, 'FTD数': 886, '入金者数': 38013,
      '総入金額': 5504337729, '総出金額': 4715576100, '入出金差分': 788761650,
      'T/O': 81341143415, '勝利金': 79564390800, 'GGR': 1776752675, 'NGR': 373387494,
      'ボーナス': 862595250, 'ゲームプロバイダーフィー': 142170900, 'PSP手数料': 305910750,
      'AFF報酬': 92686050, 'アクティブプレイ人数': 146582, '出金者数': 18040,
      '新規入金転移率': 0.23, '平均入金額': 144677, '出金人数割合': 0.48, 'T/O倍率': 14.78,
      'T/O倍率(Bonus込)': 12.77, 'ボーナス付与率': 0.16, 'GGR率': 0.32, 'NGR率': 0.10, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2024年2月':{
    サマリー: {
      '登録人数': 4078, 'ログインユーザー数': 102418, 'FTD数': 901, '入金者数': 36820,
      '総入金額': 5342984510, '総出金額': 4743772950, '入出金差分': 599211600,
      'T/O': 75251374755, '勝利金': 73797058350, 'GGR': 1454316398, 'NGR': 172636140,
      'ボーナス': 781318950, 'ゲームプロバイダーフィー': 113026350, 'PSP手数料': 297307350,
      'AFF報酬': 90027600, 'アクティブプレイ人数': 140429, '出金者数': 18063,
      '新規入金転移率': 0.22, '平均入金額': 144986, '出金人数割合': 0.49, 'T/O倍率': 14.09,
      'T/O倍率(Bonus込)': 12.28, 'ボーナス付与率': 0.15, 'GGR率': 0.27, 'NGR率': 0.05, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2024年3月':{
    サマリー: {
      '登録人数': 3503, 'ログインユーザー数': 105059, 'FTD数': 751, '入金者数': 37818,
      '総入金額': 5579782415, '総出金額': 4787182800, '入出金差分': 792599550,
      'T/O': 89824454253, '勝利金': 87845299500, 'GGR': 1979154735, 'NGR': 453683172,
      'ボーナス': 975895650, 'ゲームプロバイダーフィー': 159008250, 'PSP手数料': 312431700,
      'AFF報酬': 78135600, 'アクティブプレイ人数': 142097, '出金者数': 18205,
      '新規入金転移率': 0.22, '平均入金額': 146835, '出金人数割合': 0.48, 'T/O倍率': 16.10,
      'T/O倍率(Bonus込)': 13.70, 'ボーナス付与率': 0.17, 'GGR率': 0.35, 'NGR率': 0.12, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2024年4月':{
    サマリー: {
      '登録人数': 3435, 'ログインユーザー数': 97196, 'FTD数': 709, '入金者数': 34843,
      '総入金額': 4912516781, '総出金額': 4253515650, '入出金差分': 659001150,
      'T/O': 65363829648, '勝利金': 63924359250, 'GGR': 1439470410, 'NGR': 255814203,
      'ボーナス': 716412000, 'ゲームプロバイダーフィー': 111637050, 'PSP手数料': 278171700,
      'AFF報酬': 77417550, 'アクティブプレイ人数': 131055, '出金者数': 16666,
      '新規入金転移率': 0.21, '平均入金額': 140601, '出金人数割合': 0.48, 'T/O倍率': 13.31,
      'T/O倍率(Bonus込)': 11.61, 'ボーナス付与率': 0.15, 'GGR率': 0.29, 'NGR率': 0.08, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2024年5月':{
    サマリー: {
      '登録人数': 2988, 'ログインユーザー数': 93791, 'FTD数': 612, '入金者数': 29254,
      '総入金額': 3950292507, '総出金額': 3468943350, '入出金差分': 481349100,
      'T/O': 64810819769, '勝利金': 63450258750, 'GGR': 1360560959, 'NGR': 195802487,
      'ボーナス': 738496050, 'ゲームプロバイダーフィー': 107695350, 'PSP手数料': 238751550,
      'AFF報酬': 79801200, 'アクティブプレイ人数': 114070, '出金者数': 12535,
      '新規入金転移率': 0.20, '平均入金額': 136782, '出金人数割合': 0.44, 'T/O倍率': 16.41,
      'T/O倍率(Bonus込)': 13.82, 'ボーナス付与率': 0.20, 'GGR率': 0.34, 'NGR率': 0.07, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2024年6月':{
    サマリー: {
      '登録人数': 2279, 'ログインユーザー数': 78468, 'FTD数': 471, '入金者数': 20390,
      '総入金額': 3337435341, '総出金額': 2831238450, '入出金差分': 506196900,
      'T/O': 60062903072, '勝利金': 58886391900, 'GGR': 1176511172, 'NGR': 107916104,
      'ボーナス': 707013450, 'ゲームプロバイダーフィー': 90939600, 'PSP手数料': 202148700,
      'AFF報酬': 68486250, 'アクティブプレイ人数': 91091, '出金者数': 7636,
      '新規入金転移率': 0.21, '平均入金額': 163809, '出金人数割合': 0.39, 'T/O倍率': 18.00,
      'T/O倍率(Bonus込)': 14.85, 'ボーナス付与率': 0.23, 'GGR率': 0.35, 'NGR率': 0.05, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2024年7月':{
    サマリー: {
      '登録人数': 2402, 'ログインユーザー数': 72319, 'FTD数': 497, '入金者数': 18788,
      '総入金額': 3434823930, '総出金額': 3161142150, '入出金差分': 273681750,
      'T/O': 49957559358, '勝利金': 48993883950, 'GGR': 963675405, 'NGR': 8912231,
      'ボーナス': 587573850, 'ゲームプロバイダーフィー': 74630400, 'PSP手数料': 211748100,
      'AFF報酬': 80801850, 'アクティブプレイ人数': 78644, '出金者数': 8364,
      '新規入金転移率': 0.21, '平均入金額': 189875, '出金人数割合': 0.44, 'T/O倍率': 14.54,
      'T/O倍率(Bonus込)': 12.42, 'ボーナス付与率': 0.20, 'GGR率': 0.28, 'NGR率': 0.004, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2024年8月':{
    サマリー: {
      '登録人数': 2196, 'ログインユーザー数': 78908, 'FTD数': 521, '入金者数': 25556,
      '総入金額': 4328371512, '総出金額': 3878467650, '入出金差分': 449903850,
      'T/O': 50787813531, '勝利金': 49674529050, 'GGR': 1113284550, 'NGR': 105244757,
      'ボーナス': 591573000, 'ゲームプロバイダーフィー': 94503150, 'PSP手数料': 281166600,
      'AFF報酬': 40789050, 'アクティブプレイ人数': 101244, '出金者数': 11830,
      '新規入金転移率': 0.23, '平均入金額': 166973, '出金人数割合': 0.47, 'T/O倍率': 11.73,
      'T/O倍率(Bonus込)': 10.32, 'ボーナス付与率': 0.14, 'GGR率': 0.26, 'NGR率': 0.04, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2024年9月':{
    サマリー: {
      '登録人数': 2401, 'ログインユーザー数': 83028, 'FTD数': 579, '入金者数': 28123,
      '総入金額': 3470643279, '総出金額': 3061083600, '入出金差分': 409559700,
      'T/O': 65575118414, '勝利金': 64328653350, 'GGR': 1246465052, 'NGR': 159288717,
      'ボーナス': 700383750, 'ゲームプロバイダーフィー': 110865750, 'PSP手数料': 207615000,
      'AFF報酬': 68308200, 'アクティブプレイ人数': 115123, '出金者数': 12506,
      '新規入金転移率': 0.24, '平均入金額': 123072, '出金人数割合': 0.45, 'T/O倍率': 18.90,
      'T/O倍率(Bonus込)': 15.72, 'ボーナス付与率': 0.22, 'GGR率': 0.36, 'NGR率': 0.07, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2024年10月':{
    サマリー: {
      '登録人数': 2229, 'ログインユーザー数': 81738, 'FTD数': 417, '入金者数': 28579,
      '総入金額': 2842999037, '総出金額': 2326613850, '入出金差分': 516385200,
      'T/O': 43725574466, '勝利金': 42598401300, 'GGR': 1127173100, 'NGR': 266367035,
      'ボーナス': 517256550, 'ゲームプロバイダーフィー': 97382850, 'PSP手数料': 166166700,
      'AFF報酬': 79999800, 'アクティブプレイ人数': 113727, '出金者数': 12397,
      '新規入金転移率': 0.19, '平均入金額': 98901, '出金人数割合': 0.44, 'T/O倍率': 15.38,
      'T/O倍率(Bonus込)': 13.02, 'ボーナス付与率': 0.19, 'GGR率': 0.40, 'NGR率': 0.14, 'RTP': 0.97,
      '為替レート(USD/JPY)': 150
    }
  },
  '2024年11月':{
    サマリー: {
      '登録人数': 2177, 'ログインユーザー数': 78283, 'FTD数': 341, '入金者数': 26599,
      '総入金額': 2752151892, '総出金額': 2298848850, '入出金差分': 453303000,
      'T/O': 65122202033, '勝利金': 63929160300, 'GGR': 1193041727, 'NGR': 159072351,
      'ボーナス': 722200500, 'ゲームプロバイダーフィー': 103667400, 'PSP手数料': 164377500,
      'AFF報酬': 43719450, 'アクティブプレイ人数': 105420, '出金者数': 11704,
      '新規入金転移率': 0.16, '平均入金額': 103488, '出金人数割合': 0.44, 'T/O倍率': 23.66,
      'T/O倍率(Bonus込)': 18.74, 'ボーナス付与率': 0.28, 'GGR率': 0.43, 'NGR率': 0.09, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2024年12月':{
    サマリー: {
      '登録人数': 2039, 'ログインユーザー数': 78040, 'FTD数': 374, '入金者数': 28170,
      '総入金額': 3134613941, '総出金額': 2581030500, '入出金差分': 553583400,
      'T/O': 55949762927, '勝利金': 54648331200, 'GGR': 1301431692, 'NGR': 251382368,
      'ボーナス': 707630850, 'ゲームプロバイダーフィー': 112495350, 'PSP手数料': 181163400,
      'AFF報酬': 48746100, 'アクティブプレイ人数': 107311, '出金者数': 12218,
      '新規入金転移率': 0.19, '平均入金額': 111231, '出金人数割合': 0.44, 'T/O倍率': 17.85,
      'T/O倍率(Bonus込)': 14.56, 'ボーナス付与率': 0.23, 'GGR率': 0.42, 'NGR率': 0.12, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2025年1月':{
    サマリー: {
      '登録人数': 2068, 'ログインユーザー数': 79257, 'FTD数': 307, '入金者数': 26916,
      '総入金額': 2859050655, '総出金額': 2599758600, '入出金差分': 259292100,
      'T/O': 62025393782, '勝利金': 61107617700, 'GGR': 917776022, 'NGR': -100565124,
      'ボーナス': 683755650, 'ゲームプロバイダーフィー': 91123650, 'PSP手数料': 163017150,
      'AFF報酬': 80440950, 'アクティブプレイ人数': 104049, '出金者数': 11836,
      '新規入金転移率': 0.15, '平均入金額': 105719, '出金人数割合': 0.44, 'T/O倍率': 21.70,
      'T/O倍率(Bonus込)': 17.50, 'ボーナス付与率': 0.25, 'GGR率': 0.32, 'NGR率': -0.05, 'RTP': 0.98,
      '為替レート(USD/JPY)': 150
    }
  },
  '2025年2月':{
    サマリー: {
      '登録人数': 1529, 'ログインユーザー数': 67156, 'FTD数': 238, '入金者数': 21577,
      '総入金額': 2369026662, '総出金額': 2076390900, '入出金差分': 292635750,
      'T/O': 41623468230, '勝利金': 40712228700, 'GGR': 911239544, 'NGR': 87880101,
      'ボーナス': 525676500, 'ゲームプロバイダーフィー': 80864250, 'PSP手数料': 136554750,
      'AFF報酬': 80256750, 'アクティブプレイ人数': 85587, '出金者数': 9593,
      '新規入金転移率': 0.20, '平均入金額': 116306, '出金人数割合': 0.44, 'T/O倍率': 17.57,
      'T/O倍率(Bonus込)': 14.38, 'ボーナス付与率': 0.19, 'GGR率': 0.38, 'NGR率': 0.06, 'RTP': 0.97,
      '為替レート(USD/JPY)': 150
    }
  },
  '2025年3月':{
    サマリー: {
      '登録人数': 260, 'ログインユーザー数': 13088, 'FTD数': 35, '入金者数': 4243,
      '総入金額': 497473926, '総出金額': 454611750, '入出金差分': 42862200,
      'T/O': 9250014171, '勝利金': 9121352850, 'GGR': 128661300, 'NGR': -41461250,
      'ボーナス': 113304150, 'ゲームプロバイダーフィー': 12304950, 'PSP手数料': 31400400,
      'AFF報酬': 13111200, 'アクティブプレイ人数': 17026, '出金者数': 2004,
      '新規入金転移率': 0.11, '平均入金額': 123350, '出金人数割合': 0.49, 'T/O倍率': 18.59,
      'T/O倍率(Bonus込)': 15.14, 'ボーナス付与率': 0.22, 'GGR率': 0.26, 'NGR率': -0.12, 'RTP': 0.99,
      '為替レート(USD/JPY)': 150
    }
  }
};

const DEFAULT_BUSINESSES = {
  '元amuse': { data: MOTO_AMUSE_DATA, type: 'samExcel' },
  'DSC': { data: DSC_DATA, type: 'samExcel' },
  'スロ天': { data: SLOTEN_DATA, type: 'sloten' },
  '広告': { data: {}, type: 'ads' },
  'バカラツール': { data: {}, type: 'baccara' },
  'AMUSEVIP': { data: {}, type: 'agent' },
  'Konibet': { data: KONIBET_DATA, type: 'konibet' }
};

// LZ圧縮ライブラリ（軽量版）
const LZString={compressToEncodedURIComponent:function(a){if(null==a)return"";return LZString._compress(a,6,function(b){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$".charAt(b)})},decompressFromEncodedURIComponent:function(a){if(null==a)return"";if(""==a)return null;a=a.replace(/ /g,"+");return LZString._decompress(a.length,32,function(b){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$".indexOf(a.charAt(b))})},_compress:function(a,b,c){if(null==a)return"";var d,e,f,g={},h={},k="",l="",m="",n=2,o=3,p=2,q=[],r=0,s=0;for(f=0;f<a.length;f+=1)if(k=a.charAt(f),Object.prototype.hasOwnProperty.call(g,k)||(g[k]=o++,h[k]=!0),l=m+k,Object.prototype.hasOwnProperty.call(g,l))m=l;else{if(Object.prototype.hasOwnProperty.call(h,m)){if(256>m.charCodeAt(0)){for(d=0;d<p;d++)r<<=1,15==s?(s=0,q.push(c(r)),r=0):s++;for(e=m.charCodeAt(0),d=0;8>d;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1}else{for(e=1,d=0;d<p;d++)r=r<<1|e,15==s?(s=0,q.push(c(r)),r=0):s++,e=0;for(e=m.charCodeAt(0),d=0;16>d;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1}0==--n&&(n=Math.pow(2,p),p++);delete h[m]}else for(e=g[m],d=0;d<p;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1;0==--n&&(n=Math.pow(2,p),p++);g[l]=o++;m=k}if(""!==m){if(Object.prototype.hasOwnProperty.call(h,m)){if(256>m.charCodeAt(0)){for(d=0;d<p;d++)r<<=1,15==s?(s=0,q.push(c(r)),r=0):s++;for(e=m.charCodeAt(0),d=0;8>d;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1}else{for(e=1,d=0;d<p;d++)r=r<<1|e,15==s?(s=0,q.push(c(r)),r=0):s++,e=0;for(e=m.charCodeAt(0),d=0;16>d;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1}0==--n&&(n=Math.pow(2,p),p++);delete h[m]}else for(e=g[m],d=0;d<p;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1;0==--n&&(n=Math.pow(2,p),p++)}for(e=2,d=0;d<p;d++)r=r<<1|1&e,15==s?(s=0,q.push(c(r)),r=0):s++,e>>=1;for(;;)if(r<<=1,15==s){q.push(c(r));break}else s++;return q.join("")},_decompress:function(a,b,c){var d,e,f,g,h,k,l,m=[],n=4,o=4,p=3,q="",r=[],s={val:c(0),position:b,index:1};for(d=0;3>d;d+=1)m[d]=d;for(f=0,h=Math.pow(2,2),k=1;k!=h;)g=s.val&s.position,s.position>>=1,0==s.position&&(s.position=b,s.val=c(s.index++)),f|=(0<g?1:0)*k,k<<=1;switch(f){case 0:for(f=0,h=Math.pow(2,8),k=1;k!=h;)g=s.val&s.position,s.position>>=1,0==s.position&&(s.position=b,s.val=c(s.index++)),f|=(0<g?1:0)*k,k<<=1;l=String.fromCharCode(f);break;case 1:for(f=0,h=Math.pow(2,16),k=1;k!=h;)g=s.val&s.position,s.position>>=1,0==s.position&&(s.position=b,s.val=c(s.index++)),f|=(0<g?1:0)*k,k<<=1;l=String.fromCharCode(f);break;case 2:return""}for(m[3]=l,e=l,r.push(l);;){if(s.index>a)return"";for(f=0,h=Math.pow(2,p),k=1;k!=h;)g=s.val&s.position,s.position>>=1,0==s.position&&(s.position=b,s.val=c(s.index++)),f|=(0<g?1:0)*k,k<<=1;switch(l=f){case 0:for(f=0,h=Math.pow(2,8),k=1;k!=h;)g=s.val&s.position,s.position>>=1,0==s.position&&(s.position=b,s.val=c(s.index++)),f|=(0<g?1:0)*k,k<<=1;m[o++]=String.fromCharCode(f);l=o-1;n--;break;case 1:for(f=0,h=Math.pow(2,16),k=1;k!=h;)g=s.val&s.position,s.position>>=1,0==s.position&&(s.position=b,s.val=c(s.index++)),f|=(0<g?1:0)*k,k<<=1;m[o++]=String.fromCharCode(f);l=o-1;n--;break;case 2:return r.join("")}if(0==n&&(n=Math.pow(2,p),p++),m[l])q=m[l];else if(l===o)q=e+e.charAt(0);else return null;r.push(q);m[o++]=e+q.charAt(0);n--;e=q;0==n&&(n=Math.pow(2,p),p++)}}};

let cloudEnabled = false;

let BUSINESSES = JSON.parse(JSON.stringify(DEFAULT_BUSINESSES));
let currentBusiness = '元amuse';
let currentPeriod = null;
let chartInstance = null;
let cryptoPieChart = null;
let gamePieChart = null;
let providerPieChart = null;
let retentionChart = null;
let viewMode = 'period';

// ========== ユーティリティ ==========
function parseNumber(val) {
  if (val === undefined || val === null || val === '' || val === '-' || String(val).startsWith('#')) return null;
  if (typeof val === 'number') return val;
  let cleaned = String(val).replace(/[¥￥$,、"\s]/g, '').trim();
  if (cleaned.endsWith('%')) cleaned = cleaned.replace(/%$/, '');
  const num = parseFloat(cleaned);
  return isNaN(num) ? null : num;
}
function formatCurrency(val) {
  if (val == null || isNaN(val)) return '-';
  const abs = Math.abs(val); const sign = val < 0 ? '-' : '';
  if (abs >= 100000000) return sign + '¥' + (abs / 100000000).toFixed(2) + '億';
  if (abs >= 10000) return sign + '¥' + Math.round(abs / 10000).toLocaleString() + '万';
  return sign + '¥' + Math.round(abs).toLocaleString();
}
function formatPercent(val) { 
  if (val == null || isNaN(val)) return '-'; 
  let v = Math.abs(val) <= 1 ? val * 100 : val; 
  return v.toFixed(2) + '%'; 
}
function formatRTP(val) {
  if (val == null || isNaN(val)) return '-';
  // 控除率（0.02など小さい値）の場合はRTPに変換
  let v = val;
  if (v <= 0.1) v = 1 - v; // 控除率をRTPに変換
  v = Math.abs(v) <= 1 ? v * 100 : v;
  return v.toFixed(2) + '%';
}
function formatNumber(val) { if (val == null || isNaN(val)) return '-'; return Math.round(val).toLocaleString(); }
function sortPeriods(periods) {
  return [...periods].sort((a, b) => {
    const mA = a.match(/(\d{4})年(\d{1,2})月/), mB = b.match(/(\d{4})年(\d{1,2})月/);
    if (mA && mB) { const yA = parseInt(mA[1]), monA = parseInt(mA[2]), yB = parseInt(mB[1]), monB = parseInt(mB[2]); return (yB * 12 + monB) - (yA * 12 + monA); }
    return b.localeCompare(a);
  });
}

// ========== クラウド同期 ==========
function getBinIdFromURL() { return ''; }
function setBinIdToURL(binId) { }
function updateSyncStatus(msg, isError = false) { const el = document.getElementById('sync-status'); el.textContent = isError ? '⚠️ ' + msg : '💾 ' + msg; el.style.color = isError ? '#ef4444' : '#10b981'; }

function getShareDataFromURL() {
  const hash = window.location.hash;
  if (hash && hash.startsWith('#data=')) {
    try {
      const compressed = hash.substring(6);
      const json = LZString.decompressFromEncodedURIComponent(compressed);
      return json ? JSON.parse(json) : null;
    } catch (e) { console.error('URL data parse error:', e); }
  }
  return null;
}

function createShareLink() {
  try {
    updateSyncStatus('リンク作成中...');
    // 全データを共有（DEFAULT含む）
    const toShare = {};
    Object.keys(BUSINESSES).forEach(key => {
      toShare[key] = BUSINESSES[key];
    });
    
    const json = JSON.stringify(toShare);
    const compressed = LZString.compressToEncodedURIComponent(json);
    const baseUrl = window.location.href.split('#')[0].split('?')[0];
    const shareUrl = baseUrl + '#data=' + compressed;
    
    if (shareUrl.length > 100000) {
      alert('データが大きすぎます。\n一部の期間を削除してから共有してください。');
      updateSyncStatus('データ過大', true);
      return;
    }
    
    window.history.replaceState({}, '', shareUrl);
    updateSyncStatus('共有リンク作成済');
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(shareUrl).then(() => {
        alert('✅ 共有リンクをコピーしました！\n\nURL長: ' + shareUrl.length + '文字');
      }).catch(() => {
        prompt('共有リンク（コピーしてください）:', shareUrl);
      });
    } else {
      prompt('共有リンク（コピーしてください）:', shareUrl);
    }
  } catch (e) {
    console.error('createShareLink error:', e);
    updateSyncStatus('エラー', true);
    alert('共有リンクの作成に失敗しました。\nエラー: ' + e.message);
  }
}

function showShareURL() { createShareLink(); }
function saveToCloud() { }
function loadCloudData() { return {}; }
function clearCloudData() { }
function mergeWithDefault(sharedData) { const merged = JSON.parse(JSON.stringify(DEFAULT_BUSINESSES)); Object.keys(sharedData).forEach(key => { if (merged[key]) { merged[key].data = { ...merged[key].data, ...(sharedData[key].data || {}) }; merged[key].type = sharedData[key].type || merged[key].type; } else merged[key] = sharedData[key]; }); return merged; }
function saveBusinessData() { 
  try { 
    const backup = {}; 
    Object.keys(BUSINESSES).forEach(k => { 
      const def = DEFAULT_BUSINESSES[k]; 
      if (!def) backup[k] = BUSINESSES[k]; 
      else { 
        const newPeriods = {}; 
        Object.keys(BUSINESSES[k].data).forEach(p => { 
          if (!def.data[p]) newPeriods[p] = BUSINESSES[k].data[p]; 
        }); 
        if (Object.keys(newPeriods).length > 0) backup[k] = { data: newPeriods, type: BUSINESSES[k].type }; 
      } 
    }); 
    localStorage.setItem('dashboard_backup', JSON.stringify(backup)); 
    updateSyncStatus('保存完了');
  } catch (e) { console.error('saveBusinessData error:', e); } 
}
async function clearAllData() { if (confirm('全データを削除しますか？')) { localStorage.removeItem('dashboard_backup'); window.location.href = window.location.pathname; } }
function initializeData() { 
  // 1. URLからデータを読み込む
  const urlData = getShareDataFromURL();
  if (urlData && Object.keys(urlData).length > 0) {
    BUSINESSES = urlData;
    updateSyncStatus('共有データ読込済');
    selectBusiness(currentBusiness);
    return;
  }
  
  // 2. ローカルバックアップから読み込む
  try { 
    const backup = localStorage.getItem('dashboard_backup'); 
    if (backup) { 
      const parsed = JSON.parse(backup); 
      Object.keys(parsed).forEach(key => { 
        if (BUSINESSES[key]) BUSINESSES[key].data = { ...BUSINESSES[key].data, ...parsed[key].data }; 
        else BUSINESSES[key] = parsed[key]; 
      }); 
      updateSyncStatus('ローカル');
    } else {
      updateSyncStatus('ローカル');
    }
  } catch (e) { 
    updateSyncStatus('ローカル'); 
  } 
  selectBusiness(currentBusiness); 
}
document.addEventListener('DOMContentLoaded', () => { initializeData(); renderTabs(); setupDragDrop(); });

// ========== 表示モード ==========
function setViewMode(mode) {
  viewMode = mode;
  document.getElementById('view-period').classList.toggle('active', mode === 'period');
  document.getElementById('view-total').classList.toggle('active', mode === 'total');
  document.getElementById('period-selector').classList.toggle('hidden', mode === 'total');
  document.getElementById('totals-section').classList.toggle('hidden', mode !== 'total');
  if (mode === 'total') renderTotalsSection();
  renderSummary(); renderCryptoSection(); renderGameSection(); renderProviderSection();
}

// ========== トータル・平均計算 ==========
function calculateTotalsAndAverages(businessName) {
  const business = BUSINESSES[businessName]; if (!business || !business.data) return null;
  const periods = Object.keys(business.data); if (periods.length === 0) return null;
  const totals = {}, counts = {};
  periods.forEach(period => {
    const periodData = business.data[period], summary = periodData?.サマリー || periodData || {};
    Object.entries(summary).forEach(([key, val]) => { if (typeof val === 'number' && !isNaN(val)) { if (!totals[key]) { totals[key] = 0; counts[key] = 0; } totals[key] += val; counts[key]++; } });
  });
  const result = { totals: {}, averages: {}, periodCount: periods.length };
  Object.keys(totals).forEach(key => { result.totals[key] = totals[key]; result.averages[key] = totals[key] / counts[key]; });
  return result;
}

function renderTotalsSection() {
  const container = document.getElementById('totals-grid');
  const result = calculateTotalsAndAverages(currentBusiness);
  if (!result) { container.innerHTML = '<p style="opacity:0.7">データがありません</p>'; return; }
  const business = BUSINESSES[currentBusiness], type = business?.type || 'samExcel';
  let metrics = type === 'samExcel' ? [
    { key: 'T/O', alt: ['総TO'], label: 'T/O', type: 'total' },
    { key: 'GGR(WIN/LOSE)', alt: ['GGR','WIN/LOSE'], label: 'GGR', type: 'total' },
    { key: 'NGR', alt: ['総NGR'], label: 'NGR', type: 'total' },
    { key: '回収金額', alt: ['総回収額'], label: '回収金額', type: 'total' },
    { key: '出金金額', alt: ['総出金額'], label: '出金金額', type: 'total' },
    { key: 'RTP', label: 'RTP', type: 'avg', format: 'rtp' },
    { key: '回収率(全体)', label: '回収率', type: 'avg', format: 'percent' },
    { key: 'FTD数', label: 'FTD数', type: 'total', format: 'number' },
    { key: '残未回収金額', label: '未回収金額', type: 'total' },
    { key: '遅れ回収金額', label: '遅れ回収', type: 'total' }
  ] : type === 'sloten' ? [
    { key: 'GGR', label: 'GGR', type: 'total' },
    { key: '総入金額', label: '総入金額', type: 'total' },
    { key: '総出金額', label: '総出金額', type: 'total' },
    { key: '入出金差分', label: '入出金差分', type: 'total' },
    { key: '登録人数', label: '登録人数', type: 'total', format: 'number' },
    { key: 'RTP', label: 'RTP', type: 'avg', format: 'rtp' }
  ] : type === 'agent' ? [
    { key: '入金合計', label: '入金合計', type: 'total' },
    { key: '出金合計', label: '出金合計', type: 'total' },
    { key: '収益合計', label: '収益合計', type: 'total' },
    { key: 'NGR', label: 'NGR', type: 'total' },
    { key: 'ローリング報酬', label: 'ローリング', type: 'total' }
  ] : type === 'ads' ? [
    { key: 'コスト($)', label: 'コスト($)', type: 'total', format: 'number' },
    { key: 'インプレッション', label: 'IMP', type: 'total', format: 'number' },
    { key: 'クリック', label: 'クリック', type: 'total', format: 'number' },
    { key: '登録数', label: '登録', type: 'total', format: 'number' },
    { key: '入金数', label: '入金', type: 'total', format: 'number' }
  ] : type === 'baccara' ? [
    { key: '登録数', label: '登録数', type: 'total', format: 'number' },
    { key: '総GGR', label: 'GGR', type: 'total' },
    { key: 'コスト', label: 'コスト', type: 'total' },
    { key: 'NGR', label: 'NGR', type: 'total' }
  ] : [];
  container.innerHTML = `<div class="total-card" style="grid-column:span 2;"><h4>📅 対象期間数</h4><div class="main-val">${result.periodCount}期間</div></div>` + metrics.map(m => { 
    let totalVal = result.totals[m.key], avgVal = result.averages[m.key]; 
    if ((totalVal == null) && m.alt) { for (const k of m.alt) { if (result.totals[k] != null) { totalVal = result.totals[k]; avgVal = result.averages[k]; break; } } } 
    if (totalVal == null) return ''; 
    let fT, fA; 
    if (m.format === 'rtp') { fT = '-'; fA = formatRTP(avgVal); } 
    else if (m.format === 'percent') { fT = '-'; fA = formatPercent(avgVal); } 
    else if (m.format === 'number') { fT = formatNumber(totalVal); fA = formatNumber(avgVal); } 
    else { fT = formatCurrency(totalVal); fA = formatCurrency(avgVal); } 
    return `<div class="total-card"><h4>${m.label}</h4><div class="main-val">${m.type === 'total' ? fT : fA}</div><div class="sub-val">${m.type === 'total' ? '平均: ' + fA : ''}</div></div>`; 
  }).join('');
}

// ========== 仮想通貨セクション（円グラフ付き） ==========
function renderCryptoSection() {
  const section = document.getElementById('crypto-section');
  const container = document.getElementById('crypto-grid');
  const business = BUSINESSES[currentBusiness];
  
  let cryptoData = null;
  let depositTotal = 0;
  let withdrawTotal = 0;
  
  if (viewMode === 'total') {
    // 全期間：全ての期間の仮想通貨データを集計
    const allCrypto = {};
    const periods = Object.keys(business?.data || {});
    periods.forEach(period => {
      const periodCrypto = business.data[period]?.仮想通貨;
      if (periodCrypto) {
        Object.entries(periodCrypto).forEach(([coin, data]) => {
          if (!allCrypto[coin]) allCrypto[coin] = { 件数: 0, 金額: 0 };
          allCrypto[coin].件数 += data.件数 || 0;
          allCrypto[coin].金額 += data.金額 || 0;
        });
      }
      depositTotal += business.data[period]?.入金方法?.['仮想通貨'] || 0;
      withdrawTotal += business.data[period]?.出金方法?.['仮想通貨'] || 0;
    });
    if (Object.keys(allCrypto).length > 0) cryptoData = allCrypto;
  } else {
    const periodData = business?.data?.[currentPeriod];
    cryptoData = periodData?.仮想通貨 || null;
    depositTotal = periodData?.入金方法?.['仮想通貨'] || 0;
    withdrawTotal = periodData?.出金方法?.['仮想通貨'] || 0;
  }
  
  if (!cryptoData && depositTotal === 0 && withdrawTotal === 0) { section.classList.add('hidden'); return; }
  section.classList.remove('hidden');
  
  // 円グラフ用データ
  const labels = [], values = [], colors = ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];
  let html = '';
  
  if (cryptoData && Object.keys(cryptoData).length > 0) {
    const total = Object.values(cryptoData).reduce((sum, c) => sum + (c.金額 || 0), 0);
    Object.entries(cryptoData).forEach(([coin, data], i) => {
      const amount = data.金額 || 0;
      const pct = total > 0 ? (amount / total * 100).toFixed(1) : 0;
      labels.push(coin); values.push(amount);
      html += `<div class="crypto-card"><h5>${coin}</h5><div class="crypto-val">${formatCurrency(amount)}</div><div class="crypto-pct">${data.件数 || 0}件 (${pct}%)</div></div>`;
    });
    html = `<div class="crypto-card" style="grid-column:span 2;background:#dcfce7;"><h5>💰 仮想通貨合計</h5><div class="crypto-val">${formatCurrency(total)}</div></div>` + html;
  } else {
    if (depositTotal > 0) { labels.push('入金'); values.push(depositTotal); html += `<div class="crypto-card"><h5>入金</h5><div class="crypto-val">${formatCurrency(depositTotal)}</div></div>`; }
    if (withdrawTotal > 0) { labels.push('出金'); values.push(withdrawTotal); html += `<div class="crypto-card"><h5>出金</h5><div class="crypto-val">${formatCurrency(withdrawTotal)}</div></div>`; }
  }
  
  container.innerHTML = html;
  
  // 円グラフ描画
  if (cryptoPieChart) cryptoPieChart.destroy();
  if (values.length > 0) {
    const ctx = document.getElementById('crypto-pie-chart').getContext('2d');
    cryptoPieChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, values.length) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } } } });
  }
}

// ========== ゲーム種別セクション（円グラフ付き） ==========
function renderGameSection() {
  const section = document.getElementById('game-section');
  const container = document.getElementById('game-grid');
  const business = BUSINESSES[currentBusiness];
  
  let games = null;
  
  if (viewMode === 'total') {
    // 全期間：全ての期間のゲーム別データを集計
    const allGames = {};
    const periods = Object.keys(business?.data || {});
    periods.forEach(period => {
      const periodGames = business.data[period]?.ゲーム別;
      if (periodGames) {
        Object.entries(periodGames).forEach(([game, stats]) => {
          if (!allGames[game]) allGames[game] = { ユーザー数: 0, TO: 0, GGR: 0 };
          allGames[game].ユーザー数 += stats.ユーザー数 || 0;
          allGames[game].TO += stats.TO || 0;
          allGames[game].GGR += stats.GGR || 0;
        });
      }
    });
    if (Object.keys(allGames).length > 0) games = allGames;
  } else {
    const periodData = business?.data?.[currentPeriod];
    games = periodData?.ゲーム別;
  }
  
  if (!games || Object.keys(games).length === 0) { section.classList.add('hidden'); return; }
  section.classList.remove('hidden');
  
  const labels = [], values = [], colors = ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6'];
  let html = '';
  
  Object.entries(games).forEach(([game, stats], i) => {
    const ggr = stats.GGR || 0;
    labels.push(game); values.push(Math.max(0, ggr));
    html += `<div class="provider-card"><h5>🎰 ${game}</h5><div class="provider-stats"><div class="stat-item"><div class="stat-label">ユーザー数</div><div class="stat-val">${formatNumber(stats.ユーザー数)}</div></div><div class="stat-item"><div class="stat-label">T/O</div><div class="stat-val">${formatCurrency(stats.TO)}</div></div><div class="stat-item"><div class="stat-label">GGR</div><div class="stat-val">${formatCurrency(ggr)}</div></div><div class="stat-item"><div class="stat-label">RTP</div><div class="stat-val">${stats.TO > 0 ? formatRTP((stats.TO - ggr) / stats.TO) : '-'}</div></div></div></div>`;
  });
  
  container.innerHTML = html;
  
  if (gamePieChart) gamePieChart.destroy();
  if (values.length > 0) {
    const ctx = document.getElementById('game-pie-chart').getContext('2d');
    gamePieChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, values.length) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } } } });
  }
}

// ========== プロバイダー別セクション（円グラフ付き） ==========
function renderProviderSection() {
  const section = document.getElementById('provider-section');
  const container = document.getElementById('provider-grid');
  const business = BUSINESSES[currentBusiness];
  
  let providers = null;
  
  if (viewMode === 'total') {
    // 全期間：全ての期間のプロバイダーデータを集計
    const allProviders = {};
    const periods = Object.keys(business?.data || {});
    periods.forEach(period => {
      const periodProviders = business.data[period]?.プロバイダー;
      if (periodProviders) {
        Object.entries(periodProviders).forEach(([name, stats]) => {
          if (!allProviders[name]) allProviders[name] = { ユーザー数: 0, 賭け金額: 0, 配当金額: 0, GGR: 0 };
          allProviders[name].ユーザー数 += stats.ユーザー数 || 0;
          allProviders[name].賭け金額 += stats.賭け金額 || 0;
          allProviders[name].配当金額 += stats.配当金額 || 0;
          allProviders[name].GGR += stats.GGR || 0;
        });
      }
    });
    if (Object.keys(allProviders).length > 0) providers = allProviders;
  } else {
    const periodData = business?.data?.[currentPeriod];
    providers = periodData?.プロバイダー;
  }
  
  if (!providers || Object.keys(providers).length === 0) { section.classList.add('hidden'); return; }
  section.classList.remove('hidden');
  
  const labels = [], values = [], colors = ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#06b6d4', '#84cc16'];
  let html = '';
  
  // GGRでソート
  const sorted = Object.entries(providers).sort((a, b) => (b[1].GGR || 0) - (a[1].GGR || 0));
  sorted.forEach(([name, stats], i) => {
    const ggr = stats.GGR || 0;
    labels.push(name); values.push(Math.max(0, ggr));
    html += `<div class="provider-card"><h5>🏭 ${name}</h5><div class="provider-stats"><div class="stat-item"><div class="stat-label">ユーザー数</div><div class="stat-val">${formatNumber(stats.ユーザー数)}</div></div><div class="stat-item"><div class="stat-label">賭け金額</div><div class="stat-val">${formatCurrency(stats.賭け金額)}</div></div><div class="stat-item"><div class="stat-label">GGR</div><div class="stat-val">${formatCurrency(ggr)}</div></div><div class="stat-item"><div class="stat-label">RTP</div><div class="stat-val">${stats.賭け金額 > 0 ? formatRTP(stats.配当金額 / stats.賭け金額) : '-'}</div></div></div></div>`;
  });
  
  container.innerHTML = html;
  
  if (providerPieChart) providerPieChart.destroy();
  if (values.length > 0) {
    const ctx = document.getElementById('provider-pie-chart').getContext('2d');
    providerPieChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, values.length) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } } } });
  }
}

// ========== 継続KPI推移グラフ ==========
function renderRetentionChart() {
  const section = document.getElementById('retention-chart-section');
  const business = BUSINESSES[currentBusiness];
  
  // スロ天以外は非表示
  if (business?.type !== 'sloten') {
    section.classList.add('hidden');
    if (retentionChart) { retentionChart.destroy(); retentionChart = null; }
    return;
  }
  
  const data = business.data || {};
  const periods = sortPeriods(Object.keys(data)).reverse().slice(-12);
  
  if (periods.length === 0) {
    section.classList.add('hidden');
    return;
  }
  
  section.classList.remove('hidden');
  const ctx = document.getElementById('retention-chart').getContext('2d');
  if (retentionChart) retentionChart.destroy();
  
  const datasets = [
    {
      label: '登録人数',
      data: periods.map(p => data[p]?.サマリー?.['登録人数'] || 0),
      backgroundColor: 'rgba(59, 130, 246, 0.7)',
      borderColor: 'rgba(59, 130, 246, 1)',
      borderWidth: 2,
      type: 'bar'
    },
    {
      label: '前月登録からの継続',
      data: periods.map(p => data[p]?.サマリー?.['前月登録ユーザー数'] || 0),
      backgroundColor: 'rgba(16, 185, 129, 0.7)',
      borderColor: 'rgba(16, 185, 129, 1)',
      borderWidth: 2,
      type: 'bar'
    },
    {
      label: '前々月登録からの継続',
      data: periods.map(p => data[p]?.サマリー?.['前々月登録ユーザー数'] || 0),
      backgroundColor: 'rgba(245, 158, 11, 0.7)',
      borderColor: 'rgba(245, 158, 11, 1)',
      borderWidth: 2,
      type: 'bar'
    },
    {
      label: '3か月以上前からの継続',
      data: periods.map(p => data[p]?.サマリー?.['3か月以上前登録ユーザー数'] || 0),
      backgroundColor: 'rgba(139, 92, 246, 0.7)',
      borderColor: 'rgba(139, 92, 246, 1)',
      borderWidth: 2,
      type: 'bar'
    },
    {
      label: '前月継続率',
      data: periods.map(p => {
        const rate = data[p]?.サマリー?.['前月継続率'];
        return rate ? rate * 100 : 0;
      }),
      borderColor: 'rgba(239, 68, 68, 1)',
      backgroundColor: 'rgba(239, 68, 68, 0.1)',
      borderWidth: 3,
      type: 'line',
      yAxisID: 'y1',
      tension: 0.3
    }
  ];
  
  retentionChart = new Chart(ctx, {
    data: { labels: periods, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'top' } },
      scales: {
        y: {
          beginAtZero: true,
          position: 'left',
          title: { display: true, text: '人数' },
          ticks: { callback: v => v.toLocaleString() }
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          max: 100,
          title: { display: true, text: '継続率(%)' },
          grid: { drawOnChartArea: false },
          ticks: { callback: v => v + '%' }
        }
      }
    }
  });
}

// ========== メイン描画 ==========
function renderTabs() { const container = document.getElementById('business-tabs'); container.innerHTML = Object.keys(BUSINESSES).map(name => `<button class="tab ${name === currentBusiness ? 'active' : ''}" onclick="selectBusiness('${name}')">${name}</button>`).join('') + '<button class="btn btn-danger" onclick="deleteBusiness()" style="margin-left:auto">🗑️</button>'; }
function selectBusiness(name) { currentBusiness = name; const business = BUSINESSES[name], data = business?.data || {}, periods = sortPeriods(Object.keys(data)); currentPeriod = periods[0] || null; renderTabs(); renderPeriodSelector(periods); if (viewMode === 'total') renderTotalsSection(); renderSummary(); renderKPISections(); renderCryptoSection(); renderGameSection(); renderProviderSection(); renderChart(); renderRetentionChart(); renderTable(); }
function renderPeriodSelector(periods) { const container = document.getElementById('period-selector'); if (periods.length === 0) { container.innerHTML = '<span style="color:#94a3b8;font-size:13px">データをアップロードしてください</span>'; return; } container.innerHTML = periods.map(p => `<button class="period-btn ${p === currentPeriod ? 'active' : ''}" onclick="selectPeriod('${p}')">${p}</button>`).join('') + `<button class="btn btn-danger" style="padding:4px 10px;font-size:11px" onclick="deletePeriod()">期間削除</button>`; }
function selectPeriod(period) { currentPeriod = period; renderPeriodSelector(sortPeriods(Object.keys(BUSINESSES[currentBusiness]?.data || {}))); renderSummary(); renderKPISections(); renderCryptoSection(); renderGameSection(); renderProviderSection(); renderTable(); }
function deletePeriod() { const business = BUSINESSES[currentBusiness], periods = Object.keys(business?.data || {}); if (periods.length <= 1) { alert('最後の期間は削除できません'); return; } if (confirm(`「${currentPeriod}」を削除しますか？`)) { delete business.data[currentPeriod]; saveBusinessData(); selectBusiness(currentBusiness); } }

function renderSummary() {
  const container = document.getElementById('summary-section');
  const business = BUSINESSES[currentBusiness];
  if (!business) { container.innerHTML = ''; return; }
  let data;
  if (viewMode === 'total') { const result = calculateTotalsAndAverages(currentBusiness); if (!result) { container.innerHTML = ''; return; } data = result.totals; }
  else { const periodData = business.data?.[currentPeriod]; data = periodData?.サマリー || periodData || {}; }
  if (!data || Object.keys(data).length === 0) { container.innerHTML = '<div class="card" style="text-align:center;padding:40px;color:#94a3b8">データがありません</div>'; return; }
  const type = business.type || 'samExcel';
  const colors = ['linear-gradient(135deg,#3b82f6,#1d4ed8)','linear-gradient(135deg,#10b981,#059669)','linear-gradient(135deg,#f59e0b,#d97706)','linear-gradient(135deg,#ef4444,#dc2626)','linear-gradient(135deg,#8b5cf6,#7c3aed)','linear-gradient(135deg,#ec4899,#db2777)'];
  
  // Konibet専用の詳細サマリー表示
  if (type === 'konibet') {
    // 基本指標グループ
    const basicCards = [
      { key: '登録人数', alt: ['登録'], label: '登録人数', format: 'number' },
      { key: 'FTD数', alt: ['FTD', '初回入金人数(FTD)'], label: 'FTD数', format: 'number' },
      { key: '入金者数', alt: ['入金人数'], label: '入金者数', format: 'number' },
      { key: '総入金額', alt: ['入金額'], label: '総入金額' },
      { key: 'T/O', alt: ['ターンオーバー'], label: 'T/O' },
      { key: 'アクティブプレイ人数', alt: ['アクティブプレイ数', 'ベット人数', 'MAU'], label: 'アクティブ人数', format: 'number' }
    ];
    // 収益指標グループ
    const revenueCards = [
      { key: 'GGR', label: 'GGR' },
      { key: '入出金差分', alt: ['入金と出金の差'], label: '入出金差分' },
      { key: 'ボーナス', alt: ['ボーナス（FS除く）'], label: 'ボーナス' },
      { key: 'NGR', label: 'NGR' }
    ];
    // 比率指標グループ
    const ratioCards = [
      { key: '新規入金転移率', label: '新規入金転移率', format: 'percent' },
      { key: '平均入金額', alt: ['平均入金額(人数/デイリ)'], label: '平均入金額' },
      { key: '出金人数割合', label: '出金人数割合', format: 'percent' },
      { key: 'T/O倍率', label: 'T/O倍率', format: 'number' },
      { key: 'ボーナス付与率', alt: ['ボーナス付与率(入金に対して)'], label: 'ボーナス付与率', format: 'percent' },
      { key: 'GGR率', alt: ['入金額に対してのGGR割合'], label: 'GGR率', format: 'percent' },
      { key: 'NGR率', alt: ['入金に対してのNGR割合'], label: 'NGR率', format: 'percent' }
    ];
    
    const renderCardGroup = (cards, title, bgColors) => {
      const cardHtml = cards.map((card, i) => {
        let val = data[card.key];
        if (val == null && card.alt) { for (const k of card.alt) { if (data[k] != null) { val = data[k]; break; } } }
        if (val == null) return '';
        let formatted = card.format === 'percent' ? formatPercent(val) : card.format === 'number' ? formatNumber(val) : formatCurrency(val);
        const bg = val < 0 && card.format !== 'percent' ? 'linear-gradient(135deg,#ef4444,#dc2626)' : bgColors[i % bgColors.length];
        return `<div class="summary-card" style="background:${bg}"><h3>${card.label}</h3><div class="value">${formatted}</div></div>`;
      }).filter(h => h).join('');
      if (!cardHtml) return '';
      return `<div style="margin-bottom:16px"><div style="font-size:12px;color:#64748b;margin-bottom:8px;font-weight:600">${title}</div><div class="summary-grid">${cardHtml}</div></div>`;
    };
    
    const basicColors = ['linear-gradient(135deg,#3b82f6,#1d4ed8)','linear-gradient(135deg,#0ea5e9,#0284c7)','linear-gradient(135deg,#06b6d4,#0891b2)','linear-gradient(135deg,#14b8a6,#0d9488)','linear-gradient(135deg,#10b981,#059669)','linear-gradient(135deg,#22c55e,#16a34a)'];
    const revenueColors = ['linear-gradient(135deg,#f59e0b,#d97706)','linear-gradient(135deg,#f97316,#ea580c)','linear-gradient(135deg,#ef4444,#dc2626)','linear-gradient(135deg,#8b5cf6,#7c3aed)'];
    const ratioColors = ['linear-gradient(135deg,#6366f1,#4f46e5)','linear-gradient(135deg,#8b5cf6,#7c3aed)','linear-gradient(135deg,#a855f7,#9333ea)','linear-gradient(135deg,#d946ef,#c026d3)','linear-gradient(135deg,#ec4899,#db2777)','linear-gradient(135deg,#f43f5e,#e11d48)','linear-gradient(135deg,#fb7185,#f43f5e)'];
    
    container.innerHTML = renderCardGroup(basicCards, '📊 基本指標', basicColors) + 
                         renderCardGroup(revenueCards, '💰 収益指標', revenueColors) + 
                         renderCardGroup(ratioCards, '📈 比率指標', ratioColors);
    return;
  }
  
  // バカラツール専用の詳細サマリー表示
  if (type === 'baccara') {
    const followerCards = [
      { key: 'Twitter', label: 'Twitter', format: 'number' },
      { key: 'Instagram', label: 'Instagram', format: 'number' },
      { key: 'TikTok', label: 'TikTok', format: 'number' },
      { key: 'YouTube', label: 'YouTube', format: 'number' },
      { key: 'LINE公式', label: 'LINE公式', format: 'number' },
      { key: '合計フォロワー', label: '合計', format: 'number' }
    ];
    const bizCards = [
      { key: '総ユーザー数', label: 'ユーザー数', format: 'number' },
      { key: '総入金額', label: '総入金額' },
      { key: '平均T/O', label: '平均T/O' },
      { key: '総GGR', label: 'GGR' },
      { key: 'コスト', label: 'コスト' },
      { key: 'NGR', label: 'NGR' }
    ];
    const renderCardGroup = (cards, title, bgColors) => {
      const cardHtml = cards.map((card, i) => {
        let val = data[card.key];
        if (val == null) return '';
        let formatted = card.format === 'number' ? formatNumber(val) : formatCurrency(val);
        const bg = val < 0 ? 'linear-gradient(135deg,#ef4444,#dc2626)' : bgColors[i % bgColors.length];
        return `<div class="summary-card" style="background:${bg}"><h3>${card.label}</h3><div class="value">${formatted}</div></div>`;
      }).filter(h => h).join('');
      if (!cardHtml) return '';
      return `<div style="margin-bottom:16px"><div style="font-size:12px;color:#64748b;margin-bottom:8px;font-weight:600">${title}</div><div class="summary-grid">${cardHtml}</div></div>`;
    };
    const followerColors = ['linear-gradient(135deg,#3b82f6,#1d4ed8)','linear-gradient(135deg,#ec4899,#db2777)','linear-gradient(135deg,#000000,#333333)','linear-gradient(135deg,#ef4444,#dc2626)','linear-gradient(135deg,#22c55e,#16a34a)','linear-gradient(135deg,#8b5cf6,#7c3aed)'];
    const bizColors = ['linear-gradient(135deg,#10b981,#059669)','linear-gradient(135deg,#f59e0b,#d97706)','linear-gradient(135deg,#f97316,#ea580c)','linear-gradient(135deg,#22c55e,#16a34a)','linear-gradient(135deg,#ef4444,#dc2626)','linear-gradient(135deg,#8b5cf6,#7c3aed)'];
    container.innerHTML = renderCardGroup(followerCards, '📱 SNSフォロワー数', followerColors) + renderCardGroup(bizCards, '💰 収益', bizColors);
    return;
  }
  
  let cards = type === 'samExcel' ? [{ key: 'T/O', label: 'T/O' },{ key: 'GGR(WIN/LOSE)', alt: ['GGR','WIN/LOSE'], label: 'GGR' },{ key: 'NGR', label: 'NGR' },{ key: '回収率(全体)', alt: ['回収率'], label: '回収率', format: 'percent' },{ key: 'GGR(回収金額-出金金額)', label: '入出金差分' }] : type === 'sloten' ? [{ key: 'GGR', label: 'GGR' },{ key: '総入金額', label: '総入金額' },{ key: '総出金額', label: '総出金額' },{ key: '入出金差分', label: '入出金差分' },{ key: 'RTP', label: 'RTP', format: 'percent' },{ key: '登録人数', label: '登録人数', format: 'number' }] : type === 'ads' ? [{ key: 'コスト($)', label: 'コスト($)', format: 'number' },{ key: 'インプレッション', label: 'IMP', format: 'number' },{ key: 'クリック', label: 'クリック', format: 'number' },{ key: '登録数', label: '登録', format: 'number' },{ key: '入金数', label: '入金', format: 'number' },{ key: 'CPA(税込)', label: 'CPA' }] : type === 'agent' ? [{ key: '入金合計', label: '入金合計' },{ key: '出金合計', label: '出金合計' },{ key: '収益合計', label: '収益合計' },{ key: 'NGR', label: 'NGR' }] : [];
  container.innerHTML = '<div class="summary-grid">' + cards.map((card, i) => { let val = data[card.key]; if (val == null && card.alt) { for (const k of card.alt) { if (data[k] != null) { val = data[k]; break; } } } if (val == null) return ''; let formatted = card.key === 'RTP' ? formatRTP(val) : card.format === 'percent' ? formatPercent(val) : card.format === 'number' ? formatNumber(val) : formatCurrency(val); const bg = val < 0 && card.format !== 'percent' ? 'linear-gradient(135deg,#ef4444,#dc2626)' : colors[i % colors.length]; return `<div class="summary-card" style="background:${bg}"><h3>${card.label}</h3><div class="value">${formatted}</div></div>`; }).join('') + '</div>';
}

function renderKPISections() {
  const container = document.getElementById('kpi-sections');
  const business = BUSINESSES[currentBusiness];
  if (!business) { container.innerHTML = ''; return; }
  
  let data;
  if (viewMode === 'total') {
    const result = calculateTotalsAndAverages(currentBusiness);
    if (!result) { container.innerHTML = ''; return; }
    data = result.totals;
  } else {
    const periodData = business.data?.[currentPeriod];
    data = periodData?.サマリー || periodData || {};
  }
  
  if (!data || Object.keys(data).length === 0) { container.innerHTML = ''; return; }
  const type = business.type || 'samExcel';
  if (type === 'agent' || type === 'ads' || type === 'baccara') { container.innerHTML = ''; return; }
  
  // Konibet専用KPIセクション
  if (type === 'konibet') {
    const exchangeRate = data['為替レート(USD/JPY)'] || 150;
    const konibetSections = [
      { 
        title: '📊 実績', 
        keys: ['登録','FTD','MAU','入金額','ターンオーバー','AFF固定費','NGR'], 
        bg: '#dbeafe',
        format: { '登録': 'number', 'FTD': 'number', 'MAU': 'number', '入金額': 'currency', 'ターンオーバー': 'currency', 'AFF固定費': 'currency', 'NGR': 'currency' }
      },
      { 
        title: '🎯 目標', 
        keys: ['登録目標','FTD目標','MAU目標','入金額目標','ターンオーバー目標','AFF固定費目標','NGR目標'], 
        bg: '#fef3c7',
        format: { '登録目標': 'number', 'FTD目標': 'number', 'MAU目標': 'number', '入金額目標': 'currency', 'ターンオーバー目標': 'currency', 'AFF固定費目標': 'currency', 'NGR目標': 'currency' }
      },
      { 
        title: '📈 達成率', 
        keys: ['登録達成率','FTD達成率','MAU達成率','入金額達成率','ターンオーバー達成率','NGR達成率'], 
        bg: '#dcfce7',
        format: { '登録達成率': 'percent', 'FTD達成率': 'percent', 'MAU達成率': 'percent', '入金額達成率': 'percent', 'ターンオーバー達成率': 'percent', 'NGR達成率': 'percent' }
      }
    ];
    
    // 為替レート情報バナー
    container.innerHTML = `<div style="background:linear-gradient(135deg,#059669,#10b981);color:white;padding:12px 20px;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;gap:12px">
      <span style="font-size:20px">💱</span>
      <span><strong>為替レート:</strong> $1 = ¥${exchangeRate} で換算済み</span>
    </div>`;
    
    container.innerHTML += konibetSections.map(section => {
      const items = section.keys.filter(k => data[k] != null);
      if (items.length === 0) return '';
      return `<div class="card" style="background:${section.bg}"><div class="section-title">${section.title}</div><div class="kpi-grid">${items.map(key => {
        const val = data[key];
        const fmt = section.format[key];
        let formatted = fmt === 'percent' ? formatPercent(val) : fmt === 'currency' ? formatCurrency(val) : formatNumber(val);
        const isNeg = typeof val === 'number' && val < 0;
        const isLow = fmt === 'percent' && typeof val === 'number' && val < 0.8;
        return `<div class="kpi-item"><div class="label">${key}</div><div class="val ${isNeg ? 'negative' : ''}" style="${isLow ? 'color:#f59e0b' : ''}">${formatted}</div></div>`;
      }).join('')}</div></div>`;
    }).join('');
    
    // 週次詳細データがある場合は表示
    if (viewMode !== 'total') {
      const periodData = business.data?.[currentPeriod];
      if (periodData?.週次詳細 && periodData.週次詳細.length > 0) {
        container.innerHTML += `<div class="card" style="background:#f1f5f9">
          <div class="section-title">📅 週次詳細</div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>週</th>
                  <th class="text-right">登録</th>
                  <th class="text-right">FTD</th>
                  <th class="text-right">MAU</th>
                  <th class="text-right">入金額</th>
                  <th class="text-right">T/O</th>
                  <th class="text-right">NGR</th>
                  <th class="text-right">登録率</th>
                  <th class="text-right">入金率</th>
                </tr>
              </thead>
              <tbody>
                ${periodData.週次詳細.map(w => `
                  <tr>
                    <td>${w.週}</td>
                    <td class="text-right">${formatNumber(w.登録)}</td>
                    <td class="text-right">${formatNumber(w.FTD)}</td>
                    <td class="text-right">${formatNumber(w.MAU)}</td>
                    <td class="text-right">${formatCurrency(w.入金額)}</td>
                    <td class="text-right">${formatCurrency(w.ターンオーバー)}</td>
                    <td class="text-right ${w.NGR < 0 ? 'text-red' : ''}">${formatCurrency(w.NGR)}</td>
                    <td class="text-right">${formatPercent(w['登録達成率'])}</td>
                    <td class="text-right">${formatPercent(w['入金額達成率'])}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>`;
      }
    }
    return;
  }
  
  const sections = [
    { title: '📞 営業KPI', keys: ['リスト件数','総登録数','登録人数','打電数','着電数','LINE登録数','アカウント作成数','ログインユーザー数','アクティブプレイ人数（ユニーク）','アクティブユーザー数','入金者数(デイリーユニーク)'], bg: '#dbeafe' },
    { title: '🎯 転換KPI', keys: ['FTP数','FTP率','FTD数','FTD率','FTW数','FTW率','FTDW数','FTDW率','FTDのみ入金者数','FTDのみ率','2nd入金者数','2nd率','3rd入金者数','3rd率','Active入金者数','Active率','今月登録のFTD以降ユーザー数','今月登録FTD以降ユーザー割合'], bg: '#dcfce7' },
    { title: '🔄 継続KPI', keys: ['前月リテンション数','引継ぎプレイヤー数','前月登録ユーザー数','前月継続率','前々月登録ユーザー数','前々月継続率','3か月以上前登録ユーザー数','3か月以上前継続率'], bg: '#fef3c7' },
    { title: '💰 収益KPI', keys: ['T/O','総TO','T/O(リアルのみ)','勝利金','勝利金(リアルのみ)','RTP','GGR(WIN/LOSE)','GGR','WIN/LOSE','LTV(WIN/LOSE)','GGRLTV','総差分利益','総NGR','平均NGR'], bg: '#e0e7ff' },
    { title: '💵 回収KPI', keys: ['回収予定金額','回収金額','総回収額','回収率(全体)','回収率(今月)','出金金額','総出金額','GGR(回収金額-出金金額)','回収出金差分','LTV(GGR)','NGR','総入金額','入出金差分'], bg: '#fce7f3' },
    { title: '🏦 信用・ボーナスKPI', keys: ['総信用枠','平均信用枠','平均Credit単価','総ボーナス','ボーナス対象者数','総ボーナス付与金額','ボーナス対象入金額','ボーナス対象NGR'], bg: '#fef9c3' },
    { title: '📊 顧客分析KPI', keys: ['平均プレイ月間','事前清算回数','事前清算金額','事前清算割合','事前清算件数割合','通常清算回数','通常清算金額','通常清算割合','通常清算件数割合'], bg: '#e0f2fe' },
    { title: '⚠️ 未回収・遅れKPI', keys: ['未回収者数','残未回収金額','遅れ回収件数','遅れ回収金額'], bg: '#fee2e2' },
    { title: '👥 担当者KPI', keys: ['担当者数','担当者計_登録数','担当者計_FTD数','担当者計_GGR','担当者計_NGR'], bg: '#e0e7ff' }
  ];
  const percentKeys = ['FTP率','FTD率','FTW率','FTDW率','RTP','回収率(全体)','回収率(今月)','今月登録FTD以降ユーザー割合','前月継続率','前々月継続率','3か月以上前継続率','事前清算割合','通常清算割合','事前清算件数割合','通常清算件数割合','FTDのみ率','2nd率','3rd率','Active率'];
  const currencyKeys = ['T/O','総TO','T/O(リアルのみ)','勝利金','勝利金(リアルのみ)','GGR(WIN/LOSE)','GGR','WIN/LOSE','LTV(WIN/LOSE)','回収予定金額','回収金額','総回収額','出金金額','総出金額','GGR(回収金額-出金金額)','回収出金差分','LTV(GGR)','NGR','合計経費','プロバイダーフィー','人件費','通信費','インセンティブ','ペイメントフィー','雑費・福利厚生等','BK','利益','総入金額','総出金額','入出金差分','GGRLTV','総差分利益','総NGR','平均NGR','総信用枠','平均信用枠','平均Credit単価','総ボーナス','総ボーナス付与金額','ボーナス対象入金額','ボーナス対象NGR','残未回収金額','遅れ回収金額','担当者計_GGR','担当者計_NGR','事前清算金額','通常清算金額'];
  container.innerHTML = sections.map(section => { const items = section.keys.filter(k => data[k] != null); if (items.length === 0) return ''; return `<div class="card" style="background:${section.bg}"><div class="section-title">${section.title}</div><div class="kpi-grid">${items.map(key => { const val = data[key]; let formatted = key === 'RTP' ? formatRTP(val) : percentKeys.includes(key) ? formatPercent(val) : currencyKeys.includes(key) ? formatCurrency(val) : formatNumber(val); const isNeg = typeof val === 'number' && val < 0; return `<div class="kpi-item"><div class="label">${key}</div><div class="val ${isNeg ? 'negative' : ''}">${formatted}</div></div>`; }).join('')}</div></div>`; }).join('');
  
  // 入金/出金方法、Affiliate、リスト種別
  if (viewMode !== 'total') {
    const periodData = business.data?.[currentPeriod];
    if (periodData?.リスト種別) {
      const listOrder = ['B', 'E', 'T', 'S', 'BE', 'C', '紹介', 'その他'];
      const sortedList = listOrder.filter(k => periodData.リスト種別[k] != null).map(k => [k, periodData.リスト種別[k]]);
      container.innerHTML += `<div class="card" style="background:#f0fdf4"><div class="section-title">📋 リスト種別</div><div class="kpi-grid">${sortedList.map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatNumber(v)}件</div></div>`).join('')}</div></div>`;
    }
    if (periodData?.入金方法) container.innerHTML += `<div class="card" style="background:#e0f2fe"><div class="section-title">💳 入金方法</div><div class="kpi-grid">${Object.entries(periodData.入金方法).map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatCurrency(v)}</div></div>`).join('')}</div></div>`;
    if (periodData?.出金方法) container.innerHTML += `<div class="card" style="background:#fef9c3"><div class="section-title">🏦 出金方法</div><div class="kpi-grid">${Object.entries(periodData.出金方法).map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatCurrency(v)}</div></div>`).join('')}</div></div>`;
    if (periodData?.Affiliate) container.innerHTML += `<div class="card" style="background:#ecfdf5"><div class="section-title">🤝 Affiliate</div><div class="kpi-grid">${Object.entries(periodData.Affiliate).map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${k.includes('率') ? formatPercent(v) : k.includes('数') ? formatNumber(v) : formatCurrency(v)}</div></div>`).join('')}</div></div>`;
  } else {
    // 全期間モード：リスト種別を集計
    const allListTypes = {};
    const validListTypes = ['B', 'E', 'T', 'S', 'BE', 'C', '紹介'];
    const periods = Object.keys(business.data || {});
    periods.forEach(period => {
      const listTypes = business.data[period]?.リスト種別;
      if (listTypes) {
        Object.entries(listTypes).forEach(([type, count]) => {
          let targetType = validListTypes.includes(type) ? type : 'その他';
          if (!allListTypes[targetType]) allListTypes[targetType] = 0;
          allListTypes[targetType] += count;
        });
      }
    });
    if (Object.keys(allListTypes).length > 0) {
      const listOrder = ['B', 'E', 'T', 'S', 'BE', 'C', '紹介', 'その他'];
      const sortedList = listOrder.filter(k => allListTypes[k] != null).map(k => [k, allListTypes[k]]);
      container.innerHTML += `<div class="card" style="background:#f0fdf4"><div class="section-title">📋 リスト種別（全期間）</div><div class="kpi-grid">${sortedList.map(([k,v]) => `<div class="kpi-item"><div class="label">${k}</div><div class="val">${formatNumber(v)}件</div></div>`).join('')}</div></div>`;
    }
  }
}

function renderChart() {
  const ctx = document.getElementById('main-chart').getContext('2d');
  const business = BUSINESSES[currentBusiness];
  if (!business) { if (chartInstance) chartInstance.destroy(); return; }
  const data = business.data || {};
  const periods = sortPeriods(Object.keys(data)).reverse().slice(-12);
  if (chartInstance) chartInstance.destroy();
  if (periods.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); return; }
  const type = business.type || 'samExcel';
  let datasets = type === 'samExcel' ? [{ label: 'GGR', data: periods.map(p => { const d = data[p]?.サマリー || data[p] || {}; return d['GGR(WIN/LOSE)'] || d['GGR'] || d['WIN/LOSE'] || 0; }), backgroundColor: 'rgba(59,130,246,0.7)' },{ label: 'NGR', data: periods.map(p => (data[p]?.サマリー?.['NGR'] || data[p]?.['NGR'] || 0)), backgroundColor: 'rgba(16,185,129,0.7)' }] : type === 'sloten' ? [{ label: 'GGR', data: periods.map(p => (data[p]?.サマリー?.['GGR'] || data[p]?.['GGR'] || 0)), backgroundColor: 'rgba(59,130,246,0.7)' },{ label: '入出金差分', data: periods.map(p => (data[p]?.サマリー?.['入出金差分'] || data[p]?.['入出金差分'] || 0)), backgroundColor: 'rgba(16,185,129,0.7)' }] : type === 'konibet' ? [{ label: '入金額', data: periods.map(p => (data[p]?.サマリー?.['入金額'] || 0)), backgroundColor: 'rgba(59,130,246,0.7)' },{ label: 'NGR', data: periods.map(p => (data[p]?.サマリー?.['NGR'] || 0)), backgroundColor: 'rgba(16,185,129,0.7)' },{ label: 'ターンオーバー', data: periods.map(p => (data[p]?.サマリー?.['ターンオーバー'] || 0) / 10), backgroundColor: 'rgba(245,158,11,0.5)', hidden: true }] : [{ label: 'GGR', data: periods.map(p => (data[p]?.サマリー?.['総GGR'] || data[p]?.サマリー?.['GGR'] || 0)), backgroundColor: 'rgba(59,130,246,0.7)' }];
  chartInstance = new Chart(ctx, { type: 'bar', data: { labels: periods, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '¥' + (v / 1000000).toFixed(0) + 'M' } } } } });
}

function renderTable() {
  const business = BUSINESSES[currentBusiness];
  let data;
  if (viewMode === 'total') {
    const result = calculateTotalsAndAverages(currentBusiness);
    data = result ? result.totals : {};
  } else {
    const periodData = business?.data?.[currentPeriod];
    data = periodData?.サマリー || periodData || {};
  }
  const header = document.getElementById('table-header');
  const body = document.getElementById('table-body');
  header.innerHTML = '<th>項目</th><th class="text-right">値</th>';
  const percentKeys = ['FTP率','FTD率','FTW率','FTDW率','RTP','回収率(全体)','回収率(今月)','今月登録FTD以降ユーザー割合','前月継続率','前々月継続率'];
  const currencyKeys = ['T/O','総TO','T/O(リアルのみ)','勝利金','勝利金(リアルのみ)','GGR(WIN/LOSE)','GGR','WIN/LOSE','LTV(WIN/LOSE)','回収予定金額','回収金額','総回収額','出金金額','総出金額','GGR(回収金額-出金金額)','回収出金差分','LTV(GGR)','NGR','合計経費','プロバイダーフィー','人件費','通信費','インセンティブ','ペイメントフィー','雑費・福利厚生等','BK','利益','総入金額','入出金差分','GGRLTV','総差分利益','総NGR','平均NGR','総信用枠','平均信用枠','平均Credit単価','総ボーナス','総ボーナス付与金額','ボーナス対象入金額','ボーナス対象NGR','残未回収金額','遅れ回収金額','担当者計_GGR','担当者計_NGR','事前清算金額','通常清算金額'];
  const percentKeysTable = ['FTP率','FTD率','FTW率','FTDW率','RTP','回収率(全体)','回収率(今月)','今月登録FTD以降ユーザー割合','前月継続率','前々月継続率','3か月以上前継続率','事前清算割合','通常清算割合','事前清算件数割合','通常清算件数割合','FTDのみ率','2nd率','3rd率','Active率'];
  body.innerHTML = Object.entries(data).map(([key, value]) => { if (value === null || value === undefined) return ''; let formatted = key === 'RTP' ? formatRTP(value) : percentKeysTable.includes(key) ? formatPercent(value) : currencyKeys.includes(key) ? formatCurrency(value) : typeof value === 'number' ? formatNumber(value) : String(value); const isNeg = typeof value === 'number' && value < 0; return `<tr><td>${key}</td><td class="text-right ${isNeg ? 'text-red' : ''}">${formatted}</td></tr>`; }).join('');
}

// ========== モーダル ==========
function showUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); document.getElementById('upload-status').style.display = 'none'; toggleExchangeRate(); }
function hideUploadModal() { document.getElementById('upload-modal').classList.add('hidden'); }
function toggleExchangeRate() { const type = document.getElementById('upload-type').value; const row = document.getElementById('exchange-rate-row'); row.style.display = (type === 'konibet' || type === 'auto') ? 'block' : 'none'; }
function showAddBusinessModal() { document.getElementById('add-business-modal').classList.remove('hidden'); }
function hideAddBusinessModal() { document.getElementById('add-business-modal').classList.add('hidden'); }
function setupDragDrop() { const zone = document.getElementById('upload-zone'); zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); }); zone.addEventListener('dragleave', () => zone.classList.remove('dragover')); zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('dragover'); if (e.dataTransfer.files[0]) handleFileUpload(e.dataTransfer.files[0]); }); }
function showStatus(msg, isError = false) { const s = document.getElementById('upload-status'); s.style.display = 'block'; s.style.background = isError ? '#fee2e2' : '#dcfce7'; s.style.color = isError ? '#dc2626' : '#16a34a'; s.textContent = msg; }

// ========== ファイルアップロード ==========
function handleFileUpload(file) {
  if (!file) return;
  const period = document.getElementById('upload-period').value || new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' }).replace(' ', '');
  const uploadType = document.getElementById('upload-type').value;
  const reader = new FileReader();
  if (file.name.endsWith('.zip')) { showStatus('ZIPファイルは非対応です', true); return; }
  reader.onload = function(e) {
    try {
      if (file.name.endsWith('.csv')) handleCSV(e.target.result, period, uploadType, file.name);
      else { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); handleExcel(workbook, period, uploadType, file.name); }
    } catch (err) { showStatus('エラー: ' + err.message, true); }
  };
  if (file.name.endsWith('.csv')) reader.readAsText(file, 'UTF-8');
  else reader.readAsArrayBuffer(file);
}

function handleCSV(text, period, uploadType, filename) {
  const parseCSVLine = (line) => { const result = []; let current = ''; let inQuotes = false; for (let i = 0; i < line.length; i++) { const c = line[i]; if (c === '"') inQuotes = !inQuotes; else if (c === ',' && !inQuotes) { result.push(current.trim().replace(/^"|"$/g, '')); current = ''; } else current += c; } result.push(current.trim().replace(/^"|"$/g, '')); return result; };
  const lines = text.replace(/\r\n/g, '\n').split('\n').filter(l => l.trim()).map(l => parseCSVLine(l));
  if (lines.length < 2) { showStatus('CSVにデータがありません', true); return; }
  const headerStr = lines[0].join(',').toLowerCase();
  const fn = filename.toLowerCase();
  
  // 全行のテキストを結合してチェック
  const allText = lines.slice(0, 60).map(r => r.join(',')).join(' ').toLowerCase();
  
  const isCustomerList = fn.includes('顧客リスト') || fn.includes('customer');
  const isUncollected = fn.includes('未回収') || headerStr.includes('残未回収金額');
  const isDelayed = fn.includes('遅れ回収') || fn.includes('遅れ');
  const isBonus = fn.includes('ボーナス') && !allText.includes('ターンオーバー');
  const isAgent = fn.includes('エージェント') || fn.includes('agent') || headerStr.includes('teamkyoto');
  const isAds = fn.includes('日报') || fn.includes('広告') || (headerStr.includes('コスト') && headerStr.includes('インプレッション'));
  const isSloten = fn.includes('スロ天') || (headerStr.includes('項目名') && headerStr.includes('月次'));
  const isKonibet = fn.includes('konibet') || fn.includes('コニベット') || (headerStr.includes('sign-up') && headerStr.includes('ftd') && headerStr.includes('mau') && headerStr.includes('deposits'));
  
  // Konibet日次KPIシート（日本語フォーマット）の検出
  // 複数のパターンに対応
  const isKonibetDaily = (allText.includes('名目') && allText.includes('登録') && allText.includes('ggr') && allText.includes('ngr')) ||
                         (allText.includes('ロジック') && allText.match(/\d{4}\/\d{1,2}\/\d{1,2}/)) ||
                         (allText.includes('初回入金人数') && allText.includes('ターンオーバー')) ||
                         (allText.includes('目標') && allText.includes('合計') && allText.includes('登録') && allText.includes('ggr')) ||
                         (allText.includes('合計') && allText.includes('ftd') && allText.includes('ターンオーバー') && allText.includes('ngr')) ||
                         (allText.includes('前月') && allText.includes('合計') && allText.includes('登録') && allText.includes('ggr')) ||
                         (allText.includes('先月比較') && allText.includes('合計') && allText.includes('ターンオーバー'));
  
  if (uploadType === 'auto') {
    // Konibet日次KPIシート（日本語）を優先的にチェック
    if (isKonibetDaily) { parseKonibetDailyCSV(lines, period, fn); return; }
    if (isKonibet) { parseKonibetCSV(lines, period, fn); return; }
    if (isSloten) { parseSlotenCSV(lines, period, fn); return; }
    if (isCustomerList) { parseCustomerListCSV(lines, period, fn); return; }
    if (isUncollected) { parseUncollectedCSV(lines, period, fn); return; }
    if (isDelayed) { parseDelayedCSV(lines, period, fn); return; }
    if (isBonus) { parseBonusCSV(lines, period, fn); return; }
    if (isAgent) { parseAgentCSV(lines, period); return; }
    if (isAds) { parseAdsCSV(lines, period); return; }
  }
  if (uploadType === 'sloten') { parseSlotenCSV(lines, period, fn); return; }
  if (uploadType === 'konibet') { 
    // konibet選択時も日本語フォーマットをチェック
    if (isKonibetDaily) { parseKonibetDailyCSV(lines, period, fn); return; }
    parseKonibetCSV(lines, period, fn); return; 
  }
  if (uploadType === 'customerList') { parseCustomerListCSV(lines, period, fn); return; }
  if (uploadType === 'uncollected') { parseUncollectedCSV(lines, period, fn); return; }
  if (uploadType === 'bonus') { parseBonusCSV(lines, period, fn); return; }
  if (uploadType === 'delayed') { parseDelayedCSV(lines, period, fn); return; }
  if (uploadType === 'agent') { parseAgentCSV(lines, period); return; }
  if (uploadType === 'ads') { parseAdsCSV(lines, period); return; }
  
  showStatus('CSVの形式を判別できませんでした', true);
}

// ========== 各種CSVパーサー ==========

// Konibet 日次KPIシート用パーサー（日本語フォーマット）
function parseKonibetDailyCSV(lines, period, filename) {
  // 為替レート（USD → JPY）- 入力欄から取得、なければデフォルト150
  const rateInput = document.getElementById('usd-jpy-rate');
  const USD_TO_JPY = rateInput ? parseFloat(rateInput.value) || 150 : 150;
  
  // KPIマッピング（名目 → KPI名）
  const kpiMapping = {
    '登録': '登録人数',
    'ログイン': 'ログインユーザー数',
    '初回入金人数(FTD)': 'FTD数',
    '初回入金人数': 'FTD数',
    'FTD': 'FTD数',
    '初回入金額': '初回入金額',
    '入金人数': '入金者数',
    '入金額': '総入金額',
    '実際の出金人数': '出金者数',
    '実際の出金額': '総出金額',
    '出金額': '総出金額',
    '入金と出金の差': '入出金差分',
    'ベット人数': 'アクティブプレイ人数',
    'ターンオーバー': 'T/O',
    'GGR': 'GGR',
    'win額': '勝利金',
    'ボーナス（FS除く）': 'ボーナス',
    'ボーナス': 'ボーナス',
    'ゲームフィー': 'ゲームプロバイダーフィー',
    'PSP手数料': 'PSP手数料',
    'AFF報酬': 'AFF報酬',
    'NGR': 'NGR',
    'アカウント内残高': 'アカウント残高',
    '新規入金転移率': '新規入金転移率',
    '平均入金額(人数/デイリ)': '平均入金額',
    '平均入金額(daily)': '平均入金額',
    '出金人数割合': '出金人数割合',
    '出金割合(ボーナス込み)': '出金割合',
    'T/O倍率': 'T/O倍率',
    'T/O倍率(Bonus込)': 'T/O倍率(Bonus込)',
    'ボーナス付与率(入金に対して)': 'ボーナス付与率',
    '入金額に対してのGGR割合': 'GGR率',
    '入金に対してのNGR割合': 'NGR率',
    'RTP(ゲーム種類ごとに計測していく必要あり)': 'RTP',
    'RTP': 'RTP',
    'LTV(GGRベース)': 'LTV(GGR)',
    'LTV(GGRベース)実入金人数': 'LTV(GGR)',
    'LTV(NGRベース)': 'LTV(NGR)',
    'LTV(NGRベース)実入金人数': 'LTV(NGR)'
  };
  
  // USDフィールド（為替換算が必要なフィールド）
  const usdFields = [
    '初回入金額', '入金額', '出金額', '入金と出金の差', 'ターンオーバー', 
    'GGR', 'win額', 'ボーナス（FS除く）', 'ボーナス', 'ゲームフィー', 
    'PSP手数料', 'NGR', 'アカウント内残高', '平均入金額(人数/デイリ)', '平均入金額(daily)',
    '実際の出金額', 'LTV(GGRベース)', 'LTV(NGRベース)', 'ボーナス＋プロバイダー＋PSP',
    'ボーナス＋プロバイダー＋PSP＋AFF', 'AFF報酬', 'LTV(GGRベース)実入金人数', 'LTV(NGRベース)実入金人数'
  ];
  
  const summary = {};
  let headerRowIndex = -1;
  let labelColIndex = -1;  // KPI名の列
  let totalColIndex = -1;  // 合計の列
  
  // ヘッダー行を探す
  // 複数の形式に対応: 「合計」列を探してその位置を基準にする
  for (let i = 0; i < Math.min(5, lines.length); i++) {
    const row = lines[i];
    if (!row) continue;
    
    // 「合計」列を探す
    let totalIdx = row.findIndex(cell => String(cell || '').trim() === '合計');
    if (totalIdx < 0) continue;
    
    // 形式を判定（データ行の最初の列にKPI名がある）
    headerRowIndex = i;
    labelColIndex = 0;  // KPI名は常に列0
    totalColIndex = totalIdx;
    break;
  }
  
  if (headerRowIndex < 0) {
    showStatus('Konibet日次KPIシートの形式を認識できませんでした', true);
    return;
  }
  
  // 期間名を取得（ヘッダー行の日付から）
  let periodName = period;
  const headerRow = lines[headerRowIndex];
  for (let j = totalColIndex + 1; j < headerRow.length; j++) {
    const cell = String(headerRow[j] || '').trim();
    // 「1月1日(金)」や「12月1日(火)」形式
    const dateMatch = cell.match(/(\d{1,2})月(\d{1,2})日/);
    if (dateMatch) {
      const month = parseInt(dateMatch[1]);
      // ファイル名から年を推測、なければ期間入力欄から
      const yearMatch = filename.match(/(202\d)/);
      let year = yearMatch ? yearMatch[1] : null;
      if (!year) {
        const inputPeriod = document.getElementById('upload-period')?.value || '';
        const inputYearMatch = inputPeriod.match(/(202\d)/);
        year = inputYearMatch ? inputYearMatch[1] : '2022';
      }
      periodName = `${year}年${month}月`;
      break;
    }
  }
  
  // データ行を読み取り
  for (let i = headerRowIndex + 1; i < lines.length; i++) {
    const row = lines[i];
    if (!row || row.length < totalColIndex + 1) continue;
    
    let rawLabel = String(row[labelColIndex] || '').trim();
    if (!rawLabel || rawLabel === '' || rawLabel.startsWith('統計')) continue;
    
    // スペースや特殊文字を正規化
    rawLabel = rawLabel.replace(/\s+/g, '');
    
    // 合計列の値を取得
    const totalVal = row[totalColIndex];
    if (totalVal === undefined || totalVal === null || totalVal === '') continue;
    
    // #DIV/0! などのエラー値をスキップ
    if (String(totalVal).includes('#')) continue;
    
    // KPI名をマッピング
    const kpiName = kpiMapping[rawLabel] || rawLabel;
    
    // 値をパース
    let val = parseNumber(totalVal);
    if (val === null) continue;
    
    // USDフィールドの場合は為替換算
    if (usdFields.some(f => rawLabel.includes(f) || rawLabel === f)) {
      val = val * USD_TO_JPY;
    }
    
    // パーセンテージフィールドの場合
    const isPercent = rawLabel.includes('率') || rawLabel.includes('割合') || rawLabel.includes('RTP');
    if (isPercent && Math.abs(val) > 1) {
      val = val / 100; // パーセント表記を小数に変換
    }
    
    // 重複キーは最初の値を優先（GGRなど）
    if (summary[kpiName] === undefined) {
      summary[kpiName] = val;
    }
  }
  
  // 計算項目を追加
  if (summary['総入金額'] && summary['総出金額'] && !summary['入出金差分']) {
    summary['入出金差分'] = summary['総入金額'] - summary['総出金額'];
  }
  if (summary['T/O'] && summary['勝利金'] && !summary['GGR']) {
    summary['GGR'] = summary['T/O'] - summary['勝利金'];
  }
  if (summary['GGR'] && summary['T/O'] && !summary['RTP']) {
    summary['RTP'] = summary['勝利金'] / summary['T/O'];
  }
  
  // 為替レートを保存
  summary['為替レート(USD/JPY)'] = USD_TO_JPY;
  
  // BUSINESSESに保存
  BUSINESSES['Konibet'].data[periodName] = {
    サマリー: summary
  };
  
  const kpiCount = Object.keys(summary).length;
  showStatus(`Konibet日次KPI取込完了: ${periodName} (${kpiCount}項目) ※USD→JPY: ¥${USD_TO_JPY}換算`);
  selectBusiness('Konibet'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseKonibetCSV(lines, period, filename) {
  // Konibet KPI CSVパーサー
  // CSVフォーマット:
  // 行1: ヘッダー (,KPI,sign-up,FTD,MAU,Deposits,T/0,AFF cost,NGR)
  // 行2-13: 月別KPI目標値
  // 行16以降: 実績データ（週次）
  
  // 為替レート（USD → JPY）- 入力欄から取得、なければデフォルト150
  const rateInput = document.getElementById('usd-jpy-rate');
  const USD_TO_JPY = rateInput ? parseFloat(rateInput.value) || 150 : 150;
  
  const yearMatch = filename.match(/202[0-9]/);
  const year = yearMatch ? yearMatch[0] : new Date().getFullYear().toString();
  
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  const monthsJP = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
  
  // KPI目標値を読み取り（行2-13）
  const targets = {};
  for (let i = 1; i <= 13; i++) {
    const row = lines[i];
    if (!row || row.length < 8) continue;
    const monthName = String(row[1] || '').trim();
    const monthIdx = months.findIndex(m => m.toLowerCase() === monthName.toLowerCase());
    if (monthIdx < 0) continue;
    
    targets[monthsJP[monthIdx]] = {
      '登録目標': parseNumber(row[2]) || 0,
      'FTD目標': parseNumber(row[3]) || 0,
      'MAU目標': parseNumber(row[4]) || 0,
      '入金額目標': (parseNumber(row[5]) || 0) * USD_TO_JPY,
      'ターンオーバー目標': (parseNumber(row[6]) || 0) * USD_TO_JPY,
      'AFF固定費目標': (parseNumber(row[7]) || 0) * USD_TO_JPY,
      'NGR目標': (parseNumber(row[8]) || 0) * USD_TO_JPY
    };
  }
  
  // 実績データを読み取り
  let currentMonth = null;
  let monthlyData = {};
  let weeklyDetails = {};
  
  for (let i = 16; i < lines.length; i++) {
    const row = lines[i];
    if (!row || row.length < 8) continue;
    
    const col0 = String(row[0] || '').trim();
    const col1 = String(row[1] || '').trim();
    
    // 月名の検出
    const monthIdx = months.findIndex(m => m.toLowerCase() === col0.toLowerCase());
    if (monthIdx >= 0) {
      currentMonth = monthsJP[monthIdx];
      if (!monthlyData[currentMonth]) {
        monthlyData[currentMonth] = { weeks: [], totals: null };
        weeklyDetails[currentMonth] = [];
      }
    }
    
    if (!currentMonth) continue;
    
    // Week行またはIn Total行
    const isWeek = col1.toLowerCase().includes('week');
    const isTotal = col1.toLowerCase().includes('in total') || col1.toLowerCase().includes('total');
    
    if (isWeek || isTotal) {
      const weekData = {
        週: col1,
        登録: parseNumber(row[2]) || 0,
        FTD: parseNumber(row[3]) || 0,
        MAU: parseNumber(row[4]) || 0,
        入金額: (parseNumber(row[5]) || 0) * USD_TO_JPY,
        ターンオーバー: (parseNumber(row[6]) || 0) * USD_TO_JPY,
        'AFF固定費': (parseNumber(row[7]) || 0) * USD_TO_JPY,
        NGR: (parseNumber(row[8]) || 0) * USD_TO_JPY,
        '登録達成率': parseNumber(row[9]) || 0,
        'FTD達成率': parseNumber(row[10]) || 0,
        'MAU達成率': parseNumber(row[11]) || 0,
        '入金額達成率': parseNumber(row[12]) || 0,
        'ターンオーバー達成率': parseNumber(row[13]) || 0,
        'AFF固定費達成率': parseNumber(row[14]) || 0,
        'NGR達成率': parseNumber(row[15]) || 0
      };
      
      if (isTotal) {
        monthlyData[currentMonth].totals = weekData;
      } else {
        weeklyDetails[currentMonth].push(weekData);
      }
    }
  }
  
  // ダッシュボード用データ構造に変換
  let count = 0;
  Object.keys(monthlyData).forEach(month => {
    const data = monthlyData[month];
    const target = targets[month] || {};
    const totals = data.totals || {};
    
    // 実績がない月はスキップ
    if (!totals.登録 && !totals.FTD && !totals.MAU) return;
    
    const periodName = `${year}年${month}`;
    const summary = {
      // 実績
      '登録': totals.登録 || 0,
      'FTD': totals.FTD || 0,
      'MAU': totals.MAU || 0,
      '入金額': totals.入金額 || 0,
      'ターンオーバー': totals.ターンオーバー || 0,
      'AFF固定費': totals['AFF固定費'] || 0,
      'NGR': totals.NGR || 0,
      // 目標
      '登録目標': target['登録目標'] || 0,
      'FTD目標': target['FTD目標'] || 0,
      'MAU目標': target['MAU目標'] || 0,
      '入金額目標': target['入金額目標'] || 0,
      'ターンオーバー目標': target['ターンオーバー目標'] || 0,
      'AFF固定費目標': target['AFF固定費目標'] || 0,
      'NGR目標': target['NGR目標'] || 0,
      // 達成率
      '登録達成率': totals['登録達成率'] || 0,
      'FTD達成率': totals['FTD達成率'] || 0,
      'MAU達成率': totals['MAU達成率'] || 0,
      '入金額達成率': totals['入金額達成率'] || 0,
      'ターンオーバー達成率': totals['ターンオーバー達成率'] || 0,
      'NGR達成率': totals['NGR達成率'] || 0,
      // 為替レート
      '為替レート(USD/JPY)': USD_TO_JPY
    };
    
    // 週次詳細データ
    const weeks = weeklyDetails[month] || [];
    
    BUSINESSES['Konibet'].data[periodName] = {
      サマリー: summary,
      ...(weeks.length > 0 ? { 週次詳細: weeks } : {})
    };
    count++;
  });
  
  showStatus(`Konibet KPI取込完了: ${count}期間 (${year}年) ※USD→JPY: ¥${USD_TO_JPY}換算`);
  selectBusiness('Konibet'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseSlotenCSV(lines, period, filename) {
  const kpi = {};
  let periodName = period;
  const match = filename.match(/(\d{4})(\d{2})/);
  if (match) periodName = `${match[1]}年${parseInt(match[2])}月`;
  lines.forEach((row, idx) => { if (!row || row.length < 2) return; const rawLabel = String(row[0] || '').trim(); if (!rawLabel || rawLabel === '項目名') return; const val = parseNumber(row[1]); if (val === null) return; const cleanLabel = rawLabel.split('/')[0].trim(); if (idx < 90 || kpi[cleanLabel] === undefined) kpi[cleanLabel] = val; });
  if (kpi['入出金差分'] === undefined && kpi['総入金額'] !== undefined && kpi['総出金額'] !== undefined) kpi['入出金差分'] = kpi['総入金額'] - kpi['総出金額'];
  BUSINESSES['スロ天'].data[periodName] = { サマリー: kpi };
  showStatus(`スロ天KPI取込完了: ${periodName}`);
  selectBusiness('スロ天'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseCustomerListCSV(lines, period, filename) {
  const fn = filename.toLowerCase();
  const isDSC = fn.includes('リストd') || fn.includes('d.csv') || filename.includes('リストD') || filename.includes('顧客リストD');
  const target = isDSC ? 'DSC' : '元amuse';
  
  // 4行目（index 3）がヘッダー行
  const headerRowIdx = 3;
  const header = lines[headerRowIdx] || [];
  const colIdx = {};
  
  // ヘッダーから列インデックスを取得
  header.forEach((h, idx) => { 
    const col = String(h).trim(); 
    if (col === 'FULLNAME1' || col === '名前') colIdx.name = idx; 
    if (col === 'credit' || col === '信用枠' || col === 'Credit') colIdx.credit = idx; 
    if (col.includes('トータル回収額') || col === '回収額') colIdx.collected = idx; 
    if (col.includes('トータル出金額') || col === '出金額') colIdx.withdraw = idx; 
    if (col.includes('トータル差分利益') || col === '差分利益') colIdx.diff = idx; 
    if (col === '入金回数') colIdx.depCount = idx; 
    if (col === '出金回数') colIdx.wdCount = idx; 
    if (col === 'NGR' && !colIdx.ngr) colIdx.ngr = idx;
    if (col === 'ボーナス付与総金額' || col === 'ボーナス' || col.includes('ボーナス')) colIdx.bonus = idx;
    if (col === 'プレイ月間' || col.includes('プレイ月')) colIdx.playMonths = idx;
    if (col === '事前清算回数' || col === '事前回数') colIdx.preSettleCount = idx;
    if (col === '事前清算金額' || col === '事前金額') colIdx.preSettleAmount = idx;
    if (col === '通常清算回数' || col === '通常回数' || col === '回収回数') colIdx.normalSettleCount = idx;
    if (col === '通常清算金額' || col === '通常金額' || col === '回収金額') colIdx.normalSettleAmount = idx;
    if (col === 'リスト種別' || col === 'リスト' || col === 'List') colIdx.listType = idx;
    if (col === 'FTD' || col === 'FTD日') colIdx.ftdDate = idx;
    if (col === 'FTW' || col === 'FTW日') colIdx.ftwDate = idx;
  });
  
  // AR列(44)からBE列(57)の範囲もチェック（リスト種別用）- 0始まりなので43から56
  if (colIdx.listType === undefined) {
    for (let i = 43; i <= 56; i++) {
      const col = String(header[i] || '').trim();
      if (col === 'リスト種別' || col === 'リスト' || col === 'List' || col.includes('リスト')) {
        colIdx.listType = i;
        break;
      }
    }
  }
  
  let stats = { 
    総登録数: 0, 総回収額: 0, 総出金額: 0, 総差分利益: 0, 総NGR: 0, 
    FTD数: 0, FTW数: 0, FTDW数: 0, 総信用枠: 0, 総ボーナス: 0, 総プレイ月間: 0, 
    事前清算回数: 0, 事前清算金額: 0, 通常清算回数: 0, 通常清算金額: 0 
  };
  const listTypes = {};
  
  // 5行目（index 4）からデータ開始
  for (let i = headerRowIdx + 1; i < lines.length; i++) { 
    const row = lines[i]; 
    if (!row || row.length < 5) continue; 
    
    const nameIdx = colIdx.name !== undefined ? colIdx.name : 1;
    const name = String(row[nameIdx] || '').trim(); 
    if (!name || name === '担当者' || name.includes('セル') || name === '' || name === 'FULLNAME1') continue;
    
    stats.総登録数++; 
    
    const collected = parseNumber(row[colIdx.collected]) || 0; 
    const withdraw = parseNumber(row[colIdx.withdraw]) || 0; 
    const diff = parseNumber(row[colIdx.diff]) || 0; 
    const ngr = parseNumber(row[colIdx.ngr]) || 0; 
    const credit = parseNumber(row[colIdx.credit]) || 0; 
    const bonus = parseNumber(row[colIdx.bonus]) || 0;
    const playMonths = parseNumber(row[colIdx.playMonths]) || 0;
    const preSettleCount = parseNumber(row[colIdx.preSettleCount]) || 0;
    const preSettleAmount = parseNumber(row[colIdx.preSettleAmount]) || 0;
    const normalSettleCount = parseNumber(row[colIdx.normalSettleCount]) || 0;
    const normalSettleAmount = parseNumber(row[colIdx.normalSettleAmount]) || 0;
    const depCount = parseNumber(row[colIdx.depCount]) || 0; 
    const wdCount = parseNumber(row[colIdx.wdCount]) || 0; 
    
    stats.総回収額 += collected; 
    stats.総出金額 += withdraw; 
    stats.総差分利益 += diff; 
    stats.総NGR += ngr; 
    stats.総信用枠 += credit;
    stats.総ボーナス += bonus;
    stats.総プレイ月間 += playMonths;
    stats.事前清算回数 += preSettleCount;
    stats.事前清算金額 += preSettleAmount;
    stats.通常清算回数 += normalSettleCount;
    stats.通常清算金額 += normalSettleAmount;
    
    // FTD/FTW判定
    const ftdDate = row[colIdx.ftdDate] ? String(row[colIdx.ftdDate]).trim() : '';
    const ftwDate = row[colIdx.ftwDate] ? String(row[colIdx.ftwDate]).trim() : '';
    const hasFTD = ftdDate !== '' || depCount > 0 || collected > 0; 
    const hasFTW = ftwDate !== '' || wdCount > 0 || withdraw > 0; 
    if (hasFTD) { stats.FTD数++; if (hasFTW) stats.FTDW数++; } 
    if (hasFTW) stats.FTW数++;
    
    // リスト種別集計（B, E, T, S, BE, C, 紹介のみ、それ以外はその他）
    if (colIdx.listType !== undefined) {
      let listType = String(row[colIdx.listType] || '').trim();
      if (listType && listType !== '' && listType !== 'リスト種別') {
        const validTypes = ['B', 'E', 'T', 'S', 'BE', 'C', '紹介'];
        if (!validTypes.includes(listType)) {
          listType = 'その他';
        }
        if (!listTypes[listType]) listTypes[listType] = 0;
        listTypes[listType]++;
      }
    }
  }
  
  // 計算項目
  stats['FTD率'] = stats.総登録数 > 0 ? stats.FTD数 / stats.総登録数 : 0;
  stats['FTW率'] = stats.総登録数 > 0 ? stats.FTW数 / stats.総登録数 : 0;
  stats['FTDW率'] = stats.FTD数 > 0 ? stats.FTDW数 / stats.FTD数 : 0;
  stats['回収出金差分'] = stats.総回収額 - stats.総出金額;
  stats['平均信用枠'] = stats.総登録数 > 0 ? stats.総信用枠 / stats.総登録数 : 0;
  stats['平均Credit単価'] = stats.FTD数 > 0 ? stats.総信用枠 / stats.FTD数 : 0;
  stats['平均プレイ月間'] = stats.総登録数 > 0 ? stats.総プレイ月間 / stats.総登録数 : 0;
  
  // 事前清算・通常清算の割合
  const totalSettleAmount = stats.事前清算金額 + stats.通常清算金額;
  const totalSettleCount = stats.事前清算回数 + stats.通常清算回数;
  stats['事前清算割合'] = totalSettleAmount > 0 ? stats.事前清算金額 / totalSettleAmount : 0;
  stats['通常清算割合'] = totalSettleAmount > 0 ? stats.通常清算金額 / totalSettleAmount : 0;
  stats['事前清算件数割合'] = totalSettleCount > 0 ? stats.事前清算回数 / totalSettleCount : 0;
  stats['通常清算件数割合'] = totalSettleCount > 0 ? stats.通常清算回数 / totalSettleCount : 0;
  
  const existing = BUSINESSES[target].data[period]?.サマリー || {};
  // 0の値で既存データを上書きしない
  const mergedStats = { ...existing };
  Object.entries(stats).forEach(([key, val]) => {
    if (val !== 0 || existing[key] === undefined) {
      mergedStats[key] = val;
    }
  });
  BUSINESSES[target].data[period] = { 
    サマリー: mergedStats,
    ...(Object.keys(listTypes).length > 0 ? { リスト種別: listTypes } : (BUSINESSES[target].data[period]?.リスト種別 ? { リスト種別: BUSINESSES[target].data[period].リスト種別 } : {}))
  };
  
  const listInfo = Object.keys(listTypes).length > 0 ? `, リスト種別${Object.keys(listTypes).length}種(${Object.entries(listTypes).map(([k,v])=>k+':'+v).join(',')})` : '';
  showStatus(`顧客リスト取込完了: ${target} ${stats.総登録数}件, FTD${stats.FTD数}件, 事前清算${stats.事前清算回数}件/${formatCurrency(stats.事前清算金額)}${listInfo}`);
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseUncollectedCSV(lines, period, filename) {
  const fn = filename.toLowerCase();
  const isDSC = fn.includes('シートd') || fn.includes('d.csv') || filename.includes('シートD');
  const target = isDSC ? 'DSC' : '元amuse';
  let total = 0, count = 0;
  for (let i = 0; i < Math.min(5, lines.length); i++) { const row = lines[i]; if (!row) continue; const rowStr = row.join(','); if (rowStr.includes('未回収金総額')) { for (let j = 0; j < row.length; j++) { const val = parseNumber(row[j]); if (val && val > 1000000) { total = val; break; } } for (let j = 0; j < row.length; j++) { const val = parseNumber(row[j]); if (val && val > 0 && val < 10000) { count = val; break; } } break; } }
  if (total === 0) { const colIdx = lines[0].findIndex(h => String(h).includes('残未回収')); for (let i = 1; i < lines.length; i++) { const val = parseNumber(lines[i][colIdx >= 0 ? colIdx : 0]) || 0; total += val; } count = lines.length - 1; }
  const data = { '未回収者数': count, '残未回収金額': total };
  const existing = BUSINESSES[target].data[period]?.サマリー || {};
  BUSINESSES[target].data[period] = { サマリー: { ...existing, ...data } };
  showStatus(`未回収シート取込完了: ${target} ${count}人, ${formatCurrency(total)}`);
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseBonusCSV(lines, period, filename) {
  const fn = filename.toLowerCase();
  const isDSC = fn.includes('ボーナスd') || fn.includes('d.csv') || filename.includes('ボーナスD');
  const target = isDSC ? 'DSC' : '元amuse';
  let totalBonus = 0, count = 0;
  for (let i = 0; i < lines.length; i++) { const row = lines[i]; if (!row) continue; const firstCol = String(row[0] || '').trim().toUpperCase(); if (firstCol === 'TOTAL') { totalBonus = parseNumber(row[1]) || 0; break; } }
  let foundTotal = false;
  for (let i = 1; i < lines.length; i++) { const row = lines[i]; if (!row) continue; const firstCol = String(row[0] || '').trim().toUpperCase(); if (firstCol === 'TOTAL') { foundTotal = true; continue; } if (!foundTotal) continue; if (row[3] && String(row[3]).trim()) count++; }
  const data = { 'ボーナス対象者数': count, '総ボーナス付与金額': totalBonus };
  const existing = BUSINESSES[target].data[period]?.サマリー || {};
  BUSINESSES[target].data[period] = { サマリー: { ...existing, ...data } };
  showStatus(`ボーナスシート取込完了: ${target} ${count}人, ${formatCurrency(totalBonus)}`);
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseDelayedCSV(lines, period, filename) {
  const fn = filename.toLowerCase();
  const isDSC = fn.includes('回収d') || fn.includes('d.csv') || filename.includes('回収D');
  const target = isDSC ? 'DSC' : '元amuse';
  let totalDelayed = 0, count = 0;
  const header = lines[0] || [];
  const amountIdx = header.findIndex(h => String(h).includes('今回返済金額'));
  for (let i = 1; i < lines.length; i++) { const row = lines[i]; if (!row || row.length < 10) continue; const amount = parseNumber(row[amountIdx >= 0 ? amountIdx : 10]) || 0; if (amount > 0) { totalDelayed += amount; count++; } }
  const data = { '遅れ回収件数': count, '遅れ回収金額': totalDelayed };
  const existing = BUSINESSES[target].data[period]?.サマリー || {};
  BUSINESSES[target].data[period] = { サマリー: { ...existing, ...data } };
  showStatus(`遅れ回収シート取込完了: ${target} ${count}件, ${formatCurrency(totalDelayed)}`);
  selectBusiness(target); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseAgentCSV(lines, period) {
  let weeklyData = [];
  let totals = { 入金合計: 0, 出金合計: 0, 収益合計: 0, TO合計: 0, ローリング合計: 0, 大阪合計: 0 };
  for (let i = 2; i < lines.length; i++) { const row = lines[i]; if (!row || row.length < 17) continue; const col7 = (row[7] || '').trim(); const col12 = (row[12] || '').trim(); const isOldFormat = col7.includes('/') && !col7.toLowerCase().includes('kyoto'); const isNewFormat = col7 === '' && col12.includes('/'); if (isOldFormat || isNewFormat) { const 日付 = isOldFormat ? col7 : col12; const 入金 = parseNumber(row[8]) || 0; const 出金 = parseNumber(row[9]) || 0; const 収益 = parseNumber(row[11]) || 0; const TO = parseNumber(row[13]) || 0; const ローリング = parseNumber(row[14]) || 0; const 大阪 = parseNumber(row[16]) || 0; const ローリング報酬 = ローリング + 大阪; const NGR = 収益 - ローリング報酬; totals.入金合計 += 入金; totals.出金合計 += 出金; totals.収益合計 += 収益; totals.TO合計 += TO; totals.ローリング合計 += ローリング; totals.大阪合計 += 大阪; weeklyData.push({ 日付, 入金, 出金, 収益, 'T/O': TO, ローリング, 大阪, ローリング報酬, NGR }); } }
  const ローリング報酬合計 = totals.ローリング合計 + totals.大阪合計;
  const NGR合計 = totals.収益合計 - ローリング報酬合計;
  BUSINESSES['AMUSEVIP'].data['全期間'] = { サマリー: { ...totals, 'ローリング報酬': ローリング報酬合計, 'NGR': NGR合計, '精算回数': weeklyData.length }, 週別: weeklyData };
  showStatus(`エージェント取込完了: ${weeklyData.length}回, 収益${formatCurrency(totals.収益合計)}`);
  selectBusiness('AMUSEVIP'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseAdsCSV(lines, period) {
  const header = lines[0].map(h => String(h || '').toLowerCase().replace(/\n/g, '').trim());
  const costIdx = header.findIndex(h => h.includes('コスト') || h === 'cost');
  const impIdx = header.findIndex(h => h.includes('インプレッション') || h.includes('imp'));
  const clickIdx = header.findIndex(h => h.includes('クリック') || h.includes('click'));
  const regIdx = header.findIndex(h => h === '登録数' || h === 'registrations');
  const depIdx = header.findIndex(h => h === '入金数' || h === 'deposits');
  let totals = { コスト: 0, インプレッション: 0, クリック: 0, 登録: 0, 入金: 0 };
  let foundTotal = false;
  // TOTAL行を探してその値を使用
  for (let i = 1; i < lines.length; i++) {
    const row = lines[i]; if (!row || row.length < 5) continue;
    const firstCell = String(row[0] || '').trim().toLowerCase();
    // TOTAL行を検出（"total", "合計", 月名+total など）
    if (firstCell.includes('total') || firstCell.includes('合計')) {
      foundTotal = true;
      const parseVal = (idx, fb) => { if (idx < 0 && fb < 0) return 0; const v = row[idx >= 0 ? idx : fb] || ''; return parseFloat(String(v).replace(/[$￥¥,"\s]/g, '')) || 0; };
      totals.コスト = parseVal(costIdx, 1);
      totals.インプレッション = parseVal(impIdx, 2);
      totals.クリック = parseVal(clickIdx, 3);
      totals.登録 = parseVal(regIdx, 4);
      totals.入金 = parseVal(depIdx, 5);
      break; // 最初のTOTAL行を使用
    }
  }
  // TOTAL行がない場合は従来通り合計
  if (!foundTotal) {
    for (let i = 1; i < lines.length; i++) { const row = lines[i]; if (!row || row.length < 5) continue; const parseVal = (idx, fb) => { if (idx < 0 && fb < 0) return 0; const v = row[idx >= 0 ? idx : fb] || ''; return parseFloat(String(v).replace(/[$￥¥,"\s]/g, '')) || 0; }; totals.コスト += parseVal(costIdx, 1); totals.インプレッション += parseVal(impIdx, 2); totals.クリック += parseVal(clickIdx, 3); totals.登録 += parseVal(regIdx, 4); totals.入金 += parseVal(depIdx, 5); }
  }
  const ctr = totals.インプレッション > 0 ? totals.クリック / totals.インプレッション : 0;
  const cvr = totals.クリック > 0 ? totals.登録 / totals.クリック : 0;
  const costYen = totals.コスト < 10000 ? totals.コスト * 150 : totals.コスト;
  const cpaYen = totals.登録 > 0 ? costYen / totals.登録 : 0;
  BUSINESSES['広告'].data['全期間'] = { サマリー: { 'コスト($)': totals.コスト, 'コスト(税込)': costYen, 'インプレッション': totals.インプレッション, 'クリック': totals.クリック, '登録数': totals.登録, '入金数': totals.入金, 'CTR': ctr, 'CVR': cvr, 'CPA(税込)': cpaYen } };
  showStatus(`広告データ取込完了: 登録${totals.登録}件, 入金${totals.入金}件`);
  selectBusiness('広告'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

// ========== Excel処理 ==========
function handleExcel(workbook, period, uploadType, filename) {
  const sheetNames = workbook.SheetNames;
  const fn = filename.toLowerCase();
  const slotenSheets = sheetNames.filter(s => /^\d{6}$/.test(s));
  if (uploadType === 'sloten' || (uploadType === 'auto' && (slotenSheets.length > 0 || fn.includes('スロ天') || fn.includes('kpi')))) { parseSlotenExcel(workbook, slotenSheets); return; }
  const hasBaccaraSheet = sheetNames.includes('ダッシュボード') || sheetNames.includes('コスト') || sheetNames.some(s => s.includes('バカラ'));
  if (uploadType === 'baccarat' || (uploadType === 'auto' && (hasBaccaraSheet || fn.includes('バカラ') || fn.includes('baccara')))) { parseBaccaratExcel(workbook, period); return; }
  const revenueSheets = sheetNames.filter(s => s.includes('収益') && !s.includes('import'));
  if (revenueSheets.length > 0) { parseSamExcel(workbook, revenueSheets); return; }
  parseGenericExcel(workbook, period);
}

function parseSlotenExcel(workbook, monthlySheets) {
  let count = 0;
  const primaryKeys = ['GGR', '総入金額', '総出金額', '入出金差分', 'T/O', 'RTP', 'NGR', '登録人数', 'ログインユーザー数', 'GGRLTV'];
  monthlySheets.forEach(sheetName => {
    const sheet = workbook.Sheets[sheetName];
    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    const kpi = {}, depositMethods = {}, withdrawMethods = {}, gameData = {}, affData = {}, cryptoData = {}, providerData = {};
    data.forEach((row, idx) => { if (!row || row.length < 2) return; const rawLabel = String(row[0] || '').trim(); if (!rawLabel || rawLabel === '項目名' || rawLabel.includes('【')) return; const label = rawLabel.split('/')[0].trim(); const val = parseNumber(row[1]); if (val === null) return; const isPrimaryKey = primaryKeys.some(pk => label === pk || label.startsWith(pk)); if (isPrimaryKey && kpi[label] !== undefined) return; if (idx < 90 || !isPrimaryKey) kpi[label] = val; });
    for (let i = 191; i < Math.min(198, data.length); i++) { const row = data[i]; if (row && row[0] && row[1] !== undefined) { const key = String(row[0]).trim(); if (key && key !== '入金' && key !== '合計金額') { const val = parseNumber(row[1]); if (val !== null && val > 0) depositMethods[key] = val; } } }
    for (let i = 199; i < Math.min(206, data.length); i++) { const row = data[i]; if (row && row[0] && row[1] !== undefined) { const key = String(row[0]).trim(); if (key && key !== '出金' && key !== '合計金額') { const val = parseNumber(row[1]); if (val !== null && val > 0) withdrawMethods[key] = val; } } }
    for (let i = 216; i < Math.min(227, data.length); i++) { const row = data[i]; if (row && row[0]) { const key = String(row[0]).trim(); if (key && /^(BTC|ETH|USDT|TRX|XRP|LTC)/i.test(key)) { const cnt = parseNumber(row[1]) || 0; const amt = parseNumber(row[2]) || 0; if (cnt > 0 || amt > 0) cryptoData[key] = { 件数: cnt, 金額: amt }; } } }
    for (let i = 226; i < Math.min(270, data.length); i++) { const row = data[i]; if (row && row[0]) { const key = String(row[0]).trim(); if (key === 'プロバイダー' || key.includes('アクティブ')) continue; const users = parseNumber(row[1]) || 0; const bet = parseNumber(row[2]) || 0; const payout = parseNumber(row[3]) || 0; if (users > 0 || bet > 0) providerData[key] = { ユーザー数: users, 賭け金額: bet, 配当金額: payout, GGR: bet - payout }; } }
    const gamePositions = [{ name: 'パチンコ', userRow: 123, toRow: 124, ggrRow: 127 },{ name: 'パチスロ', userRow: 142, toRow: 143, ggrRow: 146 },{ name: 'スロット', userRow: 161, toRow: 162, ggrRow: 165 },{ name: 'ライブ', userRow: 180, toRow: 181, ggrRow: 184 }];
    gamePositions.forEach(g => { if (data[g.userRow] && data[g.toRow] && data[g.ggrRow]) { gameData[g.name] = { ユーザー数: parseNumber(data[g.userRow]?.[1]) || 0, TO: parseNumber(data[g.toRow]?.[1]) || 0, GGR: parseNumber(data[g.ggrRow]?.[1]) || 0 }; } });
    for (let i = 92; i < Math.min(112, data.length); i++) { const row = data[i]; if (row && row[0] && row[1] !== undefined) { const key = String(row[0]).trim().split('/')[0].trim(); if (key && key.includes('AFF')) { const val = parseNumber(row[1]); if (val !== null) affData[key] = val; } } }
    const year = sheetName.substring(0, 4), month = parseInt(sheetName.substring(4, 6)), periodName = `${year}年${month}月`;
    if (Object.keys(kpi).length > 0) {
      BUSINESSES['スロ天'].data[periodName] = { サマリー: kpi, ...(Object.keys(depositMethods).length > 0 ? { 入金方法: depositMethods } : {}), ...(Object.keys(withdrawMethods).length > 0 ? { 出金方法: withdrawMethods } : {}), ...(Object.keys(cryptoData).length > 0 ? { 仮想通貨: cryptoData } : {}), ...(Object.keys(providerData).length > 0 ? { プロバイダー: providerData } : {}), ...(Object.keys(gameData).length > 0 ? { ゲーム別: gameData } : {}), ...(Object.keys(affData).length > 0 ? { Affiliate: affData } : {}) };
      count++;
    }
  });
  showStatus(`スロ天データ取込完了: ${count}期間`);
  selectBusiness('スロ天'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseBaccaratExcel(workbook, period) {
  // 各シートを取得
  const dashSheetName = workbook.SheetNames.find(s => s.includes('ダッシュボード') || s.includes('サマリー'));
  const dashSheet = dashSheetName ? workbook.Sheets[dashSheetName] : null;
  const costSheet = workbook.Sheets['コスト'] || workbook.Sheets['cost'];
  const userSheet = workbook.Sheets['ユーザー・収益分析'] || workbook.Sheets['ユーザー分析'];
  const followerSheet = workbook.Sheets['SNSフォロワー数'] || workbook.Sheets['フォロワー数'];
  
  const extractedData = {
    'Twitter': 0, 'Instagram': 0, 'TikTok': 0, 'YouTube': 0, 'LINE公式': 0,
    '総ユーザー数': 0, '総入金額': 0, '平均T/O': 0, '総GGR': 0, 'コミッション': 0, 'コスト': 0, 'NGR': 0
  };
  
  // SNSフォロワー数シートから最新データを取得
  if (followerSheet) {
    const followerData = XLSX.utils.sheet_to_json(followerSheet, { header: 1 });
    // ヘッダー行を探す
    let colMap = {};
    followerData.forEach((row, idx) => {
      if (!row) return;
      const first = String(row[0] || '').trim();
      if (first === '日付' || first.includes('日付')) {
        row.forEach((cell, colIdx) => {
          const h = String(cell || '').trim();
          if (h === 'Twitter' || h === 'X') colMap['Twitter'] = colIdx;
          else if (h === 'Instagram') colMap['Instagram'] = colIdx;
          else if (h === 'TikTok') colMap['TikTok'] = colIdx;
          else if (h === 'YouTube') colMap['YouTube'] = colIdx;
          else if (h.includes('LINE')) colMap['LINE公式'] = colIdx;
        });
      }
    });
    // 最新の有効なデータを下から探す
    for (let i = followerData.length - 1; i >= 0; i--) {
      const row = followerData[i];
      if (!row) continue;
      let hasData = false;
      for (const [key, colIdx] of Object.entries(colMap)) {
        const val = parseNumber(row[colIdx]);
        if (val !== null && val > 0 && extractedData[key] === 0) {
          extractedData[key] = val;
          hasData = true;
        }
      }
      if (hasData) break;
    }
  }
  
  // ダッシュボードシートからサマリーデータを抽出
  if (dashSheet) {
    const dashData = XLSX.utils.sheet_to_json(dashSheet, { header: 1 });
    dashData.forEach(row => {
      if (!row || row.length < 2) return;
      const label = String(row[0] || '').trim();
      const value = parseNumber(row[1]);
      if (value === null) return;
      
      // ユーザー・収益
      if (label.includes('総ユーザー')) extractedData['総ユーザー数'] = value;
      else if (label.includes('総入金')) extractedData['総入金額'] = value;
      else if (label.includes('平均T/O') || label.includes('平均TO')) extractedData['平均T/O'] = value;
      else if (label.includes('総GGR') || (label.includes('GGR') && !label.includes('NGR'))) extractedData['総GGR'] = value;
      else if (label.includes('コミッション')) extractedData['コミッション'] = value;
      else if (label === 'コスト' || label === 'cost') extractedData['コスト'] = value;
      else if (label === 'NGR' || label.includes('NGR')) extractedData['NGR'] = value;
    });
  }
  
  // ユーザー・収益分析シートから合計行を取得（ダッシュボードにない場合のフォールバック）
  if (userSheet) {
    const userData = XLSX.utils.sheet_to_json(userSheet, { header: 1 });
    // ヘッダー行を探す
    let headerIdx = -1;
    let colMap = {};
    userData.forEach((row, idx) => {
      if (!row) return;
      const first = String(row[0] || '').trim();
      if (first === '日付' || first.includes('日付')) {
        headerIdx = idx;
        row.forEach((cell, colIdx) => {
          const h = String(cell || '').trim();
          if (h.includes('ユーザー')) colMap['users'] = colIdx;
          else if (h.includes('入金額')) colMap['deposit'] = colIdx;
          else if (h.includes('T/O') || h.includes('ターンオーバー')) colMap['to'] = colIdx;
          else if (h.includes('GGR')) colMap['ggr'] = colIdx;
        });
      }
      // 合計行
      if (first === '合計') {
        if (colMap['users'] && extractedData['総ユーザー数'] === 0) {
          const v = parseNumber(row[colMap['users']]);
          if (v !== null) extractedData['総ユーザー数'] = v;
        }
        if (colMap['deposit'] && extractedData['総入金額'] === 0) {
          const v = parseNumber(row[colMap['deposit']]);
          if (v !== null) extractedData['総入金額'] = v;
        }
        if (colMap['ggr'] && extractedData['総GGR'] === 0) {
          const v = parseNumber(row[colMap['ggr']]);
          if (v !== null) extractedData['総GGR'] = v;
        }
      }
    });
  }
  
  // コストシートから合計を取得
  if (costSheet) {
    const costData = XLSX.utils.sheet_to_json(costSheet, { header: 1 });
    costData.forEach(row => {
      if (!row) return;
      const label = String(row[0] || '').trim();
      if (label === '合計' || label.toLowerCase() === 'total') {
        // 金額列（通常は列2）
        const costVal = parseNumber(row[2]) || parseNumber(row[1]) || 0;
        if (costVal > 0 && extractedData['コスト'] === 0) extractedData['コスト'] = costVal;
      }
    });
  }
  
  // NGRが0の場合は計算
  if (extractedData['NGR'] === 0 && (extractedData['総GGR'] !== 0 || extractedData['コスト'] !== 0)) {
    extractedData['NGR'] = extractedData['総GGR'] - extractedData['コスト'];
  }
  
  // フォロワー数合計を計算
  extractedData['合計フォロワー'] = extractedData['Twitter'] + extractedData['Instagram'] + 
                                   extractedData['TikTok'] + extractedData['YouTube'] + extractedData['LINE公式'];
  
  // データを保存
  BUSINESSES['バカラツール'].data['全期間'] = { サマリー: extractedData };
  
  const ggrStr = extractedData['総GGR'] >= 0 ? `GGR ¥${Math.round(extractedData['総GGR']).toLocaleString()}` : `GGR ¥${Math.round(extractedData['総GGR']).toLocaleString()}`;
  const ngrStr = extractedData['NGR'] >= 0 ? `NGR ¥${Math.round(extractedData['NGR']).toLocaleString()}` : `NGR ¥${Math.round(extractedData['NGR']).toLocaleString()}`;
  showStatus(`バカラツール取込完了: ユーザー${extractedData['総ユーザー数']}人, ${ggrStr}, ${ngrStr}`);
  selectBusiness('バカラツール'); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseSamExcel(workbook, revenueSheets) {
  let amuseCount = 0, dscCount = 0;
  revenueSheets.forEach(sheetName => { const sheet = workbook.Sheets[sheetName]; const data = XLSX.utils.sheet_to_json(sheet, { header: 1 }); const isDSC = sheetName.endsWith('D'); let periodName = sheetName.replace('収益', '').replace(/D$/, ''); const extracted = {}; data.forEach(row => { if (row[1] && row[2] !== undefined && row[2] !== null && row[2] !== '') { const key = String(row[1]).trim().replace(/（/g, '(').replace(/）/g, ')'); const val = parseNumber(row[2]); if (val !== null && !String(row[2]).startsWith('#') && !key.startsWith('0.')) extracted[key] = val; } if (row[3] && row[4] !== undefined && row[4] !== null && row[4] !== '') { const key = String(row[3]).trim().replace(/（/g, '(').replace(/）/g, ')'); const val = parseNumber(row[4]); if (val !== null && !String(row[4]).startsWith('#') && !key.startsWith('0.')) extracted[key] = val; } }); if (Object.keys(extracted).length > 0) { if (isDSC) { BUSINESSES['DSC'].data[periodName] = { サマリー: extracted }; dscCount++; } else { BUSINESSES['元amuse'].data[periodName] = { サマリー: extracted }; amuseCount++; } } });
  showStatus(`収益シート取込完了: 元amuse ${amuseCount}件, DSC ${dscCount}件`);
  if (dscCount > 0) selectBusiness('DSC'); else selectBusiness('元amuse');
  saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function parseGenericExcel(workbook, period) {
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
  const kpi = {};
  data.forEach(row => { if (!row || row.length < 2) return; const label = String(row[0] || '').trim(); const val = parseNumber(row[1]); if (label && val !== null) kpi[label] = val; });
  BUSINESSES[currentBusiness].data[period] = { サマリー: kpi };
  showStatus(`Excel取込完了: ${Object.keys(kpi).length}項目`);
  selectBusiness(currentBusiness); saveBusinessData(); setTimeout(hideUploadModal, 1500);
}

function addBusiness() { const name = document.getElementById('new-business-name').value.trim(); const type = document.getElementById('new-business-type').value; if (!name) { alert('事業名を入力してください'); return; } if (BUSINESSES[name]) { alert('同名の事業が存在します'); return; } BUSINESSES[name] = { data: {}, type: type }; saveBusinessData(); hideAddBusinessModal(); selectBusiness(name); }
function deleteBusiness() { if (Object.keys(BUSINESSES).length <= 1) { alert('最後の事業は削除できません'); return; } if (confirm(`「${currentBusiness}」を削除しますか？`)) { delete BUSINESSES[currentBusiness]; saveBusinessData(); selectBusiness(Object.keys(BUSINESSES)[0]); } }

// ========== 営業報告書プロンプト生成 ==========
function showReportPromptModal() {
  const business = BUSINESSES[currentBusiness];
  if (!business) { alert('事業を選択してください'); return; }
  
  let data;
  let periodLabel;
  if (viewMode === 'total') {
    const result = calculateTotalsAndAverages(currentBusiness);
    if (!result) { alert('データがありません'); return; }
    data = result.totals;
    periodLabel = '全期間トータル';
  } else {
    const periodData = business.data?.[currentPeriod];
    data = periodData?.サマリー || periodData || {};
    periodLabel = currentPeriod || '未選択';
  }
  
  if (!data || Object.keys(data).length === 0) { alert('データがありません'); return; }
  
  document.getElementById('report-business-period').textContent = `${currentBusiness} - ${periodLabel}`;
  document.getElementById('report-prompt-text').value = generateReportPrompt(currentBusiness, periodLabel, data, business.type);
  document.getElementById('report-prompt-modal').classList.remove('hidden');
}

function hideReportPromptModal() { document.getElementById('report-prompt-modal').classList.add('hidden'); }

function copyReportPrompt() {
  const text = document.getElementById('report-prompt-text').value;
  navigator.clipboard.writeText(text).then(() => {
    showStatus('📋 プロンプトをコピーしました');
  }).catch(() => {
    document.getElementById('report-prompt-text').select();
    document.execCommand('copy');
    showStatus('📋 プロンプトをコピーしました');
  });
}

function generateReportPrompt(businessName, period, data, type) {
  const formatVal = (key, val) => {
    if (val == null) return null;
    if (key.includes('率') || key.includes('割合') || key === 'RTP') {
      return (val * 100).toFixed(2) + '%';
    }
    if (typeof val === 'number') {
      if (Math.abs(val) >= 1000000) return '¥' + (val / 1000000).toFixed(2) + 'M';
      if (Math.abs(val) >= 1000) return '¥' + Math.round(val).toLocaleString();
      return val.toLocaleString();
    }
    return val;
  };
  
  let prompt = `以下は「${businessName}」の${period}の営業データです。このデータを元に営業報告書を作成してください。\n\n`;
  prompt += `【事業名】${businessName}\n【期間】${period}\n\n`;
  prompt += `【主要KPIデータ】\n`;
  
  // 事業タイプに応じた主要KPIの順序
  let keyOrder = [];
  if (type === 'konibet') {
    keyOrder = ['登録人数', 'FTD数', '入金者数', '総入金額', '総出金額', '入出金差分', 'T/O', 'GGR', 'NGR', 'ボーナス', 'ゲームプロバイダーフィー', 'PSP手数料', 'AFF報酬', 'アクティブプレイ人数', '新規入金転移率', '平均入金額', '出金人数割合', 'T/O倍率', 'ボーナス付与率', 'GGR率', 'NGR率', 'RTP'];
  } else if (type === 'sloten') {
    keyOrder = ['GGR', '総入金額', '総出金額', '入出金差分', 'T/O', 'RTP', 'NGR', '登録人数', 'ログインユーザー数'];
  } else if (type === 'baccara') {
    keyOrder = ['Twitter', 'Instagram', 'TikTok', 'YouTube', 'LINE公式', '合計フォロワー', '総ユーザー数', '総入金額', '平均T/O', '総GGR', 'コスト', 'NGR'];
  } else if (type === 'ads') {
    keyOrder = ['コスト($)', 'インプレッション', 'クリック', '登録数', '入金数', 'CPA(税込)'];
  } else {
    keyOrder = ['T/O', 'GGR', 'NGR', '回収率', '入出金差分'];
  }
  
  // 主要KPIを出力
  keyOrder.forEach(key => {
    const val = data[key];
    if (val != null) {
      prompt += `・${key}: ${formatVal(key, val)}\n`;
    }
  });
  
  // その他のKPIも出力
  prompt += `\n【その他データ】\n`;
  Object.keys(data).forEach(key => {
    if (!keyOrder.includes(key) && key !== '為替レート(USD/JPY)') {
      const val = data[key];
      if (val != null) {
        prompt += `・${key}: ${formatVal(key, val)}\n`;
      }
    }
  });
  
  prompt += `\n---\n`;
  prompt += `上記データを元に、以下の構成で営業報告書を作成してください：\n`;
  prompt += `1. サマリー（主要指標の概要）\n`;
  prompt += `2. 前期比較・トレンド分析（可能であれば）\n`;
  prompt += `3. 課題と改善点\n`;
  prompt += `4. 次期の目標・アクションプラン\n`;
  
  return prompt;
}

</script>
</body>
</html>
