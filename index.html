<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº‹æ¥­åˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f1f5f9; min-height: 100vh; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .header h1 { font-size: 24px; color: #1e293b; }
    .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .card { background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 20px; margin-bottom: 20px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab { padding: 10px 18px; border-radius: 10px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; background: #e2e8f0; color: #475569; }
    .tab:hover { background: #cbd5e1; }
    .tab.active { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
    .btn { padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn-primary { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
    .btn-secondary { background: #f1f5f9; color: #475569; }
    .btn-danger { background: #fee2e2; color: #dc2626; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; margin-bottom: 24px; }
    .summary-card { border-radius: 14px; padding: 16px; color: white; }
    .summary-card h3 { font-size: 11px; opacity: 0.9; margin-bottom: 4px; }
    .summary-card .value { font-size: 20px; font-weight: 700; }
    .chart-container { height: 300px; margin: 20px 0; }
    .period-selector { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .period-btn { padding: 6px 14px; border-radius: 8px; border: none; cursor: pointer; font-size: 12px; background: #f1f5f9; color: #64748b; }
    .period-btn.active { background: #3b82f6; color: white; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: white; border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .upload-zone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .upload-zone:hover, .upload-zone.dragover { border-color: #3b82f6; background: #eff6ff; }
    .hidden { display: none !important; }
    .links-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; max-height: 400px; overflow-y: auto; }
    .link-category { background: white; border-radius: 12px; padding: 16px; border: 1px solid #e2e8f0; }
    .link-category h4 { font-size: 13px; color: #64748b; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0; }
    .link-item { display: inline-block; background: #dbeafe; color: #1d4ed8; padding: 4px 10px; border-radius: 6px; font-size: 12px; margin: 3px; text-decoration: none; transition: all 0.2s; }
    .link-item:hover { background: #bfdbfe; transform: translateY(-1px); }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f8fafc; font-weight: 600; color: #64748b; position: sticky; top: 0; }
    tr:hover { background: #f8fafc; }
    .text-right { text-align: right; }
    .text-green { color: #16a34a; }
    .text-red { color: #dc2626; }
    input, select { padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 100%; }
    input:focus, select:focus { outline: none; border-color: #3b82f6; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; color: #64748b; margin-bottom: 6px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    footer { text-align: center; color: #94a3b8; font-size: 11px; margin-top: 30px; padding: 20px; }
    .agent-table { max-height: 400px; overflow-y: auto; }
    .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; }
    .status-positive { background: #dcfce7; color: #16a34a; }
    .status-negative { background: #fee2e2; color: #dc2626; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š äº‹æ¥­åˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="showUploadModal()">ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <button class="btn btn-secondary" onclick="showAddBusinessModal()">â• äº‹æ¥­è¿½åŠ </button>
      </div>
    </div>

    <div class="tabs" id="business-tabs"></div>
    <div id="period-selector" class="period-selector"></div>
    <div id="summary-section" class="summary-grid"></div>

    <div class="card">
      <h3 style="margin-bottom: 16px; color: #1e293b;">ğŸ“ˆ æ¨ç§»ã‚°ãƒ©ãƒ•</h3>
      <div class="chart-container"><canvas id="main-chart"></canvas></div>
    </div>

    <div id="links-section" class="card hidden">
      <h3 style="margin-bottom: 16px; color: #1e293b;" id="links-title">ğŸ”— ãƒªãƒ³ã‚¯ä¸€è¦§</h3>
      <div id="links-grid" class="links-grid"></div>
    </div>

    <div id="data-table" class="card">
      <h3 style="margin-bottom: 16px; color: #1e293b;">ğŸ“‹ è©³ç´°ãƒ‡ãƒ¼ã‚¿</h3>
      <div class="table-container agent-table">
        <table><thead><tr id="table-header"></tr></thead><tbody id="table-body"></tbody></table>
      </div>
    </div>

    <footer>åç›Šç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v2.0 | å…ƒamuseãƒ»DSCãƒ»ã‚¹ãƒ­å¤©ãƒ»AMUSEVIPãƒ»åºƒå‘Šãƒ»ãƒã‚«ãƒ©ãƒ„ãƒ¼ãƒ«å¯¾å¿œ</footer>
  </div>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal hidden">
    <div class="modal-content">
      <h3 style="margin-bottom: 20px;">ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
      <div class="form-row">
        <div class="form-group">
          <label>æœŸé–“</label>
          <input type="text" id="upload-period" placeholder="ä¾‹: 2025å¹´10æœˆ">
        </div>
        <div class="form-group">
          <label>ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥</label>
          <select id="upload-type">
            <option value="auto">è‡ªå‹•åˆ¤åˆ¥</option>
            <option value="revenue">åç›Šã‚·ãƒ¼ãƒˆï¼ˆå…ƒamuse/DSCï¼‰</option>
            <option value="sloten">ã‚¹ãƒ­å¤©æœˆæ¬¡</option>
            <option value="agent">AMUSEVIP ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</option>
            <option value="ads">åºƒå‘Šãƒ‡ãƒ¼ã‚¿</option>
            <option value="baccarat">ãƒã‚«ãƒ©ãƒ„ãƒ¼ãƒ«</option>
          </select>
        </div>
      </div>
      <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“</div>
        <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
        <p style="font-size: 12px; color: #94a3b8; margin-top: 8px;">.xlsx, .xls, .csv å¯¾å¿œ</p>
      </div>
      <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileUpload(this.files[0])">
      <div id="upload-status" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
      <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="hideUploadModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Add Business Modal -->
  <div id="add-business-modal" class="modal hidden">
    <div class="modal-content">
      <h3 style="margin-bottom: 20px;">â• äº‹æ¥­è¿½åŠ </h3>
      <div class="form-group">
        <label>äº‹æ¥­å</label>
        <input type="text" id="new-business-name" placeholder="ä¾‹: æ–°è¦äº‹æ¥­">
      </div>
      <div class="form-group">
        <label>äº‹æ¥­ã‚¿ã‚¤ãƒ—</label>
        <select id="new-business-type">
          <option value="standard">æ¨™æº–ï¼ˆGGR/NGRç­‰ï¼‰</option>
          <option value="agent">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹</option>
          <option value="ads">åºƒå‘Šå‹</option>
          <option value="tool">ãƒ„ãƒ¼ãƒ«å‹</option>
        </select>
      </div>
      <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="hideAddBusinessModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="addBusiness()">è¿½åŠ </button>
      </div>
    </div>
  </div>

<script>
// ========================================
// ãƒ‡ãƒ¼ã‚¿å®šç¾©
// ========================================

const BUSINESSES = {
  'å…ƒamuse': {
    type: 'standard',
    data: {
      '2025å¹´10æœˆ': { 'GGR': 70311340, 'NGR': 30910896, 'T/O': 1577495817, 'RTP': 95.54, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 294, 'FTDæ•°': 48, 'å›åç‡': 77.89, 'LTV': 239154, 'å›åé‡‘é¡': 55956778, 'å‡ºé‡‘é‡‘é¡': 17719827 },
      '2025å¹´9æœˆ': { 'GGR': -2176638, 'NGR': 0, 'T/O': 56770645, 'RTP': 103.83, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 0, 'FTDæ•°': 0, 'å›åç‡': 0, 'LTV': 0 },
      '2025å¹´8æœˆ': { 'GGR': 56952667, 'NGR': 23459499, 'T/O': 1910465086, 'RTP': 97.35, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 284, 'FTDæ•°': 12, 'å›åç‡': 77.59, 'LTV': 92276 },
      '2025å¹´7æœˆ': { 'GGR': 89408914, 'NGR': 3791600, 'T/O': 3753649644, 'RTP': 97.62, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 381, 'FTDæ•°': 11, 'å›åç‡': 66.86, 'LTV': 34271 },
      '2025å¹´6æœˆ': { 'GGR': 106821992, 'NGR': 69120861, 'T/O': 3764837698, 'RTP': 97.16, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 698, 'FTDæ•°': 0, 'å›åç‡': 0, 'LTV': 113348 },
      '2025å¹´5æœˆ': { 'GGR': 30822400, 'NGR': 21494893, 'T/O': 5416323482, 'RTP': 99.95, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 754, 'FTDæ•°': 110, 'å›åç‡': 83.35, 'LTV': 40878 },
      '2025å¹´4æœˆ': { 'GGR': 69357611, 'NGR': 62624282, 'T/O': 3401315523, 'RTP': 97.63, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 551, 'FTDæ•°': 127, 'å›åç‡': 89.32, 'LTV': 125875 },
      '2025å¹´3æœˆ': { 'GGR': 88303648, 'NGR': 73575372, 'T/O': 2574622273, 'RTP': 97.37, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 455, 'FTDæ•°': 103, 'å›åç‡': 93.93, 'LTV': 194073 },
    }
  },
  'DSC': {
    type: 'standard',
    data: {
      '2026å¹´1æœˆ': { 'GGR': 43248155, 'NGR': 20776887, 'T/O': 1342354453, 'RTP': 96.78, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 173, 'FTDæ•°': 10, 'å›åç‡': 80.07, 'LTV': 128277 },
      '2025å¹´12æœˆ': { 'GGR': 53578505, 'NGR': 31242527, 'T/O': 1514244472, 'RTP': 96.46, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 292, 'FTDæ•°': 1, 'å›åç‡': 83.81, 'LTV': 133161 },
      '2025å¹´11æœˆ': { 'GGR': 64900999, 'NGR': 33610642, 'T/O': 1568206349, 'RTP': 95.86, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 227, 'FTDæ•°': 29, 'å›åç‡': 82.91, 'LTV': 191404 },
      '2025å¹´9æœˆ': { 'GGR': 74174997, 'NGR': 31772784, 'T/O': 2578173994, 'RTP': 97.12, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 298, 'FTDæ•°': 73, 'å›åç‡': 81.94, 'LTV': 137774 },
      '2025å¹´8æœˆ': { 'GGR': 10510724, 'NGR': -1612843, 'T/O': 624445698, 'RTP': 98.32, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 135, 'FTDæ•°': 7, 'å›åç‡': 21.50, 'LTV': -11946 },
      '2025å¹´7æœˆ': { 'GGR': 89408914, 'NGR': -1758164, 'T/O': 3753649644, 'RTP': 97.62, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼': 381, 'FTDæ•°': 11, 'å›åç‡': 66.86, 'LTV': 34271 },
    }
  },
  'ã‚¹ãƒ­å¤©': {
    type: 'sloten',
    data: {}
  },
  'AMUSEVIP': {
    type: 'agent',
    data: {
      'ã‚µãƒ³ãƒ—ãƒ«': {
        'ç·åç›Š': 5000000,
        'ãƒ­ãƒ¼ãƒªãƒ³ã‚°å ±é…¬': 1000000,
        'NGR': 4000000,
        'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ•°': 10
      }
    },
    agents: [
      { name: 'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆA', revenue: 1500000, rolling: 300000, ngr: 1200000 },
      { name: 'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆB', revenue: 1200000, rolling: 240000, ngr: 960000 },
      { name: 'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆC', revenue: 800000, rolling: 160000, ngr: 640000 },
    ]
  },
  'åºƒå‘Š': {
    type: 'ads',
    data: {
      'ã‚µãƒ³ãƒ—ãƒ«': {
        'ã‚³ã‚¹ãƒˆ': 500000,
        'ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³': 1000000,
        'ã‚¯ãƒªãƒƒã‚¯': 50000,
        'CTR': 5.0,
        'ç™»éŒ²æ•°': 500,
        'å…¥é‡‘æ•°': 100,
        'CVR': 1.0,
        'CPA': 1000
      }
    }
  },
  'ãƒã‚«ãƒ©ãƒ„ãƒ¼ãƒ«': {
    type: 'tool',
    data: {
      'å…¨æœŸé–“': {
        'LINEæµå…¥': 0,
        'Telegramæµå…¥': 0,
        'Twitteræµå…¥': 0,
        'åˆè¨ˆæµå…¥': 0,
        'ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°': 0,
        'ç·å…¥é‡‘é¡': 0,
        'ç·GGR': 0,
        'ã‚³ã‚¹ãƒˆ': 788525.92,
        'NGR': -788525.92
      }
    }
  }
};

// DSCãƒªãƒ³ã‚¯ï¼ˆ56ä»¶ï¼‰
const DSC_LINKS = [
  { category: 'WELCOMELP', name: 'ãƒ¡ã‚¤ãƒ³', url: 'https://lp.diamond-secret.club/' },
  { category: 'WELCOMELP', name: '1', url: 'https://lp.diamond-secret.club/1/' },
  { category: 'WELCOMELP', name: 'A', url: 'https://lp.diamond-secret.club/A/' },
  { category: 'WELCOMELP', name: 'BIZ', url: 'https://lp.diamond-secret.club/BIZ/' },
  { category: 'WELCOMELP', name: 'AR', url: 'https://lp.diamond-secret.club/AR/' },
  { category: 'WELCOMELP', name: 'NA', url: 'https://lp.diamond-secret.club/NA/' },
  { category: 'WELCOMELP', name: 'OO', url: 'https://lp.diamond-secret.club/OO/' },
  { category: 'WELCOMELP', name: 'SK', url: 'https://lp.diamond-secret.club/SK/' },
  { category: 'WELCOMELP', name: 'TK', url: 'https://lp.diamond-secret.club/TK/' },
  { category: 'é–‹é‹LP', name: 'ãƒ¡ã‚¤ãƒ³', url: 'https://lp.diamond-secret.club/kaiun/' },
  { category: 'é–‹é‹LP', name: 'AR', url: 'https://lp.diamond-secret.club/kaiun/AR/' },
  { category: 'é–‹é‹LP', name: 'NK', url: 'https://lp.diamond-secret.club/kaiun/NK/' },
  { category: 'é–‹é‹LP', name: 'OO', url: 'https://lp.diamond-secret.club/kaiun/OO/' },
  { category: 'é–‹é‹LP', name: 'SU', url: 'https://lp.diamond-secret.club/kaiun/SU/' },
  { category: 'é–‹é‹LP', name: 'TK', url: 'https://lp.diamond-secret.club/kaiun/TK/' },
  { category: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆLP', name: 'ãƒ¡ã‚¤ãƒ³', url: 'https://lp.diamond-secret.club/credit/' },
  { category: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆLP', name: 'BIZ', url: 'https://lp.diamond-secret.club/credit/BIZ/' },
  { category: 'UPSLP', name: 'ãƒ¡ã‚¤ãƒ³', url: 'https://lp.diamond-secret.club/UPS/' },
  { category: 'UPSLP', name: 'BIZ', url: 'https://lp.diamond-secret.club/UPS/BIZ/' },
  { category: '10æ—¥é–“ç„¡åˆ©æ¯LP', name: 'ãƒ¡ã‚¤ãƒ³', url: 'https://lp.diamond-secret.club/10days/' },
  { category: '10æ—¥é–“ç„¡åˆ©æ¯LP', name: 'AR', url: 'https://lp.diamond-secret.club/10days/AR/' },
  { category: '10æ—¥é–“ç„¡åˆ©æ¯LP', name: 'OO', url: 'https://lp.diamond-secret.club/10days/OO/' },
  { category: '10æ—¥é–“ç„¡åˆ©æ¯LP', name: 'TK', url: 'https://lp.diamond-secret.club/10days/TK/' },
  { category: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³LP', name: 'ãƒã‚«ãƒ©å¤§ä¼š', url: 'https://lp.diamond-secret.club/baccaratournament/' },
  { category: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³LP', name: 'å‹ã¡ãƒãƒƒã‚¯', url: 'https://lp.diamond-secret.club/backlp/' },
  { category: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³LP', name: 'å®ãã˜', url: 'https://lp.diamond-secret.club/takarakuji/' },
  { category: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³LP', name: 'ãƒªãƒœãƒ—ãƒ¬ã‚¤', url: 'https://lp.diamond-secret.club/riboplay/' },
  { category: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³LP', name: 'ã‚¹ãƒ­ãƒƒãƒˆã‚«ãƒ³ã‚¹ãƒˆ', url: 'https://lp.diamond-secret.club/slotkanst/' },
  { category: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³LP', name: 'ãƒã‚«ãƒ©åºƒå‘Šç”¨', url: 'https://lp.diamond-secret.club/baccara_ad/' },
  { category: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³LP', name: 'BaccaratMillion', url: 'https://lp.diamond-secret.club/baccaratmillion/' },
  { category: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³LP', name: 'PayPay', url: 'https://lp.diamond-secret.club/paypay/' },
  { category: 'é‡çƒLP', name: 'ãƒ¡ã‚¤ãƒ³', url: 'https://lp.diamond-secret.club/baseball/' },
  { category: 'é‡çƒLP', name: 'AR', url: 'https://lp.diamond-secret.club/baseball/AR/' },
  { category: 'é‡çƒLP', name: 'OO', url: 'https://lp.diamond-secret.club/baseball/OO/' },
  { category: 'é‡çƒLP', name: 'TK', url: 'https://lp.diamond-secret.club/baseball/TK/' },
  { category: 'é‡çƒå‘ŠçŸ¥LP', name: 'ãƒ¡ã‚¤ãƒ³', url: 'https://lp.diamond-secret.club/baseball_notice/' },
  { category: 'maxkaitori', name: 'ãƒ¡ã‚¤ãƒ³', url: 'https://lp.diamond-secret.club/maxkaitori/' },
  { category: 'maxkaitori', name: 'BIZ', url: 'https://lp.diamond-secret.club/maxkaitori/BIZ/' },
  { category: 'maxkaitori', name: 'G', url: 'https://lp.diamond-secret.club/maxkaitori/G/' },
  { category: 'maxkaitori', name: 'T', url: 'https://lp.diamond-secret.club/maxkaitori/T/' },
  { category: 'maxkaitori', name: 'X', url: 'https://lp.diamond-secret.club/maxkaitori/X/' },
  { category: 'maxkaitori', name: 'Y', url: 'https://lp.diamond-secret.club/maxkaitori/Y/' },
  { category: 'ãƒ„ãƒ¼ãƒ«', name: 'MOL', url: 'https://mol-d-x.com/' },
  { category: 'ãƒ„ãƒ¼ãƒ«', name: 'MOLç®¡ç†ç”»é¢', url: 'https://mol-d-x.com/admin' },
  { category: 'ãƒ„ãƒ¼ãƒ«', name: 'æš´éœ²ãƒšãƒ¼ã‚¸', url: 'https://expose.diamond-secret.club/' },
  { category: 'ãƒ„ãƒ¼ãƒ«', name: 'å…¥å‡ºé‡‘ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ', url: 'https://payment.diamond-secret.club/' },
  { category: 'ãƒ„ãƒ¼ãƒ«', name: 'ã‚®ãƒ£ãƒ³ãƒ–ãƒ«å ã„', url: 'https://lp.diamond-secret.club/fortune/' },
  { category: 'ãƒ„ãƒ¼ãƒ«', name: 'ã‚¹ãƒ­ãƒƒãƒˆå›³é‘‘', url: 'https://lp.diamond-secret.club/slotzukan/' },
  { category: 'ãã®ä»–', name: 'ã‚²ãƒ¼ãƒ åºƒå‘Šç”¨', url: 'https://lp.diamond-secret.club/game_ad/' },
  { category: 'ãã®ä»–', name: 'SLOTENTEST', url: 'https://lp.diamond-secret.club/SLOTENTEST/' },
  { category: 'ãã®ä»–', name: 'é«˜é…å½“è²·å–', url: 'https://lp.diamond-secret.club/highpayout/' },
  { category: 'ãã®ä»–', name: '5ã®ã¤ãæ—¥CB', url: 'https://lp.diamond-secret.club/5day_cb/' },
  { category: 'ãã®ä»–', name: '9ã®ã¤ãæ—¥6ç¢ºå®š', url: 'https://lp.diamond-secret.club/9day_6/' },
];

// ã‚¹ãƒ­å¤©ãƒªãƒ³ã‚¯ï¼ˆ162ä»¶ã‹ã‚‰ä¸»è¦ãªã‚‚ã®ï¼‰
const SLOTEN_LINKS = [
  { category: 'å…¨éƒ¨ç½²', name: 'ç®¡ç†ç”»é¢BO', url: 'https://admin.sloten.io/' },
  { category: 'å…¨éƒ¨ç½²', name: 'ã‚·ãƒ•ãƒˆ', url: 'https://docs.google.com/spreadsheets/d/1tR0hRKy7wyKMc9Nk1MhQ_kOqs3Acg6LoG-nau1VETIA/edit' },
  { category: 'å…¨éƒ¨ç½²', name: 'å…¬å¼ã‚µã‚¤ãƒˆ', url: 'https://sloten.io/' },
  { category: 'å…¨éƒ¨ç½²', name: 'USPLPâ‘ (AFFç”¨)', url: 'https://affiliate2.sloten.io/' },
  { category: 'å…¨éƒ¨ç½²', name: 'é–‹ç™ºãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬', url: 'https://docs.google.com/spreadsheets/d/1qjfoPKpugtf9flrfDsdHHsnLQyIM6ARI4EmPJ-_EYGY/edit' },
  { category: 'å…¨éƒ¨ç½²', name: 'ãƒ‡ã‚¶ã‚¤ãƒ³ä¾é ¼', url: 'https://docs.google.com/document/d/1aZeeeN3jeTOtFIPb-w522eUPwqFQa-HA1jtunnlwhI4/edit' },
  { category: 'å…¨éƒ¨ç½²', name: 'ã‚¨ãƒ©ãƒ¼ä¸€è¦§', url: 'https://docs.google.com/document/d/140p9DoXIrl-g3ARPueRCktRcM6wMtYe0umLsBl_KzJw/edit' },
  { category: 'å…¨éƒ¨ç½²', name: 'DISCORD', url: 'https://discord.gg/7hrDaJfw' },
  { category: 'å…¨éƒ¨ç½²', name: 'LINE', url: 'https://lin.ee/jTDURj3' },
  { category: 'å…¨éƒ¨ç½²', name: 'TELEGRAM', url: 'https://t.me/slotheavenbot' },
  { category: 'å…¨éƒ¨ç½²', name: 'ãƒ‰ãƒªãƒ¼ãƒ ãƒãƒƒãƒˆèª¬æ˜', url: 'https://lottojackpot-jkhjm2sm.manus.space' },
  { category: 'AFF', name: 'Affiliateæ¥­å‹™å†…å®¹', url: 'https://drive.google.com/file/d/1MD17WZ-1_3FPfbSda8ZazXFoHPDBWs5q/view' },
  { category: 'AFF', name: 'AFFéƒ¨é–€', url: 'https://docs.google.com/spreadsheets/d/1GLaqQEoqEJZSRUUkYHiPKMhPXG7X7gwRmpoCe14FTQ8/edit' },
  { category: 'AFF', name: 'ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆç®¡ç†ç”»é¢', url: 'https://asp.sloten.io/login?redirect=/home' },
  { category: 'AFF', name: 'ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆä¸€è¦§', url: 'https://docs.google.com/spreadsheets/d/1RpzwRIDj9kdLA9IgiDyJp2FglPfFjonsehacHzhZA_Q/edit' },
  { category: 'AFF', name: 'ç«¶é¦¬ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼', url: 'https://docs.google.com/spreadsheets/d/1glOO7LnOfonaRDXqbjQp0olXBx4OCwm1w9oWJk1-mIE/edit' },
  { category: 'AFF', name: 'ã‚«ã‚¸ãƒã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼', url: 'https://docs.google.com/spreadsheets/d/1IS_kyOhRxbBryaKKys_2_wrQuZeH1rKfSdhtMoXXyFk/edit' },
  { category: 'CS', name: 'CSæ¥­å‹™å†…å®¹', url: 'https://drive.google.com/file/d/1yaJLp77zkMbuRSklo9c5nTsfJTv7pESC/view' },
  { category: 'CS', name: 'CSéƒ¨é–€', url: 'https://docs.google.com/spreadsheets/d/1lmjDjjwtQvykisZAqUD2OsI9zB_Xru8nTkGIPo5NSsY/edit' },
  { category: 'CS', name: 'ãƒãƒ£ãƒƒãƒˆã‚¦ãƒƒãƒ‰', url: 'https://im.slot-h.com/app/accounts/3/dashboard' },
  { category: 'VIP', name: 'VIPæ¥­å‹™å†…å®¹', url: 'https://drive.google.com/file/d/1ifRKr1I94k2YMjJ0x9rfoLOL4lkBxqnq/view' },
  { category: 'VIP', name: 'VIPéƒ¨é–€', url: 'https://docs.google.com/spreadsheets/d/1UdC202Mx0UP_qzIIJY3tI3DyI4OGAJg88o5C7GIklU0/edit' },
  { category: 'VIP', name: 'é›»è©±ãƒªã‚¹ãƒˆ', url: 'https://docs.google.com/spreadsheets/d/1TKIejq0QR2bywgZ67xsDQKjH5ZYqn3ijJZRzs4t2y9Y/edit' },
  { category: 'ã‚ªãƒš', name: 'ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¥­å‹™å†…å®¹', url: 'https://drive.google.com/file/d/161xgqNM94UIKiszi_kr-UGLtfE-9gnJM/view' },
  { category: 'ã‚ªãƒš', name: 'KPI', url: 'https://docs.google.com/spreadsheets/d/1oGnetFNtGd1ZB-A9YkzzfqIU4Bxh3djsABeEX_bHl8M/edit' },
  { category: 'ã‚ªãƒš', name: 'LPâ‘ è¨ˆæ¸¬ã‚·ãƒ¼ãƒˆ', url: 'https://docs.google.com/spreadsheets/d/18QiN_BoVS-hdP-e4vNOAzjDZaFLTtnWlogJ5AW1hQSY/edit' },
  { category: 'ã‚ªãƒš', name: 'ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ', url: 'https://docs.google.com/spreadsheets/d/1w2bVg5jhKNzkSPrOfdu2siWq1wwRRq3YZGZ5XdhZQBo/edit' },
  { category: 'ã‚ªãƒš', name: 'ãƒ¡ãƒ«ãƒã‚¬', url: 'https://docs.google.com/spreadsheets/d/1B0VSScmblCgUszAxIKvFzdTRSUSqxTnzJSv7djSB5DQ/edit' },
  { category: 'ã‚ªãƒš', name: 'Xè¨ˆæ¸¬ç”¨', url: 'https://millionheaven.site/' },
  { category: 'ã‚ªãƒš', name: 'TIKTOKè¨ˆæ¸¬ç”¨', url: 'https://millionheaven.space/' },
  { category: 'ã‚ªãƒš', name: 'ãƒ¡ãƒ¼ãƒ©ãƒ¼', url: 'https://fviainboxes.com/' },
  { category: 'ãƒšã‚¤ãƒ¡ãƒ³ãƒˆ', name: 'ãƒšã‚¤ãƒ¡ãƒ³ãƒˆæ¥­å‹™å†…å®¹', url: 'https://drive.google.com/file/d/1crHJAlc8zfV-x9jJFoxnDkZ45L0EFEq4/view' },
  { category: 'ãƒšã‚¤ãƒ¡ãƒ³ãƒˆ', name: 'Paymentéƒ¨é–€', url: 'https://docs.google.com/spreadsheets/d/1lBgXBn2GrDejUGd_p_SZJzFXIRRUosApgyJv-ns9PVY/edit' },
  { category: 'ãƒšã‚¤ãƒ¡ãƒ³ãƒˆ', name: 'ãƒã‚¤ãƒ³ãƒˆBO', url: 'https://add.sloten.io/' },
  { category: 'ãƒšã‚¤ãƒ¡ãƒ³ãƒˆ', name: 'ECç€é‡‘ç¢ºèª', url: 'https://docs.google.com/spreadsheets/d/18KCWtE3_wFStjIE8RYlK47XaeAi3TRwGpvugBwSe3Qk/edit' },
  { category: 'ãƒšã‚¤ãƒ¡ãƒ³ãƒˆ', name: 'PayPayç€é‡‘ç¢ºèª', url: 'https://docs.google.com/spreadsheets/d/1a-qM_--jYMaeYgurhRkZRiJH4r9INsrokjTzlzmhSds/edit' },
  { category: 'admin', name: 'ã‚¹ãƒ­å¤©ã‚¬ãƒãƒ£', url: 'https://lp.diamond-secret.club/Slotengacha/' },
  { category: 'admin', name: 'ã‚¹ãƒ­å¤©ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ', url: 'https://lp.diamond-secret.club/Slotenroulet/' },
  { category: 'admin', name: 'ãƒ‰ãƒªãƒ¼ãƒ ãƒãƒƒãƒˆLP', url: 'https://lp.diamond-secret.club/slotentakarakuji/' },
  { category: 'admin', name: 'ã‚³ãƒ¼ãƒ«å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ ', url: 'https://script.google.com/macros/s/AKfycbzi6_9-f5aIk1pKxwsQvH-CZ26wLs7GEruchrCIppiiXxRzIwRmgTIcGgSE0PctoksO/exec' },
  { category: 'admin', name: 'QAã‚·ãƒ¼ãƒˆ', url: 'https://docs.google.com/spreadsheets/d/1TCSDgHmxz6LTs4YDsu4pab0NZxd9vDR7T5q8bX3CJ-c/edit' },
  { category: 'admin', name: 'DRIVE', url: 'https://drive.google.com/drive/folders/1rrIyglyY-NpFUH7af8abapHrJOvojKdg' },
  { category: 'ãƒ„ãƒ¼ãƒ«', name: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', url: 'https://sloten-dashboard.manus.space/' },
  { category: 'ãƒ„ãƒ¼ãƒ«', name: 'ãƒªãƒ³ã‚¯é›†', url: 'https://sloten-link.manus.space' },
  { category: 'ãƒ„ãƒ¼ãƒ«', name: 'CSVã‚»ã‚°ãƒ¡ãƒ³ãƒˆ', url: 'https://crm-segmentation-tool-gnwlkpueqvcdgapck3uv8z.streamlit.app/' },
  { category: 'ãƒ„ãƒ¼ãƒ«', name: 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', url: 'https://shared-calendar-app-iota.vercel.app/' },
  { category: 'ãƒ„ãƒ¼ãƒ«', name: 'SEOãƒ„ãƒ¼ãƒ«', url: 'https://nexus-seo-u5uq936q.manus.space/' },
  { category: 'ãƒ„ãƒ¼ãƒ«', name: 'ã‚¹ãƒ­å¤©CSVãƒ‡ãƒ¼ã‚¿', url: 'https://userdash-eanx4o83.manus.space/?code=C9CEZYMehvBKv3HUVMoNGw' },
  { category: 'ãã®ä»–', name: 'CLOUD', url: 'https://panel.cloudzy.com/dashboard' },
  { category: 'ãã®ä»–', name: 'DC/ACE', url: 'https://share.dc-ace.com/login' },
  { category: 'ãã®ä»–', name: 'ã‚¿ã‚¹ã‚¯ã¾ã¨ã‚', url: 'https://docs.google.com/spreadsheets/d/1ZNo_1jd6EYX6O1cccQ9sa3A2xJwInIMU5QinvOUvk2E/edit' },
  { category: 'ãã®ä»–', name: 'ãƒã‚«ãƒ©ãƒãƒ£ãƒ¬ãƒ³ã‚¸', url: 'https://docs.google.com/spreadsheets/d/1qGd0hneNNqNNZCNMXbO89wYusHIbB0nnNqZNvjsqnbY/edit' },
];

// ========================================
// çŠ¶æ…‹ç®¡ç†
// ========================================
let currentBusiness = 'å…ƒamuse';
let currentPeriod = null;
let chartInstance = null;

// ========================================
// åˆæœŸåŒ–
// ========================================
document.addEventListener('DOMContentLoaded', () => {
  renderTabs();
  selectBusiness('å…ƒamuse');
  setupDragDrop();
});

// ========================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ========================================
function parseNumber(val) {
  if (val === undefined || val === null || val === '' || val === '-') return null;
  if (typeof val === 'number') return val;
  let cleaned = String(val).replace(/[Â¥ï¿¥,ã€\s]/g, '').replace(/^"/, '').replace(/"$/, '').trim();
  if (cleaned.endsWith('%')) cleaned = cleaned.replace(/%$/, '');
  const num = parseFloat(cleaned);
  return isNaN(num) ? null : num;
}

function formatCurrency(val) {
  if (val == null) return '-';
  return 'Â¥' + Math.round(val).toLocaleString();
}

function formatPercent(val) {
  if (val == null) return '-';
  return val.toFixed(2) + '%';
}

function formatNumber(val) {
  if (val == null) return '-';
  return Math.round(val).toLocaleString();
}

function sortPeriods(periods) {
  return [...periods].sort((a, b) => {
    const matchA = a.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
    const matchB = b.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
    if (matchA && matchB) {
      const [, yA, mA] = matchA;
      const [, yB, mB] = matchB;
      return (parseInt(yB) * 12 + parseInt(mB)) - (parseInt(yA) * 12 + parseInt(mA));
    }
    return b.localeCompare(a);
  });
}

// ========================================
// ã‚¿ãƒ–æç”»
// ========================================
function renderTabs() {
  const container = document.getElementById('business-tabs');
  container.innerHTML = Object.keys(BUSINESSES).map(name => 
    `<button class="tab ${name === currentBusiness ? 'active' : ''}" onclick="selectBusiness('${name}')">${name}</button>`
  ).join('') + `<button class="tab btn-danger" onclick="deleteBusiness()" style="margin-left: auto;">ğŸ—‘ï¸</button>`;
}

// ========================================
// äº‹æ¥­é¸æŠ
// ========================================
function selectBusiness(name) {
  currentBusiness = name;
  const business = BUSINESSES[name];
  const data = business?.data || {};
  const periods = sortPeriods(Object.keys(data));
  currentPeriod = periods[0] || null;
  
  renderTabs();
  renderPeriodSelector(periods);
  renderSummary();
  renderChart();
  renderLinks();
  renderTable();
}

// ========================================
// æœŸé–“ã‚»ãƒ¬ã‚¯ã‚¿
// ========================================
function renderPeriodSelector(periods) {
  const container = document.getElementById('period-selector');
  if (periods.length === 0) {
    container.innerHTML = '<span style="color: #94a3b8; font-size: 13px;">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</span>';
    return;
  }
  container.innerHTML = periods.map(p => 
    `<button class="period-btn ${p === currentPeriod ? 'active' : ''}" onclick="selectPeriod('${p}')">${p}</button>`
  ).join('');
}

function selectPeriod(period) {
  currentPeriod = period;
  const periods = sortPeriods(Object.keys(BUSINESSES[currentBusiness]?.data || {}));
  renderPeriodSelector(periods);
  renderSummary();
  renderTable();
}

// ========================================
// ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
// ========================================
function renderSummary() {
  const container = document.getElementById('summary-section');
  const business = BUSINESSES[currentBusiness];
  const data = business?.data?.[currentPeriod];
  
  if (!data) {
    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  
  let cards = [];
  const type = business.type;
  
  if (type === 'standard' || type === 'sloten') {
    cards = [
      { label: 'GGR', key: 'GGR', format: 'currency', color: '#3b82f6' },
      { label: 'NGR', key: 'NGR', format: 'currency', color: '#10b981' },
      { label: 'T/O', key: 'T/O', format: 'currency', color: '#8b5cf6' },
      { label: 'RTP', key: 'RTP', format: 'percent', color: '#f59e0b' },
      { label: 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼', key: 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼', format: 'number', color: '#ec4899' },
      { label: 'FTDæ•°', key: 'FTDæ•°', format: 'number', color: '#06b6d4' },
      { label: 'å›åç‡', key: 'å›åç‡', format: 'percent', color: '#84cc16' },
      { label: 'LTV', key: 'LTV', format: 'currency', color: '#f43f5e' },
    ];
  } else if (type === 'agent') {
    cards = [
      { label: 'ç·åç›Š', key: 'ç·åç›Š', format: 'currency', color: '#3b82f6' },
      { label: 'ãƒ­ãƒ¼ãƒªãƒ³ã‚°å ±é…¬', key: 'ãƒ­ãƒ¼ãƒªãƒ³ã‚°å ±é…¬', format: 'currency', color: '#10b981' },
      { label: 'NGR', key: 'NGR', format: 'currency', color: '#8b5cf6' },
      { label: 'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ•°', key: 'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ•°', format: 'number', color: '#f59e0b' },
    ];
  } else if (type === 'ads') {
    cards = [
      { label: 'ã‚³ã‚¹ãƒˆ', key: 'ã‚³ã‚¹ãƒˆ', format: 'currency', color: '#ef4444' },
      { label: 'ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³', key: 'ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³', format: 'number', color: '#3b82f6' },
      { label: 'ã‚¯ãƒªãƒƒã‚¯', key: 'ã‚¯ãƒªãƒƒã‚¯', format: 'number', color: '#10b981' },
      { label: 'CTR', key: 'CTR', format: 'percent', color: '#f59e0b' },
      { label: 'ç™»éŒ²æ•°', key: 'ç™»éŒ²æ•°', format: 'number', color: '#8b5cf6' },
      { label: 'å…¥é‡‘æ•°', key: 'å…¥é‡‘æ•°', format: 'number', color: '#ec4899' },
      { label: 'CVR', key: 'CVR', format: 'percent', color: '#06b6d4' },
      { label: 'CPA', key: 'CPA', format: 'currency', color: '#84cc16' },
    ];
  } else if (type === 'tool') {
    cards = [
      { label: 'LINEæµå…¥', key: 'LINEæµå…¥', format: 'number', color: '#06b6d4' },
      { label: 'Telegramæµå…¥', key: 'Telegramæµå…¥', format: 'number', color: '#3b82f6' },
      { label: 'Twitteræµå…¥', key: 'Twitteræµå…¥', format: 'number', color: '#1da1f2' },
      { label: 'åˆè¨ˆæµå…¥', key: 'åˆè¨ˆæµå…¥', format: 'number', color: '#8b5cf6' },
      { label: 'ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°', key: 'ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°', format: 'number', color: '#10b981' },
      { label: 'ç·å…¥é‡‘é¡', key: 'ç·å…¥é‡‘é¡', format: 'currency', color: '#f59e0b' },
      { label: 'ç·GGR', key: 'ç·GGR', format: 'currency', color: '#3b82f6' },
      { label: 'ã‚³ã‚¹ãƒˆ', key: 'ã‚³ã‚¹ãƒˆ', format: 'currency', color: '#ef4444' },
      { label: 'NGR', key: 'NGR', format: 'currency', color: '#10b981' },
    ];
  }
  
  container.innerHTML = cards.filter(c => data[c.key] != null).map(card => {
    let value = data[card.key];
    let formatted = card.format === 'currency' ? formatCurrency(value) 
                  : card.format === 'percent' ? formatPercent(value) 
                  : formatNumber(value);
    return `
      <div class="summary-card" style="background: linear-gradient(135deg, ${card.color}, ${card.color}dd);">
        <h3>${card.label}</h3>
        <div class="value">${formatted}</div>
      </div>
    `;
  }).join('');
}

// ========================================
// ãƒãƒ£ãƒ¼ãƒˆ
// ========================================
function renderChart() {
  const ctx = document.getElementById('main-chart').getContext('2d');
  const business = BUSINESSES[currentBusiness];
  const data = business?.data || {};
  const periods = sortPeriods(Object.keys(data)).reverse();
  
  if (chartInstance) chartInstance.destroy();
  
  if (periods.length === 0) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    return;
  }
  
  let datasets = [];
  const type = business.type;
  
  if (type === 'standard' || type === 'sloten') {
    datasets = [
      { label: 'GGR', data: periods.map(p => data[p]?.['GGR'] || 0), backgroundColor: 'rgba(59, 130, 246, 0.7)' },
      { label: 'NGR', data: periods.map(p => data[p]?.['NGR'] || 0), backgroundColor: 'rgba(16, 185, 129, 0.7)' },
    ];
  } else if (type === 'ads') {
    datasets = [
      { label: 'ã‚³ã‚¹ãƒˆ', data: periods.map(p => data[p]?.['ã‚³ã‚¹ãƒˆ'] || 0), backgroundColor: 'rgba(239, 68, 68, 0.7)' },
      { label: 'ç™»éŒ²æ•°Ã—1000', data: periods.map(p => (data[p]?.['ç™»éŒ²æ•°'] || 0) * 1000), backgroundColor: 'rgba(139, 92, 246, 0.7)' },
    ];
  } else if (type === 'tool') {
    datasets = [
      { label: 'ç·GGR', data: periods.map(p => data[p]?.['ç·GGR'] || 0), backgroundColor: 'rgba(59, 130, 246, 0.7)' },
      { label: 'ã‚³ã‚¹ãƒˆ', data: periods.map(p => data[p]?.['ã‚³ã‚¹ãƒˆ'] || 0), backgroundColor: 'rgba(239, 68, 68, 0.7)' },
      { label: 'NGR', data: periods.map(p => data[p]?.['NGR'] || 0), backgroundColor: 'rgba(16, 185, 129, 0.7)' },
    ];
  } else {
    datasets = [
      { label: 'ç·åç›Š', data: periods.map(p => data[p]?.['ç·åç›Š'] || 0), backgroundColor: 'rgba(59, 130, 246, 0.7)' },
    ];
  }
  
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: { labels: periods, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'top' } },
      scales: { y: { beginAtZero: true, ticks: { callback: v => 'Â¥' + (v / 1000000).toFixed(0) + 'M' } } }
    }
  });
}

// ========================================
// ãƒªãƒ³ã‚¯ä¸€è¦§
// ========================================
function renderLinks() {
  const section = document.getElementById('links-section');
  const grid = document.getElementById('links-grid');
  const title = document.getElementById('links-title');
  
  let links = [];
  if (currentBusiness === 'DSC') {
    links = DSC_LINKS;
    title.textContent = 'ğŸ”— LPãƒ»ãƒ„ãƒ¼ãƒ«ä¸€è¦§ï¼ˆ' + links.length + 'ä»¶ï¼‰';
  } else if (currentBusiness === 'ã‚¹ãƒ­å¤©') {
    links = SLOTEN_LINKS;
    title.textContent = 'ğŸ”— ãƒªãƒ³ã‚¯ä¸€è¦§ï¼ˆ' + links.length + 'ä»¶ï¼‰';
  }
  
  if (links.length === 0) {
    section.classList.add('hidden');
    return;
  }
  
  section.classList.remove('hidden');
  
  const grouped = {};
  links.forEach(link => {
    if (!grouped[link.category]) grouped[link.category] = [];
    grouped[link.category].push(link);
  });
  
  grid.innerHTML = Object.entries(grouped).map(([cat, items]) => `
    <div class="link-category">
      <h4>${cat}ï¼ˆ${items.length}ä»¶ï¼‰</h4>
      <div>${items.map(item => `<a href="${item.url}" target="_blank" class="link-item">${item.name}</a>`).join('')}</div>
    </div>
  `).join('');
}

// ========================================
// ãƒ†ãƒ¼ãƒ–ãƒ«
// ========================================
function renderTable() {
  const business = BUSINESSES[currentBusiness];
  const data = business?.data?.[currentPeriod];
  const header = document.getElementById('table-header');
  const body = document.getElementById('table-body');
  
  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹ã®å ´åˆã¯ç‰¹æ®Šè¡¨ç¤º
  if (business?.type === 'agent' && business.agents?.length > 0) {
    header.innerHTML = '<th>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå</th><th class="text-right">åç›Š</th><th class="text-right">ãƒ­ãƒ¼ãƒªãƒ³ã‚°</th><th class="text-right">NGR</th>';
    body.innerHTML = business.agents.map(agent => `
      <tr>
        <td>${agent.name}</td>
        <td class="text-right">${formatCurrency(agent.revenue)}</td>
        <td class="text-right">${formatCurrency(agent.rolling)}</td>
        <td class="text-right ${agent.ngr >= 0 ? 'text-green' : 'text-red'}">${formatCurrency(agent.ngr)}</td>
      </tr>
    `).join('');
    return;
  }
  
  if (!data) {
    header.innerHTML = '';
    body.innerHTML = '<tr><td colspan="2" style="text-align:center; padding: 40px; color: #94a3b8;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</td></tr>';
    return;
  }
  
  header.innerHTML = '<th>é …ç›®</th><th class="text-right">å€¤</th>';
  body.innerHTML = Object.entries(data).map(([key, value]) => {
    let formatted;
    if (typeof value === 'number') {
      if (key.includes('ç‡') || key.includes('RTP') || key.includes('CTR') || key.includes('CVR')) {
        formatted = formatPercent(value);
      } else {
        formatted = formatCurrency(value);
      }
    } else {
      formatted = value;
    }
    return `<tr><td>${key}</td><td class="text-right">${formatted}</td></tr>`;
  }).join('');
}

// ========================================
// ãƒ¢ãƒ¼ãƒ€ãƒ«
// ========================================
function showUploadModal() {
  document.getElementById('upload-modal').classList.remove('hidden');
  document.getElementById('upload-status').style.display = 'none';
}

function hideUploadModal() {
  document.getElementById('upload-modal').classList.add('hidden');
}

function showAddBusinessModal() {
  document.getElementById('add-business-modal').classList.remove('hidden');
}

function hideAddBusinessModal() {
  document.getElementById('add-business-modal').classList.add('hidden');
}

function setupDragDrop() {
  const zone = document.getElementById('upload-zone');
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('dragover');
    if (e.dataTransfer.files[0]) handleFileUpload(e.dataTransfer.files[0]);
  });
}

function showStatus(message, isError = false) {
  const status = document.getElementById('upload-status');
  status.style.display = 'block';
  status.style.background = isError ? '#fee2e2' : '#dcfce7';
  status.style.color = isError ? '#dc2626' : '#16a34a';
  status.textContent = message;
}

// ========================================
// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
// ========================================
function handleFileUpload(file) {
  if (!file) return;
  
  const period = document.getElementById('upload-period').value || new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' }).replace(' ', '');
  const uploadType = document.getElementById('upload-type').value;
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      if (file.name.endsWith('.csv')) {
        handleCSV(e.target.result, period, uploadType, file.name);
      } else {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        handleExcel(workbook, period, uploadType, file.name);
      }
    } catch (err) {
      showStatus('ã‚¨ãƒ©ãƒ¼: ' + err.message, true);
    }
  };
  
  if (file.name.endsWith('.csv')) {
    reader.readAsText(file);
  } else {
    reader.readAsArrayBuffer(file);
  }
}

// ========================================
// CSVå‡¦ç†
// ========================================
function handleCSV(text, period, uploadType, filename) {
  const lines = text.split('\n').map(line => line.split(',').map(cell => cell.trim().replace(/^"|"$/g, '')));
  
  // AMUSEVIP ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå½¢å¼ã®æ¤œå‡º
  if (uploadType === 'agent' || uploadType === 'auto' && (
    lines[0]?.some(h => h.includes('åç›Š') || h.includes('ãƒ­ãƒ¼ãƒªãƒ³ã‚°')) ||
    filename.toLowerCase().includes('agent') ||
    filename.toLowerCase().includes('vip')
  )) {
    parseAgentCSV(lines, period);
    return;
  }
  
  // åºƒå‘Šãƒ‡ãƒ¼ã‚¿å½¢å¼ã®æ¤œå‡º
  if (uploadType === 'ads' || uploadType === 'auto' && (
    lines[0]?.some(h => h.includes('ã‚³ã‚¹ãƒˆ') || h.includes('ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³') || h.includes('ã‚¯ãƒªãƒƒã‚¯')) ||
    filename.toLowerCase().includes('ad') ||
    filename.toLowerCase().includes('åºƒå‘Š')
  )) {
    parseAdsCSV(lines, period);
    return;
  }
  
  showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ã‚’åˆ¤åˆ¥ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
}

function parseAgentCSV(lines, period) {
  const headers = lines[0].map(h => String(h || '').toLowerCase());
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®š
  const findIdx = (keywords) => headers.findIndex(h => keywords.some(k => h.includes(k)));
  
  const nameIdx = findIdx(['åå‰', 'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ', 'name', 'agent', 'æ‹…å½“']);
  const revenueIdx = findIdx(['åç›Š', 'revenue', 'å£²ä¸Š', 'ç·é¡']);
  const rollingIdx = findIdx(['ãƒ­ãƒ¼ãƒªãƒ³ã‚°', 'rolling', 'å ±é…¬']);
  const ngrIdx = findIdx(['ngr', 'ç´”åˆ©ç›Š']);
  
  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®
  const nIdx = nameIdx >= 0 ? nameIdx : 0;
  const rIdx = revenueIdx >= 0 ? revenueIdx : 1;
  const rollIdx = rollingIdx >= 0 ? rollingIdx : 2;
  const ngIdx = ngrIdx >= 0 ? ngrIdx : 3;
  
  let agents = [];
  let totalRevenue = 0, totalRolling = 0, totalNGR = 0;
  
  for (let i = 1; i < lines.length; i++) {
    const row = lines[i];
    if (row.length < 2) continue;
    
    const name = String(row[nIdx] || '').trim();
    if (!name || name === '') continue;
    
    const revenue = parseNumber(row[rIdx]) || 0;
    const rolling = parseNumber(row[rollIdx]) || 0;
    const ngr = ngrIdx >= 0 ? (parseNumber(row[ngIdx]) || 0) : (revenue - rolling);
    
    agents.push({ name, revenue, rolling, ngr });
    totalRevenue += revenue;
    totalRolling += rolling;
    totalNGR += ngr;
  }
  
  if (agents.length === 0) {
    showStatus('ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', true);
    return;
  }
  
  if (!BUSINESSES['AMUSEVIP']) {
    BUSINESSES['AMUSEVIP'] = { type: 'agent', data: {}, agents: [] };
  }
  
  BUSINESSES['AMUSEVIP'].agents = agents;
  BUSINESSES['AMUSEVIP'].data[period] = {
    'ç·åç›Š': totalRevenue,
    'ãƒ­ãƒ¼ãƒªãƒ³ã‚°å ±é…¬': totalRolling,
    'NGR': totalNGR,
    'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ•°': agents.length
  };
  
  showStatus(`ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ: ${agents.length}ä»¶`);
  selectBusiness('AMUSEVIP');
  setTimeout(hideUploadModal, 1500);
}

function parseAdsCSV(lines, period) {
  const headers = lines[0].map(h => String(h || '').toLowerCase());
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®š
  const findIdx = (keywords) => headers.findIndex(h => keywords.some(k => h.includes(k)));
  
  const costIdx = findIdx(['ã‚³ã‚¹ãƒˆ', 'cost', 'è²»ç”¨', 'åºƒå‘Šè²»']);
  const impIdx = findIdx(['ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³', 'imp', 'è¡¨ç¤º', 'impression']);
  const clickIdx = findIdx(['ã‚¯ãƒªãƒƒã‚¯', 'click']);
  const regIdx = findIdx(['ç™»éŒ²', 'reg', 'registration', 'ä¼šå“¡']);
  const depIdx = findIdx(['å…¥é‡‘', 'dep', 'ftd', 'deposit']);
  
  let totalCost = 0, totalImp = 0, totalClick = 0, totalReg = 0, totalDep = 0;
  
  for (let i = 1; i < lines.length; i++) {
    const row = lines[i];
    if (row.length < 2) continue;
    
    if (costIdx >= 0) totalCost += parseNumber(row[costIdx]) || 0;
    if (impIdx >= 0) totalImp += parseNumber(row[impIdx]) || 0;
    if (clickIdx >= 0) totalClick += parseNumber(row[clickIdx]) || 0;
    if (regIdx >= 0) totalReg += parseNumber(row[regIdx]) || 0;
    if (depIdx >= 0) totalDep += parseNumber(row[depIdx]) || 0;
  }
  
  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã€ä½ç½®ãƒ™ãƒ¼ã‚¹ã§è©¦ã™
  if (costIdx < 0 && impIdx < 0) {
    for (let i = 1; i < lines.length; i++) {
      const row = lines[i];
      if (row.length >= 5) {
        totalCost += parseNumber(row[1]) || 0;
        totalImp += parseNumber(row[2]) || 0;
        totalClick += parseNumber(row[3]) || 0;
        totalReg += parseNumber(row[4]) || 0;
        if (row.length >= 6) totalDep += parseNumber(row[5]) || 0;
      }
    }
  }
  
  const ctr = totalImp > 0 ? (totalClick / totalImp) * 100 : 0;
  const cvr = totalClick > 0 ? (totalReg / totalClick) * 100 : 0;
  const cpa = totalReg > 0 ? totalCost / totalReg : 0;
  
  if (!BUSINESSES['åºƒå‘Š']) {
    BUSINESSES['åºƒå‘Š'] = { type: 'ads', data: {} };
  }
  
  BUSINESSES['åºƒå‘Š'].data[period] = {
    'ã‚³ã‚¹ãƒˆ': totalCost,
    'ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³': totalImp,
    'ã‚¯ãƒªãƒƒã‚¯': totalClick,
    'CTR': ctr,
    'ç™»éŒ²æ•°': totalReg,
    'å…¥é‡‘æ•°': totalDep,
    'CVR': cvr,
    'CPA': cpa
  };
  
  showStatus(`åºƒå‘Šãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ: ${period}ï¼ˆ${lines.length - 1}è¡Œï¼‰`);
  selectBusiness('åºƒå‘Š');
  setTimeout(hideUploadModal, 1500);
}

// ========================================
// Excelå‡¦ç†
// ========================================
function handleExcel(workbook, period, uploadType, filename) {
  const sheetNames = workbook.SheetNames;
  
  // ãƒã‚«ãƒ©ãƒ„ãƒ¼ãƒ«å½¢å¼ã®æ¤œå‡º
  if (uploadType === 'baccarat' || uploadType === 'auto' && (
    sheetNames.some(s => s.includes('ãƒã‚«ãƒ©') || s.includes('baccara')) ||
    filename.toLowerCase().includes('baccara') ||
    filename.toLowerCase().includes('ãƒã‚«ãƒ©')
  )) {
    parseBaccaratExcel(workbook, period);
    return;
  }
  
  // ã‚¹ãƒ­å¤©å½¢å¼ã®æ¤œå‡º
  if (uploadType === 'sloten' || uploadType === 'auto' && (
    sheetNames.some(s => s.includes('ã‚¹ãƒ­å¤©') || s.includes('sloten') || s.includes('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰')) ||
    filename.toLowerCase().includes('ã‚¹ãƒ­å¤©') ||
    filename.toLowerCase().includes('sloten')
  )) {
    parseSlotenExcel(workbook, period);
    return;
  }
  
  // åç›Šã‚·ãƒ¼ãƒˆå½¢å¼ï¼ˆå…ƒamuse/DSCï¼‰
  parseRevenueExcel(workbook, period);
}

function parseRevenueExcel(workbook, period) {
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
  
  // KPIè¡Œã‚’æ¤œç´¢
  const kpiMap = {};
  const kpiNames = ['GGR', 'NGR', 'T/O', 'RTP', 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼', 'FTD', 'å›åç‡', 'LTV', 'å›åé‡‘é¡', 'å‡ºé‡‘é‡‘é¡'];
  
  json.forEach((row, rowIdx) => {
    if (!row || row.length < 2) return;
    const label = String(row[0] || '').trim();
    kpiNames.forEach(kpi => {
      if (label.includes(kpi)) {
        const value = parseNumber(row[1]);
        if (value !== null) {
          kpiMap[kpi.replace('FTD', 'FTDæ•°').replace('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼', 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼')] = value;
        }
      }
    });
  });
  
  if (Object.keys(kpiMap).length === 0) {
    showStatus('KPIãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', true);
    return;
  }
  
  // äº‹æ¥­ã‚’è‡ªå‹•åˆ¤åˆ¥
  let targetBusiness = currentBusiness;
  if (currentBusiness !== 'å…ƒamuse' && currentBusiness !== 'DSC') {
    targetBusiness = 'å…ƒamuse';
  }
  
  BUSINESSES[targetBusiness].data[period] = kpiMap;
  
  showStatus(`${targetBusiness}ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ: ${period}`);
  selectBusiness(targetBusiness);
  setTimeout(hideUploadModal, 1500);
}

function parseSlotenExcel(workbook, period) {
  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ¢ã™
  const dashSheet = workbook.SheetNames.find(s => s.includes('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰')) || workbook.SheetNames[0];
  const sheet = workbook.Sheets[dashSheet];
  const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
  
  const kpiMap = {};
  
  // è¡Œã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦KPIã‚’æŠ½å‡º
  json.forEach((row, idx) => {
    if (!row || row.length < 2) return;
    const label = String(row[0] || '').trim();
    
    if (label.includes('GGR')) kpiMap['GGR'] = parseNumber(row[1]);
    if (label.includes('NGR')) kpiMap['NGR'] = parseNumber(row[1]);
    if (label.includes('å…¥é‡‘') && !label.includes('å‡ºé‡‘')) kpiMap['å…¥é‡‘é¡'] = parseNumber(row[1]);
    if (label.includes('å‡ºé‡‘')) kpiMap['å‡ºé‡‘é¡'] = parseNumber(row[1]);
    if (label.includes('RTP')) kpiMap['RTP'] = parseNumber(row[1]);
    if (label.includes('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–')) kpiMap['ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼'] = parseNumber(row[1]);
    if (label.includes('T/O') || label.includes('ã‚¿ãƒ¼ãƒ³ã‚ªãƒ¼ãƒãƒ¼')) kpiMap['T/O'] = parseNumber(row[1]);
  });
  
  BUSINESSES['ã‚¹ãƒ­å¤©'].data[period] = kpiMap;
  
  showStatus(`ã‚¹ãƒ­å¤©ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ: ${period}`);
  selectBusiness('ã‚¹ãƒ­å¤©');
  setTimeout(hideUploadModal, 1500);
}

function parseBaccaratExcel(workbook, period) {
  const kpiMap = {};
  
  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
  const dashSheetName = workbook.SheetNames.find(s => s.includes('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰')) || workbook.SheetNames[0];
  const dashSheet = workbook.Sheets[dashSheetName];
  const dashData = XLSX.utils.sheet_to_json(dashSheet, { header: 1 });
  
  dashData.forEach((row, idx) => {
    if (!row || row.length < 2) return;
    const label = String(row[0] || '').trim();
    const value = parseNumber(row[1]);
    
    if (label.includes('LINEæµå…¥')) kpiMap['LINEæµå…¥'] = value || 0;
    if (label.includes('Telegramæµå…¥')) kpiMap['Telegramæµå…¥'] = value || 0;
    if (label.includes('Twitteræµå…¥')) kpiMap['Twitteræµå…¥'] = value || 0;
    if (label.includes('åˆè¨ˆæµå…¥')) kpiMap['åˆè¨ˆæµå…¥'] = value || 0;
    if (label.includes('ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼')) kpiMap['ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°'] = value || 0;
    if (label.includes('ç·å…¥é‡‘é¡')) kpiMap['ç·å…¥é‡‘é¡'] = value || 0;
    if (label.includes('ç·GGR') || label === 'GGR') kpiMap['ç·GGR'] = value || 0;
    if (label === 'ã‚³ã‚¹ãƒˆ') kpiMap['ã‚³ã‚¹ãƒˆ'] = value || 0;
    if (label === 'NGR') kpiMap['NGR'] = value || 0;
  });
  
  // ã‚³ã‚¹ãƒˆã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  const costSheetName = workbook.SheetNames.find(s => s.includes('ã‚³ã‚¹ãƒˆ'));
  if (costSheetName) {
    const costSheet = workbook.Sheets[costSheetName];
    const costData = XLSX.utils.sheet_to_json(costSheet, { header: 1 });
    
    let totalCost = 0;
    costData.forEach((row, idx) => {
      if (idx === 0) return; // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¹ã‚­ãƒƒãƒ—
      // é‡‘é¡åˆ—ã‚’æ¢ã™ï¼ˆé€šå¸¸ã¯æœ€å¾Œã®åˆ—ã‹ã€Œé‡‘é¡ã€åˆ—ï¼‰
      for (let i = row.length - 1; i >= 0; i--) {
        const val = parseNumber(row[i]);
        if (val !== null && val > 0) {
          totalCost += val;
          break;
        }
      }
    });
    
    if (totalCost > 0) {
      kpiMap['ã‚³ã‚¹ãƒˆ'] = totalCost;
      if (kpiMap['ç·GGR'] !== undefined) {
        kpiMap['NGR'] = (kpiMap['ç·GGR'] || 0) - totalCost;
      }
    }
  }
  
  // åˆè¨ˆæµå…¥ã‚’è¨ˆç®—ï¼ˆãªã‘ã‚Œã°ï¼‰
  if (!kpiMap['åˆè¨ˆæµå…¥'] && (kpiMap['LINEæµå…¥'] || kpiMap['Telegramæµå…¥'] || kpiMap['Twitteræµå…¥'])) {
    kpiMap['åˆè¨ˆæµå…¥'] = (kpiMap['LINEæµå…¥'] || 0) + (kpiMap['Telegramæµå…¥'] || 0) + (kpiMap['Twitteræµå…¥'] || 0);
  }
  
  BUSINESSES['ãƒã‚«ãƒ©ãƒ„ãƒ¼ãƒ«'].data[period] = kpiMap;
  
  showStatus(`ãƒã‚«ãƒ©ãƒ„ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ: ${period}`);
  selectBusiness('ãƒã‚«ãƒ©ãƒ„ãƒ¼ãƒ«');
  setTimeout(hideUploadModal, 1500);
}

// ========================================
// äº‹æ¥­è¿½åŠ ãƒ»å‰Šé™¤
// ========================================
function addBusiness() {
  const name = document.getElementById('new-business-name').value.trim();
  const type = document.getElementById('new-business-type').value;
  
  if (!name) {
    alert('äº‹æ¥­åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  if (BUSINESSES[name]) {
    alert('åŒã˜åå‰ã®äº‹æ¥­ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™');
    return;
  }
  
  BUSINESSES[name] = { type, data: {} };
  hideAddBusinessModal();
  selectBusiness(name);
}

function deleteBusiness() {
  if (Object.keys(BUSINESSES).length <= 1) {
    alert('æœ€å¾Œã®äº‹æ¥­ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
    return;
  }
  if (confirm(`ã€Œ${currentBusiness}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
    delete BUSINESSES[currentBusiness];
    selectBusiness(Object.keys(BUSINESSES)[0]);
  }
}
</script>
</body>
</html>
